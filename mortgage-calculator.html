<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>AI Mortgage Calculator 2025 | PITI, Rates & Amortization | FinGuid</title>

    <meta name="description" content="World's Best AI-Powered Mortgage Calculator by FinGuid. Calculate PITI (Principal, Interest, Taxes, Insurance) with live FRED rates, ZIP code tax lookup, extra payments, and 100+ AI insights. WCAG 2.1 AA compliant. Mobile-friendly.">
    <meta name="keywords" content="mortgage calculator, PITI calculator, home loan calculator, mortgage payment calculator, amortization calculator, property tax calculator, home insurance calculator, mortgage rates calculator, monthly payment calculator, house affordability calculator, FHA calculator, VA loan calculator, USDA calculator, refinance calculator, extra payment calculator, lump sum payment, principal interest calculator, PMI calculator, HOA fees calculator, first time home buyer, down payment calculator, interest rate calculator, loan term calculator, 30 year mortgage, 15 year mortgage, adjustable rate mortgage, fixed rate mortgage, mortgage rates today, current mortgage rates, FRED API rates, live rates, real estate calculator, home buying calculator, mortgage affordability calculator, debt to income calculator, closing costs calculator, zip code tax lookup, state tax rates, property tax by state, homeowners insurance rates, mortgage insurance, private mortgage insurance, mortgage prepayment, extra principal payment, mortgage payoff calculator, pay off mortgage early, mortgage acceleration, interest savings calculator, loan amortization schedule, amortization table, payment schedule, monthly payment breakdown, principal vs interest, mortgage comparison, mortgage quotes, mortgage lenders, mortgage brokers, pre-approval letter, mortgage pre-qualification, credit score mortgage, down payment assistance, first time homebuyer programs, VA benefits, FHA loans, USDA loans, conventional loans, jumbo loans, government loans, reverse mortgage, mortgage refinancing, cash out refinance, rate and term refinance, streamline refinance, ARM calculator, interest only mortgage, balloon mortgage, bi-weekly mortgage payment, mortgage calculator with taxes and insurance, comprehensive mortgage calculator, detailed amortization calculator">

    <meta name="author" content="FinGuid USA">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="theme-color" content="#24ACB9">
    <meta property="og:type" content="website">
    <meta property="og:title" content="AI Mortgage Calculator 2025 | Live FRED Rates | FinGuid">
    <meta property="og:description" content="Free AI mortgage calculator with FRED rates, ZIP code tax lookup, extra payments, and 100+ insights">
    
    <link rel="canonical" href="https://www.finguid.com/calculators/mortgage">
    
    <!-- 
      NEW: Inlined PWA Web App Manifest
      This fulfills the PWA requirement from your 'tools scrept.docx'
      It uses placeholder icons. Replace the 'src' URLs with your hosted icons.
    -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22FinGuid%20AI%20Mortgage%20Calculator%22,%22short_name%22:%22MortgageCalc%22,%22description%22:%22AI-Powered%20Mortgage%20Calculator%20with%20PITI,%20Live%20Rates,%20and%20Amortization.%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#FFFFFD%22,%22theme_color%22:%22#24ACB9%22,%22icons%22:[{%22src%22:%22https://placehold.co/192x192/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://placehold.co/512x512/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22512x512%22}]}">
    
    <!-- 
      START: Inlined CSS
      Content from mortgage-calculator (5).css is pasted here.
    -->
    <style>
        /* === START: Global Variables (Brand Color Match) === */
        :root {
            --primary: #24ACB9; /* Teal (Matches FinGuid Image & Car Lease CSS) */
            --primary-dark: #19343B; /* Dark Teal (Matches Car Lease CSS) */
            --accent: #FFC107;
            --accent-dark: #E69500;
            --text: #1F2121;
            --text-light: #64748B;
            --bg: #FFFFFD;
            --bg-secondary: #F5F7FA;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --error: #EF4444;
            --success: #10B981;
            --fred-color: #A31B20; /* FRED standard color for Live Rates button */
        }

        [data-color-scheme="dark"] {
            --text: #E1E8ED;
            --text-light: #B8C5D0;
            --bg: #1F2121;
            --bg-secondary: #242B36;
            --card: #181919;
            --border: #38444D;
        }
        /* === END: Global Variables === */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { font-size: 16px; -webkit-font-smoothing: antialiased; }

        body {
            font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* ===== NEW HEADER STYLES (Single Line) ===== */
        .header {
            position: sticky;
            top: 0;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            gap: 16px;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--primary); /* Uses new primary brand color */
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .logo:hover { color: var(--primary-dark); }

        .calculator-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            flex-shrink: 0;
            margin-left: 16px;
        }

        /* === IMPROVED: Animated Features === */
        .header-features {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 24px;
            flex-grow: 1;
            justify-content: flex-start;
            overflow: hidden;
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        .header-feature-item {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            animation: pulse-color-text 2.5s infinite ease-in-out;
        }
        .header-feature-item:nth-child(1) { animation-delay: 0s; }
        .header-feature-item:nth-child(2) { animation-delay: 0.2s; }
        .header-feature-item:nth-child(3) { animation-delay: 0.4s; }
        .header-feature-item:nth-child(4) { animation-delay: 0.6s; }

        /* New animation for better visibility */
        @keyframes pulse-color-text {
            0%, 100% {
                opacity: 0.8;
                color: var(--text-light);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                color: var(--primary); /* Pulses to brand color */
                transform: scale(1.03);
            }
        }
        /* === END: Improved Animated Features === */


        /* Header Controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:hover { background: var(--primary); color: white; }

        /* --- STYLE FOR ACTIVE TOGGLES (from previous fix) --- */
        .icon-btn.active {
            background: var(--primary);
            color: white;
        }
        /* --- END NEW STYLE --- */

        #pwa-install-btn {
            display: none;
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #pwa-install-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        /* ===== END NEW HEADER STYLES ===== */


        /* ===== SPONSOR BANNER (Uses FinGuid/Car Lease Gradient) ===== */
        .sponsor-banner {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); /* Matched car lease color */
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sponsor-text { font-weight: 500; flex: 1; min-width: 200px; }
        .sponsor-buttons { display: flex; gap: 8px; }

        .sponsor-btn {
            padding: 8px 12px;
            background: white;
            color: #6366F1; /* Color from the gradient for consistency */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .sponsor-btn:hover { background: var(--accent); color: var(--text); transform: translateY(-2px); }

        /* ===== MAIN CALCULATOR (Layout Preserved) ===== */
        .calculator-wrapper {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            padding: 24px 0;
            margin-bottom: 40px;
        }

        .inputs-panel, .results-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        .inputs-panel:hover, .results-panel:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .panel-title { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }

        .section-heading {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary); /* Uses new primary brand color */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        /* ===== NEW: Style for automated FRED update text ===== */
        .fred-rates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        #fred-last-updated {
            font-size: 11px;
            color: var(--text-light);
            text-align: left;
        }
        .fred-branding {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 600;
        }
        .fred-branding a {
            color: var(--text-light);
            text-decoration: none;
        }
        .fred-branding a:hover {
            color: var(--primary);
        }

        .live-rates-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .rate-btn {
            flex-grow: 1;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .rate-btn:hover {
            background: var(--card);
            border-color: var(--primary);
            color: var(--primary);
        }
        .rate-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .rate-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* ===== END: New Styles ===== */

        /* ===== NEW: Tooltip Styles (from Car Lease) ===== */
        .tooltip {
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
            display: inline-flex; /* Use flex to align icon */
            align-items: center;
            color: var(--text-light); /* Make hint text match */
        }

        /* IMPROVED: Tooltip icon */
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-light);
            color: var(--card);
            font-style: normal;
            font-size: 10px;
            font-weight: 700;
            line-height: 14px;
            margin-left: 5px;
            transition: all 0.2s ease;
        }
        .tooltip:hover .tooltip-icon {
            background: var(--primary);
        }


        .tooltip-box {
            position: fixed;
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 200px;
            white-space: normal;
            display: none; /* Hidden by default, shown by JS */
            opacity: 0;
            transition: opacity 0.2s;
        }
        /* ===== END: Tooltip Styles ===== */


        .input-wrapper { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            /* IMPROVED: Fix for % input overflow */
            min-width: 0; 
        }

        input[type="number"], input[type="text"], input[type="date"], input[type="month"], select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
            /* IMPROVED: Fix for % input overflow */
            min-width: 0;
            width: 100%; /* Ensure it takes available space */
        }

        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus, input[type="month"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.1); /* Updated focus color */
        }

        .input-addon {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            min-width: 50px;
            text-align: center;
        }

        .toggle-btn {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s ease;
        }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* ===== FRED BRANDING (Button styles preserved in case you add other buttons) ===== */
        .lookup-btn {
            padding: 10px 12px;
            background: var(--primary); /* Default button uses new brand color */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .lookup-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .lookup-btn.fred-btn { background: var(--fred-color); }
        .lookup-btn.fred-btn:hover { background: #7D1418; }
        .lookup-btn:active { transform: translateY(0); }

        /* ===== NEW: Ad Slot (from Car Lease) ===== */
        .ad-slot {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
        }
        .ad-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .ad-placeholder {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 600;
        }
        /* ===== END: Ad Slot ===== */

        /* ===== RESULTS SECTION (Preserved) ===== */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); /* Updated gradient */
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(36, 172, 185, 0.2); /* Updated shadow */
            text-align: center;
        }
        .summary-label { font-size: 0.875rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .payment-amount { display: flex; align-items: baseline; justify-content: center; gap: 8px; margin: 8px 0; }
        .amount { font-size: 2rem; font-weight: bold; }
        .unit { font-size: 1rem; opacity: 0.9; }
        .payment-breakdown { font-size: 0.875rem; opacity: 0.8; }

        .tabs { margin-bottom: 24px; }
        .tab-buttons { display: flex; gap: 4px; border-bottom: 2px solid var(--border); margin-bottom: 24px; overflow-x: auto; }

        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .tab-content { display: none; padding: 8px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .results-heading {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin: 16px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .result-box { background: var(--bg-secondary); padding: 16px; border-radius: 6px; border-left: 4px solid var(--border); transition: all 0.2s; }
        .result-box:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        /* IMPROVED: Result card visibility */
        .result-box.highlight { 
            border-left-color: var(--primary); 
            background: rgba(36, 172, 185, 0.1); 
        }
        .result-box.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .result-box.accent {
            border-left-color: var(--accent-dark);
            background: rgba(255, 193, 7, 0.1);
        }

        /* --- IMPROVEMENT: Made result labels/values more visible (Preserved) --- */
        .result-label { 
            display: block; 
            font-size: 0.9rem; /* Increased from 0.875rem */
            font-weight: 600; /* Added font weight */
            color: var(--text-light); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
        }
        .result-value { 
            display: block; 
            font-size: 1.5rem; /* Increased from 1.3rem */
            font-weight: 700; /* Bolder */
            color: var(--text); /* Darker text */
        }
        /* --- END: Improvement --- */

        .chart-container {
            position: relative;
            height: 350px; /* Taller for better charts */
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
        }

        /* === NEW: Chart Summary Controls (for chart.jpg) === */
        .chart-summary-controls {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .chart-summary-controls label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        #slider-year-label {
            display: inline-block;
            font-weight: 700;
            color: var(--primary);
            min-width: 20px;
        }
        .year-slider {
            width: 100%;
            cursor: pointer;
        }
        /* === END: Chart Summary Controls === */


        /* ===== NEW: Amortization Controls & Table Styles ===== */
        .amortization-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 8px 16px;
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .table-scroll-wrapper {
            overflow-x: auto;
            max-height: 500px; /* Scrollable table body */
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .amortization-table thead {
            position: sticky;
            top: 0;
            background: var(--primary); /* Branded color */
            color: white;
            z-index: 10;
        }
        .amortization-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .amortization-table th:nth-child(n+2) { text-align: right; } /* Right-align numbers */

        .amortization-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .amortization-table tbody tr:nth-child(even) {
            background: var(--bg-secondary);
        }
        .amortization-table tbody tr:hover {
            background: rgba(36, 172, 185, 0.1); /* Branded hover */
        }
        .amortization-table td {
            padding: 10px 12px;
            color: var(--text-light);
        }
        .amortization-table td:first-child {
            font-weight: 600;
            color: var(--text);
        }
        .amortization-table td:nth-child(n+2) {
            text-align: right; /* Right-align numbers */
            font-family: 'Courier New', Courier, monospace;
        }
        .amortization-table .summary-row td {
            font-weight: bold;
            color: var(--text);
            background: var(--bg-secondary);
        }
        /* ===== END: Amortization Styles ===== */


        /* ===== AI INSIGHTS (Preserved) ===== */
        .insights-container { margin-top: 20px; }
        .insight-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary); /* Uses new primary brand color */
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .insight-box.success { border-left-color: var(--success); }
        .insight-box.warning { border-left-color: var(--accent-dark); }
        .insight-box.error { border-left-color: var(--error); }


        /* ===== PARTNER SECTION (Preserved) ===== */
        .footer-sponsor {
            background: linear-gradient(135deg, rgba(36, 172, 185, 0.1) 0%, rgba(25, 52, 59, 0.1) 100%); /* Updated gradient */
            padding: 40px;
            border-bottom: 1px solid rgba(36, 172, 185, 0.2);
            border-radius: 12px;
        }
        .sponsor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; }
        .sponsor-item { text-align: center; padding: 16px; border-radius: 8px; background: var(--card); transition: all 0.2s; }
        .sponsor-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sponsor-item h4 { margin-bottom: 8px; color: var(--primary); font-size: 1rem; }
        .sponsor-item p { color: var(--text-light); margin-bottom: 12px; font-size: 0.875rem; line-height: 1.5; }
        .sponsor-item a {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); /* Updated gradient */
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .sponsor-item a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(36, 172, 185, 0.3); } /* Updated shadow */

        /* ===== FOOTER (Preserved) ===== */
        .footer { background: var(--card); border-top: 1px solid var(--border); padding: 32px 0; margin-top: 40px; }
        .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .footer-section h4 { font-size: 13px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .footer-section a { display: block; font-size: 12px; color: var(--text-light); text-decoration: none; margin-bottom: 8px; transition: color 0.3s ease; }
        .footer-section a:hover { color: var(--primary); }
        .compliance-badges { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; font-size: 12px; }
        .badge { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; font-weight: 600; color: var(--text-light); }
        .disclaimer { font-size: 11px; color: var(--text-light); line-height: 1.6; padding-top: 20px; border-top: 1px solid var(--border); }
        .footer-bottom { text-align: center; font-size: 12px; color: var(--text-light); padding-top: 16px; border-top: 1px solid var(--border); }

        /* ===== FAQ ACCORDION (Preserved) ===== */
        .faq-section { margin: 40px 0; }
        .faq-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 20px; text-align: center; }
        .faq-container { max-width: 900px; margin: 0 auto; }
        .faq-item { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; }
        .faq-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .faq-question { padding: 16px; background: var(--bg-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text); transition: all 0.3s ease; }
        .faq-question:hover { background: var(--card); color: var(--primary); }
        .faq-question.active { background: var(--primary); color: white; }
        .faq-icon { font-size: 18px; transition: transform 0.3s ease; }
        .faq-question.active .faq-icon { transform: rotate(180deg); }
        .faq-answer { display: none; padding: 16px; background: var(--card); color: var(--text-light); line-height: 1.8; font-size: 14px; }
        .faq-answer.active { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }

        /* ===== NEW: Styles for ZIP Code Location Info ===== */
        .location-info {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            display: none; /* Hidden by default, shown by JS */
        }
        .location-info.success {
            color: var(--success);
            background-color: rgba(16, 185, 129, 0.1);
            display: block;
        }
        .location-info.error {
            color: var(--error);
            background-color: rgba(239, 68, 68, 0.1);
            display: block;
        }
        .location-info:not(.success):not(.error) {
            color: var(--text-light);
            background-color: var(--bg-secondary);
            display: block;
        }
        /* ===== END: New Styles ===== */


        /* ===== RESPONSIVE (Updated for new header) ===== */
        @media (max-width: 1024px) {
            .calculator-wrapper { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .header-features { display: none; }
            .sponsor-banner { flex-direction: column; gap: 12px; }
            .sponsor-buttons { flex: 1 1 100%; justify-content: space-between; }
            .tab-buttons { flex-wrap: nowrap; overflow-x: auto; }
        }

        @media (max-width: 480px) {
            .calculator-title { display: none; }
            .header-features { display: none; }
            .payment-breakdown { font-size: 0.75rem; }
            .amount { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; }
            .sponsor-grid { grid-template-columns: 1fr; }
        }

        /* ===== PRINT STYLE (Preserved) ===== */
        @media print {
            .header, .sponsor-banner, .header-controls, .footer-sponsor, .faq-section, .footer, .ad-slot, .amortization-controls, .chart-summary-controls {
                display: none;
            }
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel, .results-panel { box-shadow: none; border: 1px solid #ccc; }
            .table-scroll-wrapper { max-height: none; overflow: visible; }
        }
    </style>
    <!-- END: Inlined CSS -->

    <!-- Google Analytics Script (from your HTML) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYBL2CDNQJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NYBL2CDNQJ');
    </script>

    <!-- PWA Install & Preload Logic (from your HTML) -->
    <script>
        // PWA Install Detection (Preserved)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            const pwaInstall = document.getElementById('pwa-install-btn');
            if (pwaInstall) pwaInstall.style.display = 'flex';
        });

        // Preload critical resources (Preserved)
        document.addEventListener('DOMContentLoaded', () => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'script';
            link.href = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            document.head.appendChild(link);
        });
    </script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="https_www.finguid.com" class="logo">
                    <span>üí∞</span>
                    <span>FinGuid USA</span>
                </a>
                
                <span class="calculator-title">Home Loan Pro - Mortgage Calculator</span>

                <div class="header-features">
                    <span class="header-feature-item">ü§ñ AI Powered</span>
                    <span class="header-feature-item">üìà Live FRED Rates</span>
                    <span class="header-feature-item">üí° AI Insights</span>
                    <span class="header-feature-item">üìç ZIP Tax Lookup</span>
                </div>

                <div class="header-controls">
                    <button id="pwa-install-btn" aria-label="Install App">üì± Install</button>
                    <button class="icon-btn" id="darkModeToggle" aria-label="Toggle dark mode" title="Dark mode">üåô</button>
                    <button class="icon-btn" id="voiceToggle" aria-label="Voice control" title="Voice commands">üé§</button>
                    <button class="icon-btn" id="ttsToggle" aria-label="Text to speech" title="Read results">üîä</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="sponsor-banner">
        <span class="sponsor-text">üéÅ Get Pre-Qualified and Receive a $1,000 Lender Credit</span>
        <div class="sponsor-buttons">
            <button class="sponsor-btn" onclick="location.href='#our-partners'">View Partners ‚Üí</button>
            <button class="sponsor-btn" onclick="alert('Please contact us at: contactus@finguid.com')">Become our partner ‚Üí</button>
            </div>
    </div>

    <div class="container">
        <div class="calculator-wrapper">
            <div class="inputs-panel">
                <h2 class="panel-title">üìã Loan Parameters</h2>

                <div class="section-heading">Home Purchase</div>
                <div class="form-group">
                    <label class="form-label" for="homePrice">Home Purchase Price <span class="tooltip" data-tooltip="The full purchase price of the home."><i class="tooltip-icon">i</i></span></label>
                    <div class="input-wrapper">
                        <span class="input-addon">$</span>
                        <input type="number" id="homePrice" value="350000" min="10000" step="5000" aria-label="Home price">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="downPaymentAmount">Down Payment <span class="tooltip" data-tooltip="The initial amount paid upfront.">$ <i class="tooltip-icon">i</i></span></label>
                        <div class="input-wrapper">
                            <span class="input-addon">$</span>
                            <input type="number" id="downPaymentAmount" value="70000" min="0" step="1000" aria-label="Down payment amount in dollars">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="downPaymentPercent">Down Payment <span class="tooltip" data-tooltip="The percentage of the home price paid upfront.">% <i class="tooltip-icon">i</i></span></label>
                        <div class="input-wrapper">
                             <input type="number" id="downPaymentPercent" value="20" min="0" max="100" step="1" aria-label="Down payment percentage">
                             <span class="input-addon">%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="interestRate">
                        Interest Rate %
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="interestRate" value="6.50" min="0" max="12" step="0.01" aria-label="Interest rate">
                        <span class="input-addon">%</span>
                    </div>
                    
                    <div class="fred-rates-header">
                        <span id="fred-last-updated">Loading live rates...</span>
                        <span class="fred-branding">
                            Data via <a href="https://fred.stlouisfed.org/" target="_blank" rel="noopener">FRED¬Æ</a>
                        </span>
                    </div>
                    <div class="live-rates-container">
                        <button class="rate-btn" id="rate-btn-30yr" disabled>30-Yr Fixed: ...</button>
                        <button class="rate-btn" id="rate-btn-15yr" disabled>15-Yr Fixed: ...</button>
                        <button class="rate-btn" id="rate-btn-10yr" disabled>10-Yr Treasury: ...</button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="loanTerm">Loan Term <span class="tooltip" data-tooltip="The length of the loan in years."><i class="tooltip-icon">i</i></span></label>
                        <select id="loanTerm" aria-label="Loan term">
                            <option value="15">15 Years</option>
                            <option value="20">20 Years</option>
                            <option value="30" selected>30 Years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="customTerm">Custom Term <span class="tooltip" data-tooltip="Enter a custom loan term in years."><i class="tooltip-icon">i</i></span></label>
                        <input type="number" id="customTerm" placeholder="or custom" min="1" max="50" aria-label="Custom loan term">
                    </div>
                </div>

                <div class="section-heading">Taxes, Insurance & Fees</div>
                <div class="form-group">
                    <label class="form-label" for="zipCode">ZIP Code <span class="tooltip" data-tooltip="Used to estimate state and local property taxes."><i class="tooltip-icon">i</i></span></label>
                    <div class="input-wrapper">
                        <input type="text" id="zipCode" placeholder="e.g., 90210" maxlength="5" aria-label="ZIP code">
                        <button class="lookup-btn" onclick="app.lookupZipCode()">Lookup</button>
                    </div>
                    <div class="location-info" id="zip-location-info"></div>
                    </div>

                <div class="form-group">
                    <label class="form-label" for="propertyTax">Property Tax (Annual) <span class="tooltip" data-tooltip="Estimated annual property tax.">$ <i class="tooltip-icon">i</i></span></label>
                    <div class="input-wrapper">
                        <span class="input-addon">$</span>
                        <input type="number" id="propertyTax" value="4000" min="0" step="100" aria-label="Property tax">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="homeInsurance">Home Insurance (Annual) <span class="tooltip" data-tooltip="Estimated annual homeowners insurance.">$ <i class="tooltip-icon">i</i></span></label>
                    <div class="input-wrapper">
                        <span class="input-addon">$</span>
                        <input type="number" id="homeInsurance" value="1200" min="0" step="50" aria-label="Home insurance">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="hoaFees">HOA Fees (Monthly) <span class="tooltip" data-tooltip="Monthly Homeowners Association fees, if any.">$ <i class="tooltip-icon">i</i></span></label>
                    <div class="input-wrapper">
                        <span class="input-addon">$</span>
                        <input type="number" id="hoaFees" value="0" min="0" step="50" aria-label="HOA fees">
                    </div>
                </div>

                <div class="section-heading">Extra Payments</div>
                <div class="form-group">
                    <label class="form-label" for="extraMonthly">Extra Monthly Payment <span class="tooltip" data-tooltip="Additional amount paid monthly to reduce principal.">$ <i class="tooltip-icon">i</i></span></label>
                    <div class="input-wrapper">
                        <span class="input-addon">$</span>
                        <input type="number" id="extraMonthly" value="0" min="0" step="50" aria-label="Extra monthly payment">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="extraOneTime">Extra One-Time Payment <span class="tooltip" data-tooltip="A single lump-sum payment applied to principal.">$ <i class="tooltip-icon">i</i></span></label>
                    <div class="input-wrapper">
                        <span class="input-addon">$</span>
                        <input type="number" id="extraOneTime" value="0" min="0" step="100" aria-label="Extra one-time payment">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="extraPaymentDate">Payment Date <span class="tooltip" data-tooltip="Date for the one-time payment. (Note: For this calculator, it's applied as month 1)"><i class="tooltip-icon">i</i></span></label>
                    <input type="month" id="extraPaymentDate" aria-label="Extra payment date">
                </div>
            </div>

            <div class="results-panel">
                <h2 class="panel-title">üìä Analysis & Results</h2>

                <div class="ad-slot">
                    <p class="ad-label">ADVERTISEMENT</p>
                    <div class="ad-placeholder">
                        <p>Compare Top Mortgage Lenders</p>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="summary-label">Estimated Monthly Payment (PITI + HOA)</div>
                    <div class="payment-amount">
                        <span class="amount" id="monthly-payment">$0.00</span>
                        <span class="unit">/month</span>
                    </div>
                    <div class="payment-breakdown" id="payment-breakdown">P&I: $0 | Tax: $0 | Ins: $0 | PMI: $0 | HOA: $0</div>
                </div>
                
                <div class="tabs">
                    <div class="tab-buttons">
                        <button class="tab-btn active" data-tab="analysis">Loan Analysis</button>
                        <button class="tab-btn" data-tab="charts">Mortgage Over Time</button>
                        <button class="tab-btn" data-tab="amortization">Amortization</button>
                        <button class="tab-btn" data-tab="insights">AI Insights</button>
                    </div>

                    <div class="tab-content active" id="analysis">
                        <h3 class="results-heading">Monthly Payment Breakdown</h3>
                        <div class="chart-container">
                            <canvas id="paymentBreakdownChart"></canvas>
                        </div>
                        
                        <h3 class="results-heading">Loan Summary</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <div class="result-label">Loan Amount</div>
                                <div class="result-value" id="loanAmount">$280,000</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Total Interest Paid</div>
                                <div class="result-value" id="totalInterest">$259,105</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Total PITI Payments</div>
                                <div class="result-value" id="totalPayments">$663,105</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">LTV Ratio</div>
                                <div class="result-value" id="ltv">80%</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Monthly P&I</div>
                                <div class="result-value" id="monthlyPI">$1,475</div>
                            </div>
                             <div class="result-box">
                                <div class="result-label">Monthly HOA</div>
                                <div class="result-value" id="monthlyHOA">$0</div>
                            </div>
                            <div class="result-box" id="pmiStatusBox">
                                <div class="result-label">PMI Status</div>
                                <div class="result-value" id="pmiStatus">Required</div>
                            </div>
                            <div class="result-box success" id="interestSavedBox">
                                <div class="result-label">Interest Saved</div>
                                <div class="result-value" id="interestSaved">$0</div>
                            </div>
                            <div class="result-box success" id="payoffAccelBox">
                                <div class="result-label">Payoff Acceleration</div>
                                <div class="result-value" id="payoffAccel">0 months</div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="charts">
                        <h3 class="results-heading">Mortgage Balance Over Time</h3>
                        <div class="chart-container">
                            <canvas id="mortgageOverTimeChart"></canvas>
                        </div>
                        
                        <div class="chart-summary-controls">
                            <label for="year-slider">View Details for Year: <span id="slider-year-label">1</span></label>
                            <input type="range" id="year-slider" min="1" max="30" value="1" class="year-slider" aria-label="Select year to view summary">
                        </div>
                        <div class="result-grid" id="chart-year-summary">
                            <div class="result-box">
                                <div class="result-label">Principal Paid This Year</div>
                                <div class="result-value" id="summary-principal-paid">$0</div>
                            </div>
                            <div class="result-box accent">
                                <div class="result-label">Interest Paid This Year</div>
                                <div class="result-value" id="summary-interest-paid">$0</div>
                            </div>
                            <div class="result-box highlight">
                                <div class="result-label">Remaining Balance</div>
                                <div class="result-value" id="summary-remaining-balance">$0</div>
                            </div>
                        </div>
                        </div>

                    <div class="tab-content" id="amortization">
                        <div class="amortization-controls">
                            <button id="amortToggle" class="btn-secondary">Show Yearly</button>
                            <button id="exportCsv" class="btn-secondary">Export as CSV</button>
                        </div>
                        <div class="table-scroll-wrapper">
                            <table class="amortization-table">
                                <thead id="amortizationThead">
                                    </thead>
                                <tbody id="amortizationTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-content" id="insights">
                         <h3 class="results-heading">ü§ñ AI-Powered Insights</h3>
                        <div class="insights-container" id="insightsContainer">
                            <div class="insight-box">
                                <strong>ü§ñ AI Advisor:</strong> Enter your details to generate personalized insights...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section class="footer-sponsor" id="our-partners" style="margin-top: 40px; border-radius: 12px;">
            <div class="container">
                <h3 style="text-align: center; margin-bottom: 24px; color: var(--primary); font-size: 24px; font-weight: 700;">Our Partners</h3>
                <div class="sponsor-grid">
                    <div class="sponsor-item">
                        <h4>üí≥ Mortgage Pre-Approval</h4>
                        <p>Compare rates from top lenders. Get pre-approved in minutes. Save thousands on your home loan.</p>
                        <a href="#affiliate-link-1" onclick="alert('Partner: Mortgage Lender'); return false;">Get Quotes ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üõ°Ô∏è Home Insurance Quotes</h4>
                        <p>Compare insurance rates from major providers. Save up to 40% on coverage. Get instant quotes.</p>
                        <a href="#affiliate-link-2" onclick="alert('Partner: Insurance'); return false;">Compare Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üè† Home Equity (HELOC)</h4>
                        <p>Access your home's equity. Get quotes for HELOCs or cash-out refinancing. Informed decisions.</p>
                        <a href="#affiliate-link-3" onclick="alert('Partner: HELOC'); return false;">Check Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üîß Home Services</h4>
                        <p>Affordable plans for home warranties, repairs, and moving services. Protect your investment.</p>
                        <a href="#affiliate-link-4" onclick="alert('Partner: Services'); return false;">View Plans ‚Üí</a>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="faq-section">
            <h2 class="faq-title">‚ùì Frequently Asked Questions</h2>
            <div class="faq-container" id="faqContainer">
                </div>
        </section>

        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h4>About Mortgage Calculator</h4>
                        <a href="#how-it-works">How It Works</a>
                        <a href="#features">Features</a>
                        <a href="#faq">FAQ</a>
                        <a href="#contact">Contact Us</a>
                    </div>
                    <div class="footer-section">
                        <h4>Learn More</h4>
                        <a href="#piti">What is PITI?</a>
                        <a href="#amortization">Amortization Guide</a>
                        <a href="#rates">Current Rates</a>
                        <a href="#blog">Blog</a>
                    </div>
                    <div class="footer-section">
                        <h4>Resources</h4>
                        <a href="#calculators">Other Calculators</a>
                        <a href="#tools">Financial Tools</a>
                        <a href="#education">Education</a>
                        <a href="#glossary">Glossary</a>
                    </div>
                    <div class="footer-section">
                        <h4>Legal</h4>
                        <a href="#privacy">Privacy Policy</a>
                        <a href="#terms">Terms of Service</a>
                        <a href="#disclaimer">Disclaimer</a>
                        <a href="#affiliate">Affiliate Disclosure</a>
                    </div>
                </div>

                <div class="compliance-badges">
                    <span class="badge">üîí SSL Secured</span>
                    <span class="badge">‚úÖ GDPR Compliant</span>
                    <span class="badge">‚úÖ CCPA Compliant</span>
                    <span class="badge">‚úÖ FTC Compliant</span>
                    <span class="badge">‚ôø WCAG 2.1 AA</span>
                </div>

                <div class="disclaimer">
                    <strong>Educational & Informational Only:</strong> This mortgage calculator is for educational and informational purposes only. It is NOT financial advice. Actual mortgage rates, terms, and payments may vary significantly based on credit score, debt-to-income ratio, location, loan type, down payment percentage, credit history, employment status, and many other factors. Lenders may impose additional requirements or restrictions. Always consult with a qualified mortgage professional, financial advisor, or lender before making any borrowing decisions.
                    <br><br>
                    <strong>Affiliate Disclosure:</strong> FinGuid participates in affiliate programs with lending partners. When you click on partner links or apply for mortgage products through this calculator, FinGuid may receive compensation. This does not affect your rates or terms. We only recommend products we believe provide value to users.
                    <br><br>
    
                    <strong>Data Accuracy:</strong> Mortgage rates (MORTGAGE30US, MORTGAGE15US) provided by Freddie Mac. Treasury rates (DGS10) provided by the U.S. Treasury. All data delivered via FRED¬Æ API from the Federal Reserve Bank of St. Louis. Rates are updated regularly but we make no guarantees about accuracy. Always verify rates directly with lenders.
                    </div>

                <div class="footer-bottom">
                    ¬© 2025 FinGuid USA. All Rights Reserved. | AI-Powered Financial Tools for Americans
                </div>
            </div>
        </footer>
    </div>

    <!-- CDN Dependencies (from your HTML) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- 
      START: Inlined JavaScript
      Content from mortgage-calculator (4).js is pasted here.
    -->
    <script>
        /**
         * ========================================================================
         * HOME LOAN PRO - WORLD'S BEST AI-POWERED MORTGAGE CALCULATOR
         * ========================================================================
         * Version: 7.1 - PRODUCTION READY (Live ZIP Code Lookup)
         * Built with: SOLID Principles, WCAG 2.1 AA, PWA Compatible
         *
         * This file contains all logic from the provided 'mortgage-calculator (4).js'
         * It is fully functional and meets the requirements of 'tools scrept.docx'.
         * ========================================================================
         */

        // ===== APP STATE & CONSTANTS (KEEP THIS ID CONFIDENCAL) =====
        const FRED_API_KEY = '9c6c421f077f2091e8bae4f143ada59a';
        const FRED_URL = 'https://api.stlouisfed.org/fred/series/observations';
        const FRED_SERIES_IDS = {
            rate30: 'MORTGAGE30US', // 30-Year Fixed
            rate15: 'MORTGAGE15US', // 15-Year Fixed
            rate10: 'DGS10'           // 10-Year Treasury
        };

        // Fallback rates in case API fails
        const FALLBACK_RATES = {
            rates: { rate30: 6.85, rate15: 6.15, rate10: 4.50 },
            dates: { rate30: null, rate15: null, rate10: null },
        };

        // (All other constants like STATE_TAX_RATES, FAQs are preserved)
        const STATE_TAX_RATES = {
            AL: 0.41, AK: 1.19, AZ: 0.62, AR: 0.61, CA: 0.76, CO: 0.51, CT: 2.14,
            DE: 0.57, FL: 0.91, GA: 0.92, HI: 0.28, ID: 0.69, IL: 2.27, IN: 0.85,
            IA: 1.57, KS: 1.41, KY: 0.86, LA: 0.55, ME: 1.36, MD: 1.09, MA: 1.23,
            MI: 1.54, MN: 1.12, MS: 0.79, MO: 0.97, MT: 0.84, NE: 1.73, NV: 0.60,
            NH: 2.18, NJ: 2.49, NM: 0.80, NY: 1.72, NC: 0.84, ND: 0.98, OH: 1.56,
            OK: 0.90, OR: 0.97, PA: 1.58, RI: 1.63, SC: 0.57, SD: 1.31, TN: 0.71,
            TX: 1.80, UT: 0.58, VT: 1.90, VA: 0.82, WA: 0.94, WV: 0.58, WI: 1.85, WY: 0.61
        };

        // ===== REMOVED: ZIP_TO_STATE constant is no longer needed, using live API =====

        // ===== NEW: EXPANDED FAQs for SEO / Ranking (Preserved) =====
        const FAQs = [
            {
                q: "What is a mortgage calculator and how does it work?",
                a: "A mortgage calculator is an AI-powered tool that estimates your monthly home loan payment. It uses the loan amount (home price minus down payment), interest rate, and loan term to calculate the principal and interest (P&I). It then adds estimated property taxes, homeowners insurance, and PMI (if applicable) to show your full PITI payment."
            },
            {
                q: "What is PITI in a mortgage payment?",
                a: "PITI stands for **Principal, Interest, Taxes, and Insurance**. These are the four main components of your monthly mortgage payment. Principal reduces your loan balance, Interest is the cost of borrowing, and Taxes & Insurance are typically held in an escrow account by your lender and paid on your behalf."
            },
            {
                q: "How much house can I afford in 2025?",
                a: "A common rule of thumb is the **28/36 rule**. Lenders prefer your total housing payment (PITI + HOA) to be at or below **28%** of your gross monthly income. Your total debt payments (including mortgage, car loans, credit cards) should be at or below **36%** of your gross monthly income. Use this AI calculator to find your PITI, then compare it to your income."
            },
            {
                q: "What is a good mortgage rate today?",
                a: "Mortgage rates change daily. This calculator provides the latest available 30-year fixed, 15-year fixed, and 10-year Treasury rates from the FRED API, which updates daily. A 'good' rate depends on your credit score, down payment, loan type, and the current market. Rates below the national average are generally considered very good. Contact our partners to see what rate you qualify for."
            },
            {
                q: "How does my down payment affect my mortgage?",
                a: "A larger down payment reduces your loan amount, which lowers your monthly P&I payment. If you pay **20% or more**, you also avoid **PMI (Private Mortgage Insurance)**, which further reduces your monthly cost. This calculator's AI insights will show you the exact impact of your down payment."
            },
            {
                q: "What is PMI (Private Mortgage Insurance)?",
                a: "PMI is insurance that protects the lender in case you default on your loan. It is typically required on conventional loans if your down payment is less than 20%. Our calculator automatically estimates PMI if your LTV (Loan-to-Value) ratio is above 80%."
            },
            {
                q: "Should I choose a 15-year or 30-year mortgage?",
                a: "A **30-year** mortgage offers a lower monthly payment, making it more affordable. A **15-year** mortgage has a higher monthly payment but typically a lower interest rate. You will pay off the loan in half the time and save a significant amount in total interest. Our AI insights will show you the exact interest savings."
            },
            {
                q: "What is an amortization schedule?",
                a: "An amortization schedule (or table) is a complete breakdown of every payment over the life of your loan. It shows how much of each payment goes toward principal and how much goes toward interest. Use the 'Amortization' tab to see your full schedule, either monthly or yearly."
            },
            {
                q: "How do extra payments help pay off a mortgage early?",
                a: "When you make an extra payment, 100% of that money goes directly to your **principal balance** (not interest). This reduces your loan balance, meaning you pay less interest on the next payment, and every payment after. This 'accelerates' your payoff and can save you thousands. See your 'Interest Saved' in the Loan Summary."
            },
            {
                q: "What are FHA, VA, and USDA loans?",
                a: "These are government-backed loans. **FHA loans** are popular with first-time buyers due to low down payment requirements (as low as 3.5%) but require mortgage insurance. **VA loans** are for eligible veterans and service members, often requiring no down payment and no PMI. **USDA loans** are for rural and suburban homebuyers and also offer 0% down options."
            },
            {
                q: "What are closing costs?",
                a: "Closing costs are fees paid at the end of the home-buying process. They typically range from 2% to 5% of the home's purchase price and include appraisal fees, title insurance, attorney fees, and more. This calculator focuses on your ongoing PITI payment; be sure to budget separately for closing costs."
            },
            {
                q: "What is the difference between a fixed-rate and adjustable-rate mortgage (ARM)?",
                a: "A **fixed-rate** mortgage has the same interest rate for the entire loan term (e.g., 30 years). Your P&I payment never changes. An **ARM** has a lower 'introductory' rate for a set period (e.g., 5 or 7 years), after which the rate adjusts based on the market. ARMs can be risky if rates rise."
            },
            {
                q: "How do I get pre-approved for a mortgage?",
                a: "To get pre-approved, you'll provide a lender with your financial information (income, assets, debts) and they will check your credit. If you qualify, they'll give you a pre-approval letter stating how much you can borrow. This shows sellers you are a serious buyer. You can start the process by 'Viewing Partners' on our site."
            },
            // --- (All 15+ additional preserved FAQs are included below) ---
            {
                q: "What is a PITI calculator?",
                a: "A PITI calculator is another name for a mortgage calculator that includes all four components of a typical payment: **P**rincipal, **I**nterest, **T**axes, and **I**nsurance. This tool is a PITI calculator, and it also includes HOA fees for a complete estimate."
            },
            {
                q: "How is mortgage interest calculated?",
                a: "Mortgage interest is typically calculated monthly based on your outstanding loan balance. At the beginning of your loan, most of your payment goes to interest. As you pay down the principal, the interest portion decreases. You can see this in the 'Amortization' tab."
            },
            {
                q: "What is a good down payment for a house in 2025?",
                a: "Putting down 20% of the home's purchase price is ideal as it allows you to avoid PMI. However, many programs, like FHA loans, allow for down payments as low as 3.5%. The 'best' down payment depends on your savings and financial goals."
            },
            {
                q: "Does this mortgage payment calculator include property taxes?",
                a: "Yes. You can enter your annual property tax, or use our 'Lookup' feature to estimate property taxes based on your ZIP code and home price. This is a critical part of your total PITI payment."
            },
            {
                q: "How does this home loan calculator handle HOA fees?",
                a: "This calculator includes a specific field for monthly **HOA (Homeowners Association) fees**. These fees are added to your total monthly payment, as they are a required housing expense, but they do not affect your loan balance."
            },
            {
                q: "Can I use this as a refinance calculator?",
                a: "Yes. To use this as a refinance calculator, enter your current loan balance as the 'Home Purchase Price' and '0' for the 'Down Payment'. Then, enter your new (or potential) interest rate and term to see your new estimated P&I payment."
            },
            {
                q: "What is the mortgage 'principal'?",
                a: "The principal is the amount of money you borrowed from the lender to buy your home (Loan Amount). Each month, a portion of your payment goes towards reducing this principal balance."
            },
            {
                q: "What is Loan-to-Value (LTV) ratio?",
                a: "LTV is the ratio of your loan amount to the home's appraised value. For example, if your home is worth $100,000 and you borrow $80,000, your LTV is 80%. Lenders use LTV to assess risk. An LTV over 80% typically requires PMI."
            },
            {
                q: "How can I pay off my mortgage early?",
                a: "You can pay off your mortgage early by making extra payments. This calculator allows you to add an 'Extra Monthly Payment' or an 'Extra One-Time Payment'. Both methods apply directly to your principal, saving you interest and shortening your loan term."
            },
            {
                q: "What is mortgage amortization?",
                a: "Amortization is the process of paying off a loan over time with regular, scheduled payments. An amortization schedule, like the one in this calculator, shows how each payment is split between principal and interest."
            },
            {
                q: "What is a conventional loan?",
                a: "A conventional loan is a mortgage not insured or guaranteed by the federal government (like FHA, VA, or USDA loans). They often require a higher credit score and a down payment of 3% to 20%."
            },
            {
                q: "What are 'points' on a mortgage?",
                a: "Mortgage points (or 'discount points') are fees you pay to the lender at closing in exchange for a lower interest rate. One point typically costs 1% of your loan amount and might lower your rate by 0.25%."
            },
            {
                q: "What is a jumbo loan?",
                a: "A jumbo loan is a mortgage that exceeds the 'conforming loan limits' set by the Federal Housing Finance Agency (FHFA). These limits vary by county. Jumbo loans are used for high-value properties and often have different underwriting requirements."
            },
            {
                q: "Does this calculator work for bi-weekly mortgage payments?",
                a: "This calculator is designed for monthly payments. However, you can simulate a bi-weekly payment's effect by taking your monthly P&I payment, dividing it by 12, and adding that amount to the 'Extra Monthly Payment' field. (A true bi-weekly plan results in 13 full payments per year)."
            },
            {
                q: "What is an escrow account?",
                a: "An escrow account is set up by your mortgage lender to pay for property taxes and homeowners insurance on your behalf. A portion of your total monthly payment (the 'T' and 'I' in PITI) is deposited into this account."
            },
            {
                q: "Is a fixed-rate or adjustable-rate mortgage (ARM) better?",
                a: "A **fixed-rate** mortgage is stable and predictable; your P&I payment never changes. An **ARM** offers a lower introductory rate but can increase (or decrease) after a set period. A fixed-rate is generally safer for long-term homeowners, while an ARM might be suitable if you plan to sell the home before the fixed period ends."
            }
        ];

        // ===== CALCULATOR ENGINE (Preserved) =====
        class MortgageCalculator {
            constructor(inputs) {
                this.inputs = inputs;
                this.results = {};
                this.amortizationSchedule = [];
            }

            // --- (Preserved) ---
            static calculatePayment(principal, rate, numPayments) {
                let payment = 0;
                if (principal > 0 && rate > 0) {
                    payment = principal * (rate * Math.pow(1 + rate, numPayments)) / 
                              (Math.pow(1 + rate, numPayments) - 1);
                } else if (principal > 0 && numPayments > 0) {
                    payment = principal / numPayments;
                }
                return payment;
            }

            calculate() {
                try {
                    this.calculateMonthlyPayment();
                    this.calculatePMI();
                    this.generateAmortizationSchedule(); 
                    this.calculateTotals(); 
                    return this.results;
                } catch (error) {
                    console.error('Calculation error:', error);
                    return null;
                }
            }

            calculateMonthlyPayment() {
                const homePrice = parseFloat(this.inputs.homePrice) || 0;
                const downPaymentVal = parseFloat(this.inputs.downPayment) || 0;

                const principal = homePrice - downPaymentVal;
                const rate = (parseFloat(this.inputs.interestRate) || 0) / 100 / 12;
                const numPayments = this.getTotalPayments();

                let payment = MortgageCalculator.calculatePayment(principal, rate, numPayments);

                const monthlyTax = (parseFloat(this.inputs.propertyTax) || 0) / 12;
                const monthlyInsurance = (parseFloat(this.inputs.homeInsurance) || 0) / 12;
                const hoaFees = parseFloat(this.inputs.hoaFees) || 0;

                this.results.loanAmount = principal;
                this.results.monthlyPI = payment;
                this.results.monthlyTax = monthlyTax;
                this.results.monthlyInsurance = monthlyInsurance;
                this.results.monthlyHOA = hoaFees;
                this.results.monthlyPayment = payment + monthlyTax + monthlyInsurance + hoaFees;
                this.results.downPaymentAmount = downPaymentVal;
                this.results.homePrice = homePrice;
            }

            calculatePMI() {
                const ltv = (this.results.homePrice > 0) ? (this.results.loanAmount / this.results.homePrice) * 100 : 0;
                this.results.ltv = ltv;

                if (ltv > 80 && this.results.loanAmount > 0) {
                    const pmiRate = 0.005; // 0.5% annual
                    const monthlyPMI = (this.results.loanAmount * pmiRate) / 12;
                    this.results.monthlyPMI = monthlyPMI;
                    this.results.monthlyPayment += monthlyPMI;
                    this.results.pmiRequired = true;
                } else {
                    this.results.monthlyPMI = 0;
                    this.results.pmiRequired = false;
                }
            }

            generateAmortizationSchedule(baseline = false) {
                const numPayments = this.getTotalPayments();
                const rate = (parseFloat(this.inputs.interestRate) || 0) / 100 / 12;
                let balance = this.results.loanAmount;
                
                const extraMonthly = baseline ? 0 : (parseFloat(this.inputs.extraMonthly) || 0);
                const extraOneTime = baseline ? 0 : (parseFloat(this.inputs.extraOneTime) || 0);
                
                const basePayment = this.results.monthlyPI;

                const schedule = [];
                let totalInterest = 0;
                let totalPrincipal = 0;
                let totalExtra = 0;

                for (let i = 1; i <= numPayments; i++) {
                    if (balance <= 0.01) break; 

                    const interestPayment = balance * rate;
                    let principalPayment = basePayment - interestPayment;
                    
                    let extraPay = extraMonthly;

                    // Apply one-time payment on month 1
                    if (i === 1 && extraOneTime > 0) {
                         extraPay += extraOneTime;
                    }

                    let totalPrincipalPaid = principalPayment + extraPay;
                    
                    if ((balance - totalPrincipalPaid) < 0) {
                        totalPrincipalPaid = balance;
                        principalPayment = totalPrincipalPaid - extraPay;
                        if (principalPayment < 0) {
                             extraPay = totalPrincipalPaid;
                             principalPayment = 0;
                        }
                    }
                    
                    if(balance < (basePayment + extraPay)) {
                        principalPayment = balance;
                        extraPay = 0; 
                        totalPrincipalPaid = principalPayment;
                        balance = 0;
                    } else {
                        balance -= totalPrincipalPaid;
                    }

                    totalInterest += interestPayment;
                    totalPrincipal += principalPayment;
                    totalExtra += extraPay;

                    schedule.push({
                        payment: i,
                        principal: principalPayment,
                        interest: interestPayment,
                        extra: extraPay,
                        balance: balance
                    });

                    if (balance <= 0.01) break;
                }

                if (!baseline) {
                    this.amortizationSchedule = schedule;
                    this.results.totalInterest = totalInterest;
                    this.results.totalPrincipal = totalPrincipal;
                    this.results.totalExtra = totalExtra;
                    this.results.actualPayments = schedule.length;
                }
                
                return {
                    totalInterest: totalInterest,
                    actualPayments: schedule.length,
                    totalPrincipal: totalPrincipal
                };
            }

            calculateTotals() {
                const actualTotalInterest = this.results.totalInterest;
                const actualPayments = this.results.actualPayments;

                const baselineResults = this.generateAmortizationSchedule(true);
                const baselineTotalInterest = baselineResults.totalInterest;
                const baselinePayments = baselineResults.actualPayments;
                
                this.results.interestSaved = baselineTotalInterest - actualTotalInterest;
                this.results.payoffAccel = baselinePayments - actualPayments; // in months
                this.results.baselineTotalInterest = baselineTotalInterest;

                const totalTax = (this.results.monthlyTax * actualPayments);
                const totalIns = (this.results.monthlyInsurance * actualPayments);
                const totalPMI = (this.results.monthlyPMI * actualPayments); 
                const totalHOA = (this.results.monthlyHOA * actualPayments);
                
                this.results.totalPayments = this.results.loanAmount + actualTotalInterest + totalTax + totalIns + totalPMI + totalHOA;
            
                let firstYearInterest = 0;
                let firstYearPrincipal = 0;
                const yearSlice = this.amortizationSchedule.slice(0, 12);
                yearSlice.forEach(row => {
                    firstYearInterest += row.interest;
                    firstYearPrincipal += row.principal + row.extra;
                });
                this.results.firstYearInterest = firstYearInterest;
                this.results.firstYearPrincipal = firstYearPrincipal;
            }

            getTotalPayments() {
                const customTerm = parseFloat(document.getElementById('customTerm').value);
                const loanTerm = customTerm > 0 ? customTerm : parseFloat(document.getElementById('loanTerm').value) || 30;
                return loanTerm * 12;
            }
        }

        // ===== AI INSIGHTS ENGINE (Preserved) =====
        class AIInsightEngine {
            constructor(results, inputs) {
                this.results = results;
                this.inputs = inputs;
            }
            
            generateInsights() {
                const insights = [];
                const { monthlyPayment, pmiRequired, monthlyPMI, interestSaved, payoffAccel, ltv, loanAmount, homePrice, monthlyPI, monthlyTax, monthlyInsurance, firstYearInterest, firstYearPrincipal, baselineTotalInterest } = this.results;
                const { extraMonthly, extraOneTime, interestRate, hoaFees, loanTerm } = this.inputs;
                const fmtd = UIManager.formatCurrency; // Helper

                if (!monthlyPayment || monthlyPayment <= 0) {
                     insights.push({
                        title: "ü§ñ AI Advisor",
                        text: `Enter your loan details to generate personalized insights and see your affordability.`,
                        type: 'info'
                    });
                    return insights;
                }

                // Insight 1: Affordability (General)
                insights.push({
                    title: "üí∞ Monthly Payment Affordability",
                    text: `Your estimated PITI + HOA payment is ${fmtd(monthlyPayment, 2)}. As a guideline, lenders often want this to be under 28% of your gross monthly income.`,
                    type: monthlyPayment > 3000 ? 'warning' : 'success'
                });

                // Insight 2 (PMI)
                if (pmiRequired) {
                     let pmiText = `Your LTV is ${ltv.toFixed(1)}% (over 80%), so you'll pay an estimated ${fmtd(monthlyPMI, 2)}/mo for PMI.`;
                     const neededFor20 = (homePrice * 0.2) - this.results.downPaymentAmount;
                     if (ltv < 85 && neededFor20 > 0) { 
                        pmiText += ` **AI Tip:** You only need ${fmtd(neededFor20, 0)} more on your down payment to reach 20% LTV and eliminate this PMI cost entirely.`;
                     } else {
                        pmiText += ` AI suggests increasing your down payment to 20% (${fmtd(homePrice * 0.2, 0)}) to eliminate this cost.`;
                     }
                     insights.push({ title: "üè† PMI Required", text: pmiText, type: 'warning' });
                } else if (ltv <= 80 && ltv > 0) {
                     insights.push({
                        title: "‚úÖ No PMI Required",
                        text: `Great job! Your LTV is ${ltv.toFixed(1)}%, so you avoid paying for Private Mortgage Insurance (PMI). This saves you money every month.`,
                        type: 'success'
                    });
                }
                
                // Insight 3: LTV Rating
                if (ltv > 0) {
                    let ltvText = `Your ${ltv.toFixed(1)}% LTV (Loan-to-Value) ratio is considered`;
                    if (ltv <= 80) {
                        ltvText += ` **Excellent**. This gives you access to the best rates and avoids PMI.`;
                        insights.push({ title: "üìä LTV Rating: Excellent", text: ltvText, type: 'success' });
                    } else if (ltv <= 90) {
                        ltvText += ` **Good**. This is common for many buyers. You can request to remove PMI once your LTV drops to 80%.`;
                        insights.push({ title: "üìä LTV Rating: Good", text: ltvText, type: 'info' });
                    } else {
                        ltvText += ` **High**. This may lead to higher interest rates and PMI. AI suggests increasing your down payment if possible.`;
                        insights.push({ title: "üìä LTV Rating: High", text: ltvText, type: 'warning' });
                    }
                }

                // Insight 4: Extra Payment Impact
                if (interestSaved > 0) {
                    insights.push({
                        title: "üíµ Extra Payment Impact",
                        text: `Your extra payments will save ${fmtd(interestSaved, 0)} in interest and you'll pay off your loan ${payoffAccel} months earlier. This is a powerful wealth-building strategy.`,
                        type: 'success'
                    });
                }
                
                // Insight 5: Round Up Tip
                if (extraMonthly <= 0 && extraOneTime <= 0 && monthlyPI > 0) {
                    const roundedPayment = Math.ceil(monthlyPI / 50) * 50;
                    const extra = roundedPayment - monthlyPI;
                    if (extra > 5) { 
                        const shadowInputs = {...this.inputs, extraMonthly: extra};
                        const shadowCalc = new MortgageCalculator(shadowInputs);
                        const shadowResults = shadowCalc.calculate();
                        if(shadowResults && shadowResults.interestSaved > 0) {
                            insights.push({
                                title: "üí° AI Payoff Tip: 'Round Up'",
                                text: `Consider "rounding up" your P&I payment from ${fmtd(monthlyPI, 2)} to ${fmtd(roundedPayment, 2)}. That extra ${fmtd(extra, 2)}/mo would save you ${fmtd(shadowResults.interestSaved, 0)} in interest and pay off your loan ${shadowResults.payoffAccel} months earlier!`,
                                type: 'info'
                            });
                        }
                    }
                }

                // Insight 6: First Year Interest
                if (firstYearInterest > 0 && firstYearPrincipal > 0) {
                    const interestPercent = (firstYearInterest / (firstYearInterest + firstYearPrincipal)) * 100;
                    insights.push({
                        title: "üí∏ First-Year Interest",
                        text: `In your first 12 months, you will pay ${fmtd(firstYearInterest, 2)} in interest and only ${fmtd(firstYearPrincipal, 2)} in principal. That means **${interestPercent.toFixed(0)}%** of your payments go to the bank, not your equity. This is normal, but extra payments can change this!`,
                        type: 'info'
                    });
                }

                // Insight 7: High Interest Rate
                if (interestRate >= 7.5) {
                     insights.push({
                        title: "üìà High Interest Rate",
                        text: `Your interest rate of ${interestRate}% is high. This significantly increases your total interest paid. AI suggests checking your credit score and comparing quotes from our partners to find a more competitive rate.`,
                        type: 'warning'
                    });
                }
                
                // Insight 8: Refinance Potential
                if (interestRate >= 6.0) {
                    const newRate = (Math.floor(interestRate - 1));
                    const newRateMonthly = (parseFloat(interestRate) - 1) / 100 / 12;
                    const numPayments = (parseFloat(loanTerm) || 30) * 12;
                    const newPI = MortgageCalculator.calculatePayment(loanAmount, newRateMonthly, numPayments);
                    const savings = monthlyPI - newPI;
                    if (savings > 50) {
                         insights.push({
                            title: "üîÆ AI Refinance Potential",
                            text: `If market rates drop in the future, keep an eye on refinancing. For example, if you could get a rate of ${newRate.toFixed(1)}%, you could potentially lower your P&I payment by ${fmtd(savings, 0)}/mo.`,
                            type: 'info'
                        });
                    }
                }

                // Insight 9: 15-year vs 30-year
                const currentTerm = parseFloat(loanTerm) || 30;
                
                if (currentTerm === 30) {
                    const term15 = 15 * 12;
                    const rate15 = (parseFloat(interestRate) - 0.5) / 100 / 12; // 15-yr is usually lower
                    const payment15 = MortgageCalculator.calculatePayment(loanAmount, rate15, term15);
                    const totalInterest30 = baselineTotalInterest; 
                    const totalInterest15 = (payment15 * term15) - loanAmount;
                    const interestSaved = totalInterest30 - totalInterest15;
                    
                     insights.push({
                        title: "‚öñÔ∏è 30-Year vs. 15-Year",
                        text: `Your 30-year P&I is ${fmtd(monthlyPI, 2)}. A 15-year loan at a ~${(rate15*12*100).toFixed(2)}% rate would have a higher payment of ${fmtd(payment15, 2)}, but it would save you an incredible ${fmtd(interestSaved, 0)} in total interest.`,
                        type: 'info'
                    });
                } else if (currentTerm === 15) {
                    const term30 = 30 * 12;
                    const rate30 = (parseFloat(interestRate) + 0.5) / 100 / 12; // 30-yr is usually higher
                    const payment30 = MortgageCalculator.calculatePayment(loanAmount, rate30, term30);
                    
                     insights.push({
                        title: "üöÄ 15-Year Loan",
                        text: `You've selected a 15-year term. Your payment is ${fmtd(monthlyPI, 2)}, putting you on the fast track to building equity. A 30-year loan would be lower at ${fmtd(payment30, 2)}, but you're saving thousands in interest.`,
                        type: 'success'
                    });
                }
                
                // Insight 10: Escrow Ratio
                const escrow = monthlyTax + monthlyInsurance;
                const escrowPercent = (monthlyPayment > 0) ? (escrow / monthlyPayment) * 100 : 0;
                if (escrowPercent > 33) {
                     insights.push({
                        title: "üìä High Escrow Costs",
                        text: `Your monthly taxes and insurance (${fmtd(escrow, 2)}) make up ${escrowPercent.toFixed(0)}% of your total payment. While property taxes are fixed, remember to shop around for homeowners insurance annually to save money.`,
                        type: 'info'
                    });
                }
                
                // Insight 11: HOA Fee
                if (hoaFees > 0) {
                     insights.push({
                        title: "üè¢ HOA Fee",
                        text: `Your ${fmtd(parseFloat(hoaFees), 2)}/mo HOA fee adds to your total housing cost. Remember this payment does not build equity and can increase over time. Factor this in when comparing properties.`,
                        type: 'info'
                    });
                }

                return insights;
            }
        }

        // ===== ZIP CODE MANAGER (Modified) =====
        class ZipCodeManager {
            
            // --- NEW: Fetches location data from a free ZIP API ---
            static async lookupZipInfo(zip) {
                try {
                    const response = await fetch(`https://api.zippopotam.us/us/${zip}`);
                    if (!response.ok) {
                        if (response.status === 404) return { error: 'Invalid ZIP code.' };
                        throw new Error('ZIP API request failed');
                    }
                    const data = await response.json();
                    if (!data || !data.places || data.places.length === 0) {
                        return { error: 'Invalid ZIP code data.' };
                    }
                    const place = data.places[0];
                    return {
                        city: place['place name'],
                        state: place['state'],
                        stateAbbr: place['state abbreviation'],
                        error: null
                    };
                } catch (error) {
                    console.error('ZIP lookup error:', error);
                    return { error: 'Could not fetch location. Check connection.' };
                }
            }

            static getTaxRateByState(state) {
                return STATE_TAX_RATES[state] || 0.85; // Default national average
            }

            // --- MODIFIED: Now takes stateAbbr from the API, not zip ---
            static estimateTaxAndInsurance(homePrice, stateAbbr) {
                if (!stateAbbr) return null;
                const taxRate = this.getTaxRateByState(stateAbbr); // Uses the existing STATE_TAX_RATES constant
                const annualTax = (homePrice * taxRate) / 100;
                const annualInsurance = homePrice * 0.0035; // ~0.35% of home value
                return { annualTax, annualInsurance, state: stateAbbr };
            }
        }

        // ===== NEW: IMPROVED FRED API MANAGER (Preserved) =====
        class FREDManager {
            
            /**
             * Helper to get the current time in ET and check against the 4:45 PM cutoff.
             */
            static getEasternTimeInfo() {
                const now = new Date();
                // Get current time in 'America/New_York' (ET)
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const parts = etFormatter.formatToParts(now).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const currentETDate = `${parts.year}-${parts.month.padStart(2, '0')}-${parts.day.padStart(2, '0')}`;
                const currentETHour = parseInt(parts.hour, 10);
                const currentETMinute = parseInt(parts.minute, 10);
                
                // 4:45 PM ET is 16:45
                const isAfterCutoff = (currentETHour > 16) || (currentETHour === 16 && currentETMinute >= 45);

                return { currentETDate, isAfterCutoff, now };
            }

            /**
             * Checks if the cache is valid based on the 4:45 PM ET update time.
             */
            static isCacheValid(cache) {
                const { lastFetch } = cache;
                if (!lastFetch) return false;

                const { currentETDate, isAfterCutoff } = this.getEasternTimeInfo();

                // Get last fetch time in ET
                const lastFetchDate = new Date(lastFetch);
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const lastFetchParts = etFormatter.formatToParts(lastFetchDate).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const lastFetchETDate = `${lastFetchParts.year}-${lastFetchParts.month.padStart(2, '0')}-${lastFetchParts.day.padStart(2, '0')}`;
                const lastFetchHour = parseInt(lastFetchParts.hour, 10);
                const lastFetchMinute = parseInt(lastFetchParts.minute, 10);
                const wasLastFetchAfterCutoff = (lastFetchHour > 16) || (lastFetchHour === 16 && lastFetchMinute >= 45);

                // --- The Caching Logic ---
                // 1. If the current ET date is NOT the same as the last fetch ET date...
                if (currentETDate !== lastFetchETDate) {
                    // 1a. ... and it's currently AFTER the cutoff, the cache is STALE (we need today's new data).
                    if (isAfterCutoff) {
                        return false; 
                    }
                    // 1b. ... and it's currently BEFORE the cutoff, the cache is STALE (we need *yesterday's* data, which the last fetch might be, but we'll refresh to be sure).
                    // A simpler rule: if dates don't match, refresh *unless* it's a new day before the cutoff AND the last fetch was after the cutoff (meaning it's the latest data).
                    if (wasLastFetchAfterCutoff) {
                        return true; // Last fetch was after cutoff, so it's the latest data until today's cutoff
                    }
                    return false;
                }

                // 2. If the current ET date IS the same as the last fetch ET date...
                // 2a. ... and the last fetch was BEFORE the cutoff, but it is now AFTER the cutoff, the cache is STALE.
                if (!wasLastFetchAfterCutoff && isAfterCutoff) {
                    return false;
                }

                // 3. In all other cases, the cache is VALID.
                // (e.g., same day, both before cutoff; same day, both after cutoff)
                return true;
            }

            /**
             * Formats the timestamp for display.
             */
            static formatTimestamp(now) {
                return new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    dateStyle: 'short',
                    timeStyle: 'short'
                }).format(now) + " ET";
            }

            /**
             * Fetches a single FRED series.
             */
            static async fetchFredSeries(seriesId) {
                try {
                    const url = `${FRED_URL}?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json&sort_order=desc&limit=1`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`FRED API request failed for ${seriesId}: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.observations && data.observations.length > 0) {
                        const rate = parseFloat(data.observations[0].value);
                        const date = data.observations[0].date;
                        if (isNaN(rate)) return { rate: null, date: null }; // Handle '.' or invalid values
                        return { rate, date };
                    }
                } catch (error) {
                    console.error(error);
                }
                return { rate: null, date: null }; // Fallback for this series
            }

            /**
             * Main function to get all 3 rates, using cache if valid.
             */
            static async getRates() {
                const cacheStr = localStorage.getItem('fredRatesCache');
                let cache = cacheStr ? JSON.parse(cacheStr) : null;
                
                const { now } = this.getEasternTimeInfo();

                if (cache && this.isCacheValid(cache)) {
                    console.log('Using cached FRED rates');
                    return {
                        ...cache,
                        isCache: true,
                        lastUpdatedTimestamp: `Rates as of ${this.formatTimestamp(new Date(cache.lastFetch))}`
                    };
                }

                console.log('Fetching new FRED rates');
                
                // Fetch all 3 series concurrently
                const [data30, data15, data10] = await Promise.all([
                    this.fetchFredSeries(FRED_SERIES_IDS.rate30),
                    this.fetchFredSeries(FRED_SERIES_IDS.rate15),
                    this.fetchFredSeries(FRED_SERIES_IDS.rate10)
                ]);

                const newRates = {
                    rate30: data30.rate || FALLBACK_RATES.rates.rate30,
                    rate15: data15.rate || FALLBACK_RATES.rates.rate15,
                    rate10: data10.rate || FALLBACK_RATES.rates.rate10,
                };

                const newDates = {
                    date30: data30.date || null,
                    date15: data15.date || null,
                    date10: data10.date || null,
                };

                const newCache = {
                    rates: newRates,
                    dates: newDates,
                    lastFetch: now.toISOString()
                };

                localStorage.setItem('fredRatesCache', JSON.stringify(newCache));

                return {
                    ...newCache,
                    isCache: false,
                    lastUpdatedTimestamp: `Live Rates updated: ${this.formatTimestamp(now)}`
                };
            }
        }

        // ===== UI MANAGER (Preserved) =====
        class UIManager {
            static formatCurrency(value, decimals = 0) {
                if (typeof value !== 'number' || isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(value);
            }
            static formatPercent(value) { return (value).toFixed(1) + '%'; } 

            static updateResults(results) {
                 document.getElementById('monthly-payment').textContent = this.formatCurrency(results.monthlyPayment, 2);
                 const breakdownStr = `P&I: ${this.formatCurrency(results.monthlyPI, 2)} | Tax: ${this.formatCurrency(results.monthlyTax, 2)} | Ins: ${this.formatCurrency(results.monthlyInsurance, 2)} | PMI: ${this.formatCurrency(results.monthlyPMI, 2)} | HOA: ${this.formatCurrency(results.monthlyHOA, 2)}`;
                 document.getElementById('payment-breakdown').textContent = breakdownStr;
                 document.getElementById('loanAmount').textContent = this.formatCurrency(results.loanAmount);
                 document.getElementById('totalInterest').textContent = this.formatCurrency(results.totalInterest);
                 document.getElementById('totalPayments').textContent = this.formatCurrency(results.totalPayments);
                 document.getElementById('ltv').textContent = this.formatPercent(results.ltv);
                 document.getElementById('monthlyPI').textContent = this.formatCurrency(results.monthlyPI, 2);
                 document.getElementById('monthlyHOA').textContent = this.formatCurrency(results.monthlyHOA, 2);
                 document.getElementById('pmiStatus').textContent = results.pmiRequired ? 'Required' : 'Not Required';
                 document.getElementById('interestSaved').textContent = this.formatCurrency(results.interestSaved);
                 document.getElementById('payoffAccel').textContent = `${results.payoffAccel} months`;
                 
                 document.getElementById('pmiStatusBox').className = results.pmiRequired ? 'result-box accent' : 'result-box';
                 document.getElementById('interestSavedBox').style.display = results.interestSaved > 0 ? 'block' : 'none';
                 document.getElementById('payoffAccelBox').style.display = results.payoffAccel > 0 ? 'block' : 'none';
            }

            static updateAmortizationTable(schedule, view = 'monthly') {
                const thead = document.getElementById('amortizationThead');
                const tbody = document.getElementById('amortizationTable');
                tbody.innerHTML = '';
                thead.innerHTML = '';

                if (!schedule || schedule.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 12px; text-align: center; color: var(--text-light);">No schedule to display.</td></tr>';
                    return;
                }

                if (view === 'monthly') {
                    thead.innerHTML = `
                        <tr>
                            <th>Month</th>
                            <th>Total Payment</th>
                            <th>Principal</th>
                            <th>Interest</th>
                            <th>Extra Payment</th>
                            <th>Balance</th>
                        </tr>
                    `;
                    const rowsToShow = schedule.length > 120 ? 120 : schedule.length;
                    for (let i = 0; i < rowsToShow; i++) {
                        tbody.appendChild(this.createAmortRow(schedule[i]));
                    }
                    if (schedule.length > 120) {
                         tbody.innerHTML += `<tr><td colspan="6" style="text-align: center; padding: 10px; background: var(--bg-secondary); font-weight: bold;">...</td></tr>`;
                         tbody.appendChild(this.createAmortRow(schedule[schedule.length - 1]));
                    }
                } else { // Yearly view
                    thead.innerHTML = `
                        <tr>
                            <th>Year</th>
                            <th>Total Paid</th>
                            <th>Principal Paid</th>
                            <th>Interest Paid</th>
                            <th>Extra Paid</th>
                            <th>Ending Balance</th>
                        </tr>
                    `;
                    let yearlyData = [];
                    for (let y = 0; y < schedule.length / 12; y++) {
                        const yearSlice = schedule.slice(y * 12, (y + 1) * 12);
                        if (yearSlice.length === 0) continue;

                        const yearSummary = yearSlice.reduce((acc, row) => {
                            acc.principal += row.principal;
                            acc.interest += row.interest;
                            acc.extra += row.extra;
                            return acc;
                        }, { payment: y + 1, principal: 0, interest: 0, extra: 0, balance: yearSlice[yearSlice.length - 1].balance });
                        
                        tbody.appendChild(this.createAmortRow(yearSummary, 'yearly'));
                    }
                }
            }
            
            static createAmortRow(row, view = 'monthly') {
                const tr = document.createElement('tr');
                const totalPayment = row.principal + row.interest + row.extra;
                if (view === 'monthly') {
                    tr.innerHTML = `
                        <td>${row.payment}</td>
                        <td>${this.formatCurrency(totalPayment, 2)}</td>
                        <td>${this.formatCurrency(row.principal, 2)}</td>
                        <td>${this.formatCurrency(row.interest, 2)}</td>
                        <td>${this.formatCurrency(row.extra, 2)}</td>
                        <td>${this.formatCurrency(row.balance, 2)}</td>
                    `;
                } else { // Yearly
                     tr.innerHTML = `
                        <td>${row.payment}</td>
                        <td>${this.formatCurrency(totalPayment, 2)}</td>
                        <td>${this.formatCurrency(row.principal, 2)}</td>
                        <td>${this.formatCurrency(row.interest, 2)}</td>
                        <td>${this.formatCurrency(row.extra, 2)}</td>
                        <td>${this.formatCurrency(row.balance, 2)}</td>
                    `;
                }
                return tr;
            }

            static updateInsights(insights) {
                const container = document.getElementById('insightsContainer');
                container.innerHTML = '';
                if(!insights || insights.length === 0) {
                     container.innerHTML = '<div class="insight-box"><strong>ü§ñ AI Advisor:</strong> Enter valid loan details to generate personalized insights...</div>';
                     return;
                }
                insights.forEach(insight => {
                    const box = document.createElement('div');
                    box.className = `insight-box ${insight.type}`;
                    box.innerHTML = `<strong>${insight.title}:</strong> ${insight.text}`;
                    container.appendChild(box);
                });
            }
        }

        // ===== CHART MANAGER (Preserved) =====
        class ChartManager {
            static charts = {};

            static registerPlugins() {
                if (Chart.registerables) { 
                    if (typeof ChartDataLabels !== 'undefined') {
                        Chart.register(ChartDataLabels);
                    }
                }
            }

            static renderPaymentBreakdownChart(results) {
                const ctx = document.getElementById('paymentBreakdownChart').getContext('2d');
                if (!ctx) return;
                if (this.charts.paymentBreakdown) this.charts.paymentBreakdown.destroy();
                
                const data = [
                    results.monthlyPI,
                    results.monthlyTax,
                    results.monthlyInsurance,
                    results.monthlyPMI,
                    results.monthlyHOA
                ];
                const total = data.reduce((a, b) => a + b, 0);
                const allZero = total === 0;

                this.charts.paymentBreakdown = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['P&I', 'Tax', 'Insurance', 'PMI', 'HOA'],
                        datasets: [{
                            data: allZero ? [1] : data, 
                            backgroundColor: allZero ? ['#E2E8F0'] : ['#24ACB9', '#FFC107', '#10B981', '#EF4444', '#3B82F6'], // Brand colors
                            borderColor: 'var(--card)',
                            borderWidth: 3, 
                            hoverOffset: 10 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    color: 'var(--text-light)', 
                                    font: { size: 13 } 
                                } 
                            },
                            datalabels: {
                                display: (context) => {
                                    const value = context.dataset.data[context.dataIndex];
                                    return !allZero && (value / total) > 0.05; // Only show for slices > 5%
                                },
                                color: '#fff',
                                font: { weight: 'bold', size: 12 },
                                formatter: (value) => {
                                    return ((value / total) * 100).toFixed(0) + '%';
                                }
                            },
                            tooltip: {
                                 callbacks: {
                                    label: function(context) {
                                        if(allZero) return ' No data';
                                        let label = context.label || '';
                                        let value = context.raw;
                                        let percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${UIManager.formatCurrency(value, 2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            static renderMortgageOverTimeChart(schedule) {
                const ctx = document.getElementById('mortgageOverTimeChart').getContext('2d');
                if (!ctx) return;
                if (this.charts.mortgageOverTime) this.charts.mortgageOverTime.destroy();
                if(!schedule || schedule.length === 0) return;

                const years = Math.ceil(schedule.length / 12);
                const yearlyLabels = [];
                const yearlyData = []; // Store full data for summary
                
                for (let y = 0; y < years; y++) {
                    const yearSlice = schedule.slice(y * 12, (y + 1) * 12);
                    if(yearSlice.length === 0) continue;
                    
                    const yearInterest = yearSlice.reduce((acc, row) => acc + row.interest, 0);
                    const yearPrincipal = yearSlice.reduce((acc, row) => acc + row.principal + row.extra, 0);
                    const yearBalance = yearSlice[yearSlice.length - 1].balance;

                    yearlyLabels.push(`Year ${y + 1}`);
                    yearlyData.push({
                        label: `Year ${y + 1}`,
                        interest: yearInterest,
                        principal: yearPrincipal,
                        balance: yearBalance
                    });
                }
                
                app.lastYearlyData = yearlyData;

                this.charts.mortgageOverTime = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: yearlyLabels,
                        datasets: [
                            {
                                label: 'Yearly Interest Paid',
                                data: yearlyData.map(d => d.interest),
                                backgroundColor: 'rgba(36, 172, 185, 0.2)', // Brand Primary (Teal)
                                borderColor: 'rgba(36, 172, 185, 1)',
                                fill: 'start',
                                type: 'bar', 
                                order: 2
                            },
                            {
                                label: 'Yearly Principal Paid',
                                data: yearlyData.map(d => d.principal),
                                backgroundColor: 'rgba(25, 52, 59, 0.2)', // Brand Dark
                                borderColor: 'rgba(25, 52, 59, 1)',
                                fill: 'start',
                                type: 'bar', 
                                order: 3
                            },
                             {
                                label: 'Loan Balance',
                                data: yearlyData.map(d => d.balance),
                                borderColor: 'rgba(230, 149, 0, 1)', // Accent Dark
                                backgroundColor: 'transparent',
                                borderWidth: 3,
                                borderDash: [5, 5],
                                pointBackgroundColor: 'rgba(230, 149, 0, 1)',
                                fill: false,
                                type: 'line',
                                order: 1,
                                yAxisID: 'y1' // Assign to secondary axis
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                stacked: true, 
                                ticks: { color: 'var(--text-light)' }, 
                                grid: { display: false } 
                            },
                            y: { // Primary axis (P&I)
                                stacked: true, 
                                beginAtZero: true, 
                                ticks: { color: 'var(--text-light)', callback: (val) => `$${val/1000}k` }, 
                                grid: { color: 'var(--border)' },
                                position: 'left',
                                title: { display: true, text: 'Yearly P&I Paid ($)', color: 'var(--text-light)' }
                            },
                            y1: { // Secondary axis (Balance)
                                beginAtZero: false,
                                position: 'right',
                                ticks: { color: 'var(--text-light)', callback: (val) => `$${val/1000}k` },
                                grid: { display: false }, 
                                title: { display: true, text: 'Remaining Loan Balance ($)', color: 'var(--text-light)' }
                            }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { color: 'var(--text-light)' } },
                             tooltip: {
                                 mode: 'index',
                                 intersect: false,
                                 callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        let value = context.raw;
                                        return `${label}: ${UIManager.formatCurrency(value, 0)}`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                const slider = document.getElementById('year-slider');
                slider.max = yearlyLabels.length || 1;
                slider.value = 1;
                app.updateChartSummary(1);
            }
        }

        // ===== MAIN APP (Controller) =====
        const app = {
            calculateDebounce: null,
            lastResults: null,
            lastSchedule: null,
            lastYearlyData: [], 
            state: {
                amortizationView: 'monthly', 
                isTtsEnabled: false,
                liveRates: FALLBACK_RATES.rates // NEW: Store live rates in state
            },

            async init() {
                this.setupEventListeners();
                this.setupDarkMode();
                this.setupPWA();
                this.setupVoiceControls();
                this.setupFAQ();
                this.initTooltips(); 
                ChartManager.registerPlugins(); 
                await this.loadInitialRates(); // UPDATED: Changed function name
                // calculate() is now called by loadInitialRates()
            },

            setupEventListeners() {
                // Standard inputs (Preserved)
                ['homePrice', 'interestRate', 'loanTerm', 'customTerm', 
                 'propertyTax', 'homeInsurance', 'hoaFees', 'extraMonthly', 'extraOneTime', 
                 'extraPaymentDate'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.debouncedCalculate());
                        el.addEventListener('change', () => this.debouncedCalculate());
                    }
                });
                
                // Synced Down Payment Listeners (Preserved)
                document.getElementById('downPaymentAmount').addEventListener('input', (e) => this.syncDownPayment('amount', e.target.value));
                document.getElementById('downPaymentPercent').addEventListener('input', (e) => this.syncDownPayment('percent', e.target.value));
                document.getElementById('homePrice').addEventListener('input', () => this.syncDownPayment('amount', document.getElementById('downPaymentAmount').value));

                // Tab switching (Preserved)
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.currentTarget.getAttribute('data-tab');
                        this.activateTab(tab);
                    });
                });
                
                // Amortization Controls (Preserved)
                document.getElementById('amortToggle').addEventListener('click', () => this.toggleAmortizationView());
                document.getElementById('exportCsv').addEventListener('click', () => this.exportAmortizationToCsv());
                
                // Chart Summary Slider (Preserved)
                document.getElementById('year-slider').addEventListener('input', (e) => this.updateChartSummary(e.target.value));

                // Live Rate Button Listeners (Preserved)
                document.getElementById('rate-btn-30yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate30, 'rate-btn-30yr'));
                    
                document.getElementById('rate-btn-15yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate15, 'rate-btn-15yr'));
                    
                document.getElementById('rate-btn-10yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate10, 'rate-btn-10yr'));
            },

            // (Preserved)
            applyRate(rate, btnId) {
                if (!rate) return;
                
                document.getElementById('interestRate').value = rate.toFixed(2);
                document.querySelectorAll('.rate-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(btnId).classList.add('active');
                
                this.calculate();
            },

            // (Preserved)
            activateTab(tab) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
                document.getElementById(tab).classList.add('active');

                if (tab === 'analysis' && this.lastResults) {
                    setTimeout(() => ChartManager.renderPaymentBreakdownChart(this.lastResults), 50);
                }
                if (tab === 'charts' && this.lastSchedule) {
                    setTimeout(() => ChartManager.renderMortgageOverTimeChart(this.lastSchedule), 50);
                }
            },
            
            // (Preserved)
            syncDownPayment(source, value) {
                const price = parseFloat(document.getElementById('homePrice').value) || 0;
                const amountEl = document.getElementById('downPaymentAmount');
                const percentEl = document.getElementById('downPaymentPercent');

                if (price > 0) {
                    if (source === 'amount') {
                        const amount = parseFloat(value) || 0;
                        percentEl.value = ((amount / price) * 100).toFixed(2);
                    } else { // source === 'percent'
                        const percent = parseFloat(value) || 0;
                        amountEl.value = (price * (percent / 100)).toFixed(0);
                    }
                }
                this.debouncedCalculate();
            },

            // (Preserved)
            debouncedCalculate() {
                clearTimeout(this.calculateDebounce);
                this.calculateDebounce = setTimeout(() => this.calculate(), 250);
            },

            // (Preserved)
            async calculate() {
                const inputs = {
                    homePrice: document.getElementById('homePrice').value,
                    downPayment: document.getElementById('downPaymentAmount').value, 
                    interestRate: document.getElementById('interestRate').value,
                    loanTerm: document.getElementById('loanTerm').value,
                    customTerm: document.getElementById('customTerm').value, 
                    propertyTax: document.getElementById('propertyTax').value,
                    homeInsurance: document.getElementById('homeInsurance').value,
                    hoaFees: document.getElementById('hoaFees').value,
                    extraMonthly: document.getElementById('extraMonthly').value,
                    extraOneTime: document.getElementById('extraOneTime').value,
                    extraPaymentDate: document.getElementById('extraPaymentDate').value
                };

                const calculator = new MortgageCalculator(inputs);
                const results = calculator.calculate();

                if (results) {
                    this.lastResults = results;
                    this.lastSchedule = calculator.amortizationSchedule;

                    UIManager.updateResults(results);
                    UIManager.updateAmortizationTable(this.lastSchedule, this.state.amortizationView);

                    const aiEngine = new AIInsightEngine(results, inputs);
                    const insights = aiEngine.generateInsights();
                    UIManager.updateInsights(insights);

                    if (this.state.isTtsEnabled) {
                        this.speakResults();
                    }

                    this.activateTab(document.querySelector('.tab-btn.active').getAttribute('data-tab'));
                }
            },
            
            // (Preserved)
            updateChartSummary(year) {
                const yearIndex = parseInt(year) - 1;
                if (!this.lastYearlyData || !this.lastYearlyData[yearIndex]) return;

                const data = this.lastYearlyData[yearIndex];

                document.getElementById('slider-year-label').textContent = year;
                document.getElementById('summary-principal-paid').textContent = UIManager.formatCurrency(data.principal, 2);
                document.getElementById('summary-interest-paid').textContent = UIManager.formatCurrency(data.interest, 2);
                document.getElementById('summary-remaining-balance').textContent = UIManager.formatCurrency(data.balance, 2);
            },

            // (Preserved)
            initTooltips() {
                let tooltipBox = null;
                document.querySelectorAll('.tooltip').forEach(el => {
                    el.addEventListener('mouseenter', (e) => {
                        const text = e.currentTarget.getAttribute('data-tooltip');
                        if (!text) return;
                        
                        tooltipBox = document.createElement('div');
                        tooltipBox.className = 'tooltip-box';
                        tooltipBox.textContent = text;
                        document.body.appendChild(tooltipBox);

                        const rect = e.currentTarget.getBoundingClientRect();
                        
                        let top = rect.top - tooltipBox.offsetHeight - 5;
                        let left = rect.left + rect.width / 2 - tooltipBox.offsetWidth / 2;

                        if (top < 0) { top = rect.bottom + 5; }
                        if (left < 0) { left = 5; }
                        if (left + tooltipBox.offsetWidth > window.innerWidth) {
                            left = window.innerWidth - tooltipBox.offsetWidth - 5;
                        }

                        tooltipBox.style.left = `${left}px`;
                        tooltipBox.style.top = `${top}px`;
                        tooltipBox.style.display = 'block';
                        setTimeout(() => { tooltipBox.style.opacity = '1'; }, 10);
                    });
                    el.addEventListener('mouseleave', () => {
                        if (tooltipBox) {
                            tooltipBox.style.opacity = '0';
                            setTimeout(() => {
                                if (tooltipBox) {
                                    tooltipBox.remove();
                                    tooltipBox = null;
                                }
                            }, 200);
                        }
                    });
                });
            },

            // (Preserved)
            toggleAmortizationView() {
                const btn = document.getElementById('amortToggle');
                if (this.state.amortizationView === 'monthly') {
                    this.state.amortizationView = 'yearly';
                    btn.textContent = 'Show Monthly';
                } else {
                    this.state.amortizationView = 'monthly';
                    btn.textContent = 'Show Yearly';
                }
                UIManager.updateAmortizationTable(this.lastSchedule, this.state.amortizationView);
            },

            // (Preserved)
            exportAmortizationToCsv() {
                if (!this.lastSchedule || this.lastSchedule.length === 0) return;

                let csvContent = "data:text/csv;charset=utf-8,";
                let rows = [];
                const view = this.state.amortizationView;

                if (view === 'monthly') {
                    rows.push(["Month", "Total Payment", "Principal", "Interest", "Extra Payment", "Balance"]);
                    this.lastSchedule.forEach(row => {
                        rows.push([
                            row.payment,
                            (row.principal + row.interest + row.extra).toFixed(2),
                            row.principal.toFixed(2),
                            row.interest.toFixed(2),
                            row.extra.toFixed(2),
                            row.balance.toFixed(2)
                        ]);
                    });
                } else { // Yearly
                    rows.push(["Year", "Total Paid", "Principal Paid", "Interest Paid", "Extra Paid", "Ending Balance"]);
                    for (let y = 0; y < this.lastSchedule.length / 12; y++) {
                        const yearSlice = this.lastSchedule.slice(y * 12, (y + 1) * 12);
                        if (yearSlice.length === 0) continue;
                        
                        const yearSummary = yearSlice.reduce((acc, row) => {
                            acc.principal += row.principal;
                            acc.interest += row.interest;
                            acc.extra += row.extra;
                            return acc;
                        }, { principal: 0, interest: 0, extra: 0 });
                        
                        const totalPaid = yearSummary.principal + yearSummary.interest + yearSummary.extra;
                        rows.push([
                            y + 1,
                            totalPaid.toFixed(2),
                            yearSummary.principal.toFixed(2),
                            yearSummary.interest.toFixed(2),
                            yearSummary.extra.toFixed(2),
                            yearSlice[yearSlice.length - 1].balance.toFixed(2)
                        ]);
                    }
                }
                
                rows.forEach(rowArray => {
                    let row = rowArray.join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `amortization_schedule_${view}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            // (Preserved)
            async loadInitialRates() {
                const updatedEl = document.getElementById('fred-last-updated');
                const rateEl = document.getElementById('interestRate');
                
                const btn30 = document.getElementById('rate-btn-30yr');
                const btn15 = document.getElementById('rate-btn-15yr');
                const btn10 = document.getElementById('rate-btn-10yr');

                try {
                    const { rates, lastUpdatedTimestamp } = await FREDManager.getRates();
                    
                    this.state.liveRates = rates;

                    updatedEl.textContent = lastUpdatedTimestamp;
                    updatedEl.style.color = "var(--text-light)";

                    btn30.textContent = `30-Yr Fixed: ${rates.rate30.toFixed(2)}%`;
                    btn15.textContent = `15-Yr Fixed: ${rates.rate15.toFixed(2)}%`;
                    btn10.textContent = `10-Yr Treasury: ${rates.rate10.toFixed(2)}%`;
                    
                    btn30.disabled = false;
                    btn15.disabled = false;
                    btn10.disabled = false;
                    
                    rateEl.value = rates.rate30.toFixed(2);
                    btn30.classList.add('active');

                } catch (error) {
                    console.error("Error loading initial rates:", error);
                    updatedEl.textContent = 'Error loading rates. Using fallbacks.';
                    updatedEl.style.color = "var(--error)";
                    this.state.liveRates = FALLBACK_RATES.rates;
                    btn30.textContent = `30-Yr Fixed: ${this.state.liveRates.rate30.toFixed(2)}%`;
                    btn15.textContent = `15-Yr Fixed: ${this.state.liveRates.rate15.toFixed(2)}%`;
                    btn10.textContent = `10-Yr Treasury: ${this.state.liveRates.rate10.toFixed(2)}%`;
                }
                
                this.calculate(); // Use calculate() instead of debounced for instant load
            },

            // --- REPLACED: This function now uses the live API ---
            async lookupZipCode() {
                const zipEl = document.getElementById('zipCode');
                const zip = zipEl.value;
                const homePrice = parseFloat(document.getElementById('homePrice').value) || 0;
                const locationInfoEl = document.getElementById('zip-location-info');

                if (homePrice <= 0) {
                    // This is one of the few places an alert is acceptable, but we'll use the info box
                    locationInfoEl.textContent = 'Please enter a Home Purchase Price first.';
                    locationInfoEl.className = 'location-info error';
                    return;
                }
                if (!zip || zip.length !== 5 || !/^\d{5}$/.test(zip)) {
                    locationInfoEl.textContent = 'Please enter a valid 5-digit ZIP code.';
                    locationInfoEl.className = 'location-info error';
                    return;
                }

                locationInfoEl.textContent = 'Looking up location...';
                locationInfoEl.className = 'location-info'; // Default/info style

                const info = await ZipCodeManager.lookupZipInfo(zip);

                if (info.error) {
                    locationInfoEl.textContent = info.error;
                    locationInfoEl.className = 'location-info error';
                } else {
                    // Success: Display Area (City), State
                    locationInfoEl.textContent = `${info.city}, ${info.state}`;
                    locationInfoEl.className = 'location-info success';

                    // Now, use the stateAbbr to estimate taxes
                    const estimate = ZipCodeManager.estimateTaxAndInsurance(homePrice, info.stateAbbr);
                    
                    if (estimate) {
                        document.getElementById('propertyTax').value = Math.round(estimate.annualTax);
                        document.getElementById('homeInsurance').value = Math.round(estimate.annualInsurance);
                        // We found data, so recalculate
                        this.debouncedCalculate();
                    }
                }
            },

            // (Preserved)
            setupDarkMode() {
                const toggle = document.getElementById('darkModeToggle');
                const scheme = localStorage.getItem('colorScheme') || 'light';
                document.documentElement.setAttribute('data-color-scheme', scheme);
                toggle.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-color-scheme');
                    const next = current === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-color-scheme', next);
                    localStorage.setItem('colorScheme', next);
                    this.activateTab(document.querySelector('.tab-btn.active').getAttribute('data-tab'));
                });
            },

            // (Preserved)
            setupPWA() {
                const pwaBtn = document.getElementById('pwa-install-btn');
                if (pwaBtn) {
                    pwaBtn.addEventListener('click', async () => {
                        if (window.deferredPrompt) {
                            window.deferredPrompt.prompt();
                            const { outcome } = await window.deferredPrompt.userChoice;
                            if (outcome === 'accepted') console.log('User accepted the PWA install prompt');
                            window.deferredPrompt = null;
                        }
                    });
                }
            },

            // (Preserved)
            setupVoiceControls() {
                const voiceBtn = document.getElementById('voiceToggle');
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = () => { 
                        voiceBtn.classList.add('active'); 
                        voiceBtn.textContent = '..'; 
                    };
                    recognition.onend = () => { 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.textContent = 'üé§'; 
                    };
                    recognition.onerror = (event) => { 
                        console.error('Voice recognition error', event.error); 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.textContent = 'üé§'; 
                    };

                    recognition.onresult = (event) => {
                        const command = event.results[0][0].transcript.toLowerCase();
                        if (command.includes('calculate')) this.calculate();
                        else if (command.includes('read results')) this.speakResults();
                        else if (command.includes('read insights')) this.speakInsights();
                    };
                    voiceBtn.addEventListener('click', () => { try { recognition.start(); } catch(e) { console.error("Voice recognition error", e); } });
                } else {
                     voiceBtn.title = 'Voice control not supported in this browser.';
                     voiceBtn.style.opacity = '0.5';
                     voiceBtn.disabled = true;
                }
                
                const ttsBtn = document.getElementById('ttsToggle');
                ttsBtn.addEventListener('click', () => {
                    this.state.isTtsEnabled = !this.state.isTtsEnabled;

                    if (this.state.isTtsEnabled) {
                        ttsBtn.classList.add('active'); 
                        this.speakResults(); 
                    } else {
                        ttsBtn.classList.remove('active'); 
                        if ('speechSynthesis' in window && speechSynthesis.speaking) {
                            speechSynthesis.cancel(); 
                        }
                    }
                });
            },

            // (Preserved)
            speakResults() {
                if ('speechSynthesis' in window && this.lastResults) {
                    speechSynthesis.cancel();
                    const text = `Your estimated monthly payment is ${UIManager.formatCurrency(this.lastResults.monthlyPayment, 2)}.`;
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                }
            },
            
            // (Preserved)
            speakInsights() {
                 if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const insightsContainer = document.getElementById('insightsContainer');
                    const firstInsight = insightsContainer.querySelector('.insight-box');
                    if(firstInsight) {
                        const text = firstInsight.textContent;
                        const utterance = new SpeechSynthesisUtterance(text);
                        speechSynthesis.speak(utterance);
                    }
                }
            },

            // (Preserved)
            setupFAQ() {
                const container = document.getElementById('faqContainer');
                if(!container) return;
                FAQs.forEach(faq => {
                    const item = document.createElement('div');
                    item.className = 'faq-item';
                    item.innerHTML = `
                        <div class="faq-question" role="button" aria-expanded="false">
                            <span>${faq.q}</span>
                            <span class="faq-icon">‚ñº</span>
                        </div>
                        <div class="faq-answer" role="region" style="display: none;">${faq.a}</div>
                    `;
                    const question = item.querySelector('.faq-question');
                    const answer = item.querySelector('.faq-answer');
                    question.addEventListener('click', () => {
                        const isActive = question.classList.contains('active');
                        
                        document.querySelectorAll('.faq-question.active').forEach(q => {
                            if (q !== question) {
                                q.classList.remove('active');
                                q.nextElementSibling.style.display = 'none';
                                q.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                            }
                        });

                        if (!isActive) {
                            question.classList.add('active');
                            answer.style.display = 'block';
                            question.querySelector('.faq-icon').style.transform = 'rotate(180deg)';
                        } else {
                            question.classList.remove('active');
                            answer.style.display = 'none';
                            question.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                        }
                    });
                    container.appendChild(item);
                });
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => app.init());

        // ===== ERROR HANDLING =====
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.message, event.filename, event.lineno);
        });
        window.addEventListener('unhandledrejection', (event) => {
             console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <!-- END: Inlined JavaScript -->

    <!-- 
      NEW: PWA Service Worker for Offline Use
      This script registers a simple service worker to cache the app shell
      and CDN files, fulfilling the offline-use requirement in 'tools scrept.docx'.
    -->
    <script>
        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'mortgage-calculator-v1';
                const urlsToCache = [
                    '.', // Caches the main HTML file (index.html)
                    'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js',
                    'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js'
                ];
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Service Worker: Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                    );
                });
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response; // Serve from cache
                                }
                                // Not in cache, fetch from network
                                return fetch(event.request); 
                            }
                        )
                    );
                });
            `;
            // Create a Blob from the SW content and register it
            const blob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered from Blob.', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>

</body>
</html>
