<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeLoan Pro - AI-Enhanced Mortgage Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #21808d;
            --color-primary-dark: #1a6a75;
            --color-secondary: #a84b2f;
            --color-accent: #626c71;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --color-bg: #f8fafc;
            --color-bg-secondary: #e5e7eb;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        /* CSS Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--color-text);
            background-color: var(--color-bg);
            padding: 0;
            margin: 0;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow-md);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
        }

        /* Main Content */
        .main-title {
            text-align: center;
            margin: 2rem 0;
            color: var(--color-primary);
        }

        .calculator-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        @media (max-width: 1024px) {
            .calculator-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Calculator Panels */
        .calculator-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .panel-header {
            margin-bottom: 1.5rem;
        }

        .panel-header h2 {
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }

        .panel-header p {
            color: var(--color-text-secondary);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
            position: relative;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--color-bg-secondary);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        .form-input.invalid {
            border-color: var(--color-error);
        }

        .error-message {
            color: var(--color-error);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Down Payment Tabs */
        .dp-tabs {
            display: flex;
            background: var(--color-bg);
            border-radius: var(--border-radius);
            padding: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            background: transparent;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .dp-inputs {
            position: relative;
        }

        .dp-input-wrap {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .hidden {
            display: none;
        }

        /* PMI Banner */
        .pmi-banner {
            background: #fef3c7;
            color: #92400e;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        /* Term Buttons */
        .term-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .chip {
            padding: 0.5rem 1rem;
            background: var(--color-bg);
            border: 1px solid var(--color-bg-secondary);
            border-radius: 2rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .chip.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .or-text {
            align-self: center;
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            margin: 0 0.5rem;
        }

        .custom-term {
            max-width: 150px;
        }

        /* Advanced Options */
        .advanced-toggle {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--color-bg);
            border: 1px solid var(--color-bg-secondary);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .advanced-toggle.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .advanced-toggle.active .arrow {
            transform: rotate(180deg);
        }

        .advanced-panel {
            border: 1px solid var(--color-bg-secondary);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
        }

        .btn-secondary {
            background: var(--color-bg);
            color: var(--color-text);
            border: 1px solid var(--color-bg-secondary);
        }

        .btn-secondary:hover {
            background: var(--color-bg-secondary);
        }

        .btn-full-width {
            flex: 1;
            justify-content: center;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
        }

        .btn-outline:hover {
            background: var(--color-primary);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Panel */
        .results-summary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
            margin-bottom: 1.5rem;
        }

        .main-result {
            text-align: center;
            margin-bottom: 1rem;
        }

        .result-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .key-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            display: block;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .metric-value {
            display: block;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Payment Breakdown */
        .breakdown-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .breakdown-table {
            display: grid;
            gap: 0.75rem;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            background: #f8fafc;
        }

        .breakdown-row:nth-child(1) {
            border-left: 4px solid var(--color-primary);
        }

        .breakdown-row:nth-child(2) {
            border-left: 4px solid var(--color-secondary);
        }

        .breakdown-row:nth-child(3) {
            border-left: 4px solid var(--color-accent);
        }

        .breakdown-row:nth-child(4) {
            border-left: 4px solid var(--color-error);
        }

        .breakdown-row:nth-child(5) {
            border-left: 4px solid #94a3b8;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .chart-container h4 {
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .chart-canvas {
            max-width: 100%;
            margin: 0 auto;
            display: block;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Insights Section */
        .insights-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .insights-list {
            list-style: none;
            margin-top: 1rem;
        }

        .insight-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background: #f8fafc;
            border-left: 4px solid var(--color-primary);
        }

        .insight-icon {
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .insight-content strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--color-text);
        }

        .insight-content p {
            margin: 0;
            color: var(--color-text-secondary);
        }

        /* Amortization Section */
        .amortization-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-container {
            overflow-x: auto;
        }

        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .amortization-table th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--color-text);
        }

        .amortization-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-bg-secondary);
        }

        .amortization-table tr:last-child td {
            border-bottom: none;
        }

        .amortization-table tr:hover {
            background: #f8fafc;
        }

        /* Result Actions */
        .result-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        /* Comparison Section */
        .comparison-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-md);
        }

        .predefined-scenarios {
            margin: 2rem 0;
        }

        .scenario-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .scenario-btn {
            padding: 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .scenario-btn:nth-child(1) {
            background: linear-gradient(135deg, var(--color-primary) 0%, #2a9d8f 100%);
            color: white;
        }

        .scenario-btn:nth-child(2) {
            background: linear-gradient(135deg, var(--color-secondary) 0%, #c15a2b 100%);
            color: white;
        }

        .scenario-btn:nth-child(3) {
            background: linear-gradient(135deg, var(--color-accent) 0%, #8191a0 100%);
            color: white;
        }

        .scenario-btn:nth-child(4) {
            background: linear-gradient(135deg, var(--color-error) 0%, #e63946 100%);
            color: white;
        }

        .scenario-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .comparison-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .comparison-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border-top: 4px solid var(--color-primary);
        }

        .comparison-card:nth-child(2) {
            border-top-color: var(--color-secondary);
        }

        .comparison-card:nth-child(3) {
            border-top-color: var(--color-accent);
        }

        .comparison-card:nth-child(4) {
            border-top-color: var(--color-error);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .comparison-title {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--color-primary);
        }

        .comparison-savings {
            background: #f0fdf4;
            color: #166534;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .comparison-details {
            display: grid;
            gap: 0.75rem;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--color-bg-secondary);
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        /* Voice Status */
        .voice-status {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .voice-status.active {
            opacity: 1;
            visibility: visible;
        }

        .voice-animation {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .voice-dot {
            width: 8px;
            height: 8px;
            background: var(--color-primary);
            border-radius: 50%;
            animation: voicePulse 1.5s infinite;
        }

        .voice-dot:nth-child(2) {
            animation-delay: 0.5s;
        }

        .voice-dot:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes voicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        .voice-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        /* Modal */
        .schedule-modal {
            width: 90%;
            max-width: 1000px;
            border: none;
            border-radius: 12px;
            padding: 0;
            box-shadow: var(--shadow-lg);
        }

        .schedule-modal::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-bg-secondary);
        }

        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .schedule-info {
            margin-bottom: 1.5rem;
        }

        .brand-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .brand-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .full-schedule {
            font-size: 0.875rem;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-table th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--color-text);
        }

        .schedule-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-bg-secondary);
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--color-bg-secondary);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-success {
            border-left: 4px solid var(--color-success);
        }

        .notification-error {
            border-left: 4px solid var(--color-error);
        }

        .notification-info {
            border-left: 4px solid var(--color-primary);
        }

        /* Additional Elements */
        .payoff-info {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .payoff-item {
            text-align: center;
        }

        .payoff-label {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .payoff-value {
            font-weight: 600;
            font-size: 1rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .calculator-layout {
                gap: 1rem;
            }
            
            .calculator-panel {
                padding: 1rem;
            }
            
            .action-buttons, .result-actions {
                flex-direction: column;
            }
            
            .key-metrics {
                grid-template-columns: 1fr;
            }
            
            .scenario-buttons {
                grid-template-columns: 1fr;
            }
            
            .comparison-cards {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .payoff-info {
                flex-direction: column;
                gap: 0.75rem;
            }
        }

        /* Dark theme support */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-text: #f1f5f9;
                --color-text-secondary: #cbd5e1;
                --color-bg: #0f172a;
                --color-bg-secondary: #1e293b;
            }
            
            .calculator-panel,
            .breakdown-section,
            .chart-container,
            .insights-section,
            .amortization-section,
            .comparison-section,
            .comparison-card {
                background: #1e293b;
                color: var(--color-text);
            }
            
            .form-input {
                background: var(--color-bg);
                color: var(--color-text);
                border-color: #334155;
            }
            
            .breakdown-row,
            .amortization-table th,
            .schedule-table th {
                background: #1a2437;
            }
            
            .chip {
                background: var(--color-bg);
                border-color: #334155;
            }
            
            .advanced-toggle {
                background: var(--color-bg);
                border-color: #334155;
                color: var(--color-text);
            }
            
            .advanced-panel {
                border-color: #334155;
                background: var(--color-bg);
            }
            
            .btn-secondary {
                background: var(--color-bg);
                color: var(--color-text);
                border-color: #334155;
            }
            
            .btn-secondary:hover {
                background: #334155;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar container">
            <a href="#" class="nav-brand">
                <i class="fas fa-calculator"></i>
                <span>HomeLoan Pro</span>
            </a>
        </nav>
    </header>

    <main class="container">
        <h1 class="main-title">
            🏠 AI-Enhanced Mortgage Calculator
        </h1>
        
        <div class="calculator-layout">
            <!-- Input Panel -->
            <div class="calculator-panel inputs-panel">
                <div class="panel-header">
                    <h2>Loan Details</h2>
                    <p>Enter your mortgage information for precise calculations</p>
                </div>

                <div class="form-group">
                    <label for="home-price" class="form-label">
                        <i class="fas fa-home"></i>
                        Home Price ($)
                        <button class="voice-btn" data-field="home-price" title="Voice Input" aria-label="Voice input for home price">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </label>
                    <input type="number" id="home-price" class="form-input" value="400000" min="10000" max="10000000" step="1000" required>
                    <div class="error-message" id="home-price-error" aria-live="polite"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-percentage"></i>
                        Down Payment
                    </label>
                    <div class="dp-tabs">
                        <button class="tab-btn active" id="tab-amount" aria-pressed="true">Amount $</button>
                        <button class="tab-btn" id="tab-percent" aria-pressed="false">Percent %</button>
                    </div>
                    <div class="dp-inputs">
                        <div id="dp-amount-wrap" class="dp-input-wrap">
                            <input type="number" id="dp-amount" class="form-input" value="80000" min="0" step="1000" required>
                            <button class="voice-btn" data-field="dp-amount" title="Voice Input" aria-label="Voice input for down payment amount">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <div id="dp-percent-wrap" class="dp-input-wrap hidden">
                            <input type="number" id="dp-percent" class="form-input" value="20" min="0" max="100" step="0.1" required>
                            <button class="voice-btn" data-field="dp-percent" title="Voice Input" aria-label="Voice input for down payment percentage">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    <div id="pmi-banner" class="pmi-banner hidden" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>PMI Required - Down payment is less than 20% of home value</span>
                    </div>
                    <div class="error-message" id="dp-error" aria-live="polite"></div>
                </div>

                <div class="form-group">
                    <label for="interest-rate" class="form-label">
                        <i class="fas fa-chart-line"></i>
                        Interest Rate (%)
                        <button class="voice-btn" data-field="interest-rate" title="Voice Input" aria-label="Voice input for interest rate">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </label>
                    <input type="number" id="interest-rate" class="form-input" value="6.75" min="0.1" max="30" step="0.01" required>
                    <div class="error-message" id="interest-rate-error" aria-live="polite"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i>
                        Loan Term
                    </label>
                    <div class="term-buttons" id="term-buttons">
                        <button class="chip" data-term="10">10y</button>
                        <button class="chip" data-term="15">15y</button>
                        <button class="chip" data-term="20">20y</button>
                        <button class="chip" data-term="25">25y</button>
                        <button class="chip active" data-term="30">30y</button>
                        <span class="or-text">or</span>
                    </div>
                    <input type="number" id="term-custom" class="form-input custom-term" placeholder="Custom years (1-40)" min="1" max="40">
                    <div class="error-message" id="term-error" aria-live="polite"></div>
                </div>

                <div class="form-group">
                    <label for="state" class="form-label">
                        <i class="fas fa-map-marker-alt"></i>
                        Property State
                    </label>
                    <select id="state" class="form-input">
                        <option value="">Select State</option>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="property-tax" class="form-label">
                        <i class="fas fa-building"></i>
                        Property Tax (Annual $)
                    </label>
                    <input type="number" id="property-tax" class="form-input" value="1640" min="0" step="100">
                    <small class="help-text">Auto-calculated based on state average</small>
                </div>

                <div class="advanced-section">
                    <button class="advanced-toggle" id="advanced-toggle" aria-expanded="false">
                        <i class="fas fa-cog"></i>
                        <span>Advanced Options</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </button>
                    <div id="advanced-panel" class="advanced-panel hidden" aria-hidden="true">
                        <div class="form-group">
                            <label for="home-insurance" class="form-label">
                                <i class="fas fa-shield-alt"></i>
                                Home Insurance (Annual $)
                            </label>
                            <input type="number" id="home-insurance" class="form-input" value="960" min="0" step="50">
                        </div>

                        <div class="form-group">
                            <label for="pmi-rate" class="form-label">
                                <i class="fas fa-umbrella"></i>
                                PMI Rate (Annual %)
                            </label>
                            <input type="number" id="pmi-rate" class="form-input" value="0.8" min="0" max="5" step="0.1">
                        </div>

                        <div class="form-group">
                            <label for="hoa-fees" class="form-label">
                                <i class="fas fa-users"></i>
                                HOA Fees (Monthly $)
                            </label>
                            <input type="number" id="hoa-fees" class="form-input" value="0" min="0" step="25">
                        </div>

                        <div class="form-group">
                            <label for="extra-monthly" class="form-label">
                                <i class="fas fa-plus-circle"></i>
                                Extra Monthly Payment ($)
                            </label>
                            <input type="number" id="extra-monthly" class="form-input" value="0" min="0" step="50">
                        </div>

                        <div class="form-group">
                            <label for="extra-once" class="form-label">
                                <i class="fas fa-hand-holding-usd"></i>
                                One-Time Extra Payment ($)
                            </label>
                            <input type="number" id="extra-once" class="form-input" value="0" min="0" step="100">
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="calculate-btn" class="btn btn-primary btn-full-width">
                        <i class="fas fa-calculator"></i>
                        <span id="calculate-text">Calculate Payment</span>
                        <span id="calculate-spinner" class="spinner hidden"></span>
                    </button>
                    <button id="reset-form" class="btn btn-secondary">
                        <i class="fas fa-undo"></i>
                        Reset
                    </button>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="calculator-panel results-panel">
                <div class="panel-header">
                    <h2>Payment Results</h2>
                    <p>Your personalized mortgage calculation with AI insights</p>
                </div>

                <div class="results-summary">
                    <div class="main-result">
                        <div class="result-label">Total Monthly Payment</div>
                        <div class="result-value" id="total-payment">$2,923</div>
                    </div>
                    <div class="key-metrics">
                        <div class="metric">
                            <span class="metric-label">Loan Amount</span>
                            <span class="metric-value" id="loan-amount">$320,000</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total Interest</span>
                            <span class="metric-value" id="total-interest">$422,983</span>
                        </div>
                    </div>
                    <div class="payoff-info">
                        <div class="payoff-item">
                            <div class="payoff-label">Total Paid</div>
                            <div class="payoff-value" id="total-paid">$742,983</div>
                        </div>
                        <div class="payoff-item">
                            <div class="payoff-label">Payoff Date</div>
                            <div class="payoff-value" id="payoff-date">Aug 2053</div>
                        </div>
                    </div>
                </div>

                <div class="breakdown-section">
                    <h3>Monthly Breakdown</h3>
                    <div class="breakdown-table">
                        <div class="breakdown-row">
                            <span class="breakdown-label">P&I</span>
                            <span class="breakdown-value" id="pi-amount">$2,590</span>
                        </div>
                        <div class="breakdown-row">
                            <span class="breakdown-label">Taxes</span>
                            <span class="breakdown-value" id="tax-amount">$137</span>
                        </div>
                        <div class="breakdown-row">
                            <span class="breakdown-label">Insurance</span>
                            <span class="breakdown-value" id="insurance-amount">$80</span>
                        </div>
                        <div class="breakdown-row" id="row-pmi">
                            <span class="breakdown-label">PMI</span>
                            <span class="breakdown-value" id="pmi-amount">$213</span>
                        </div>
                        <div class="breakdown-row">
                            <span class="breakdown-label">HOA</span>
                            <span class="breakdown-value" id="hoa-amount">$0</span>
                        </div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-container">
                        <h4>Payment Breakdown</h4>
                        <canvas id="breakdownChart" class="chart-canvas" width="300" height="200"></canvas>
                        <div id="legend-breakdown" class="chart-legend"></div>
                    </div>
                    <div class="chart-container">
                        <h4>Principal vs Interest</h4>
                        <canvas id="piChart" class="chart-canvas" width="300" height="200"></canvas>
                        <div id="legend-pi" class="chart-legend"></div>
                    </div>
                </div>

                <div class="insights-section">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        AI Insights
                        <small>Personalized recommendations to save money</small>
                    </h3>
                    <ul id="insights-list" class="insights-list">
                        <!-- Dynamic AI insights will be populated here -->
                    </ul>
                </div>

                <div class="amortization-section">
                    <div class="section-header">
                        <h3>Payment Schedule (First 5 Years)</h3>
                        <button id="view-full-schedule" class="btn btn-outline">
                            <i class="fas fa-table"></i>
                            View Full Schedule
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="amortization-table">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Payment</th>
                                    <th>Principal</th>
                                    <th>Interest</th>
                                    <th>End Balance</th>
                                </tr>
                            </thead>
                            <tbody id="amortization-body">
                                <!-- Dynamic amortization data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="result-actions">
                    <button id="email-results" class="btn btn-secondary">
                        <i class="fas fa-envelope"></i>
                        Email Results
                    </button>
                    <button id="share-results" class="btn btn-secondary">
                        <i class="fas fa-share"></i>
                        Share
                    </button>
                    <button id="print-results" class="btn btn-secondary">
                        <i class="fas fa-print"></i>
                        Print
                    </button>
                </div>
            </div>
        </div>

        <!-- Comparison Section -->
        <div class="comparison-section">
            <div class="panel-header">
                <h2>Loan Comparison Scenarios</h2>
                <p>Compare different loan options side by side</p>
            </div>
            
            <div class="predefined-scenarios">
                <h3>Quick Scenarios</h3>
                <div class="scenario-buttons">
                    <button class="scenario-btn" data-scenario="15year">15-Year vs 30-Year</button>
                    <button class="scenario-btn" data-scenario="rates">Rate Comparison</button>
                    <button class="scenario-btn" data-scenario="downpayment">Down Payment Impact</button>
                    <button class="scenario-btn" data-scenario="extraPayment">Extra Payment Benefits</button>
                </div>
            </div>

            <div class="comparison-cards" id="comparison-cards">
                <!-- Dynamic comparison cards will be populated here -->
            </div>
        </div>
    </main>

    <!-- Voice Status Indicator -->
    <div id="voice-status" class="voice-status">
        <div class="voice-animation">
            <div class="voice-dot"></div>
            <div class="voice-dot"></div>
            <div class="voice-dot"></div>
        </div>
        <span>Listening... Say "home price 400000" or "calculate"</span>
        <button class="voice-close">×</button>
    </div>

    <!-- Full Schedule Modal -->
    <dialog id="schedule-modal" class="schedule-modal">
        <div class="modal-header">
            <h2>
                <i class="fas fa-table"></i>
                Complete Amortization Schedule
            </h2>
            <button id="close-schedule" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="schedule-info">
                <div class="brand-info">
                    <i class="fas fa-calculator" style="font-size: 2rem; color: var(--color-primary);"></i>
                    <div>
                        <strong>HomeLoan Pro</strong>
                        <br>www.homeloanpro.com
                    </div>
                </div>
            </div>
            <div class="table-container full-schedule">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Payment</th>
                            <th>Principal</th>
                            <th>Interest</th>
                            <th>Extra</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="full-schedule-body">
                        <!-- Dynamic full schedule data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="window.print()">
                <i class="fas fa-print"></i>
                Print Schedule
            </button>
            <button class="btn btn-secondary" id="download-schedule">
                <i class="fas fa-download"></i>
                Download CSV
            </button>
        </div>
    </dialog>

    <script>
        // Mortgage Calculator JavaScript Implementation
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';
            
            // Utility functions
            const $ = (s) => document.querySelector(s);
            const $$ = (s) => Array.from(document.querySelectorAll(s));
            const money = (n) => `$${n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            const formatNumber = (n) => n.toLocaleString('en-US');

            // US State tax rates (%) - All 50 states
            const stateTaxRates = {
                AL: 0.41, AK: 1.24, AZ: 0.60, AR: 0.66, CA: 0.81, CO: 0.52, CT: 2.16, DE: 0.62,
                FL: 0.89, GA: 0.95, HI: 0.29, ID: 0.63, IL: 2.29, IN: 0.83, IA: 1.59, KS: 1.40,
                KY: 0.89, LA: 0.62, ME: 1.29, MD: 1.07, MA: 1.19, MI: 1.53, MN: 1.10, MS: 0.81,
                MO: 1.00, MT: 0.83, NE: 1.70, NV: 0.55, NH: 2.09, NJ: 2.46, NM: 0.84, NY: 1.73,
                NC: 0.80, ND: 1.02, OH: 1.57, OK: 0.99, OR: 0.92, PA: 1.56, RI: 1.54, SC: 0.58,
                SD: 1.24, TN: 0.65, TX: 1.90, UT: 0.57, VT: 1.89, VA: 0.83, WA: 0.93, WV: 0.59,
                WI: 1.71, WY: 0.61
            };

            // Calculator state
            let currentMode = 'payment';
            let activeTerm = 30;
            let usePct = false;
            let comparisons = [];
            let recognition = null;
            let currentCalculation = null;

            // Elements cache
            const els = {
                // Payment mode inputs
                homePrice: $('#home-price'),
                dpAmount: $('#dp-amount'),
                dpPercent: $('#dp-percent'),
                interestRate: $('#interest-rate'),
                termCustom: $('#term-custom'),
                state: $('#state'),
                propertyTax: $('#property-tax'),
                homeInsurance: $('#home-insurance'),
                pmiRate: $('#pmi-rate'),
                hoaFees: $('#hoa-fees'),
                extraMonthly: $('#extra-monthly'),
                extraOnce: $('#extra-once'),

                // UI controls
                tabAmount: $('#tab-amount'),
                tabPercent: $('#tab-percent'),
                dpAmountWrap: $('#dp-amount-wrap'),
                dpPercentWrap: $('#dp-percent-wrap'),
                pmiBanner: $('#pmi-banner'),
                termButtons: $('#term-buttons'),
                advancedToggle: $('#advanced-toggle'),
                advancedPanel: $('#advanced-panel'),

                // Results
                totalPayment: $('#total-payment'),
                loanAmount: $('#loan-amount'),
                totalInterest: $('#total-interest'),
                totalPaid: $('#total-paid'),
                payoffDate: $('#payoff-date'),
                piAmount: $('#pi-amount'),
                taxAmount: $('#tax-amount'),
                insuranceAmount: $('#insurance-amount'),
                pmiAmount: $('#pmi-amount'),
                hoaAmount: $('#hoa-amount'),
                rowPmi: $('#row-pmi'),

                // Charts and tables
                breakdownChart: $('#breakdownChart'),
                piChart: $('#piChart'),
                legendBreakdown: $('#legend-breakdown'),
                legendPi: $('#legend-pi'),
                amortizationBody: $('#amortization-body'),
                fullScheduleBody: $('#full-schedule-body'),
                scheduleModal: $('#schedule-modal'),

                // Actions
                calculateBtn: $('#calculate-btn'),
                calculateText: $('#calculate-text'),
                calculateSpinner: $('#calculate-spinner'),
                resetBtn: $('#reset-form'),
                emailBtn: $('#email-results'),
                shareBtn: $('#share-results'),
                printBtn: $('#print-results'),
                viewFullSchedule: $('#view-full-schedule'),
                closeSchedule: $('#close-schedule'),

                // Voice
                voiceBtns: $$('.voice-btn'),
                voiceStatus: $('#voice-status'),

                // Insights
                insightsList: $('#insights-list'),

                // Comparison
                comparisonCards: $('#comparison-cards'),
                scenarioBtns: $$('.scenario-btn'),

                // Error messages
                homePriceError: $('#home-price-error'),
                dpError: $('#dp-error'),
                interestRateError: $('#interest-rate-error'),
                termError: $('#term-error')
            };

            // Initialize calculator
            function init() {
                setupEventListeners();
                setupVoiceRecognition();
                setInitialValues();
                calculate();
            }

            // Event listeners setup
            function setupEventListeners() {
                // Down payment tabs
                els.tabAmount.addEventListener('click', () => switchDPMode(false));
                els.tabPercent.addEventListener('click', () => switchDPMode(true));

                // Input synchronization
                els.homePrice.addEventListener('input', handleHomePriceChange);
                els.dpAmount.addEventListener('input', () => syncDownPayment(false));
                els.dpPercent.addEventListener('input', () => syncDownPayment(true));
                els.state.addEventListener('change', updatePropertyTax);

                // Term selection
                els.termButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.chip[data-term]');
                    if (btn) setTerm(+btn.dataset.term);
                });
                els.termCustom.addEventListener('input', handleCustomTerm);

                // Advanced options
                els.advancedToggle.addEventListener('click', toggleAdvanced);

                // Auto-calculation on input changes
                const autoCalcInputs = [
                    els.homePrice, els.dpAmount, els.dpPercent, els.interestRate,
                    els.propertyTax, els.homeInsurance, els.pmiRate, els.hoaFees,
                    els.extraMonthly, els.extraOnce
                ];
                
                autoCalcInputs.forEach(input => {
                    if (input) {
                        input.addEventListener('input', debounce(validateInput, 300));
                        input.addEventListener('input', debounce(calculate, 500));
                    }
                });

                // Action buttons
                els.calculateBtn.addEventListener('click', calculate);
                els.resetBtn.addEventListener('click', resetForm);
                els.emailBtn.addEventListener('click', emailResults);
                els.shareBtn.addEventListener('click', shareResults);
                els.printBtn.addEventListener('click', () => window.print());
                els.viewFullSchedule.addEventListener('click', showFullSchedule);
                els.closeSchedule.addEventListener('click', () => els.scheduleModal.close());

                // Voice buttons
                els.voiceBtns.forEach(btn => {
                    btn.addEventListener('click', () => startVoiceInput(btn.dataset.field));
                });

                // Voice status close
                $('.voice-close')?.addEventListener('click', hideVoiceStatus);
                
                // Comparison
                els.scenarioBtns.forEach(btn => {
                    btn.addEventListener('click', () => loadScenario(btn.dataset.scenario));
                });

                // Modal backdrop click
                els.scheduleModal.addEventListener('click', (e) => {
                    if (e.target === els.scheduleModal) {
                        els.scheduleModal.close();
                    }
                });
            }

            // Input validation
            function validateInput(e) {
                const input = e.target;
                const value = parseFloat(input.value);
                const min = parseFloat(input.min) || 0;
                const max = parseFloat(input.max) || Infinity;
                
                // Clear previous errors
                hideError(input.id);
                
                // Check if empty
                if (input.value === '' || isNaN(value)) {
                    showError(input.id, 'This field is required');
                    return false;
                }
                
                // Check min value
                if (value < min) {
                    showError(input.id, `Value must be at least ${min}`);
                    return false;
                }
                
                // Check max value
                if (value > max) {
                    showError(input.id, `Value must be less than ${max}`);
                    return false;
                }
                
                // Special validation for down payment
                if (input.id === 'dp-amount' || input.id === 'dp-percent') {
                    const homePrice = parseFloat(els.homePrice.value);
                    if (input.id === 'dp-amount' && value > homePrice) {
                        showError(input.id, 'Down payment cannot exceed home price');
                        return false;
                    }
                    if (input.id === 'dp-percent' && value > 100) {
                        showError(input.id, 'Down payment cannot exceed 100%');
                        return false;
                    }
                }
                
                return true;
            }
            
            function showError(inputId, message) {
                const errorField = $(`#${inputId}-error`);
                if (errorField) {
                    errorField.textContent = message;
                    errorField.classList.add('show');
                }
                $(`#${inputId}`).classList.add('invalid');
            }
            
            function hideError(inputId) {
                const errorField = $(`#${inputId}-error`);
                if (errorField) {
                    errorField.classList.remove('show');
                }
                $(`#${inputId}`).classList.remove('invalid');
            }
            
            function validateAll() {
                const inputs = [
                    els.homePrice, 
                    usePct ? els.dpPercent : els.dpAmount, 
                    els.interestRate
                ];
                
                let isValid = true;
                
                inputs.forEach(input => {
                    if (!input) return;
                    
                    const event = new Event('input', {
                        bubbles: true,
                        cancelable: true,
                    });
                    
                    input.dispatchEvent(event);
                    
                    if (input.classList.contains('invalid')) {
                        isValid = false;
                    }
                });
                
                return isValid;
            }

            // Voice recognition setup
            function setupVoiceRecognition() {
                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (!SpeechRecognition) {
                        // Hide voice buttons if not supported
                        els.voiceBtns.forEach(btn => btn.style.display = 'none');
                        return;
                    }

                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'en-US';
                    recognition.maxAlternatives = 1;

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript.toLowerCase();
                        processVoiceCommand(transcript);
                    };

                    recognition.onerror = (event) => {
                        console.error('Voice recognition error:', event.error);
                        hideVoiceStatus();
                        showNotification('Voice recognition error. Please try again.', 'error');
                    };

                    recognition.onend = hideVoiceStatus;

                } catch (error) {
                    console.warn('Voice recognition not available:', error);
                    els.voiceBtns.forEach(btn => btn.style.display = 'none');
                }
            }

            // Set initial values
            function setInitialValues() {
                setTerm(30);
                switchDPMode(false);
                updatePropertyTax();
                updateInsurance();
            }

            // Down payment mode switching
            function switchDPMode(usePercent) {
                usePct = usePercent;
                els.tabAmount.classList.toggle('active', !usePercent);
                els.tabPercent.classList.toggle('active', usePercent);
                els.tabAmount.setAttribute('aria-pressed', !usePercent);
                els.tabPercent.setAttribute('aria-pressed', usePercent);
                els.dpAmountWrap.classList.toggle('hidden', usePercent);
                els.dpPercentWrap.classList.toggle('hidden', !usePercent);
                els.advancedPanel.setAttribute('aria-hidden', !usePercent);
                
                syncDownPayment(usePercent);
            }

            // Sync down payment inputs
            function syncDownPayment(fromPercent) {
                const homePrice = +els.homePrice.value || 0;
                
                if (fromPercent) {
                    const pct = Math.min(100, Math.max(0, +els.dpPercent.value || 0));
                    const amt = Math.round(homePrice * pct / 100);
                    els.dpAmount.value = amt;
                } else {
                    const amt = Math.min(homePrice, Math.max(0, +els.dpAmount.value || 0));
                    const pct = homePrice > 0 ? (amt / homePrice * 100) : 0;
                    els.dpPercent.value = pct.toFixed(1);
                }

                updatePMIBanner();
            }

            // Handle home price changes
            function handleHomePriceChange() {
                syncDownPayment(usePct);
                updatePropertyTax();
                updateInsurance();
            }

            // Update PMI banner
            function updatePMIBanner() {
                const dpPct = +els.dpPercent.value || 0;
                const needsPMI = dpPct < 20;
                els.pmiBanner.classList.toggle('hidden', !needsPMI);
                
                if (needsPMI) {
                    els.pmiBanner.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>PMI Required - Down payment is ${dpPct.toFixed(1)}% (less than 20% of home value)</span>
                    `;
                }
            }

            // Update property tax based on state
            function updatePropertyTax() {
                const homePrice = +els.homePrice.value || 0;
                const state = els.state.value;
                
                if (!state || !homePrice) return;
                
                const taxRate = stateTaxRates[state] || 1.0;
                const annualTax = Math.round(homePrice * (taxRate / 100));
                els.propertyTax.value = annualTax;
            }

            // Update insurance estimate
            function updateInsurance() {
                const homePrice = +els.homePrice.value || 0;
                const estimate = Math.round(homePrice * 0.0024); // ~0.24% of home value
                els.homeInsurance.value = Math.max(600, Math.min(estimate, 3000));
            }

            // Term selection
            function setTerm(years) {
                activeTerm = years;
                $$('[data-term]').forEach(btn => {
                    btn.classList.toggle('active', +btn.dataset.term === years);
                });
                els.termCustom.value = '';
                calculate();
            }

            // Handle custom term input
            function handleCustomTerm() {
                const customYears = +els.termCustom.value;
                if (customYears >= 1 && customYears <= 40) {
                    activeTerm = customYears;
                    $$('[data-term]').forEach(btn => btn.classList.remove('active'));
                }
                calculate();
            }

            // Toggle advanced options
            function toggleAdvanced() {
                const panel = els.advancedPanel;
                const arrow = els.advancedToggle.querySelector('.arrow');
                const button = els.advancedToggle;
                
                const isExpanded = panel.classList.toggle('hidden');
                arrow.classList.toggle('rotated');
                button.classList.toggle('active');
                button.setAttribute('aria-expanded', !isExpanded);
                panel.setAttribute('aria-hidden', isExpanded);
            }

            // Voice input functions
            function startVoiceInput(field) {
                if (!recognition) {
                    showNotification('Voice input not supported in this browser', 'error');
                    return;
                }
                
                showVoiceStatus();
                recognition.start();
            }

            function processVoiceCommand(transcript) {
                console.log('Voice command:', transcript);
                
                const numbers = transcript.match(/\d+(?:\.\d+)?/g);
                
                if (transcript.includes('home price') || transcript.includes('house price')) {
                    if (numbers && numbers.length > 0) {
                        let value = parseFloat(numbers[0]);
                        if (value < 10000) value *= 1000;
                        els.homePrice.value = value;
                        handleHomePriceChange();
                        showNotification(`Home price set to ${money(value)}`, 'success');
                    }
                } else if (transcript.includes('down payment')) {
                    if (numbers && numbers.length > 0) {
                        let value = parseFloat(numbers[0]);
                        if (transcript.includes('percent')) {
                            usePct = true;
                            switchDPMode(true);
                            els.dpPercent.value = value;
                            syncDownPayment(true);
                        } else {
                            if (value < 1000) value *= 1000;
                            usePct = false;
                            switchDPMode(false);
                            els.dpAmount.value = value;
                            syncDownPayment(false);
                        }
                        showNotification('Down payment updated', 'success');
                    }
                } else if (transcript.includes('interest rate') || transcript.includes('rate')) {
                    if (numbers && numbers.length > 0) {
                        const value = parseFloat(numbers[0]);
                        els.interestRate.value = value;
                        showNotification(`Interest rate set to ${value}%`, 'success');
                    }
                } else if (transcript.includes('calculate')) {
                    calculate();
                    showNotification('Calculation completed!', 'success');
                } else {
                    showNotification('Try saying: "home price 400000" or "interest rate 6.5"', 'info');
                }
                
                calculate();
            }

            function showVoiceStatus() {
                els.voiceStatus.classList.add('active');
            }

            function hideVoiceStatus() {
                els.voiceStatus.classList.remove('active');
            }

            // Main calculation function
            function calculate() {
                if (!validateAll()) {
                    showNotification('Please fix validation errors before calculating', 'error');
                    return;
                }
                
                try {
                    showLoading(true);
                    
                    // Use setTimeout to allow UI to update before heavy computation
                    setTimeout(() => {
                        const result = calculatePayment();
                        
                        if (result) {
                            currentCalculation = result;
                            updateDisplay(result);
                            generateInsights(result);
                            updateCharts(result);
                            updateAmortizationTable(result);
                        }
                        
                        showLoading(false);
                    }, 50);
                } catch (error) {
                    console.error('Calculation error:', error);
                    showNotification('Calculation error. Please check your inputs.', 'error');
                    showLoading(false);
                }
            }
            
            function showLoading(show) {
                if (show) {
                    els.calculateText.classList.add('hidden');
                    els.calculateSpinner.classList.remove('hidden');
                    els.calculateBtn.disabled = true;
                } else {
                    els.calculateText.classList.remove('hidden');
                    els.calculateSpinner.classList.add('hidden');
                    els.calculateBtn.disabled = false;
                }
            }

            // Payment calculation
            function calculatePayment() {
                const homePrice = +els.homePrice.value || 0;
                const dpAmount = +els.dpAmount.value || 0;
                const loanAmount = Math.max(0, homePrice - dpAmount);
                const rate = (+els.interestRate.value || 0) / 100;
                const term = +els.termCustom.value || activeTerm;
                const months = term * 12;

                if (!homePrice || !rate || !term) return null;

                // Property costs
                const annualTax = +els.propertyTax.value || 0;
                const annualInsurance = +els.homeInsurance.value || 0;
                const pmiRate = (+els.pmiRate.value || 0) / 100;
                const monthlyHOA = +els.hoaFees.value || 0;
                const extraMonthly = +els.extraMonthly.value || 0;
                const extraOnce = +els.extraOnce.value || 0;

                // Calculate monthly P&I
                const monthlyRate = rate / 12;
                let monthlyPI = 0;
                if (monthlyRate > 0) {
                    monthlyPI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                               (Math.pow(1 + monthlyRate, months) - 1);
                } else {
                    monthlyPI = loanAmount / months;
                }

                // Other monthly costs
                const monthlyTax = annualTax / 12;
                const monthlyInsurance = annualInsurance / 12;
                const dpPercent = homePrice > 0 ? (dpAmount / homePrice * 100) : 0;
                const needsPMI = dpPercent < 20;
                const monthlyPMI = needsPMI ? (loanAmount * pmiRate / 12) : 0;

                const totalMonthly = monthlyPI + monthlyTax + monthlyInsurance + monthlyPMI + monthlyHOA;

                // Generate amortization schedule with extra payments
                const schedule = generateSchedule(loanAmount, monthlyRate, monthlyPI, months, extraMonthly, extraOnce);
                const totalInterest = schedule.reduce((sum, payment) => sum + payment.interest, 0);
                const totalPaid = loanAmount + totalInterest;
                
                // Calculate payoff date
                const payoffDate = calculatePayoffDate(schedule);

                return {
                    mode: 'payment',
                    homePrice,
                    dpAmount,
                    dpPercent,
                    loanAmount,
                    rate: rate * 100,
                    term,
                    monthlyPI,
                    monthlyTax,
                    monthlyInsurance,
                    monthlyPMI,
                    monthlyHOA,
                    totalMonthly,
                    totalInterest,
                    totalPaid,
                    needsPMI,
                    schedule,
                    extraMonthly,
                    extraOnce,
                    payoffDate
                };
            }
            
            // Calculate payoff date
            function calculatePayoffDate(schedule) {
                if (schedule.length === 0) return 'N/A';
                
                const lastPayment = schedule[schedule.length - 1];
                const months = lastPayment.month;
                
                const today = new Date();
                const payoffDate = new Date(today);
                payoffDate.setMonth(payoffDate.getMonth() + months);
                
                return payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }

            // Generate amortization schedule
            function generateSchedule(loanAmount, monthlyRate, monthlyPI, totalMonths, extraMonthly = 0, extraOnce = 0) {
                const schedule = [];
                let balance = loanAmount;
                let totalExtra = 0;

                for (let month = 1; month <= totalMonths && balance > 0; month++) {
                    const interestPayment = balance * monthlyRate;
                    let principalPayment = monthlyPI - interestPayment;
                    let extraPayment = 0;

                    // Add extra payments
                    if (month === 1 && extraOnce > 0) {
                        extraPayment += Math.min(extraOnce, balance - principalPayment);
                    }
                    if (extraMonthly > 0) {
                        extraPayment += Math.min(extraMonthly, balance - principalPayment);
                    }

                    totalExtra += extraPayment;
                    principalPayment += extraPayment;
                    
                    // Ensure we don't overpay
                    if (principalPayment > balance) {
                        principalPayment = balance;
                        extraPayment = principalPayment - (monthlyPI - interestPayment);
                    }

                    balance = Math.max(0, balance - principalPayment);

                    schedule.push({
                        month,
                        payment: monthlyPI + extraPayment,
                        principal: principalPayment,
                        interest: interestPayment,
                        extra: extraPayment,
                        balance
                    });

                    if (balance === 0) break;
                }

                return schedule;
            }

            // Update display based on calculation mode
            function updateDisplay(result) {
                updatePaymentDisplay(result);
            }

            // Update payment mode display
            function updatePaymentDisplay(result) {
                els.totalPayment.textContent = money(result.totalMonthly);
                els.loanAmount.textContent = money(result.loanAmount);
                els.totalInterest.textContent = money(result.totalInterest);
                els.totalPaid.textContent = money(result.totalPaid);
                els.payoffDate.textContent = result.payoffDate;
                els.piAmount.textContent = money(result.monthlyPI);
                els.taxAmount.textContent = money(result.monthlyTax);
                els.insuranceAmount.textContent = money(result.monthlyInsurance);
                els.pmiAmount.textContent = money(result.monthlyPMI);
                els.hoaAmount.textContent = money(result.monthlyHOA);

                // Show/hide PMI row
                els.rowPmi.classList.toggle('hidden', !result.needsPMI);
            }

            // Update charts
            function updateCharts(result) {
                if (result.mode !== 'payment') return;

                // Pie chart for payment breakdown
                const breakdownData = [
                    result.monthlyPI,
                    result.monthlyTax,
                    result.monthlyInsurance,
                    result.monthlyPMI,
                    result.monthlyHOA
                ];
                const colors = ['#21808d', '#a84b2f', '#626c71', '#c0152f', '#94a3b8'];
                const labels = ['P&I', 'Taxes', 'Insurance', 'PMI', 'HOA'];
                
                drawPieChart(els.breakdownChart, breakdownData, colors, labels, els.legendBreakdown);
                
                // Pie chart for principal vs interest
                const totalPrincipal = result.loanAmount;
                const totalInterest = result.totalInterest;
                const piData = [totalPrincipal, totalInterest];
                const piColors = ['#21808d', '#a84b2f'];
                const piLabels = ['Principal', 'Interest'];
                
                drawPieChart(els.piChart, piData, piColors, piLabels, els.legendPi);
            }

            // Draw pie chart
            function drawPieChart(canvas, data, colors, labels, legendElement) {
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const size = Math.min(rect.width, rect.height);
                
                canvas.width = size;
                canvas.height = size;
                
                ctx.clearRect(0, 0, size, size);
                
                const total = data.reduce((sum, value) => sum + value, 0);
                const centerX = size / 2;
                const centerY = size / 2;
                const radius = Math.min(centerX, centerY) * 0.8;
                
                let startAngle = -Math.PI / 2;
                
                data.forEach((value, index) => {
                    if (value > 0) {
                        const angle = (value / total) * 2 * Math.PI;
                        
                        ctx.beginPath();
                        ctx.moveTo(centerX, centerY);
                        ctx.arc(centerX, centerY, radius, startAngle, startAngle + angle);
                        ctx.closePath();
                        
                        ctx.fillStyle = colors[index];
                        ctx.fill();
                        
                        startAngle += angle;
                    }
                });

                // Update legend
                let legendHTML = '';
                data.forEach((value, index) => {
                    if (value > 0) {
                        const percentage = ((value / total) * 100).toFixed(1);
                        legendHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background: ${colors[index]}"></div>
                                <span>${labels[index]}: ${money(value)} (${percentage}%)</span>
                            </div>
                        `;
                    }
                });
                legendElement.innerHTML = legendHTML;
            }

            // Update amortization table
            function updateAmortizationTable(result) {
                if (result.mode !== 'payment' || !result.schedule) return;

                let html = '';
                let currentYear = 1;
                let yearlyPayment = 0;
                let yearlyPrincipal = 0;
                let yearlyInterest = 0;
                let yearEndBalance = 0;

                result.schedule.forEach((payment, index) => {
                    yearlyPayment += payment.payment;
                    yearlyPrincipal += payment.principal;
                    yearlyInterest += payment.interest;
                    yearEndBalance = payment.balance;

                    // End of year or last payment
                    if (payment.month % 12 === 0 || index === result.schedule.length - 1) {
                        if (currentYear <= 5) {
                            html += `
                                <tr>
                                    <td>${currentYear}</td>
                                    <td>${money(yearlyPayment)}</td>
                                    <td>${money(yearlyPrincipal)}</td>
                                    <td>${money(yearlyInterest)}</td>
                                    <td>${money(yearEndBalance)}</td>
                                </tr>
                            `;
                        }
                        
                        currentYear++;
                        yearlyPayment = 0;
                        yearlyPrincipal = 0;
                        yearlyInterest = 0;
                    }
                });

                els.amortizationBody.innerHTML = html;
            }

            // Generate AI insights
            function generateInsights(result) {
                const insights = [];

                if (result.mode === 'payment') {
                    // PMI insight
                    if (result.needsPMI) {
                        const additionalDP = Math.max(0, result.homePrice * 0.2 - result.dpAmount);
                        insights.push({
                            icon: 'fas fa-shield-alt',
                            type: 'tip',
                            title: 'Eliminate PMI',
                            message: `Increase down payment by ${money(additionalDP)} to reach 20% and eliminate PMI (saves ${money(result.monthlyPMI)}/month)`
                        });
                    }

                    // Term comparison
                    if (result.term > 15) {
                        const rate15 = result.rate / 100 / 12;
                        const months15 = 15 * 12;
                        const payment15 = result.loanAmount * (rate15 * Math.pow(1 + rate15, months15)) / (Math.pow(1 + rate15, months15) - 1);
                        const interest15 = payment15 * months15 - result.loanAmount;
                        const interestSavings = result.totalInterest - interest15;
                        
                        insights.push({
                            icon: 'fas fa-calendar',
                            type: 'comparison',
                            title: 'Consider 15-Year Term',
                            message: `15-year loan: ${money(payment15)}/month, saves ${money(interestSavings)} in total interest`
                        });
                    }

                    // Extra payment benefits
                    if (result.extraMonthly > 0 || result.extraOnce > 0) {
                        const withoutExtra = generateSchedule(result.loanAmount, result.rate / 100 / 12, result.monthlyPI, result.term * 12, 0, 0);
                        const monthsSaved = withoutExtra.length - result.schedule.length;
                        const interestSaved = withoutExtra.reduce((sum, p) => sum + p.interest, 0) - result.totalInterest;
                        
                        insights.push({
                            icon: 'fas fa-rocket',
                            type: 'savings',
                            title: 'Extra Payment Impact',
                            message: `Extra payments save ${monthsSaved} months and ${money(interestSaved)} in interest`
                        });
                    } else {
                        insights.push({
                            icon: 'fas fa-plus-circle',
                            type: 'tip',
                            title: 'Consider Extra Payments',
                            message: `Adding $100/month could save years on your loan and thousands in interest`
                        });
                    }

                    // Interest rate insight
                    if (result.rate > 7) {
                        insights.push({
                            icon: 'fas fa-percentage',
                            type: 'warning',
                            title: 'High Interest Rate',
                            message: `Consider improving credit score or shopping for better rates to reduce monthly payment`
                        });
                    }
                }

                // Render insights
                let insightsHTML = '';
                insights.forEach(insight => {
                    const colorClass = {
                        'tip': 'insight-tip',
                        'savings': 'insight-savings',
                        'warning': 'insight-warning',
                        'comparison': 'insight-comparison',
                        'info': 'insight-info'
                    }[insight.type];

                    insightsHTML += `
                        <li class="insight-item ${colorClass}">
                            <div class="insight-icon">
                                <i class="${insight.icon}"></i>
                            </div>
                            <div class="insight-content">
                                <strong>${insight.title}</strong>
                                <p>${insight.message}</p>
                            </div>
                        </li>
                    `;
                });

                els.insightsList.innerHTML = insightsHTML;
            }

            // Show full schedule modal
            function showFullSchedule() {
                if (!currentCalculation || !currentCalculation.schedule) return;

                let html = '';
                currentCalculation.schedule.forEach(payment => {
                    html += `
                        <tr>
                            <td>${payment.month}</td>
                            <td>${money(payment.payment)}</td>
                            <td>${money(payment.principal)}</td>
                            <td>${money(payment.interest)}</td>
                            <td>${money(payment.extra)}</td>
                            <td>${money(payment.balance)}</td>
                        </tr>
                    `;
                });

                els.fullScheduleBody.innerHTML = html;
                els.scheduleModal.showModal();
            }

            // Email results
            function emailResults() {
                if (!currentCalculation) return;

                let subject, body;

                if (currentCalculation.mode === 'payment') {
                    subject = encodeURIComponent(`Mortgage Calculator Results - ${money(currentCalculation.totalMonthly)}/month`);
                    body = encodeURIComponent(
                        `Mortgage Calculator Results from HomeLoan Pro\n\n` +
                        `Home Price: ${money(currentCalculation.homePrice)}\n` +
                        `Down Payment: ${money(currentCalculation.dpAmount)} (${currentCalculation.dpPercent.toFixed(1)}%)\n` +
                        `Loan Amount: ${money(currentCalculation.loanAmount)}\n` +
                        `Interest Rate: ${currentCalculation.rate.toFixed(2)}%\n` +
                        `Term: ${currentCalculation.term} years\n\n` +
                        `Monthly Payment Breakdown:\n` +
                        `Principal & Interest: ${money(currentCalculation.monthlyPI)}\n` +
                        `Property Tax: ${money(currentCalculation.monthlyTax)}\n` +
                        `Insurance: ${money(currentCalculation.monthlyInsurance)}\n` +
                        `PMI: ${money(currentCalculation.monthlyPMI)}\n` +
                        `HOA: ${money(currentCalculation.monthlyHOA)}\n` +
                        `Total Monthly: ${money(currentCalculation.totalMonthly)}\n\n` +
                        `Total Interest: ${money(currentCalculation.totalInterest)}\n\n` +
                        `Calculate your mortgage at: https://www.homeloanpro.com`
                    );
                }

                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            }

            // Share results
            function shareResults() {
                if (!navigator.share) {
                    // Fallback: copy to clipboard
                    copyToClipboard();
                    return;
                }

                const shareData = {
                    title: 'Mortgage Calculator Results',
                    text: `Check out my mortgage calculation: ${money(currentCalculation.totalMonthly)}/month`,
                    url: window.location.href
                };

                navigator.share(shareData)
                    .then(() => showNotification('Results shared successfully!', 'success'))
                    .catch(() => copyToClipboard());
            }

            // Copy results to clipboard
            function copyToClipboard() {
                const text = `My mortgage payment: ${money(currentCalculation.totalMonthly)}/month. Calculate yours at ${window.location.href}`;
                
                navigator.clipboard.writeText(text)
                    .then(() => showNotification('Results copied to clipboard!', 'success'))
                    .catch(() => showNotification('Unable to copy results', 'error'));
            }

            // Load predefined scenarios
            function loadScenario(scenarioType) {
                // Clear previous comparisons
                comparisons = [];
                
                // Set base values
                const baseValues = {
                    homePrice: 400000,
                    dpAmount: 80000,
                    interestRate: 6.75,
                    state: 'CA'
                };

                // Set base values
                Object.keys(baseValues).forEach(key => {
                    if (els[key]) els[key].value = baseValues[key];
                });

                switch (scenarioType) {
                    case '15year':
                        // Add 30-year scenario
                        setTerm(30);
                        calculate();
                        comparisons.push({
                            name: '30-Year Fixed',
                            ...currentCalculation
                        });
                        
                        // Add 15-year scenario
                        setTerm(15);
                        calculate();
                        comparisons.push({
                            name: '15-Year Fixed',
                            ...currentCalculation
                        });
                        break;

                    case 'rates':
                        // Compare different rates
                        [5.5, 6.0, 6.5, 7.0].forEach(rate => {
                            els.interestRate.value = rate;
                            calculate();
                            comparisons.push({
                                name: `${rate}% Rate`,
                                ...currentCalculation
                            });
                        });
                        break;

                    case 'downpayment':
                        // Compare different down payments
                        [40000, 80000, 120000].forEach(dp => {
                            els.dpAmount.value = dp;
                            syncDownPayment(false);
                            calculate();
                            comparisons.push({
                                name: `${money(dp)} Down`,
                                ...currentCalculation
                            });
                        });
                        break;

                    case 'extraPayment':
                        // Compare with and without extra payments
                        els.extraMonthly.value = 0;
                        calculate();
                        comparisons.push({
                            name: 'No Extra Payment',
                            ...currentCalculation
                        });

                        els.extraMonthly.value = 200;
                        calculate();
                        comparisons.push({
                            name: '$200 Extra/Month',
                            ...currentCalculation
                        });
                        break;
                }

                renderComparisons();
                showNotification(`${scenarioType.replace(/([A-Z])/g, ' $1')} scenarios loaded', 'success`);
            }

            function renderComparisons() {
                if (comparisons.length === 0) {
                    els.comparisonCards.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">No scenarios to compare. Select a scenario above.</p>';
                    return;
                }

                let html = '';
                comparisons.forEach((scenario, index) => {
                    // Find the base scenario for comparison (first one)
                    const baseScenario = comparisons[0];
                    const monthlySavings = index > 0 ? baseScenario.totalMonthly - scenario.totalMonthly : 0;
                    const interestSavings = index > 0 ? baseScenario.totalInterest - scenario.totalInterest : 0;
                    
                    html += `
                        <div class="comparison-card">
                            <div class="comparison-header">
                                <h4 class="comparison-title">${scenario.name}</h4>
                                ${monthlySavings > 0 ? `<div class="comparison-savings">Saves ${money(monthlySavings)}/mo</div>` : ''}
                            </div>
                            <div class="comparison-details">
                                <div class="comparison-row">
                                    <span>Monthly Payment:</span>
                                    <strong>${money(scenario.totalMonthly)}</strong>
                                </div>
                                <div class="comparison-row">
                                    <span>Loan Amount:</span>
                                    <span>${money(scenario.loanAmount)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span>Interest Rate:</span>
                                    <span>${scenario.rate.toFixed(2)}%</span>
                                </div>
                                <div class="comparison-row">
                                    <span>Term:</span>
                                    <span>${scenario.term} years</span>
                                </div>
                                <div class="comparison-row">
                                    <span>Total Interest:</span>
                                    <span>${money(scenario.totalInterest)}</span>
                                </div>
                                ${interestSavings > 0 ? `
                                <div class="comparison-row">
                                    <span>Interest Savings:</span>
                                    <span style="color: #166534; font-weight: 600;">${money(interestSavings)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                els.comparisonCards.innerHTML = html;
            }

            // Reset form
            function resetForm() {
                // Reset inputs to defaults
                els.homePrice.value = 400000;
                els.dpAmount.value = 80000;
                els.dpPercent.value = 20;
                els.interestRate.value = 6.75;
                els.state.value = '';
                els.propertyTax.value = 0;
                els.homeInsurance.value = 960;
                els.pmiRate.value = 0.8;
                els.hoaFees.value = 0;
                els.extraMonthly.value = 0;
                els.extraOnce.value = 0;
                els.termCustom.value = '';

                // Reset UI state
                setTerm(30);
                switchDPMode(false);
                comparisons = [];
                renderComparisons();

                // Clear error messages
                $$('.error-message').forEach(el => el.classList.remove('show'));
                $$('.form-input').forEach(el => el.classList.remove('invalid'));

                // Recalculate
                updatePropertyTax();
                updateInsurance();
                calculate();

                showNotification('Form reset to defaults', 'info');
            }

            // Utility functions
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            function showNotification(message, type = 'info') {
                // Simple notification system
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            // Initialize the calculator
            init();
        });
    </script>
</body>
</html>
