<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO & Metadata Updated for Affordability -->
    <title>AI Affordability Calculator 2025 | How Much Home Can I Afford? | FinGuid</title>
    <meta name="description" content="World's Best AI-Powered Affordability Calculator by FinGuid. Calculate the maximum home price you can afford based on your income, debts (DTI), and down payment with live FRED rates. WCAG 2.1 AA compliant.">
    <meta name="keywords" content="affordability calculator, mortgage affordability, how much home can I afford, home affordability calculator, DTI calculator, debt-to-income ratio, mortgage pre-qualification, AI home buying, FinGuid, maximum house price, USA home loan, American home buyers, FRED API rates, live rates">
    
    <meta name="author" content="FinGuid USA">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="theme-color" content="#24ACB9">
    <meta property="og:type" content="website">
    <meta property="og:title" content="AI Home Affordability Calculator 2025 | Live FRED Rates | FinGuid">
    <meta property="og:description" content="Free AI affordability calculator to see how much home you can afford based on DTI, income, and live FRED rates.">
    
    <link rel="canonical" href="https://www.finguid.com/calculators/affordability">
    
    <!-- 
      PWA FIX: Inlined PWA Web App Manifest
      This fulfills the PWA requirement.
    -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22FinGuid%20AI%20Affordability%20Calculator%22,%22short_name%22:%22AffordabilityCalc%22,%22description%22:%22AI-Powered%20Home%20Affordability%20Calculator%20with%20DTI%20and%20Live%20Rates.%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#FFFFFD%22,%22theme_color%22:%22#24ACB9%22,%22icons%22:[{%22src%22:%22https://placehold.co/192x192/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://placehold.co/512x512/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22512x512%22}]}">
    
    <!-- 
      START: Inlined CSS
      Includes all styles from the mortgage-calculator template + affordability-specific additions.
    -->
    <style>
        /* === START: Global Variables (Brand Color Match) === */
        :root {
            --primary: #24ACB9; /* Teal (Matches FinGuid Image & Car Lease CSS) */
            --primary-dark: #19343B; /* Dark Teal (Matches Car Lease CSS) */
            --accent: #FFC107;
            --accent-dark: #E69500;
            --text: #1F2121;
            --text-light: #64748B;
            --bg: #FFFFFD;
            --bg-secondary: #F5F7FA;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --error: #EF4444;
            --success: #10B981;
            --fred-color: #A31B20; /* FRED standard color for Live Rates button */
        }

        [data-color-scheme="dark"] {
            --text: #E1E8ED;
            --text-light: #B8C5D0;
            --bg: #1F2121;
            --bg-secondary: #242B36;
            --card: #181919;
            --border: #38444D;
        }
        /* === END: Global Variables === */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { 
            font-size: 16px; 
            -webkit-font-smoothing: antialiased; 
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* ===== HEADER STYLES (From Mortgage Calc) ===== */
        .header {
            position: sticky;
            top: 0;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--primary);
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .logo:hover { color: var(--primary-dark); }

        .calculator-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            flex-shrink: 0;
            margin-left: 16px;
            flex-basis: auto;
            min-width: 0;
        }

        .header-features {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 24px;
            flex-grow: 1;
            justify-content: flex-start;
            overflow: hidden;
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        .header-feature-item {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            animation: pulse-color-text 2.5s infinite ease-in-out;
        }
        .header-feature-item:nth-child(1) { animation-delay: 0s; }
        .header-feature-item:nth-child(2) { animation-delay: 0.2s; }
        .header-feature-item:nth-child(3) { animation-delay: 0.4s; }
        .header-feature-item:nth-child(4) { animation-delay: 0.6s; }

        @keyframes pulse-color-text {
            0%, 100% {
                opacity: 0.8;
                color: var(--text-light);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                color: var(--primary);
                transform: scale(1.03);
            }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:hover { background: var(--primary); color: white; }
        .icon-btn.active { background: var(--primary); color: white; }

        #pwa-install-btn {
            display: none;
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #pwa-install-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        /* ===== END HEADER STYLES ===== */

        /* ===== SPONSOR BANNER (From Mortgage Calc) ===== */
        .sponsor-banner {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .sponsor-text { font-weight: 500; flex: 1; min-width: 200px; }
        .sponsor-buttons { display: flex; gap: 8px; }
        .sponsor-btn {
            padding: 8px 12px;
            background: white;
            color: #6366F1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .sponsor-btn:hover { background: var(--accent); color: var(--text); transform: translateY(-2px); }

        /* ===== MAIN CALCULATOR (Layout from Mortgage Calc) ===== */
        .calculator-wrapper {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            padding: 24px 0;
            margin-bottom: 40px;
        }

        .inputs-panel, .results-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        /* Sticky input panel for affordability */
        .inputs-panel {
            position: sticky;
            top: 100px; /* Adjust based on header height */
            align-self: flex-start;
        }
        
        .inputs-panel:hover, .results-panel:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .panel-title { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }

        .section-heading {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        /* FRED rate styles (From Mortgage Calc) */
        .fred-rates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        #fred-last-updated {
            font-size: 11px;
            color: var(--text-light);
            text-align: left;
        }
        .fred-branding {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 600;
        }
        .fred-branding a { color: var(--text-light); text-decoration: none; }
        .fred-branding a:hover { color: var(--primary); }

        .live-rates-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .rate-btn {
            flex-grow: 1;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .rate-btn:hover {
            background: var(--card);
            border-color: var(--primary);
            color: var(--primary);
        }
        .rate-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .rate-btn:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Tooltip Styles (From Mortgage Calc) */
        .tooltip {
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
            display: inline-flex;
            align-items: center;
            color: var(--text-light);
        }
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-light);
            color: var(--card);
            font-style: normal;
            font-size: 10px;
            font-weight: 700;
            line-height: 14px;
            margin-left: 5px;
            transition: all 0.2s ease;
        }
        .tooltip:hover .tooltip-icon,
        .tooltip:focus .tooltip-icon {
            background: var(--primary);
            outline: none;
        }
        .tooltip:focus { outline: none; }

        .tooltip-box {
            position: fixed;
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 200px;
            white-space: normal;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .input-wrapper { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            min-width: 0; 
        }

        input[type="number"], input[type="text"], select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 0;
            width: 100%;
        }

        /* WCAG Focus Styles (From Mortgage Calc) */
        input[type="number"]:focus, input[type="text"]:focus, select:focus, 
        .rate-btn:focus, .sponsor-btn:focus, .icon-btn:focus, 
        #pwa-install-btn:focus, .tab-btn:focus, .faq-question:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.25);
        }
        .icon-btn:focus, #pwa-install-btn:focus, .sponsor-btn:focus {
             box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
        }

        .input-addon {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            min-width: 50px;
            text-align: center;
        }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Ad Slot (From Mortgage Calc) */
        .ad-slot {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
        }
        .ad-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .ad-placeholder {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 600;
        }

        /* ===== RESULTS SECTION (Adapted for Affordability) ===== */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px; /* More padding */
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(36, 172, 185, 0.2);
            text-align: center;
        }
        .summary-label { font-size: 1rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .payment-amount { display: flex; align-items: baseline; justify-content: center; gap: 8px; margin: 8px 0; }
        .amount { font-size: 2.5rem; font-weight: bold; } /* Larger amount */
        .unit { font-size: 1rem; opacity: 0.9; }
        .payment-breakdown { font-size: 1rem; opacity: 0.8; } /* Larger breakdown text */

        .tabs { margin-bottom: 24px; }
        .tab-buttons { 
            display: flex; 
            gap: 4px; 
            border-bottom: 2px solid var(--border); 
            margin-bottom: 24px; 
            overflow-x: auto; 
        }

        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:focus {
            color: var(--primary);
            box-shadow: none;
            border-bottom-color: rgba(36, 172, 185, 0.5);
        }
        .tab-btn.active:focus { border-bottom-color: var(--primary); }

        .tab-content { display: none; padding: 8px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        .tab-content:focus-visible {
            outline: 2px solid var(--primary);
            border-radius: 4px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .results-heading {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin: 16px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; } /* Wider minmax */
        .result-box { background: var(--bg-secondary); padding: 16px; border-radius: 6px; border-left: 4px solid var(--border); transition: all 0.2s; }
        .result-box:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .result-box.highlight { 
            border-left-color: var(--primary); 
            background: rgba(36, 172, 185, 0.1); 
        }
        .result-box.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .result-box.accent {
            border-left-color: var(--accent-dark);
            background: rgba(255, 193, 7, 0.1);
        }
        /* Style for PMI Alert (from affordability.css) */
        .result-box.alert-pmi {
            border-left-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .result-label { 
            display: block; 
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
        }
        .result-value { 
            display: block; 
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        /* AI INSIGHTS (From Mortgage Calc) */
        .insights-container { margin-top: 20px; }
        .insight-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .insight-box.success { border-left-color: var(--success); }
        .insight-box.warning { border-left-color: var(--accent-dark); }
        .insight-box.error { border-left-color: var(--error); }
        /* Insight type from affordability.css */
        .insight-box.monetization {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        /* ===== PARTNER SECTION (From Mortgage Calc) ===== */
        .footer-sponsor {
            background: linear-gradient(135deg, rgba(36, 172, 185, 0.1) 0%, rgba(25, 52, 59, 0.1) 100%);
            padding: 40px;
            border-bottom: 1px solid rgba(36, 172, 185, 0.2);
            border-radius: 12px;
        }
        .sponsor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; }
        .sponsor-item { text-align: center; padding: 16px; border-radius: 8px; background: var(--card); transition: all 0.2s; }
        .sponsor-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sponsor-item h4 { margin-bottom: 8px; color: var(--primary); font-size: 1rem; }
        .sponsor-item p { color: var(--text-light); margin-bottom: 12px; font-size: 0.875rem; line-height: 1.5; }
        .sponsor-item a {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .sponsor-item a:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        .sponsor-item a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(36, 172, 185, 0.3); }

        /* ===== FOOTER (From Mortgage Calc) ===== */
        .footer { background: var(--card); border-top: 1px solid var(--border); padding: 32px 0; margin-top: 40px; }
        .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .footer-section h4 { font-size: 13px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .footer-section a { display: block; font-size: 12px; color: var(--text-light); text-decoration: none; margin-bottom: 8px; transition: color 0.3s ease; }
        .footer-section a:hover, .footer-section a:focus { 
            color: var(--primary); 
            text-decoration: underline;
            outline: none;
        }
        .compliance-badges { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; font-size: 12px; }
        .badge { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; font-weight: 600; color: var(--text-light); }
        .disclaimer { font-size: 11px; color: var(--text-light); line-height: 1.6; padding-top: 20px; border-top: 1px solid var(--border); }
        .footer-bottom { text-align: center; font-size: 12px; color: var(--text-light); padding-top: 16px; border-top: 1px solid var(--border); }

        /* ===== FAQ ACCORDION (From Mortgage Calc) ===== */
        .faq-section { margin: 40px 0; }
        .faq-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 20px; text-align: center; }
        .faq-container { max-width: 900px; margin: 0 auto; }
        .faq-item { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; }
        .faq-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .faq-question { padding: 16px; background: var(--bg-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text); transition: all 0.3s ease; }
        .faq-question:hover { background: var(--card); color: var(--primary); }
        .faq-question.active { background: var(--primary); color: white; }
        .faq-question:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4) inset;
            color: var(--primary);
        }
        .faq-icon { font-size: 18px; transition: transform 0.3s ease; }
        .faq-question.active .faq-icon { transform: rotate(180deg); }
        .faq-answer { display: none; padding: 16px; background: var(--card); color: var(--text-light); line-height: 1.8; font-size: 14px; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }

        /* ===== GDPR/CCPA COOKIE BANNER (From Mortgage Calc) ===== */
        #cookie-consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            color: var(--text);
            padding: 24px;
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .cookie-consent-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-light);
            flex: 1 1 400px;
        }
        .cookie-consent-text a { color: var(--primary); text-decoration: underline; }
        .cookie-consent-text a:hover { color: var(--primary-dark); }
        #cookie-consent-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #cookie-consent-btn:hover { background: var(--primary-dark); }
        #cookie-consent-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        
        /* Visually hidden class for accessibility */
        .visually-hidden {
            border: 0;
            clip: rect(0 0 0 0);
            height: 1px;
            margin: -1px;
            overflow: hidden;
            padding: 0;
            position: absolute;
            width: 1px;
        }

        /* ===== RESPONSIVE (From Mortgage Calc) ===== */
        @media (max-width: 1024px) {
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel {
                position: static; /* Remove sticky on mobile */
            }
            .footer-content { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .header-features { display: none; }
            .sponsor-banner { flex-direction: column; gap: 12px; }
            .sponsor-buttons { flex: 1 1 100%; justify-content: space-between; }
            .tab-buttons { flex-wrap: nowrap; overflow-x: auto; }
            .inputs-panel, .results-panel { padding: 16px; }
            .footer-sponsor { padding: 24px; }
        }

        @media (max-width: 480px) {
            .calculator-title { display: none; }
            .header-features { display: none; }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .header-controls {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            #pwa-install-btn { flex-grow: 1; }
            .payment-breakdown { font-size: 0.75rem; }
            .amount { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; }
            .sponsor-grid { grid-template-columns: 1fr; }
            #cookie-consent-banner { flex-direction: column; text-align: center; }
            .cookie-consent-text { flex-basis: auto; }
            #cookie-consent-btn { width: 100%; }
        }

        /* ===== PRINT STYLE (From Mortgage Calc) ===== */
        @media print {
            .header, .sponsor-banner, .header-controls, .footer-sponsor, .faq-section, 
            .footer, .ad-slot, #cookie-consent-banner, .tab-buttons {
                display: none;
            }
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel, .results-panel { box-shadow: none; border: 1px solid #ccc; }
            .tab-content.active { display: block; }
            .tab-content { display: none; }
        }
    </style>
    <!-- END: Inlined CSS -->

    <!-- Google Analytics Script (From Requirements) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYBL2CDNQJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NYBL2CDNQJ');
    </script>

    <!-- PWA Install & Preload Logic (From Mortgage Calc) -->
    <script>
        // PWA Install Detection
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            const pwaInstall = document.getElementById('pwa-install-btn');
            if (pwaInstall) pwaInstall.style.display = 'flex';
        });
    </script>
</head>
<body>
    <!-- Header (From Mortgage Calc) -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="https://www.finguid.com" class="logo">
                    <span role="img" aria-label="Money bag emoji">üí∞</span>
                    <span>FinGuid USA</span>
                </a>
                
                <!-- Title Updated -->
                <span class="calculator-title">Home Affordability Calculator</span>

                <div class="header-features" aria-hidden="true">
                    <span class="header-feature-item">ü§ñ AI Powered</span>
                    <span class="header-feature-item">üìà Live FRED Rates</span>
                    <span class="header-feature-item">üí° DTI Insights</span>
                    <span class="header-feature-item">‚úÖ WCAG 2.1 AA</span>
                </div>

                <div class="header-controls">
                    <button type="button" id="pwa-install-btn" aria-label="Install App">üì± Install</button>
                    <button type="button" class="icon-btn" id="darkModeToggle" aria-label="Toggle dark mode" title="Dark mode">üåô</button>
                    <button type="button" class="icon-btn" id="voiceToggle" aria-label="Voice control" title="Voice commands">üé§</button>
                    <button type="button" class="icon-btn" id="ttsToggle" aria-label="Text to speech" title="Read results">üîä</button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Sponsor Banner (From Mortgage Calc) -->
    <div class="sponsor-banner">
        <span class="sponsor-text">üéÅ Get Pre-Qualified and Receive a $1,000 Lender Credit</span>
        <div class="sponsor-buttons">
            <button type="button" class="sponsor-btn" onclick="location.href='#our-partners'">View Partners ‚Üí</button>
            <button type="button" class="sponsor-btn" onclick="app.showPartnerAlert()">Become our partner ‚Üí</button>
        </div>
    </div>

    <main class="container" role="main">
        <div class="calculator-wrapper">
            <!-- ===== INPUTS PANEL (Content from Affordability Calc) ===== -->
            <section class="inputs-panel" role="region" aria-labelledby="inputs-title">
                <h2 class="panel-title" id="inputs-title">üìã Your Financial Profile</h2>

                <div class="section-heading">Income & Debts (DTI)</div>
                <div class="form-group">
                    <label class="form-label" for="annualIncome">Annual Household Income
                        <span class="tooltip" data-tooltip="Your total gross income (before taxes) for the year." tabindex="0" role="tooltip" id="tooltip-income">
                            <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-addon" aria-hidden="true">$</span>
                        <input type="number" id="annualIncome" value="80000" min="0" step="1000" aria-label="Annual Household Income" aria-describedby="tooltip-income">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="monthlyDebts">Total Monthly Debts
                        <span class="tooltip" data-tooltip="All recurring monthly debt payments (car loans, student loans, credit card minimums)." tabindex="0" role="tooltip" id="tooltip-debts">
                            <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-addon" aria-hidden="true">$</span>
                        <input type="number" id="monthlyDebts" value="500" min="0" step="50" aria-label="Total Monthly Debts" aria-describedby="tooltip-debts">
                    </div>
                </div>

                <div class="section-heading">Loan Details</div>
                
                 <div class="form-group">
                    <label class="form-label" for="downPayment">Available Down Payment
                        <span class="tooltip" data-tooltip="The total cash you have saved for a down payment." tabindex="0" role="tooltip" id="tooltip-dp">
                            <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-addon" aria-hidden="true">$</span>
                        <input type="number" id="downPayment" value="20000" min="0" step="1000" aria-label="Available Down Payment" aria-describedby="tooltip-dp">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="interestRate">
                        Interest Rate %
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="interestRate" value="6.50" min="0" max="12" step="0.01" aria-label="Interest rate">
                        <span class="input-addon" aria-hidden="true">%</span>
                    </div>
                    
                    <!-- FRED Rates (From Mortgage Calc) -->
                    <div class="fred-rates-header">
                        <span id="fred-last-updated">Loading live rates...</span>
                        <span class="fred-branding">
                            Data via <a href="https://fred.stlouisfed.org/" target="_blank" rel="noopener">FRED¬Æ</a>
                        </span>
                    </div>
                    <div class="live-rates-container">
                        <button type="button" class="rate-btn" id="rate-btn-30yr" disabled>30-Yr Fixed: ...</button>
                        <button type="button" class="rate-btn" id="rate-btn-15yr" disabled>15-Yr Fixed: ...</button>
                        <button type="button" class="rate-btn" id="rate-btn-10yr" disabled>10-Yr Treasury: ...</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="mortgageTerm">Loan Term
                            <span class="tooltip" data-tooltip="The length of the loan in years." tabindex="0" role="tooltip" id="tooltip-term">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <select id="mortgageTerm" aria-label="Loan term" aria-describedby="tooltip-term">
                            <option value="15">15 Years</option>
                            <option value="20">20 Years</option>
                            <option value="30" selected>30 Years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="zipCode">ZIP Code
                            <span class="tooltip" data-tooltip="Used for AI insights and local recommendations." tabindex="0" role="tooltip" id="tooltip-zip">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <input type="text" id="zipCode" placeholder="e.g., 90210" maxlength="5" aria-label="ZIP code" aria-describedby="tooltip-zip">
                    </div>
                </div>
            </section>

            <!-- ===== RESULTS PANEL (Content from Affordability Calc) ===== -->
            <section class="results-panel" role="region" aria-labelledby="results-title">
                <h2 class="panel-title" id="results-title">üìä Affordability Analysis</h2>

                <!-- Ad Slot (From Mortgage Calc) -->
                <div class="ad-slot" role="complementary" aria-label="Advertisement">
                    <p class="ad-label">ADVERTISEMENT</p>
                    <div class="ad-placeholder">
                        <p>Compare Top Mortgage Lenders in Your Area</p>
                    </div>
                </div>

                <!-- Main Summary (Adapted for Affordability) -->
                <div class="summary-card">
                    <div class="summary-label">Maximum Affordable Home Price</div>
                    <div class="payment-amount">
                        <span class="amount" id="result-price" aria-live="polite">$0</span>
                    </div>
                    <div class="payment-breakdown" id="result-monthly-piti" aria-live="polite">Max Monthly PITI: $0</div>
                </div>
                
                <div class="tabs">
                    <!-- Tabs (Adapted for Affordability) -->
                    <div class="tab-buttons" role="tablist" aria-label="Results sections">
                        <button type="button" class="tab-btn active" role="tab" aria-controls="analysis" aria-selected="true" id="tab-analysis">Affordability Breakdown</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="insights" aria-selected="false" id="tab-insights" tabindex="-1">AI Insights</button>
                    </div>

                    <!-- Breakdown Tab -->
                    <div class="tab-content active" id="analysis" role="tabpanel" aria-labelledby="tab-analysis" tabindex="0">
                        <h3 class="results-heading">Your Qualification Details</h3>
                        <div class="result-grid">
                            <div class="result-box highlight">
                                <div class="result-label">Max Loan Amount</div>
                                <div class="result-value" id="result-loan-amount">$0</div>
                            </div>
                            <div class="result-box highlight">
                                <div class="result-label">Max Monthly PITI</div>
                                <div class="result-value" id="result-monthly-piti-detail">$0</div>
                            </div>
                        </div>
                        
                        <h3 class="results-heading">Estimated Monthly Payment Breakdown (PITI)</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <div class="result-label">Est. P&I</div>
                                <div class="result-value" id="breakdown-pi">$0</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Est. Tax</div>
                                <div class="result-value" id="breakdown-tax">$0</div>
                            </div>
                             <div class="result-box">
                                <div class="result-label">Est. Insurance</div>
                                <div class="result-value" id="breakdown-ins">$0</div>
                            </div>
                            <div class="result-box" id="pmi-box">
                                <div class="result-label">Est. PMI</div>
                                <div class="result-value" id="breakdown-pmi">$0</div>
                            </div>
                        </div>
                        
                        <h3 class="results-heading">Debt-to-Income (DTI) Ratios</h3>
                         <div class="result-grid">
                            <div class="result-box">
                                <div class="result-label">Front-End DTI (Housing)</div>
                                <div class="result-value" id="dti-front-end">0.00%</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Back-End DTI (Total Debt)</div>
                                <div class="result-value" id="dti-back-end">0.00%</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Insights Tab -->
                    <div class="tab-content" id="insights" role="tabpanel" aria-labelledby="tab-insights" tabindex="0">
                         <h3 class="results-heading">ü§ñ AI-Powered Insights</h3>
                        <div class="insights-container" id="insightsContainer" aria-live="polite">
                            <div class="insight-box">
                                <strong>ü§ñ AI Advisor:</strong> Enter your details to generate personalized insights...
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Partner Section (From Mortgage Calc) -->
        <section class="footer-sponsor" id="our-partners" aria-labelledby="partners-title">
            <div class="container">
                <h3 id="partners-title" style="text-align: center; margin-bottom: 24px; color: var(--primary); font-size: 24px; font-weight: 700;">Our Partners</h3>
                <div class="sponsor-grid">
                    <div class="sponsor-item">
                        <h4>üí≥ Mortgage Pre-Approval</h4>
                        <p>Compare rates from top lenders. Get pre-approved in minutes. Save thousands on your home loan.</p>
                        <a href="#affiliate-link-1" onclick="app.showPartnerAlert('Mortgage Lender'); return false;" aria-label="Get Quotes for Mortgage Pre-Approval">Get Quotes ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üõ°Ô∏è Home Insurance Quotes</h4>
                        <p>Compare insurance rates from major providers. Save up to 40% on coverage. Get instant quotes.</p>
                        <a href="#affiliate-link-2" onclick="app.showPartnerAlert('Insurance'); return false;" aria-label="Compare Rates for Home Insurance">Compare Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üè† Home Equity (HELOC)</h4>
                        <p>Access your home's equity. Get quotes for HELOCs or cash-out refinancing. Informed decisions.</p>
                        <a href="#affiliate-link-3" onclick="app.showPartnerAlert('HELOC'); return false;" aria-label="Check Rates for Home Equity Loans">Check Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üîß Home Services</h4>
                        <p>Affordable plans for home warranties, repairs, and moving services. Protect your investment.</p>
                        <a href="#affiliate-link-4" onclick="app.showPartnerAlert('Services'); return false;" aria-label="View Plans for Home Services">View Plans ‚Üí</a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- FAQ Section (From Mortgage Calc, content to be updated by JS) -->
        <section class="faq-section" aria-labelledby="faq-title">
            <h2 class="faq-title" id="faq-title">‚ùì Frequently Asked Questions</h2>
            <div class="faq-container" id="faqContainer">
                <!-- FAQs will be dynamically inserted here by JS -->
            </div>
        </section>

        <!-- Footer (From Mortgage Calc) -->
        <footer class="footer" role="contentinfo">
            <div class="container">
                <div class="footer-content">
                    <nav class="footer-section" role="navigation" aria-label="About this calculator">
                        <h4>About Affordability Calc</h4>
                        <a href="#how-it-works">How It Works (DTI)</a>
                        <a href="#features">Features</a>
                        <a href="#faq">FAQ</a>
                        <a href="#contact">Contact Us</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Learn more about mortgages">
                        <h4>Learn More</h4>
                        <a href="#piti">What is PITI?</a>
                        <a href="#dti">What is DTI?</a>
                        <a href="#rates">Current Rates</a>
                        <a href="#blog">Blog</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Financial resources">
                        <h4>Resources</h4>
                        <a href="/calculators/mortgage">Mortgage Calculator</a>
                        <a href="#tools">Financial Tools</a>
                        <a href="#education">Education</a>
                        <a href="#glossary">Glossary</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Legal links">
                        <h4>Legal</h4>
                        <a href="#privacy">Privacy Policy</a>
                        <a href="#terms">Terms of Service</a>
                        <a href="#disclaimer">Disclaimer</a>
                        <a href="#affiliate">Affiliate Disclosure</a>
                    </nav>
                </div>

                <div class="compliance-badges" role="list" aria-label="Compliance Badges">
                    <span class="badge" role="listitem">üîí SSL Secured</span>
                    <span class="badge" role="listitem">‚úÖ GDPR Compliant</span>
                    <span class="badge" role="listitem">‚úÖ CCPA Compliant</span>
                    <span class="badge" role="listitem">‚úÖ FTC Compliant</span>
                    <span class="badge" role="listitem">‚ôø WCAG 2.1 AA</span>
                </div>

                <section class="disclaimer" aria-label="Disclaimers and Disclosures">
                    <strong>Educational & Informational Only:</strong> This affordability calculator is for educational and informational purposes only. It is NOT financial advice. Results are estimates based on common DTI ratios (28%/36%) and do not represent a loan offer or pre-qualification. Actual mortgage rates, terms, and affordability may vary significantly based on credit score, debt-to-income ratio, location, loan type, down payment percentage, credit history, employment status, and many other factors. Lenders may impose additional requirements or restrictions. Always consult with a qualified mortgage professional, financial advisor, or lender before making any borrowing decisions.
                    <br><br>
                    <strong>Affiliate Disclosure:</strong> FinGuid participates in affiliate programs with lending partners. When you click on partner links or apply for mortgage products through this calculator, FinGuid may receive compensation. This does not affect your rates or terms. We only recommend products we believe provide value to users.
                    <br><br>
                    <strong>Data Accuracy:</strong> Mortgage rates (MORTGAGE30US, MORTGAGE15US) provided by Freddie Mac. Treasury rates (DGS10) provided by the U.S. Treasury. All data delivered via FRED¬Æ API from the Federal Reserve Bank of St. Louis. Rates are updated regularly but we make no guarantees about accuracy. Always verify rates directly with lenders.
                </section>

                <div class="footer-bottom">
                    ¬© 2025 FinGuid USA. All Rights Reserved. | AI-Powered Financial Tools for Americans
                </div>
            </div>
        </footer>
    </main>

    <!-- Cookie Consent Banner (From Mortgage Calc) -->
    <div id="cookie-consent-banner" role="dialog" aria-modal="true" aria-labelledby="cookie-consent-title" aria-describedby="cookie-consent-desc">
        <div class="cookie-consent-text">
            <h4 id="cookie-consent-title" style="font-weight: 700; color: var(--text); margin-bottom: 8px;">Your Privacy</h4>
            <p id="cookie-consent-desc">
                We use cookies and data to enhance your experience and provide personalized AI insights. By clicking "Accept", you agree to our use of cookies.
                <a href="#privacy" aria-label="Read our Privacy Policy">Privacy Policy</a>.
            </p>
        </div>
        <button type="button" id="cookie-consent-btn">Accept</button>
    </div>

    <!-- Custom Alert Modal (From Mortgage Calc) -->
    <style>
        .alert-modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .alert-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10003;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            display: none;
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }
        .alert-modal.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-backdrop.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }
        .alert-modal-body {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .alert-modal-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .alert-modal-btn:hover { background: var(--primary-dark); }
        .alert-modal-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
    </style>
    <div class="alert-modal-backdrop" id="alert-modal-backdrop"></div>
    <div class="alert-modal" id="alert-modal" role="alertdialog" aria-modal="true" aria-labelledby="alert-modal-title" aria-describedby="alert-modal-body">
        <h4 class="alert-modal-title" id="alert-modal-title">Partner Information</h4>
        <p class="alert-modal-body" id="alert-modal-body">
            This is an affiliate link for [Partner].
        </p>
        <button type="button" class="alert-modal-btn" id="alert-modal-close">Close</button>
    </div>
    <!-- END: Modal for Alerts -->
    
    <!-- 
      START: Inlined JavaScript
      Contains all logic from the mortgage-calculator template,
      merged with the calculation logic from affordability-calculator.js
    -->
    <script>
        /**
         * ========================================================================
         * AI-POWERED HOME AFFORDABILITY CALCULATOR (UNIFIED)
         * ========================================================================
         * Version: 9.0 - UNIFIED BUILD
         * Built with: SOLID Principles, WCAG 2.1 AA, PWA Compatible, GDPR/CCPA
         *
         * This file merges the mortgage-calculator.html template with the
         * affordability-calculator.js logic.
         * ========================================================================
         */

        // ===== APP STATE & CONSTANTS =====
        const FRED_API_KEY = '9c6c421f077f2091e8bae4f143ada59a'; // From requirements
        const FRED_URL = 'https://api.stlouisfed.org/fred/series/observations';
        const FRED_SERIES_IDS = {
            rate30: 'MORTGAGE30US', // 30-Year Fixed
            rate15: 'MORTGAGE15US', // 15-Year Fixed
            rate10: 'DGS10'           // 10-Year Treasury
        };

        const FALLBACK_RATES = {
            rates: { rate30: 6.85, rate15: 6.15, rate10: 4.50 },
            dates: { rate30: null, rate15: null, rate10: null },
        };
        
        // --- Logic from affordability-calculator.js ---
        const AFFORDABILITY_CONFIG = {
            FRONT_END_DTI: 0.28, // 28% DTI Rule (PITI / Income)
            BACK_END_DTI: 0.36,  // 36% DTI Rule (PITI + Debts / Income)
            // Core parameters for property-related costs
            ESTIMATES: {
                propertyTaxRate: 0.012, // 1.2% of home value
                insuranceRate: 0.0035, // 0.35% of home value (Homeowner's Insurance)
                pmiRate: 0.005, // 0.5% of loan, for < 20% down
            }
        };
        // --- End logic from affordability-calculator.js ---
        
        // --- FAQs Updated for Affordability ---
        const FAQs = [
            {
                q: "What is a home affordability calculator?",
                a: "An affordability calculator helps you estimate the maximum home price you can likely afford. It works backward from your income, monthly debts, and down payment, using lender guidelines like the 28%/36% DTI ratio, to determine a responsible home budget."
            },
            {
                q: "What is the 28%/36% DTI rule?",
                a: "This is a common rule lenders use. <br/>‚Ä¢ **Front-End DTI (28%):** Your total housing payment (PITI: Principal, Interest, Taxes, Insurance) should be no more than 28% of your gross monthly income.<br/>‚Ä¢ **Back-End DTI (36%):** Your total debt payments (PITI + car loans, credit cards, etc.) should be no more than 36% of your gross monthly income. Our AI calculator uses this rule to find your limit."
            },
            {
                q: "How much house can I afford?",
                a: "This calculator answers that exact question! Enter your gross annual income, total monthly debt payments, and your saved down payment. Our AI engine will use current interest rates and standard DTI rules to estimate the maximum home price you can afford."
            },
            {
                q: "What is PITI?",
                a: "PITI stands for **Principal, Interest, Taxes, and Insurance**. These are the four main components of a monthly mortgage payment. This calculator estimates your max PITI based on your income and then breaks it down for you."
            },
            {
                q: "How does my down payment affect affordability?",
                a: "A larger down payment increases your affordability in two ways: <br/>1. It directly adds to the total home price you can afford (since Price = Loan + Down Payment). <br/>2. If your down payment is 20% or more of the home price, you avoid paying PMI (Private Mortgage Insurance), which lowers your total monthly PITI payment."
            },
            {
                q: "What is PMI (Private Mortgage Insurance)?",
                a: "PMI protects the lender if you default on your loan. It's usually required if your down payment is less than 20%. This calculator automatically estimates PMI if your down payment isn't large enough for your affordable home price, which will affect your total purchasing power."
            },
            {
                q: "How are property taxes and insurance estimated?",
                a: "Since we don't know the exact house, this calculator uses national averages for property tax (1.2% of home value) and homeowners insurance (0.35% of home value) to estimate your full PITI payment. Your actual costs will vary by state and property."
            }
        ];

        // ===== CORE AFFORDABILITY LOGIC (From affordability-calculator.js) =====
        class AffordabilityCalculator {
            
            static getInputs() {
                const parseNumeric = (id, defaultValue = 0) => {
                    const element = document.getElementById(id);
                    if (!element) return defaultValue;
                    return parseFloat(element.value.replace(/[^0-9.]/g, '')) || defaultValue; 
                };
                
                return {
                    annualIncome: parseNumeric('annualIncome', 80000),
                    monthlyDebts: parseNumeric('monthlyDebts', 500),
                    downPayment: parseNumeric('downPayment', 20000),
                    mortgageTerm: parseInt(document.getElementById('mortgageTerm').value) || 30,
                    interestRate: parseFloat(document.getElementById('interestRate').value) || 6.5,
                    zipCode: (document.getElementById('zipCode') ? document.getElementById('zipCode').value.trim() : '')
                };
            }
            
            static calculate() {
                const inputs = this.getInputs();

                // 1. Calculate Max Monthly PITI based on DTI Rules
                const monthlyGross = inputs.annualIncome / 12;
                if (monthlyGross <= 0) {
                    return this.getZeroResults(inputs);
                }
                
                const maxMonthlyPITI_FE = monthlyGross * AFFORDABILITY_CONFIG.FRONT_END_DTI;
                const maxMonthlyDebt_BE = monthlyGross * AFFORDABILITY_CONFIG.BACK_END_DTI;
                const maxMonthlyPITI_BE = maxMonthlyDebt_BE - inputs.monthlyDebts;

                // The lender will use the *strictest* (lowest) of the two DTI calculations
                const maxMonthlyPITI = Math.min(maxMonthlyPITI_FE, maxMonthlyPITI_BE);

                if (maxMonthlyPITI <= 0) {
                    return this.getZeroResults(inputs);
                }

                // 2. Calculation Constants
                const monthlyRate = inputs.interestRate / 100 / 12;
                const termMonths = inputs.mortgageTerm * 12;
                
                // P&I Factor (Payment per $1 of loan)
                const P_I_Factor = (monthlyRate > 0) 
                    ? (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / (Math.pow(1 + monthlyRate, termMonths) - 1)
                    : (1 / termMonths); // Simple principal-only payment if rate is 0
                
                const taxFactorMonthly = AFFORDABILITY_CONFIG.ESTIMATES.propertyTaxRate / 12;
                const insuranceFactorMonthly = AFFORDABILITY_CONFIG.ESTIMATES.insuranceRate / 12;
                const initialPMIFactor = AFFORDABILITY_CONFIG.ESTIMATES.pmiRate / 12;

                // Sub-function to calculate L (Loan) and H (Price) for a given PMI factor
                const calculateLoanAndPrice = (pmiFactor) => {
                    // L = (PITI_max - DP * (T + I)) / (P_I_Factor + T + I + PMI_Factor)
                    // This formula finds the point where the (Loan + DP) * Tax/Ins + Loan * P&I/PMI = Max PITI
                    const numerator = maxMonthlyPITI - inputs.downPayment * (taxFactorMonthly + insuranceFactorMonthly);
                    const denominator = P_I_Factor + taxFactorMonthly + insuranceFactorMonthly + pmiFactor;
                    
                    if (denominator <= 0) return { maxLoanAmount: 0, maxHomePrice: 0 };
                    
                    const maxLoanAmount = numerator / denominator;
                    const maxHomePrice = maxLoanAmount + inputs.downPayment;
                    
                    return { maxLoanAmount, maxHomePrice };
                };

                // 3. Iterative Solution for PMI (Handles the Loan-to-Value requirement)
                // Step A: Calculate initial price assuming NO PMI (pmiFactor = 0)
                let pmiFactorMonthly = 0;
                let { maxLoanAmount, maxHomePrice } = calculateLoanAndPrice(pmiFactorMonthly);
                
                // Step B: Check LTV (Loan-to-Value) for PMI requirement
                const LTV = maxHomePrice > 0 ? maxLoanAmount / maxHomePrice : 1; 
                
                if (LTV > 0.80 && maxHomePrice > 0 && maxLoanAmount > 0) { 
                    // Step C: If PMI is required, set the correct factor and RE-CALCULATE
                    pmiFactorMonthly = initialPMIFactor;
                    ({ maxLoanAmount, maxHomePrice } = calculateLoanAndPrice(pmiFactorMonthly));
                }

                // 4. Final Results
                const estimatedP_I = (maxLoanAmount > 0 ? maxLoanAmount * P_I_Factor : 0);
                const estimatedTax = (maxHomePrice > 0 ? maxHomePrice * taxFactorMonthly : 0);
                const estimatedIns = (maxHomePrice > 0 ? maxHomePrice * insuranceFactorMonthly : 0);
                const estimatedPMI = (pmiFactorMonthly > 0 && maxLoanAmount > 0 ? maxLoanAmount * pmiFactorMonthly : 0);
                
                // Ensure calculated PITI doesn't exceed the max allowed
                const totalCalculatedPITI = estimatedP_I + estimatedTax + estimatedIns + estimatedPMI;
                
                const frontEndDTI = monthlyGross > 0 ? totalCalculatedPITI / monthlyGross : 0;
                const backEndDTI = monthlyGross > 0 ? (totalCalculatedPITI + inputs.monthlyDebts) / monthlyGross : 0;
                
                return {
                    maxHomePrice: Math.max(0, maxHomePrice),
                    maxLoanAmount: Math.max(0, maxLoanAmount),
                    monthlyDebt: inputs.monthlyDebts,
                    estimatedP_I: estimatedP_I,
                    estimatedTax: estimatedTax,
                    estimatedIns: estimatedIns,
                    estimatedPMI: estimatedPMI,
                    estimatedTotalPITI: totalCalculatedPITI,
                    frontEndDTI: frontEndDTI,
                    backEndDTI: backEndDTI
                };
            }
            
            static getZeroResults(inputs) {
                 const monthlyGross = inputs.annualIncome / 12;
                 const totalDebt = (inputs.monthlyDebts) + 0; // 0 for PITI
                 const backEndDTI = monthlyGross > 0 ? totalDebt / monthlyGross : 0;
                 
                 return {
                    maxHomePrice: 0, maxLoanAmount: 0, estimatedTotalPITI: 0, 
                    monthlyDebt: inputs.monthlyDebts, estimatedP_I: 0, 
                    estimatedTax: 0, estimatedIns: 0, estimatedPMI: 0,
                    frontEndDTI: 0, backEndDTI: backEndDTI
                };
            }
        }

        // ===== AI INSIGHTS ENGINE (Logic from affordability-calculator.js) =====
        class AIInsightEngine {
            
            static generateInsights(results, inputs) {
                const insights = [];
                const fmtd = UIManager.formatCurrency;
                const fmtdP = (num) => (num * 100).toFixed(1) + '%';
                
                if (results.maxHomePrice <= 0 || results.maxHomePrice <= inputs.downPayment) {
                    insights.push({
                        title: "üö® Affordability Issue",
                        text: `Your Back-End DTI of **${fmtdP(results.backEndDTI)}** (targeting 36%) is too high, or your income is too low to qualify for a loan. **AI Tip:** Focus on reducing your existing monthly debts to increase your affordability.`,
                        type: 'error'
                    });
                    return insights;
                }

                // Insight 1: PMI Warning
                if (results.estimatedPMI > 0) {
                    const pmiAvoidanceDownPayment = Math.max(0, (results.maxHomePrice * 0.20) - inputs.downPayment);
                    insights.push({ 
                        title: "‚ö†Ô∏è PMI Warning", 
                        text: `You will likely pay **${fmtd(results.estimatedPMI, 2)}/mo** for Private Mortgage Insurance (PMI). **AI Tip:** Saving an extra **${fmtd(pmiAvoidanceDownPayment, 0)}** for your down payment (to reach 20%) would eliminate this monthly cost.`,
                        type: 'warning' 
                    });
                } else {
                     insights.push({ 
                        title: "‚úÖ No PMI Required", 
                        text: `Great! Your down payment is large enough relative to your affordable price to avoid PMI, saving you money every month.`,
                        type: 'success' 
                    });
                }
                
                // Insight 2: DTI Status
                if (results.backEndDTI > 0.35) {
                    insights.push({ 
                        title: "üìà High DTI Ratio", 
                        text: `Your Back-End DTI is **${fmtdP(results.backEndDTI)}**, which is at the limit. Lenders will see you as higher risk. **AI Tip:** Paying down small debts (like credit cards) is the fastest way to lower your DTI and improve your loan terms.`,
                        type: 'warning' 
                    });
                     insights.push({ 
                        title: "Partner Recommendation", 
                        text: `Some lenders specialize in high DTI loans. **Compare rates from our partners** who may offer programs for buyers in your situation.`,
                        type: 'monetization' 
                    });
                } else if (results.backEndDTI < 0.30) {
                     insights.push({ 
                        title: "üèÜ Excellent DTI", 
                        text: `Your Back-End DTI is very low at **${fmtdP(results.backEndDTI)}**. This signals strong financial health, and you will likely qualify for the absolute best interest rates.`,
                        type: 'success' 
                    });
                }
                
                // Insight 3: Down Payment
                if (inputs.downPayment < (results.maxHomePrice * 0.10)) {
                     insights.push({ 
                        title: "üí° Down Payment", 
                        text: `Your down payment is less than 10%. **AI Tip:** Explore **First-Time Home Buyer (FHA) programs** in your state, which offer loans with down payments as low as 3.5%.`,
                        type: 'info' 
                    });
                }

                return insights;
            }
        }

        // ===== ZIP CODE MANAGER (From Mortgage Calc, but simplified) =====
        class ZipCodeManager {
            // This class is not used for calculations in this tool,
            // but the structure is here if we want to add ZIP-based tax estimation.
            // For now, the ZIP code is just for user context and potential AI insights.
        }

        // ===== FRED API MANAGER (From Mortgage Calc) =====
        class FREDManager {
            
            static getEasternTimeInfo() {
                const now = new Date();
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const parts = etFormatter.formatToParts(now).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const currentETDate = `${parts.year}-${parts.month.padStart(2, '0')}-${parts.day.padStart(2, '0')}`;
                const currentETHour = parseInt(parts.hour, 10);
                const currentETMinute = parseInt(parts.minute, 10);
                const isAfterCutoff = (currentETHour > 16) || (currentETHour === 16 && currentETMinute >= 45);

                return { currentETDate, isAfterCutoff, now };
            }

            static isCacheValid(cache) {
                const { lastFetch } = cache;
                if (!lastFetch) return false;

                const { currentETDate, isAfterCutoff } = this.getEasternTimeInfo();

                const lastFetchDate = new Date(lastFetch);
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const lastFetchParts = etFormatter.formatToParts(lastFetchDate).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const lastFetchETDate = `${lastFetchParts.year}-${lastFetchParts.month.padStart(2, '0')}-${lastFetchParts.day.padStart(2, '0')}`;
                const lastFetchHour = parseInt(lastFetchParts.hour, 10);
                const lastFetchMinute = parseInt(lastFetchParts.minute, 10);
                const wasLastFetchAfterCutoff = (lastFetchHour > 16) || (lastFetchHour === 16 && lastFetchMinute >= 45);

                if (currentETDate !== lastFetchETDate) {
                    if (isAfterCutoff) {
                        return false; 
                    }
                    if (wasLastFetchAfterCutoff) {
                        return true;
                    }
                    return false;
                }
                if (!wasLastFetchAfterCutoff && isAfterCutoff) {
                    return false;
                }
                return true;
            }

            static formatTimestamp(now) {
                return new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    dateStyle: 'short',
                    timeStyle: 'short'
                }).format(now) + " ET";
            }

            static async fetchFredSeries(seriesId) {
                try {
                    const url = `${FRED_URL}?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json&sort_order=desc&limit=1`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`FRED API request failed for ${seriesId}: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.observations && data.observations.length > 0) {
                        const rate = parseFloat(data.observations[0].value);
                        const date = data.observations[0].date;
                        if (isNaN(rate)) return { rate: null, date: null };
                        return { rate, date };
                    }
                } catch (error) {
                    console.error(error);
                }
                return { rate: null, date: null };
            }

            static async getRates() {
                const cacheStr = localStorage.getItem('fredRatesCache');
                let cache = cacheStr ? JSON.parse(cacheStr) : null;
                
                const { now } = this.getEasternTimeInfo();

                if (cache && this.isCacheValid(cache)) {
                    console.log('Using cached FRED rates');
                    return {
                        ...cache,
                        isCache: true,
                        lastUpdatedTimestamp: `Rates as of ${this.formatTimestamp(new Date(cache.lastFetch))}`
                    };
                }

                console.log('Fetching new FRED rates');
                
                const [data30, data15, data10] = await Promise.all([
                    this.fetchFredSeries(FRED_SERIES_IDS.rate30),
                    this.fetchFredSeries(FRED_SERIES_IDS.rate15),
                    this.fetchFredSeries(FRED_SERIES_IDS.rate10)
                ]);

                const newRates = {
                    rate30: data30.rate || FALLBACK_RATES.rates.rate30,
                    rate15: data15.rate || FALLBACK_RATES.rates.rate15,
                    rate10: data10.rate || FALLBACK_RATES.rates.rate10,
                };

                const newDates = {
                    date30: data30.date || null,
                    date15: data15.date || null,
                    date10: data10.date || null,
                };

                const newCache = {
                    rates: newRates,
                    dates: newDates,
                    lastFetch: now.toISOString()
                };

                localStorage.setItem('fredRatesCache', JSON.stringify(newCache));

                return {
                    ...newCache,
                    isCache: false,
                    lastUpdatedTimestamp: `Live Rates updated: ${this.formatTimestamp(now)}`
                };
            }
        }

        // ===== UI MANAGER (From Mortgage Calc) =====
        class UIManager {
            static formatCurrency(value, decimals = 0) {
                if (typeof value !== 'number' || isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(value);
            }
            static formatPercent(value, decimals = 2) { 
                if (!isFinite(value) || isNaN(value) || value < 0) return '0.00%';
                return (value * 100).toFixed(decimals) + '%'; 
            } 

            static updateInsights(insights) {
                const container = document.getElementById('insightsContainer');
                container.innerHTML = '';
                if(!insights || insights.length === 0) {
                     container.innerHTML = '<div class="insight-box"><strong>ü§ñ AI Advisor:</strong> Enter valid details to generate personalized insights...</div>';
                     return;
                }
                insights.forEach(insight => {
                    const box = document.createElement('div');
                    // Use 'monetization' class if present, otherwise 'info', 'warning', etc.
                    box.className = `insight-box ${insight.type || 'info'}`;
                    // Bold markdown support
                    const insightText = insight.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    box.innerHTML = `<strong>${insight.title}:</strong> ${insightText}`;
                    container.appendChild(box);
                });
            }
        }

        // ===== MAIN APP (Controller) =====
        const app = {
            calculateDebounce: null,
            lastResults: null,
            state: {
                isTtsEnabled: false,
                liveRates: FALLBACK_RATES.rates
            },

            async init() {
                this.setupEventListeners();
                this.setupDarkMode();
                this.setupPWA();
                this.setupVoiceControls();
                this.setupFAQ();
                this.initTooltips(); 
                this.setupTabs();
                this.setupAlertModal();
                this.setupCookieConsent();
                await this.loadInitialRates();
            },

            setupEventListeners() {
                // Inputs for affordability calculator
                ['annualIncome', 'monthlyDebts', 'downPayment', 'interestRate', 'mortgageTerm'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.debouncedCalculate());
                        el.addEventListener('change', () => this.debouncedCalculate());
                    }
                });
                
                // Live Rate Button Listeners (From Mortgage Calc)
                document.getElementById('rate-btn-30yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate30, 'rate-btn-30yr'));
                    
                document.getElementById('rate-btn-15yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate15, 'rate-btn-15yr'));
                    
                document.getElementById('rate-btn-10yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate10, 'rate-btn-10yr'));
            },

            applyRate(rate, btnId) {
                if (!rate) return;
                
                document.getElementById('interestRate').value = rate.toFixed(2);
                document.querySelectorAll('.rate-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(btnId).classList.add('active');
                
                this.calculate(); // Recalculate immediately
            },

            setupTabs() {
                const tablist = document.querySelector('[role="tablist"]');
                const tabs = tablist.querySelectorAll('[role="tab"]');
                
                tablist.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('[role="tab"]');
                    if (!clickedTab) return;
                    this.activateTab(clickedTab);
                });

                tablist.addEventListener('keydown', (e) => {
                    let index = Array.from(tabs).indexOf(document.activeElement);
                    if (index === -1) return;

                    let direction = 0;
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        direction = 1;
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        direction = -1;
                    } else if (e.key === 'Home') {
                        e.preventDefault();
                        tabs[0].focus();
                    } else if (e.key === 'End') {
                        e.preventDefault();
                        tabs[tabs.length - 1].focus();
                    }

                    if (direction !== 0) {
                        e.preventDefault();
                        index = (index + direction + tabs.length) % tabs.length;
                        tabs[index].focus();
                    }
                });
            },

            activateTab(tab) {
                const tabId = tab.getAttribute('aria-controls');
                
                document.querySelectorAll('[role="tab"]').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                    t.setAttribute('tabindex', '-1');
                });
                
                document.querySelectorAll('[role="tabpanel"]').forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                tab.setAttribute('tabindex', '0');

                const panel = document.getElementById(tabId);
                panel.classList.add('active');
                panel.style.display = 'block';
            },
            
            debouncedCalculate() {
                clearTimeout(this.calculateDebounce);
                this.calculateDebounce = setTimeout(() => this.calculate(), 250);
            },

            calculate() {
                const results = AffordabilityCalculator.calculate();
                this.lastResults = results;
                
                if (results) {
                    this.updateResultsUI(results); // New UI update function
                    
                    const inputs = AffordabilityCalculator.getInputs();
                    const insights = AIInsightEngine.generateInsights(results, inputs);
                    UIManager.updateInsights(insights);

                    if (this.state.isTtsEnabled) {
                        this.speakResults();
                    }
                }
            },
            
            // --- NEW: Specific UI update function for affordability results ---
            updateResultsUI(results) {
                // Main Summary Card
                document.getElementById('result-price').textContent = UIManager.formatCurrency(results.maxHomePrice);
                document.getElementById('result-monthly-piti').textContent = `Max Monthly PITI: ${UIManager.formatCurrency(results.estimatedTotalPITI, 2)}`;
                
                // Tab 1: Breakdown
                document.getElementById('result-loan-amount').textContent = UIManager.formatCurrency(results.maxLoanAmount);
                document.getElementById('result-monthly-piti-detail').textContent = UIManager.formatCurrency(results.estimatedTotalPITI, 2);
                
                document.getElementById('breakdown-pi').textContent = UIManager.formatCurrency(results.estimatedP_I, 2);
                document.getElementById('breakdown-tax').textContent = UIManager.formatCurrency(results.estimatedTax, 2);
                document.getElementById('breakdown-ins').textContent = UIManager.formatCurrency(results.estimatedIns, 2);
                document.getElementById('breakdown-pmi').textContent = UIManager.formatCurrency(results.estimatedPMI, 2);
                
                // Handle PMI styling
                document.getElementById('pmi-box').classList.toggle('alert-pmi', results.estimatedPMI > 0);
                
                // Tab 1: DTI
                document.getElementById('dti-front-end').textContent = UIManager.formatPercent(results.frontEndDTI);
                document.getElementById('dti-back-end').textContent = UIManager.formatPercent(results.backEndDTI);
            },

            initTooltips() {
                let tooltipBox = null;
                document.querySelectorAll('.tooltip').forEach(el => {
                    const showTooltip = (e) => {
                        const text = e.currentTarget.getAttribute('data-tooltip');
                        if (!text) return;
                        if (tooltipBox) tooltipBox.remove();
                        
                        tooltipBox = document.createElement('div');
                        tooltipBox.className = 'tooltip-box';
                        tooltipBox.textContent = text;
                        tooltipBox.setAttribute('role', 'tooltip');
                        document.body.appendChild(tooltipBox);

                        const rect = e.currentTarget.getBoundingClientRect();
                        let top = rect.top - tooltipBox.offsetHeight - 5;
                        let left = rect.left + rect.width / 2 - tooltipBox.offsetWidth / 2;

                        if (top < 0) { top = rect.bottom + 5; }
                        if (left < 0) { left = 5; }
                        if (left + tooltipBox.offsetWidth > window.innerWidth) {
                            left = window.innerWidth - tooltipBox.offsetWidth - 5;
                        }

                        tooltipBox.style.left = `${left}px`;
                        tooltipBox.style.top = `${top}px`;
                        tooltipBox.style.display = 'block';
                        setTimeout(() => { if (tooltipBox) tooltipBox.style.opacity = '1'; }, 10);
                    };

                    const hideTooltip = () => {
                        if (tooltipBox) {
                            tooltipBox.style.opacity = '0';
                            setTimeout(() => {
                                if (tooltipBox) {
                                    tooltipBox.remove();
                                    tooltipBox = null;
                                }
                            }, 200);
                        }
                    };

                    el.addEventListener('mouseenter', showTooltip);
                    el.addEventListener('focus', showTooltip);
                    el.addEventListener('mouseleave', hideTooltip);
                    el.addEventListener('blur', hideTooltip);
                });
            },

            async loadInitialRates() {
                const updatedEl = document.getElementById('fred-last-updated');
                const rateEl = document.getElementById('interestRate');
                
                const btn30 = document.getElementById('rate-btn-30yr');
                const btn15 = document.getElementById('rate-btn-15yr');
                const btn10 = document.getElementById('rate-btn-10yr');

                try {
                    const { rates, lastUpdatedTimestamp } = await FREDManager.getRates();
                    
                    this.state.liveRates = rates;

                    updatedEl.textContent = lastUpdatedTimestamp;
                    updatedEl.style.color = "var(--text-light)";

                    btn30.textContent = `30-Yr Fixed: ${rates.rate30.toFixed(2)}%`;
                    btn15.textContent = `15-Yr Fixed: ${rates.rate15.toFixed(2)}%`;
                    btn10.textContent = `10-Yr Treasury: ${rates.rate10.toFixed(2)}%`;
                    
                    btn30.disabled = false;
                    btn15.disabled = false;
                    btn10.disabled = false;
                    
                    // Default to 30-Yr Fixed Rate
                    rateEl.value = rates.rate30.toFixed(2);
                    btn30.classList.add('active');

                } catch (error) {
                    console.error("Error loading initial rates:", error);
                    updatedEl.textContent = 'Error loading rates. Using fallbacks.';
                    updatedEl.style.color = "var(--error)";
                    this.state.liveRates = FALLBACK_RATES.rates;
                    // Still populate buttons with fallback data
                    btn30.textContent = `30-Yr Fixed: ${this.state.liveRates.rate30.toFixed(2)}%`;
                    btn15.textContent = `15-Yr Fixed: ${this.state.liveRates.rate15.toFixed(2)}%`;
                    btn10.textContent = `10-Yr Treasury: ${this.state.liveRates.rate10.toFixed(2)}%`;
                    btn30.disabled = false;
                    btn15.disabled = false;
                    btn10.disabled = false;
                    rateEl.value = this.state.liveRates.rate30.toFixed(2); // Use fallback
                    btn30.classList.add('active');
                }
                
                this.calculate(); // Calculate on load
            },

            setupDarkMode() {
                const toggle = document.getElementById('darkModeToggle');
                const scheme = localStorage.getItem('colorScheme') || 'light';
                document.documentElement.setAttribute('data-color-scheme', scheme);
                
                toggle.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-color-scheme');
                    const next = current === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-color-scheme', next);
                    localStorage.setItem('colorScheme', next);
                });
            },

            setupPWA() {
                const pwaBtn = document.getElementById('pwa-install-btn');
                if (pwaBtn) {
                    pwaBtn.addEventListener('click', async () => {
                        if (window.deferredPrompt) {
                            window.deferredPrompt.prompt();
                            await window.deferredPrompt.userChoice;
                            window.deferredPrompt = null;
                        }
                    });
                }
            },

            setupVoiceControls() {
                const voiceBtn = document.getElementById('voiceToggle');
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = () => { 
                        voiceBtn.classList.add('active'); 
                        voiceBtn.textContent = '..'; 
                    };
                    recognition.onend = () => { 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.textContent = 'üé§'; 
                    };
                    recognition.onerror = (event) => { 
                        console.error('Voice recognition error', event.error); 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.textContent = 'üé§'; 
                    };

                    recognition.onresult = (event) => {
                        const command = event.results[0][0].transcript.toLowerCase();
                        if (command.includes('calculate') || command.includes('compute')) this.calculate();
                        else if (command.includes('read results')) this.speakResults();
                        else if (command.includes('read insights')) this.speakInsights();
                    };
                    voiceBtn.addEventListener('click', () => { try { recognition.start(); } catch(e) { console.error("Voice recognition error", e); } });
                } else {
                     voiceBtn.title = 'Voice control not supported in this browser.';
                     voiceBtn.style.opacity = '0.5';
                     voiceBtn.disabled = true;
                }
                
                const ttsBtn = document.getElementById('ttsToggle');
                ttsBtn.addEventListener('click', () => {
                    this.state.isTtsEnabled = !this.state.isTtsEnabled;

                    if (this.state.isTtsEnabled) {
                        ttsBtn.classList.add('active'); 
                        this.speakResults(); 
                    } else {
                        ttsBtn.classList.remove('active'); 
                        if ('speechSynthesis' in window && speechSynthesis.speaking) {
                            speechSynthesis.cancel(); 
                        }
                    }
                });
            },

            // --- Updated for Affordability ---
            speakResults() {
                if ('speechSynthesis' in window && this.lastResults) {
                    speechSynthesis.cancel();
                    const text = `Based on your inputs, your maximum affordable home price is ${UIManager.formatCurrency(this.lastResults.maxHomePrice, 0)}. This would result in an estimated maximum monthly payment of ${UIManager.formatCurrency(this.lastResults.estimatedTotalPITI, 2)}.`;
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                }
            },
            
            speakInsights() {
                 if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const insightsContainer = document.getElementById('insightsContainer');
                    const firstInsight = insightsContainer.querySelector('.insight-box');
                    if(firstInsight) {
                        const text = firstInsight.textContent;
                        const utterance = new SpeechSynthesisUtterance(text);
                        speechSynthesis.speak(utterance);
                    }
                }
            },

            setupFAQ() {
                const container = document.getElementById('faqContainer');
                if(!container) return;

                FAQs.forEach((faq, index) => {
                    const qId = `faq-q-${index}`;
                    const aId = `faq-a-${index}`;
                    
                    const item = document.createElement('div');
                    item.className = 'faq-item';
                    item.innerHTML = `
                        <div class="faq-question" role="button" tabindex="0" aria-expanded="false" aria-controls="${aId}" id="${qId}">
                            <span>${faq.q}</span>
                            <span class="faq-icon" aria-hidden="true">‚ñº</span>
                        </div>
                        <div class="faq-answer" role="region" aria-labelledby="${qId}" id="${aId}">${faq.a}</div>
                    `;
                    container.appendChild(item);
                });
                
                container.addEventListener('click', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question) this.toggleFAQ(question);
                });
                
                container.addEventListener('keydown', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question && (e.key === 'Enter' || e.key === ' ')) {
                        e.preventDefault();
                        this.toggleFAQ(question);
                    }
                });
            },
            
            toggleFAQ(question) {
                const answer = document.getElementById(question.getAttribute('aria-controls'));
                const isActive = question.getAttribute('aria-expanded') === 'true';

                document.querySelectorAll('.faq-question[aria-expanded="true"]').forEach(q => {
                    if (q !== question) {
                        q.setAttribute('aria-expanded', 'false');
                        q.classList.remove('active');
                        document.getElementById(q.getAttribute('aria-controls')).style.display = 'none';
                        q.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                    }
                });

                if (!isActive) {
                    question.setAttribute('aria-expanded', 'true');
                    question.classList.add('active');
                    answer.style.display = 'block';
                    answer.style.animation = 'slideDown 0.3s ease';
                    question.querySelector('.faq-icon').style.transform = 'rotate(180deg)';
                } else {
                    question.setAttribute('aria-expanded', 'false');
                    question.classList.remove('active');
                    answer.style.display = 'none';
                    question.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                }
            },

            setupCookieConsent() {
                const banner = document.getElementById('cookie-consent-banner');
                const btn = document.getElementById('cookie-consent-btn');
                
                if (localStorage.getItem('cookieConsent') === 'true') {
                    banner.style.display = 'none';
                } else {
                    banner.style.display = 'flex';
                }
                
                btn.addEventListener('click', () => {
                    localStorage.setItem('cookieConsent', 'true');
                    banner.style.display = 'none';
                });
            },
            
            setupAlertModal() {
                const modal = document.getElementById('alert-modal');
                const backdrop = document.getElementById('alert-modal-backdrop');
                const closeBtn = document.getElementById('alert-modal-close');
                
                const closeModal = () => {
                    modal.classList.remove('visible');
                    backdrop.classList.remove('visible');
                };

                closeBtn.addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            },
            
            showAlert(title, message) {
                document.getElementById('alert-modal-title').textContent = title;
                document.getElementById('alert-modal-body').textContent = message;
                document.getElementById('alert-modal').classList.add('visible');
                document.getElementById('alert-modal-backdrop').classList.add('visible');
                document.getElementById('alert-modal-close').focus();
            },
            
            showPartnerAlert(partnerName) {
                this.showAlert(
                    'Affiliate Partner Link',
                    `This is an affiliate link. If you click this link and apply for a product, we may receive a commission. This partner is: ${partnerName}.`
                );
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => app.init());

        // ===== ERROR HANDLING =====
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.message, event.filename, event.lineno);
        });
        window.addEventListener('unhandledrejection', (event) => {
             console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <!-- END: Inlined JavaScript -->

    <!-- 
      NEW: PWA Service Worker for Offline Use
      (From Mortgage Calc, provides offline fallback)
    -->
    <script>
        if ('serviceWorker' in navigator) {
            
            const OFFLINE_HTML = `
                <!DOCTYPE html>
                <html lang="en" style="font-family: Arial, sans-serif; background: #F5F7FA; color: #1F2121; padding: 20px;">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Offline | FinGuid Affordability Calculator</title>
                    <style>
                        body { text-align: center; padding-top: 50px; }
                        h1 { color: #24ACB9; }
                        p { font-size: 1.1rem; line-height: 1.6; }
                        .icon { font-size: 4rem; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="icon">ü§ñ</div>
                    <h1>You are Offline</h1>
                    <p>This AI Affordability Calculator needs an internet connection to function and fetch live rates.</p>
                    <p>Please check your connection and try again.</p>
                </body>
                </html>
            `;
            
            const swContent = `
                const CACHE_NAME = 'affordability-calculator-v1';
                const urlsToCache = [
                    '.', // Caches the main HTML file
                ];
                
                const OFFLINE_PAGE_CONTENT = \`${OFFLINE_HTML}\`;

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Service Worker: Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                    );
                });

                self.addEventListener('fetch', event => {
                    if (event.request.mode !== 'navigate') {
                        // For non-HTML requests (like scripts, images), use cache-first
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    return response || fetch(event.request);
                                })
                        );
                        return;
                    }
                    
                    // For navigation requests, try network first, then cache, then offline page
                    event.respondWith(
                        fetch(event.request)
                            .catch(() => {
                                // Network failed, try cache
                                return caches.match(event.request)
                                    .then(response => {
                                        // Return from cache or show offline page
                                        return response || new Response(OFFLINE_PAGE_CONTENT, {
                                            headers: { 'Content-Type': 'text/html' }
                                        });
                                    });
                            })
                    );
                });
            `;
            // Create a Blob from the SW content and register it
            const blob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered from Blob.', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>

</body>
</html>
