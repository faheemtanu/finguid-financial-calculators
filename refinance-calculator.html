<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO & Metadata Updated for Refinance -->
    <title>AI Refinance Calculator 2025 | Break-Even & Savings | FinGuid</title>
    <meta name="description" content="World's Best AI-Powered Refinance Calculator by FinGuid. Calculate your break-even point and total savings with live FRED rates. See if refinancing your mortgage makes sense. WCAG 2.1 AA compliant.">
    <meta name="keywords" content="refinance calculator, mortgage refinance calculator, refinance break-even calculator, mortgage refinance, should I refinance, refinance savings calculator, AI refinance, live mortgage rates, FRED API rates, FinGuid, home loan refinance, cash-out refinance, rate and term refinance, mortgage comparison">

    <meta name="author" content="FinGuid USA">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="theme-color" content="#24ACB9">
    <meta property="og:type" content="website">
    <meta property="og:title" content="AI Refinance Calculator 2025 | Live FRED Rates | FinGuid">
    <meta property="og:description" content="Free AI refinance calculator to see your break-even point, monthly savings, and total interest saved with live FRED rates.">
    
    <link rel="canonical" href="https://www.finguid.com/calculators/refinance">
    
    <!-- PWA FIX: Inlined PWA Web App Manifest (Updated) -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22FinGuid%20AI%20Refinance%20Calculator%22,%22short_name%22:%22RefiCalc%22,%22description%22:%22AI-Powered%20Refinance%20Calculator%20with%20Break-Even%20Analysis%20and%20Live%20Rates.%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#FFFFFD%22,%22theme_color%22:%22#24ACB9%22,%22icons%22:[{%22src%22:%22https://placehold.co/192x192/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://placehold.co/512x512/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22512x512%22}]}">
    
    <!-- 
      START: Inlined CSS
      This is the complete, unified stylesheet from the mortgage-calculator template.
      It ensures 100% visual consistency and compliance (WCAG, Dark Mode, etc.).
    -->
    <style>
        /* === START: Global Variables (Brand Color Match) === */
        :root {
            --primary: #24ACB9; /* Teal (Matches FinGuid Image & Car Lease CSS) */
            --primary-dark: #19343B; /* Dark Teal (Matches Car Lease CSS) */
            --accent: #FFC107;
            --accent-dark: #E69500;
            --text: #1F2121;
            --text-light: #64748B;
            --bg: #FFFFFD;
            --bg-secondary: #F5F7FA;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --error: #EF4444;
            --success: #10B981;
            --fred-color: #A31B20; /* FRED standard color for Live Rates button */
        }

        [data-color-scheme="dark"] {
            --text: #E1E8ED;
            --text-light: #B8C5D0;
            --bg: #1F2121;
            --bg-secondary: #242B36;
            --card: #181919;
            --border: #38444D;
        }
        /* === END: Global Variables === */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { 
            font-size: 16px; 
            -webkit-font-smoothing: antialiased; 
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* ===== HEADER STYLES (From Mortgage Calc) ===== */
        .header {
            position: sticky;
            top: 0;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--primary);
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .logo:hover { color: var(--primary-dark); }

        .calculator-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            flex-shrink: 0;
            margin-left: 16px;
            flex-basis: auto;
            min-width: 0;
        }

        .header-features {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 24px;
            flex-grow: 1;
            justify-content: flex-start;
            overflow: hidden;
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        .header-feature-item {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            animation: pulse-color-text 2.5s infinite ease-in-out;
        }
        .header-feature-item:nth-child(1) { animation-delay: 0s; }
        .header-feature-item:nth-child(2) { animation-delay: 0.2s; }
        .header-feature-item:nth-child(3) { animation-delay: 0.4s; }
        .header-feature-item:nth-child(4) { animation-delay: 0.6s; }

        @keyframes pulse-color-text {
            0%, 100% {
                opacity: 0.8;
                color: var(--text-light);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                color: var(--primary);
                transform: scale(1.03);
            }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:hover { background: var(--primary); color: white; }
        .icon-btn.active { background: var(--primary); color: white; }

        #pwa-install-btn {
            display: none;
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #pwa-install-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        /* ===== END HEADER STYLES ===== */

        /* ===== SPONSOR BANNER (From Mortgage Calc) ===== */
        .sponsor-banner {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .sponsor-text { font-weight: 500; flex: 1; min-width: 200px; }
        .sponsor-buttons { display: flex; gap: 8px; }
        .sponsor-btn {
            padding: 8px 12px;
            background: white;
            color: #6366F1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .sponsor-btn:hover { background: var(--accent); color: var(--text); transform: translateY(-2px); }

        /* ===== MAIN CALCULATOR (Layout from Mortgage Calc) ===== */
        .calculator-wrapper {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            padding: 24px 0;
            margin-bottom: 40px;
        }

        .inputs-panel, .results-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        /* Sticky input panel removed for refinance, as it's shorter */
        
        .inputs-panel:hover, .results-panel:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .panel-title { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }

        .section-heading {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        /* FRED rate styles (From Mortgage Calc) */
        .fred-rates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        #fred-last-updated {
            font-size: 11px;
            color: var(--text-light);
            text-align: left;
        }
        .fred-branding {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 600;
        }
        .fred-branding a { color: var(--text-light); text-decoration: none; }
        .fred-branding a:hover { color: var(--primary); }

        .live-rates-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .rate-btn {
            flex-grow: 1;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .rate-btn:hover {
            background: var(--card);
            border-color: var(--primary);
            color: var(--primary);
        }
        .rate-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .rate-btn:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Tooltip Styles (From Mortgage Calc) */
        .tooltip {
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
            display: inline-flex;
            align-items: center;
            color: var(--text-light);
        }
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-light);
            color: var(--card);
            font-style: normal;
            font-size: 10px;
            font-weight: 700;
            line-height: 14px;
            margin-left: 5px;
            transition: all 0.2s ease;
        }
        .tooltip:hover .tooltip-icon,
        .tooltip:focus .tooltip-icon {
            background: var(--primary);
            outline: none;
        }
        .tooltip:focus { outline: none; }

        .tooltip-box {
            position: fixed;
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 200px;
            white-space: normal;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .input-wrapper { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            min-width: 0; 
        }

        input[type="number"], input[type="text"], select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 0;
            width: 100%;
        }

        /* WCAG Focus Styles (From Mortgage Calc) */
        input[type="number"]:focus, input[type="text"]:focus, select:focus, 
        .rate-btn:focus, .sponsor-btn:focus, .icon-btn:focus, 
        #pwa-install-btn:focus, .tab-btn:focus, .faq-question:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.25);
        }
        .icon-btn:focus, #pwa-install-btn:focus, .sponsor-btn:focus {
             box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
        }

        .input-addon {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            min-width: 50px;
            text-align: center;
        }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Ad Slot (From Mortgage Calc) */
        .ad-slot {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
        }
        .ad-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .ad-placeholder {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 600;
        }

        /* ===== RESULTS SECTION (Adapted for Refinance) ===== */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px; /* More padding */
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(36, 172, 185, 0.2);
            text-align: center;
        }
        .summary-label { font-size: 1rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .payment-amount { display: flex; align-items: baseline; justify-content: center; gap: 8px; margin: 8px 0; }
        .amount { font-size: 2.5rem; font-weight: bold; } /* Larger amount */
        .unit { font-size: 1rem; opacity: 0.9; }
        .payment-breakdown { font-size: 1rem; opacity: 0.8; } /* Larger breakdown text */

        /* Special styles for savings/cost in summary */
        .payment-breakdown .savings { color: var(--success); }
        .payment-breakdown .cost { color: var(--error); }
        
        /* Result value styling for savings/cost */
        .result-value.positive { color: var(--success); }
        .result-value.negative { color: var(--error); }


        .tabs { margin-bottom: 24px; }
        .tab-buttons { 
            display: flex; 
            gap: 4px; 
            border-bottom: 2px solid var(--border); 
            margin-bottom: 24px; 
            overflow-x: auto; 
        }

        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:focus {
            color: var(--primary);
            box-shadow: none;
            border-bottom-color: rgba(36, 172, 185, 0.5);
        }
        .tab-btn.active:focus { border-bottom-color: var(--primary); }

        .tab-content { display: none; padding: 8px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        .tab-content:focus-visible {
            outline: 2px solid var(--primary);
            border-radius: 4px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .results-heading {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin: 16px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .result-box { background: var(--bg-secondary); padding: 16px; border-radius: 6px; border-left: 4px solid var(--border); transition: all 0.2s; }
        .result-box:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .result-box.highlight { 
            border-left-color: var(--primary); 
            background: rgba(36, 172, 185, 0.1); 
        }
        .result-box.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .result-box.accent {
            border-left-color: var(--accent-dark);
            background: rgba(255, 193, 7, 0.1);
        }
        .result-box.error {
            border-left-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .result-label { 
            display: block; 
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
        }
        .result-value { 
            display: block; 
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
        }

        /* AI INSIGHTS (From Mortgage Calc) */
        .insights-container { margin-top: 20px; }
        .insight-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .insight-box.success { border-left-color: var(--success); }
        .insight-box.warning { border-left-color: var(--accent-dark); }
        .insight-box.error { border-left-color: var(--error); }
        /* Insight type from refinance.js */
        .insight-box.monetization {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        /* ===== PARTNER SECTION (From Mortgage Calc) ===== */
        .footer-sponsor {
            background: linear-gradient(135deg, rgba(36, 172, 185, 0.1) 0%, rgba(25, 52, 59, 0.1) 100%);
            padding: 40px;
            border-bottom: 1px solid rgba(36, 172, 185, 0.2);
            border-radius: 12px;
        }
        .sponsor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; }
        .sponsor-item { text-align: center; padding: 16px; border-radius: 8px; background: var(--card); transition: all 0.2s; }
        .sponsor-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sponsor-item h4 { margin-bottom: 8px; color: var(--primary); font-size: 1rem; }
        .sponsor-item p { color: var(--text-light); margin-bottom: 12px; font-size: 0.875rem; line-height: 1.5; }
        .sponsor-item a {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .sponsor-item a:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        .sponsor-item a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(36, 172, 185, 0.3); }

        /* ===== FOOTER (From Mortgage Calc) ===== */
        .footer { background: var(--card); border-top: 1px solid var(--border); padding: 32px 0; margin-top: 40px; }
        .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .footer-section h4 { font-size: 13px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .footer-section a { display: block; font-size: 12px; color: var(--text-light); text-decoration: none; margin-bottom: 8px; transition: color 0.3s ease; }
        .footer-section a:hover, .footer-section a:focus { 
            color: var(--primary); 
            text-decoration: underline;
            outline: none;
        }
        .compliance-badges { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; font-size: 12px; }
        .badge { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; font-weight: 600; color: var(--text-light); }
        .disclaimer { font-size: 11px; color: var(--text-light); line-height: 1.6; padding-top: 20px; border-top: 1px solid var(--border); }
        .footer-bottom { text-align: center; font-size: 12px; color: var(--text-light); padding-top: 16px; border-top: 1px solid var(--border); }

        /* ===== FAQ ACCORDION (From Mortgage Calc) ===== */
        .faq-section { margin: 40px 0; }
        .faq-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 20px; text-align: center; }
        .faq-container { max-width: 900px; margin: 0 auto; }
        .faq-item { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; }
        .faq-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .faq-question { padding: 16px; background: var(--bg-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text); transition: all 0.3s ease; }
        .faq-question:hover { background: var(--card); color: var(--primary); }
        .faq-question.active { background: var(--primary); color: white; }
        .faq-question:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4) inset;
            color: var(--primary);
        }
        .faq-icon { font-size: 18px; transition: transform 0.3s ease; }
        .faq-question.active .faq-icon { transform: rotate(180deg); }
        .faq-answer { display: none; padding: 16px; background: var(--card); color: var(--text-light); line-height: 1.8; font-size: 14px; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }

        /* ===== GDPR/CCPA COOKIE BANNER (From Mortgage Calc) ===== */
        #cookie-consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            color: var(--text);
            padding: 24px;
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .cookie-consent-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-light);
            flex: 1 1 400px;
        }
        .cookie-consent-text a { color: var(--primary); text-decoration: underline; }
        .cookie-consent-text a:hover { color: var(--primary-dark); }
        #cookie-consent-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #cookie-consent-btn:hover { background: var(--primary-dark); }
        #cookie-consent-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        
        /* Visually hidden class for accessibility */
        .visually-hidden {
            border: 0;
            clip: rect(0 0 0 0);
            height: 1px;
            margin: -1px;
            overflow: hidden;
            padding: 0;
            position: absolute;
            width: 1px;
        }

        /* ===== RESPONSIVE (From Mortgage Calc) ===== */
        @media (max-width: 1024px) {
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel {
                position: static; /* Remove sticky on mobile */
            }
            .footer-content { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .header-features { display: none; }
            .sponsor-banner { flex-direction: column; gap: 12px; }
            .sponsor-buttons { flex: 1 1 100%; justify-content: space-between; }
            .tab-buttons { flex-wrap: nowrap; overflow-x: auto; }
            .inputs-panel, .results-panel { padding: 16px; }
            .footer-sponsor { padding: 24px; }
        }

        @media (max-width: 480px) {
            .calculator-title { display: none; }
            .header-features { display: none; }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .header-controls {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            #pwa-install-btn { flex-grow: 1; }
            .payment-breakdown { font-size: 0.75rem; }
            .amount { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; }
            .sponsor-grid { grid-template-columns: 1fr; }
            #cookie-consent-banner { flex-direction: column; text-align: center; }
            .cookie-consent-text { flex-basis: auto; }
            #cookie-consent-btn { width: 100%; }
        }

        /* ===== PRINT STYLE (From Mortgage Calc) ===== */
        @media print {
            .header, .sponsor-banner, .header-controls, .footer-sponsor, .faq-section, 
            .footer, .ad-slot, #cookie-consent-banner, .tab-buttons {
                display: none;
            }
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel, .results-panel { box-shadow: none; border: 1px solid #ccc; }
            .tab-content.active { display: block; }
            .tab-content { display: none; }
        }
    </style>
    <!-- END: Inlined CSS -->

    <!-- Google Analytics Script (From Requirements) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYBL2CDNQJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NYBL2CDNQJ');
    </script>

    <!-- PWA Install & Preload Logic (From Mortgage Calc) -->
    <script>
        // PWA Install Detection
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            const pwaInstall = document.getElementById('pwa-install-btn');
            if (pwaInstall) pwaInstall.style.display = 'flex';
        });

        // Preload critical resources
        document.addEventListener('DOMContentLoaded', () => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'script';
            link.href = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            document.head.appendChild(link);
        });
    </script>
</head>
<body>
    <!-- Header (From Mortgage Calc, Titles Updated) -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="https://www.finguid.com" class="logo">
                    <span role="img" aria-label="Money bag emoji">üí∞</span>
                    <span>FinGuid USA</span>
                </a>
                
                <span class="calculator-title">AI Refinance Calculator</span>

                <div class="header-features" aria-hidden="true">
                    <span class="header-feature-item">ü§ñ AI Powered</span>
                    <span class="header-feature-item">üìà Live FRED Rates</span>
                    <span class="header-feature-item">üí° Break-Even Analysis</span>
                    <span class="header-feature-item">‚úÖ WCAG 2.1 AA</span>
                </div>

                <div class="header-controls">
                    <button type="button" id="pwa-install-btn" aria-label="Install App">üì± Install</button>
                    <button type="button" class="icon-btn" id="darkModeToggle" aria-label="Toggle dark mode" title="Dark mode">üåô</button>
                    <button type="button" class="icon-btn" id="voiceToggle" aria-label="Voice control" title="Voice commands">üé§</button>
                    <button type="button" class="icon-btn" id="ttsToggle" aria-label="Text to speech" title="Read results">üîä</button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Sponsor Banner (From Mortgage Calc) -->
    <div class="sponsor-banner">
        <span class="sponsor-text">üéÅ Time to Refinance? Get a $1,000 Credit From Our Partners.</span>
        <div class="sponsor-buttons">
            <button type="button" class="sponsor-btn" onclick="location.href='#our-partners'">Compare Refi Rates ‚Üí</button>
            <button type="button" class="sponsor-btn" onclick="app.showPartnerAlert()">Become our partner ‚Üí</button>
        </div>
    </div>

    <main class="container" role="main">
        <div class="calculator-wrapper">
            <!-- ===== INPUTS PANEL (Content from Refinance Calc) ===== -->
            <section class="inputs-panel" role="region" aria-labelledby="inputs-title">
                <h2 class="panel-title" id="inputs-title">üìã Refinance Parameters</h2>

                <div class="section-heading">Current Loan Details</div>
                <div class="form-group">
                    <label class="form-label" for="current-principal">Current Mortgage Balance
                        <span class="tooltip" data-tooltip="Your remaining loan principal." tabindex="0" role="tooltip" id="tooltip-principal">
                            <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-addon" aria-hidden="true">$</span>
                        <input type="number" id="current-principal" value="300000" min="10000" step="1000" aria-label="Current Mortgage Balance" aria-describedby="tooltip-principal">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="current-rate">Current Rate
                            <span class="tooltip" data-tooltip="Your existing interest rate." tabindex="0" role="tooltip" id="tooltip-curr-rate">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="current-rate" value="6.5" min="0" max="15" step="0.01" aria-label="Current Interest rate" aria-describedby="tooltip-curr-rate">
                            <span class="input-addon" aria-hidden="true">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="current-term-remaining">Term Left
                            <span class="tooltip" data-tooltip="Years left on your loan." tabindex="0" role="tooltip" id="tooltip-curr-term">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="current-term-remaining" value="25" min="1" max="40" aria-label="Current term remaining in years" aria-describedby="tooltip-curr-term">
                            <span class="input-addon" aria-hidden="true">yrs</span>
                        </div>
                    </div>
                </div>

                <div class="section-heading">New Refinance Loan</div>
                
                <div class="form-group">
                    <label class="form-label" for="new-rate">New Interest Rate %</label>
                    <div class="input-wrapper">
                        <input type="number" id="new-rate" value="6.50" min="0" max="15" step="0.01" aria-label="New interest rate">
                        <span class="input-addon" aria-hidden="true">%</span>
                    </div>
                    
                    <!-- FRED Rates (From Mortgage Calc) -->
                    <div class="fred-rates-header">
                        <span id="fred-last-updated">Loading live rates...</span>
                        <span class="fred-branding">
                            Data via <a href="https://fred.stlouisfed.org/" target="_blank" rel="noopener">FRED¬Æ</a>
                        </span>
                    </div>
                    <div class="live-rates-container">
                        <button type="button" class="rate-btn" id="rate-btn-30yr" disabled>30-Yr Fixed: ...</button>
                        <button type="button" class="rate-btn" id="rate-btn-15yr" disabled>15-Yr Fixed: ...</button>
                        <button type="button" class="rate-btn" id="rate-btn-10yr" disabled>10-Yr Treasury: ...</button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="new-term">New Loan Term
                            <span class="tooltip" data-tooltip="The term for your new loan." tabindex="0" role="tooltip" id="tooltip-term">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <select id="new-term" aria-label="New loan term" aria-describedby="tooltip-term">
                            <option value="30">30 Years</option>
                            <option value="20">20 Years</option>
                            <option value="15" selected>15 Years</option>
                            <option value="10">10 Years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="refinance-costs">Closing Costs
                            <span class="tooltip" data-tooltip="Total fees for the refinance (origination, appraisal, etc.)." tabindex="0" role="tooltip" id="tooltip-costs">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-addon" aria-hidden="true">$</span>
                            <input type="number" id="refinance-costs" value="7000" min="0" step="100" aria-label="Refinance closing costs" aria-describedby="tooltip-costs">
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== RESULTS PANEL (Content from Refinance Calc) ===== -->
            <section class="results-panel" role="region" aria-labelledby="results-title">
                <h2 class="panel-title" id="results-title">üìä Refinance Analysis</h2>

                <!-- Ad Slot (From Mortgage Calc) -->
                <div class="ad-slot" role="complementary" aria-label="Advertisement">
                    <p class="ad-label">ADVERTISEMENT</p>
                    <div class="ad-placeholder">
                        <p>Compare Today's Best Refinance Rates</p>
                    </div>
                </div>

                <!-- Main Summary (Adapted for Refinance) -->
                <div class="summary-card">
                    <div class="summary-label">Refinance Break-Even Point</div>
                    <div class="payment-amount">
                        <span class="amount" id="result-breakeven" aria-live="polite">--</span>
                    </div>
                    <div class="payment-breakdown" id="result-summary-text" aria-live="polite">New Payment: $0 | Monthly Savings: $0</div>
                </div>
                
                <div class="tabs">
                    <!-- Tabs (Adapted for Refinance) -->
                    <div class="tab-buttons" role="tablist" aria-label="Results sections">
                        <button type="button" class="tab-btn active" role="tab" aria-controls="analysis" aria-selected="true" id="tab-analysis">Savings Analysis</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="charts" aria-selected="false" id="tab-charts" tabindex="-1">Cost Comparison Chart</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="insights" aria-selected="false" id="tab-insights" tabindex="-1">AI Insights</button>
                    </div>

                    <!-- Savings Analysis Tab -->
                    <div class="tab-content active" id="analysis" role="tabpanel" aria-labelledby="tab-analysis" tabindex="0">
                        <h3 class="results-heading">Monthly Payment Comparison</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <div class="result-label">Current P&I Payment</div>
                                <div class="result-value" id="current-monthly-payment">$0</div>
                            </div>
                            <div class="result-box highlight">
                                <div class="result-label">New P&I Payment</div>
                                <div class="result-value" id="new-monthly-payment">$0</div>
                            </div>
                            <div class="result-box" id="monthly-diff-box">
                                <div class="result-label">Monthly Savings / Cost</div>
                                <div class="result-value" id="monthly-difference">$0</div>
                            </div>
                        </div>
                        
                        <h3 class="results-heading">Lifetime Loan Comparison</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <div class="result-label">Total Closing Costs</div>
                                <div class="result-value" id="refinance-total-costs">$0</div>
                            </div>
                            <div class="result-box success" id="interest-saved-box">
                                <div class="result-label">Total Interest Saved</div>
                                <div class="result-value" id="total-interest-saved">$0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Tab -->
                    <div class="tab-content" id="charts" role="tabpanel" aria-labelledby="tab-charts" tabindex="0">
                        <h3 class="results-heading">Total Loan Cost Comparison</h3>
                        <div class="chart-container">
                            <canvas id="refinanceChart" role="img" aria-label="Bar chart comparing total cost of current vs. new loan"></canvas>
                        </div>
                    </div>

                    <!-- AI Insights Tab -->
                    <div class="tab-content" id="insights" role="tabpanel" aria-labelledby="tab-insights" tabindex="0">
                         <h3 class="results-heading">ü§ñ AI-Powered Insights</h3>
                        <div class="insights-container" id="insightsContainer" aria-live="polite">
                            <div class="insight-box">
                                <strong>ü§ñ AI Advisor:</strong> Enter your details to generate personalized insights...
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Partner Section (From Mortgage Calc) -->
        <section class="footer-sponsor" id="our-partners" aria-labelledby="partners-title">
            <div class="container">
                <h3 id="partners-title" style="text-align: center; margin-bottom: 24px; color: var(--primary); font-size: 24px; font-weight: 700;">Explore Refinance Partners</h3>
                <div class="sponsor-grid">
                    <div class="sponsor-item">
                        <h4>üí≥ Rate & Term Refi</h4>
                        <p>Lower your rate or change your term. Compare top lenders for free. See your new payment.</p>
                        <a href="#affiliate-link-1" onclick="app.showPartnerAlert('Rate/Term Refi Lender'); return false;" aria-label="Get Quotes for Rate and Term Refinance">Get Quotes ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üè† Cash-Out Refinance</h4>
                        <p>Access your home's equity for repairs, debt, or investments. Get multiple cash-out offers.</p>
                        <a href="#affiliate-link-2" onclick="app.showPartnerAlert('Cash-Out Refi Lender'); return false;" aria-label="Compare Rates for Cash-Out Refinance">Compare Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üèõÔ∏è VA Streamline (IRRRL)</h4>
                        <p>For veterans. Lower your rate with a VA Interest Rate Reduction Refinance Loan. Fast & easy.</p>
                        <a href="#affiliate-link-3" onclick="app.showPartnerAlert('VA IRRRL Lender'); return false;" aria-label="Check Rates for VA Streamline Refinance">Check VA Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üîß Home Equity (HELOC)</h4>
                        <p>Don't want to refi? Access equity with a Home Equity Line of Credit instead. Check your options.</p>
                        <a href="#affiliate-link-4" onclick="app.showPartnerAlert('HELOC Lender'); return false;" aria-label="View Plans for Home Equity Lines of Credit">View HELOC Plans ‚Üí</a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- FAQ Section (Content Updated for Refinance) -->
        <section class="faq-section" aria-labelledby="faq-title">
            <h2 class="faq-title" id="faq-title">‚ùì Refinance Frequently Asked Questions</h2>
            <div class="faq-container" id="faqContainer">
                <!-- FAQs will be dynamically inserted here by JS -->
            </div>
        </section>

        <!-- Footer (From Mortgage Calc, Links Updated) -->
        <footer class="footer" role="contentinfo">
            <div class="container">
                <div class="footer-content">
                    <nav class="footer-section" role="navigation" aria-label="About this calculator">
                        <h4>About Refinance Calc</h4>
                        <a href="#how-it-works">How It Works</a>
                        <a href="#break-even">Break-Even Point</a>
                        <a href="#faq">FAQ</a>
                        <a href="#contact">Contact Us</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Learn more about refinancing">
                        <h4>Learn More</h4>
                        <a href="#what-is-refi">What is Refinancing?</a>
                        <a href="#cash-out">Cash-Out vs Rate/Term</a>
                        <a href="#rates">Current Refi Rates</a>
                        <a href="#blog">Blog</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Financial resources">
                        <h4>Resources</h4>
                        <a href="/calculators/mortgage">Mortgage Calculator</a>
                        <a href="/calculators/affordability">Affordability Calculator</a>
                        <a href="#tools">Financial Tools</a>
                        <a href="#glossary">Glossary</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Legal links">
                        <h4>Legal</h4>
                        <a href="#privacy">Privacy Policy</a>
                        <a href="#terms">Terms of Service</a>
                        <a href="#disclaimer">Disclaimer</a>
                        <a href="#affiliate">Affiliate Disclosure</a>
                    </nav>
                </div>

                <div class="compliance-badges" role="list" aria-label="Compliance Badges">
                    <span class="badge" role="listitem">üîí SSL Secured</span>
                    <span class="badge" role="listitem">‚úÖ GDPR Compliant</span>
                    <span class="badge" role="listitem">‚úÖ CCPA Compliant</span>
                    <span class="badge" role="listitem">‚úÖ FTC Compliant</span>
                    <span class="badge" role="listitem">‚ôø WCAG 2.1 AA</span>
                </div>

                <!-- Disclaimers (Updated for Refinance) -->
                <section class="disclaimer" aria-label="Disclaimers and Disclosures">
                    <strong>Educational & Informational Only:</strong> This refinance calculator is for educational and informational purposes only. It is NOT financial advice. Results (including break-even point and savings) are estimates based on user-provided data and do not represent a loan offer, pre-qualification, or guarantee of savings. Actual mortgage rates, terms, and closing costs may vary significantly based on credit score, debt-to-income ratio, home value, location, loan type, and many other factors. Always consult with a qualified mortgage professional or financial advisor before making any borrowing decisions.
                    <br><br>
                    <strong>Affiliate Disclosure:</strong> FinGuid participates in affiliate programs with lending partners. When you click on partner links or apply for mortgage products through this calculator, FinGuid may receive compensation. This does not affect your rates or terms. We only recommend products we believe provide value to users.
                    <br><br>
                    <strong>Data Accuracy:</strong> Mortgage rates (MORTGAGE30US, MORTGAGE15US) provided by Freddie Mac. Treasury rates (DGS10) provided by the U.S. Treasury. All data delivered via FRED¬Æ API from the Federal Reserve Bank of St. Louis. Rates are updated regularly but we make no guarantees about accuracy. Always verify rates directly with lenders.
                </section>

                <div class="footer-bottom">
                    ¬© 2025 FinGuid USA. All Rights Reserved. | AI-Powered Financial Tools for Americans
                </div>
            </div>
        </footer>
    </main>

    <!-- Cookie Consent Banner (From Mortgage Calc) -->
    <div id="cookie-consent-banner" role="dialog" aria-modal="true" aria-labelledby="cookie-consent-title" aria-describedby="cookie-consent-desc">
        <div class="cookie-consent-text">
            <h4 id="cookie-consent-title" style="font-weight: 700; color: var(--text); margin-bottom: 8px;">Your Privacy</h4>
            <p id="cookie-consent-desc">
                We use cookies and data to enhance your experience and provide personalized AI insights. By clicking "Accept", you agree to our use of cookies.
                <a href="#privacy" aria-label="Read our Privacy Policy">Privacy Policy</a>.
            </p>
        </div>
        <button type="button" id="cookie-consent-btn">Accept</button>
    </div>

    <!-- Custom Alert Modal (From Mortgage Calc) -->
    <style>
        .alert-modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .alert-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10003;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            display: none;
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }
        .alert-modal.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-backdrop.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }
        .alert-modal-body {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .alert-modal-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .alert-modal-btn:hover { background: var(--primary-dark); }
        .alert-modal-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
    </style>
    <div class="alert-modal-backdrop" id="alert-modal-backdrop"></div>
    <div class="alert-modal" id="alert-modal" role="alertdialog" aria-modal="true" aria-labelledby="alert-modal-title" aria-describedby="alert-modal-body">
        <h4 class="alert-modal-title" id="alert-modal-title">Partner Information</h4>
        <p class="alert-modal-body" id="alert-modal-body">
            This is an affiliate link for [Partner].
        </p>
        <button type="button" class="alert-modal-btn" id="alert-modal-close">Close</button>
    </div>
    <!-- END: Modal for Alerts -->

    <!-- CDN Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- 
      START: Inlined JavaScript
      Contains all logic from the mortgage-calculator template,
      merged with the calculation logic from refinance-calculator.js
    -->
    <script>
        /**
         * ========================================================================
         * AI-POWERED REFINANCE CALCULATOR (UNIFIED)
         * ========================================================================
         * Version: 9.0 - UNIFIED BUILD
         * Built with: SOLID Principles, WCAG 2.1 AA, PWA Compatible, GDPR/CCPA
         *
         * This file merges the mortgage-calculator.html template with the
         * refinance-calculator.js logic.
         * ========================================================================
         */

        // ===== APP STATE & CONSTANTS =====
        const FRED_API_KEY = '9c6c421f077f2091e8bae4f143ada59a'; // From requirements
        const FRED_URL = 'https://api.stlouisfed.org/fred/series/observations';
        const FRED_SERIES_IDS = {
            rate30: 'MORTGAGE30US', // 30-Year Fixed
            rate15: 'MORTGAGE15US', // 15-Year Fixed
            rate10: 'DGS10'           // 10-Year Treasury
        };

        const FALLBACK_RATES = {
            rates: { rate30: 6.85, rate15: 6.15, rate10: 4.50 },
            dates: { rate30: null, rate15: null, rate10: null },
        };
        
        // --- FAQs Updated for Refinance ---
        const FAQs = [
            {
                q: "What is a refinance calculator?",
                a: "A refinance calculator is an AI-powered tool that helps you decide if refinancing your mortgage is a good idea. It compares your current loan to a new loan and calculates your **break-even point** (how long it takes for the savings to cover the costs) and your **total interest savings**."
            },
            {
                q: "What is the 'break-even point'?",
                a: "The break-even point is the most important metric. It's the number of months it takes for your monthly savings from refinancing to pay back the closing costs. For example, if costs are $5,000 and you save $200/month, your break-even point is 25 months. You must plan to stay in the home *longer* than this period to actually save money."
            },
            {
                q: "When should I refinance my mortgage?",
                a: "The best time to refinance is when current interest rates are significantly lower than your existing rate (typically 0.75% to 1% or more). You should also plan to stay in your home long enough to pass the 'break-even point' and realize the savings."
            },
            {
                q: "What are refinance closing costs?",
                a: "These are fees you pay to get the new loan, typically 2-5% of the loan amount. They include origination fees, appraisal fees, title insurance, and more. This calculator factors these costs directly into your break-even analysis."
            },
            {
                q: "What is a 'rate and term' vs. 'cash-out' refinance?",
                a: "**Rate and Term:** This is the most common type. You replace your old loan with a new one, typically to get a lower interest rate or change your loan term (e.g., from a 30-year to a 15-year).<br/>**Cash-Out:** You take out a new, larger loan than what you owe and receive the difference in cash. This is a way to tap into your home's equity, but it increases your loan balance."
            },
            {
                q: "Does it make sense to refinance to a shorter term (e.g., 30 to 15 years)?",
                a: "Often, yes! Your monthly payment will be *higher*, so this calculator will show 'No Monthly Savings.' However, you will pay off the loan decades sooner and save a massive amount in total interest. Our AI Insights will detect this strategy and show you the total interest saved."
            },
            {
                q: "How does this calculator get live interest rates?",
                a: "This AI calculator automatically fetches the latest available mortgage rates (30-Year, 15-Year) from the **FRED¬Æ API** (Federal Reserve Bank of St. Louis). This rate is then used as the default in the 'New Interest Rate' field to give you a realistic starting point."
            }
        ];

        // ===== CORE REFINANCE LOGIC (From refinance-calculator.js) =====
        class RefinanceCalculator {
            
            static getInputs() {
                const parseNumeric = (id, defaultValue = 0) => {
                    const element = document.getElementById(id);
                    if (!element) return defaultValue;
                    return parseFloat(element.value.replace(/[^0-9.]/g, '')) || defaultValue; 
                };
                
                return {
                    currentPrincipal: parseNumeric('current-principal', 300000),
                    currentRate: parseNumeric('current-rate', 6.5),
                    currentTermRemaining: parseNumeric('current-term-remaining', 25),
                    newRate: parseNumeric('new-rate', 6.5),
                    newTerm: parseInt(document.getElementById('new-term').value) || 15,
                    refinanceCosts: parseNumeric('refinance-costs', 7000),
                };
            }

            /**
             * Calculates the monthly principal and interest (P&I) payment.
             */
            static calculateMonthlyPayment(principal, annualRate, termYears) {
                if (principal <= 0 || termYears <= 0) return 0;
                
                const rate = (annualRate / 100) / 12; // Monthly rate
                const payments = termYears * 12; // Total number of payments

                if (rate === 0) {
                    return principal / payments; // Simple division for 0% rate
                }

                const numerator = principal * rate * Math.pow(1 + rate, payments);
                const denominator = Math.pow(1 + rate, payments) - 1;
                
                if (denominator === 0) return 0;

                return numerator / denominator;
            }

            /**
             * Calculates the total interest paid over the loan term.
             */
            static calculateTotalInterest(monthlyPayment, termYears, principal) {
                if (principal <= 0) return 0;
                const totalPayments = termYears * 12;
                const totalPaid = monthlyPayment * totalPayments;
                return totalPaid - principal;
            }
            
            static calculate() {
                const inputs = this.getInputs();
                const s = inputs; // Use s for brevity, matching original refi logic

                // Core Calculation
                const currentMonthlyPayment = this.calculateMonthlyPayment(s.currentPrincipal, s.currentRate, s.currentTermRemaining);
                const newMonthlyPayment = this.calculateMonthlyPayment(s.currentPrincipal, s.newRate, s.newTerm);
                
                // Note: Positive means savings, negative means new payment is higher (cost)
                const monthlyDifference = currentMonthlyPayment - newMonthlyPayment; 

                const totalCurrentInterest = this.calculateTotalInterest(currentMonthlyPayment, s.currentTermRemaining, s.currentPrincipal);
                const totalNewInterest = this.calculateTotalInterest(newMonthlyPayment, s.newTerm, s.currentPrincipal);
                
                // Total interest saved compares the *total future interest*
                const totalInterestSaved = totalCurrentInterest - totalNewInterest;

                // Break-even Analysis (Key Metric)
                let breakEvenMonths = -1; // Flag for no break-even on monthly savings
                if (monthlyDifference > 0 && s.refinanceCosts > 0) {
                    // Refinancing saves money monthly, calculate break-even
                    breakEvenMonths = Math.ceil(s.refinanceCosts / monthlyDifference);
                } else if (monthlyDifference > 0 && s.refinanceCosts <= 0) {
                    breakEvenMonths = 0; // Immediate savings if no costs
                }

                return {
                    ...inputs,
                    currentMonthlyPayment,
                    newMonthlyPayment,
                    monthlyDifference,
                    totalCurrentInterest,
                    totalNewInterest,
                    totalInterestSaved,
                    breakEvenMonths
                };
            }
        }

        // ===== AI INSIGHTS ENGINE (Logic from refinance-calculator.js) =====
        class AIInsightEngine {
            
            static formatBreakEven(months) {
                if (months === -1) {
                    return "N/A (Payment is higher)";
                }
                if (months === 0) {
                    return "Immediate Savings";
                }
                const years = Math.floor(months / 12);
                const remainingMonths = months % 12;
                let str = "";
                if (years > 0) str += `${years} ${years > 1 ? 'Years' : 'Year'}`;
                if (remainingMonths > 0) str += ` ${remainingMonths} ${remainingMonths > 1 ? 'Months' : 'Month'}`;
                return str.trim();
            }

            static generateInsights(results) {
                const insights = [];
                const s = results; // Use results object
                const fmtd = UIManager.formatCurrency;
                
                // Insight 1: Is refinancing a good idea? (Based on Monthly Savings / Break-even)
                if (s.monthlyDifference > 0) {
                    // Monthly Savings Scenario
                    if (s.breakEvenMonths === 0) {
                         insights.push({
                            title: "‚úÖ Excellent Deal",
                            text: `With **${fmtd(s.refinanceCosts)} closing costs** and **${fmtd(s.monthlyDifference, 2)} monthly savings**, your break-even is **immediate**. This is a highly recommended refinance.`,
                            type: 'success'
                        });
                    } else if (s.breakEvenMonths < 24) {
                        insights.push({
                            title: "‚úÖ Strong Recommendation",
                            text: `Your break-even point is very fast: **${this.formatBreakEven(s.breakEvenMonths)}**. Assuming you stay in your home for at least this long, this is an excellent financial move.`,
                            type: 'success'
                        });
                    } else if (s.breakEvenMonths < (s.currentTermRemaining * 12) / 2) {
                        insights.push({
                            title: "üëç Good Move",
                            text: `Your break-even point is **${this.formatBreakEven(s.breakEvenMonths)}**. This is a solid financial decision, as you will realize **${fmtd(s.totalInterestSaved, 0)}** in total interest savings over the life of the new loan.`,
                            type: 'info'
                        });
                    } else {
                         insights.push({
                            title: "‚ö†Ô∏è Caution Advised",
                            text: `Your break-even point is **${this.formatBreakEven(s.breakEvenMonths)}**, which is quite long. Ensure you plan to stay in your home for *at least* this period, otherwise the closing costs will make you lose money.`,
                            type: 'warning'
                        });
                    }
                } else {
                    // Higher Monthly Payment Scenario (e.g., refi from 30yr to 15yr)
                    if (s.newTerm < s.currentTermRemaining) {
                        insights.push({
                            title: "üöÄ Aggressive Payoff Strategy",
                            text: `Your new payment is **${fmtd(Math.abs(s.monthlyDifference), 2)} higher**, but this is a powerful wealth-building strategy. By switching from a ${s.currentTermRemaining}-year to a ${s.newTerm}-year term, you will save **${fmtd(s.totalInterestSaved, 0)}** in total interest and own your home years sooner.`,
                            type: 'success'
                        });
                    } else {
                         insights.push({
                            title: "‚ùå Not Recommended",
                            text: `This refinance is **not recommended**. Your new interest rate of ${s.newRate}% results in a higher monthly payment (**${fmtd(Math.abs(s.monthlyDifference), 2)} more**) without shortening your term. This would cost you **${fmtd(Math.abs(s.totalInterestSaved), 0)}** more over the life of the loan.`,
                            type: 'error'
                        });
                    }
                }

                // Insight 2: Monetization/Affiliate Insight
                if (s.monthlyDifference > 50 || s.totalInterestSaved > 20000) {
                     insights.push({ 
                        title: "Partner Recommendation", 
                        text: `Your profile shows significant savings potential. **Compare live rates from our partners** to lock in these savings, often with reduced origination fees.`,
                        type: 'monetization' 
                    });
                }
                
                // Insight 3: Closing Costs
                if (s.refinanceCosts > (s.currentPrincipal * 0.04)) {
                     insights.push({ 
                        title: "High Closing Costs", 
                        text: `Your closing costs of **${fmtd(s.refinanceCosts)}** seem high (over 4% of your loan). **AI Tip:** Ask lenders for a "no-cost" refinance, which rolls the fees into a slightly higher interest rate. This can be smart if you don't plan to stay long-term.`,
                        type: 'warning' 
                    });
                }

                return insights;
            }
        }

        // ===== FRED API MANAGER (From Mortgage Calc) =====
        class FREDManager {
            
            static getEasternTimeInfo() {
                const now = new Date();
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const parts = etFormatter.formatToParts(now).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const currentETDate = `${parts.year}-${parts.month.padStart(2, '0')}-${parts.day.padStart(2, '0')}`;
                const currentETHour = parseInt(parts.hour, 10);
                const currentETMinute = parseInt(parts.minute, 10);
                const isAfterCutoff = (currentETHour > 16) || (currentETHour === 16 && currentETMinute >= 45);

                return { currentETDate, isAfterCutoff, now };
            }

            static isCacheValid(cache) {
                const { lastFetch } = cache;
                if (!lastFetch) return false;

                const { currentETDate, isAfterCutoff } = this.getEasternTimeInfo();

                const lastFetchDate = new Date(lastFetch);
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const lastFetchParts = etFormatter.formatToParts(lastFetchDate).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const lastFetchETDate = `${lastFetchParts.year}-${lastFetchParts.month.padStart(2, '0')}-${lastFetchParts.day.padStart(2, '0')}`;
                const lastFetchHour = parseInt(lastFetchParts.hour, 10);
                const lastFetchMinute = parseInt(lastFetchParts.minute, 10);
                const wasLastFetchAfterCutoff = (lastFetchHour > 16) || (lastFetchHour === 16 && lastFetchMinute >= 45);

                if (currentETDate !== lastFetchETDate) {
                    if (isAfterCutoff) {
                        return false; 
                    }
                    if (wasLastFetchAfterCutoff) {
                        return true;
                    }
                    return false;
                }
                if (!wasLastFetchAfterCutoff && isAfterCutoff) {
                    return false;
                }
                return true;
            }

            static formatTimestamp(now) {
                return new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    dateStyle: 'short',
                    timeStyle: 'short'
                }).format(now) + " ET";
            }

            static async fetchFredSeries(seriesId) {
                try {
                    const url = `${FRED_URL}?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json&sort_order=desc&limit=1`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`FRED API request failed for ${seriesId}: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.observations && data.observations.length > 0) {
                        const rate = parseFloat(data.observations[0].value);
                        const date = data.observations[0].date;
                        if (isNaN(rate)) return { rate: null, date: null };
                        return { rate, date };
                    }
                } catch (error) {
                    console.error(error);
                }
                return { rate: null, date: null };
            }

            static async getRates() {
                const cacheStr = localStorage.getItem('fredRatesCache');
                let cache = cacheStr ? JSON.parse(cacheStr) : null;
                
                const { now } = this.getEasternTimeInfo();

                if (cache && this.isCacheValid(cache)) {
                    console.log('Using cached FRED rates');
                    return {
                        ...cache,
                        isCache: true,
                        lastUpdatedTimestamp: `Rates as of ${this.formatTimestamp(new Date(cache.lastFetch))}`
                    };
                }

                console.log('Fetching new FRED rates');
                
                const [data30, data15, data10] = await Promise.all([
                    this.fetchFredSeries(FRED_SERIES_IDS.rate30),
                    this.fetchFredSeries(FRED_SERIES_IDS.rate15),
                    this.fetchFredSeries(FRED_SERIES_IDS.rate10)
                ]);

                const newRates = {
                    rate30: data30.rate || FALLBACK_RATES.rates.rate30,
                    rate15: data15.rate || FALLBACK_RATES.rates.rate15,
                    rate10: data10.rate || FALLBACK_RATES.rates.rate10,
                };

                const newDates = {
                    date30: data30.date || null,
                    date15: data15.date || null,
                    date10: data10.date || null,
                };

                const newCache = {
                    rates: newRates,
                    dates: newDates,
                    lastFetch: now.toISOString()
                };

                localStorage.setItem('fredRatesCache', JSON.stringify(newCache));

                return {
                    ...newCache,
                    isCache: false,
                    lastUpdatedTimestamp: `Live Rates updated: ${this.formatTimestamp(now)}`
                };
            }
        }

        // ===== UI MANAGER (From Mortgage Calc, adapted for Refi) =====
        class UIManager {
            static formatCurrency(value, decimals = 0) {
                if (typeof value !== 'number' || isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(value);
            }
            static formatPercent(value, decimals = 2) { 
                if (!isFinite(value) || isNaN(value) || value < 0) return '0.00%';
                return (value * 100).toFixed(decimals) + '%'; 
            } 

            static updateResults(results) {
                 const s = results; // Use results object
                 const fmtd = this.formatCurrency;
                 
                 // Main Summary Card
                 const breakEvenText = AIInsightEngine.formatBreakEven(s.breakEvenMonths);
                 document.getElementById('result-breakeven').textContent = breakEvenText;
                 
                 let summaryText = `New P&I: ${fmtd(s.newMonthlyPayment, 2)}`;
                 if (s.monthlyDifference > 0) {
                    summaryText += ` | <span class="savings">Save: ${fmtd(s.monthlyDifference, 2)}/mo</span>`;
                 } else if (s.monthlyDifference < 0) {
                    summaryText += ` | <span class="cost">Cost: ${fmtd(Math.abs(s.monthlyDifference), 2)}/mo</span>`;
                 }
                 document.getElementById('result-summary-text').innerHTML = summaryText;

                 // Tab 1: Savings Analysis
                 document.getElementById('current-monthly-payment').textContent = fmtd(s.currentMonthlyPayment, 2);
                 document.getElementById('new-monthly-payment').textContent = fmtd(s.newMonthlyPayment, 2);
                 
                 const diffEl = document.getElementById('monthly-difference');
                 const diffBox = document.getElementById('monthly-diff-box');
                 if (s.monthlyDifference > 0.01) {
                    diffEl.textContent = `${fmtd(s.monthlyDifference, 2)} Savings`;
                    diffEl.className = 'result-value positive';
                    diffBox.className = 'result-box success';
                 } else if (s.monthlyDifference < -0.01) {
                    diffEl.textContent = `${fmtd(Math.abs(s.monthlyDifference), 2)} Cost`;
                    diffEl.className = 'result-value negative';
                    diffBox.className = 'result-box error';
                 } else {
                     diffEl.textContent = fmtd(0, 2);
                     diffEl.className = 'result-value';
                     diffBox.className = 'result-box';
                 }
                 
                 document.getElementById('refinance-total-costs').textContent = fmtd(s.refinanceCosts, 0);
                 
                 const interestSavedEl = document.getElementById('total-interest-saved');
                 const interestSavedBox = document.getElementById('interest-saved-box');
                 if (s.totalInterestSaved > 0) {
                    interestSavedEl.textContent = `${fmtd(s.totalInterestSaved, 0)}`;
                    interestSavedEl.className = 'result-value positive';
                    interestSavedBox.className = 'result-box success';
                 } else {
                    interestSavedEl.textContent = `${fmtd(s.totalInterestSaved, 0)}`;
                    interestSavedEl.className = 'result-value negative';
                    interestSavedBox.className = 'result-box error';
                 }
            }
            
            static updateInsights(insights) {
                const container = document.getElementById('insightsContainer');
                container.innerHTML = '';
                if(!insights || insights.length === 0) {
                     container.innerHTML = '<div class="insight-box"><strong>ü§ñ AI Advisor:</strong> Enter valid loan details to generate personalized insights...</div>';
                     return;
                }
                insights.forEach(insight => {
                    const box = document.createElement('div');
                    // Use 'monetization' class if present, otherwise 'info', 'warning', etc.
                    box.className = `insight-box ${insight.type || 'info'}`;
                    // Bold markdown support
                    const insightText = insight.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    box.innerHTML = `<strong>${insight.title}:</strong> ${insightText}`;
                    container.appendChild(box);
                });
            }
        }

        // ===== CHART MANAGER (From Mortgage Calc, adapted for Refi) =====
        class ChartManager {
            static charts = {};

            static registerPlugins() {
                if (Chart.registerables) { 
                    if (typeof ChartDataLabels !== 'undefined') {
                        Chart.register(ChartDataLabels);
                    }
                }
            }

            static renderRefinanceChart(results) {
                const s = results;
                const ctx = document.getElementById('refinanceChart').getContext('2d');
                if (!ctx) return;
                if (this.charts.refinanceChart) this.charts.refinanceChart.destroy();
                
                // Data for comparison: Total Cost (Principal + Interest + Fees)
                const currentLoanTotalCost = s.currentPrincipal + s.totalCurrentInterest;
                const newLoanTotalCost = s.currentPrincipal + s.totalNewInterest + s.refinanceCosts;

                const chartData = {
                    labels: ['Current Loan Total Cost', 'New Loan Total Cost'],
                    datasets: [
                        {
                            label: 'Total Cost Over Term',
                            data: [currentLoanTotalCost, newLoanTotalCost],
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.7)', // Error color for current (high cost)
                                'rgba(16, 185, 129, 0.7)'  // Success color for new (low cost)
                            ],
                            borderColor: [
                                'rgba(239, 68, 68, 1)', 
                                'rgba(16, 185, 129, 1)' 
                            ],
                            borderWidth: 1
                        }
                    ]
                };

                this.charts.refinanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: `Total Lifetime Cost Comparison (Including Fees)`,
                                color: 'var(--text)',
                                font: { size: 14, weight: '600' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => UIManager.formatCurrency(context.parsed.y, 0)
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false, // Start near the data
                                ticks: { 
                                    color: 'var(--text-light)',
                                    callback: (value) => `$${value/1000}k` 
                                },
                                grid: { color: 'var(--border)' }
                            },
                            x: {
                                ticks: { color: 'var(--text)' }
                            }
                        }
                    }
                });
            }
        }

        // ===== MAIN APP (Controller) =====
        const app = {
            calculateDebounce: null,
            lastResults: null,
            state: {
                isTtsEnabled: false,
                liveRates: FALLBACK_RATES.rates
            },

            async init() {
                this.setupEventListeners();
                this.setupDarkMode();
                this.setupPWA();
                this.setupVoiceControls();
                this.setupFAQ();
                this.initTooltips(); 
                this.setupTabs();
                this.setupAlertModal();
                this.setupCookieConsent();
                ChartManager.registerPlugins(); 
                await this.loadInitialRates();
            },

            setupEventListeners() {
                // Inputs for refinance calculator
                ['current-principal', 'current-rate', 'current-term-remaining', 'new-rate', 'new-term', 'refinance-costs'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.debouncedCalculate());
                        el.addEventListener('change', () => this.debouncedCalculate());
                    }
                });
                
                // Live Rate Button Listeners (From Mortgage Calc)
                document.getElementById('rate-btn-30yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate30, 'rate-btn-30yr'));
                    
                document.getElementById('rate-btn-15yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate15, 'rate-btn-15yr'));
                    
                document.getElementById('rate-btn-10yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate10, 'rate-btn-10yr'));
            },

            applyRate(rate, btnId) {
                if (!rate) return;
                
                // --- MODIFIED: Apply to 'new-rate' input ---
                document.getElementById('new-rate').value = rate.toFixed(2);
                document.querySelectorAll('.rate-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(btnId).classList.add('active');
                
                this.calculate(); // Recalculate immediately
            },

            setupTabs() {
                const tablist = document.querySelector('[role="tablist"]');
                const tabs = tablist.querySelectorAll('[role="tab"]');
                
                tablist.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('[role="tab"]');
                    if (!clickedTab) return;
                    this.activateTab(clickedTab);
                });

                tablist.addEventListener('keydown', (e) => {
                    let index = Array.from(tabs).indexOf(document.activeElement);
                    if (index === -1) return;

                    let direction = 0;
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        direction = 1;
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        direction = -1;
                    } else if (e.key === 'Home') {
                        e.preventDefault();
                        tabs[0].focus();
                    } else if (e.key === 'End') {
                        e.preventDefault();
                        tabs[tabs.length - 1].focus();
                    }

                    if (direction !== 0) {
                        e.preventDefault();
                        index = (index + direction + tabs.length) % tabs.length;
                        tabs[index].focus();
                    }
                });
            },

            activateTab(tab) {
                const tabId = tab.getAttribute('aria-controls');
                
                document.querySelectorAll('[role="tab"]').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                    t.setAttribute('tabindex', '-1');
                });
                
                document.querySelectorAll('[role="tabpanel"]').forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                tab.setAttribute('tabindex', '0');

                const panel = document.getElementById(tabId);
                panel.classList.add('active');
                panel.style.display = 'block';

                // Render chart if switching to its tab
                if (tabId === 'charts' && this.lastResults) {
                    setTimeout(() => ChartManager.renderRefinanceChart(this.lastResults), 50);
                }
            },
            
            debouncedCalculate() {
                clearTimeout(this.calculateDebounce);
                this.calculateDebounce = setTimeout(() => this.calculate(), 250);
            },

            calculate() {
                const results = RefinanceCalculator.calculate();
                this.lastResults = results;
                
                if (results) {
                    UIManager.updateResults(results);
                    
                    const insights = AIInsightEngine.generateInsights(results);
                    UIManager.updateInsights(insights);

                    if (this.state.isTtsEnabled) {
                        this.speakResults();
                    }
                    
                    // Refresh chart if tab is active
                    const activeTabId = document.querySelector('[role="tab"][aria-selected="true"]').getAttribute('aria-controls');
                    if (activeTabId === 'charts') {
                        setTimeout(() => ChartManager.renderRefinanceChart(this.lastResults), 50);
                    }
                }
            },
            
            initTooltips() {
                let tooltipBox = null;
                document.querySelectorAll('.tooltip').forEach(el => {
                    const showTooltip = (e) => {
                        const text = e.currentTarget.getAttribute('data-tooltip');
                        if (!text) return;
                        if (tooltipBox) tooltipBox.remove();
                        
                        tooltipBox = document.createElement('div');
                        tooltipBox.className = 'tooltip-box';
                        tooltipBox.textContent = text;
                        tooltipBox.setAttribute('role', 'tooltip');
                        document.body.appendChild(tooltipBox);

                        const rect = e.currentTarget.getBoundingClientRect();
                        let top = rect.top - tooltipBox.offsetHeight - 5;
                        let left = rect.left + rect.width / 2 - tooltipBox.offsetWidth / 2;

                        if (top < 0) { top = rect.bottom + 5; }
                        if (left < 0) { left = 5; }
                        if (left + tooltipBox.offsetWidth > window.innerWidth) {
                            left = window.innerWidth - tooltipBox.offsetWidth - 5;
                        }

                        tooltipBox.style.left = `${left}px`;
                        tooltipBox.style.top = `${top}px`;
                        tooltipBox.style.display = 'block';
                        setTimeout(() => { if (tooltipBox) tooltipBox.style.opacity = '1'; }, 10);
                    };

                    const hideTooltip = () => {
                        if (tooltipBox) {
                            tooltipBox.style.opacity = '0';
                            setTimeout(() => {
                                if (tooltipBox) {
                                    tooltipBox.remove();
                                    tooltipBox = null;
                                }
                            }, 200);
                        }
                    };

                    el.addEventListener('mouseenter', showTooltip);
                    el.addEventListener('focus', showTooltip);
                    el.addEventListener('mouseleave', hideTooltip);
                    el.addEventListener('blur', hideTooltip);
                });
            },

            async loadInitialRates() {
                const updatedEl = document.getElementById('fred-last-updated');
                // --- MODIFIED: Apply to 'new-rate' ---
                const rateEl = document.getElementById('new-rate');
                
                const btn30 = document.getElementById('rate-btn-30yr');
                const btn15 = document.getElementById('rate-btn-15yr');
                const btn10 = document.getElementById('rate-btn-10yr');

                try {
                    const { rates, lastUpdatedTimestamp } = await FREDManager.getRates();
                    
                    this.state.liveRates = rates;

                    updatedEl.textContent = lastUpdatedTimestamp;
                    updatedEl.style.color = "var(--text-light)";

                    btn30.textContent = `30-Yr Fixed: ${rates.rate30.toFixed(2)}%`;
                    btn15.textContent = `15-Yr Fixed: ${rates.rate15.toFixed(2)}%`;
                    btn10.textContent = `10-Yr Treasury: ${rates.rate10.toFixed(2)}%`;
                    
                    btn30.disabled = false;
                    btn15.disabled = false;
                    btn10.disabled = false;
                    
                    // --- MODIFIED: Apply to 'new-rate' ---
                    rateEl.value = rates.rate30.toFixed(2);
                    btn30.classList.add('active');

                } catch (error) {
                    console.error("Error loading initial rates:", error);
                    updatedEl.textContent = 'Error loading rates. Using fallbacks.';
                    updatedEl.style.color = "var(--error)";
                    this.state.liveRates = FALLBACK_RATES.rates;
                    btn30.textContent = `30-Yr Fixed: ${this.state.liveRates.rate30.toFixed(2)}%`;
                    btn15.textContent = `15-Yr Fixed: ${this.state.liveRates.rate15.toFixed(2)}%`;
                    btn10.textContent = `10-Yr Treasury: ${this.state.liveRates.rate10.toFixed(2)}%`;
                    // --- MODIFIED: Apply to 'new-rate' ---
                    rateEl.value = this.state.liveRates.rate30.toFixed(2); // Use fallback
                    btn30.classList.add('active');
                }
                
                this.calculate(); // Calculate on load
            },

            setupDarkMode() {
                const toggle = document.getElementById('darkModeToggle');
                const scheme = localStorage.getItem('colorScheme') || 'light';
                document.documentElement.setAttribute('data-color-scheme', scheme);
                
                toggle.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-color-scheme');
                    const next = current === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-color-scheme', next);
                    localStorage.setItem('colorScheme', next);
                    
                    // Force chart redraw on theme change
                    if (this.lastResults) {
                         setTimeout(() => ChartManager.renderRefinanceChart(this.lastResults), 50);
                    }
                });
            },

            setupPWA() {
                const pwaBtn = document.getElementById('pwa-install-btn');
                if (pwaBtn) {
                    pwaBtn.addEventListener('click', async () => {
                        if (window.deferredPrompt) {
                            window.deferredPrompt.prompt();
                            await window.deferredPrompt.userChoice;
                            window.deferredPrompt = null;
                        }
                    });
                }
            },

            setupVoiceControls() {
                const voiceBtn = document.getElementById('voiceToggle');
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = () => { 
                        voiceBtn.classList.add('active'); 
                        voiceBtn.textContent = '..'; 
                    };
                    recognition.onend = () => { 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.textContent = 'üé§'; 
                    };
                    recognition.onerror = (event) => { 
                        console.error('Voice recognition error', event.error); 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.textContent = 'üé§'; 
                    };

                    recognition.onresult = (event) => {
                        const command = event.results[0][0].transcript.toLowerCase();
                        if (command.includes('calculate') || command.includes('compute')) this.calculate();
                        else if (command.includes('read results')) this.speakResults();
                        else if (command.includes('read insights')) this.speakInsights();
                    };
                    voiceBtn.addEventListener('click', () => { try { recognition.start(); } catch(e) { console.error("Voice recognition error", e); } });
                } else {
                     voiceBtn.title = 'Voice control not supported in this browser.';
                     voiceBtn.style.opacity = '0.5';
                     voiceBtn.disabled = true;
                }
                
                const ttsBtn = document.getElementById('ttsToggle');
                ttsBtn.addEventListener('click', () => {
                    this.state.isTtsEnabled = !this.state.isTtsEnabled;

                    if (this.state.isTtsEnabled) {
                        ttsBtn.classList.add('active'); 
                        this.speakResults(); 
                    } else {
                        ttsBtn.classList.remove('active'); 
                        if ('speechSynthesis' in window && speechSynthesis.speaking) {
                            speechSynthesis.cancel(); 
                        }
                    }
                });
            },

            // --- Updated for Refinance ---
            speakResults() {
                if ('speechSynthesis' in window && this.lastResults) {
                    speechSynthesis.cancel();
                    let text = "Calculation complete. ";
                    if (this.lastResults.breakEvenMonths > 0) {
                        text += `Your break-even point is ${AIInsightEngine.formatBreakEven(this.lastResults.breakEvenMonths)}.`;
                    } else if (this.lastResults.monthlyDifference < 0) {
                        text += "Your new payment is higher, but you will save " + UIManager.formatCurrency(this.lastResults.totalInterestSaved, 0) + " in total interest.";
                    } else {
                        text += "This refinance is not recommended.";
                    }
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                }
            },
            
            speakInsights() {
                 if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const insightsContainer = document.getElementById('insightsContainer');
                    const firstInsight = insightsContainer.querySelector('.insight-box');
                    if(firstInsight) {
                        const text = firstInsight.textContent;
                        const utterance = new SpeechSynthesisUtterance(text);
                        speechSynthesis.speak(utterance);
                    }
                }
            },

            setupFAQ() {
                const container = document.getElementById('faqContainer');
                if(!container) return;

                FAQs.forEach((faq, index) => {
                    const qId = `faq-q-${index}`;
                    const aId = `faq-a-${index}`;
                    
                    const item = document.createElement('div');
                    item.className = 'faq-item';
                    item.innerHTML = `
                        <div class="faq-question" role="button" tabindex="0" aria-expanded="false" aria-controls="${aId}" id="${qId}">
                            <span>${faq.q}</span>
                            <span class="faq-icon" aria-hidden="true">‚ñº</span>
                        </div>
                        <div class="faq-answer" role="region" aria-labelledby="${qId}" id="${aId}">${faq.a}</div>
                    `;
                    container.appendChild(item);
                });
                
                container.addEventListener('click', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question) this.toggleFAQ(question);
                });
                
                container.addEventListener('keydown', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question && (e.key === 'Enter' || e.key === ' ')) {
                        e.preventDefault();
                        this.toggleFAQ(question);
                    }
                });
            },
            
            toggleFAQ(question) {
                const answer = document.getElementById(question.getAttribute('aria-controls'));
                const isActive = question.getAttribute('aria-expanded') === 'true';

                document.querySelectorAll('.faq-question[aria-expanded="true"]').forEach(q => {
                    if (q !== question) {
                        q.setAttribute('aria-expanded', 'false');
                        q.classList.remove('active');
                        document.getElementById(q.getAttribute('aria-controls')).style.display = 'none';
                        q.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                    }
                });

                if (!isActive) {
                    question.setAttribute('aria-expanded', 'true');
                    question.classList.add('active');
                    answer.style.display = 'block';
                    answer.style.animation = 'slideDown 0.3s ease';
                    question.querySelector('.faq-icon').style.transform = 'rotate(180deg)';
                } else {
                    question.setAttribute('aria-expanded', 'false');
                    question.classList.remove('active');
                    answer.style.display = 'none';
                    question.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                }
            },

            setupCookieConsent() {
                const banner = document.getElementById('cookie-consent-banner');
                const btn = document.getElementById('cookie-consent-btn');
                
                if (localStorage.getItem('cookieConsent') === 'true') {
                    banner.style.display = 'none';
                } else {
                    banner.style.display = 'flex';
                }
                
                btn.addEventListener('click', () => {
                    localStorage.setItem('cookieConsent', 'true');
                    banner.style.display = 'none';
                });
            },
            
            setupAlertModal() {
                const modal = document.getElementById('alert-modal');
                const backdrop = document.getElementById('alert-modal-backdrop');
                const closeBtn = document.getElementById('alert-modal-close');
                
                const closeModal = () => {
                    modal.classList.remove('visible');
                    backdrop.classList.remove('visible');
                };

                closeBtn.addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            },
            
            showAlert(title, message) {
                document.getElementById('alert-modal-title').textContent = title;
                document.getElementById('alert-modal-body').textContent = message;
                document.getElementById('alert-modal').classList.add('visible');
                document.getElementById('alert-modal-backdrop').classList.add('visible');
                document.getElementById('alert-modal-close').focus();
            },
            
            showPartnerAlert(partnerName) {
                this.showAlert(
                    'Affiliate Partner Link',
                    `This is an affiliate link. If you click this link and apply for a product, we may receive a commission. This partner is: ${partnerName}.`
                );
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => app.init());

        // ===== ERROR HANDLING =====
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.message, event.filename, event.lineno);
        });
        window.addEventListener('unhandledrejection', (event) => {
             console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <!-- END: Inlined JavaScript -->

    <!-- 
      NEW: PWA Service Worker for Offline Use
      (From Mortgage Calc, provides offline fallback)
    -->
    <script>
        if ('serviceWorker' in navigator) {
            
            const OFFLINE_HTML = `
                <!DOCTYPE html>
                <html lang="en" style="font-family: Arial, sans-serif; background: #F5F7FA; color: #1F2121; padding: 20px;">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Offline | FinGuid Refinance Calculator</title>
                    <style>
                        body { text-align: center; padding-top: 50px; }
                        h1 { color: #24ACB9; }
                        p { font-size: 1.1rem; line-height: 1.6; }
                        .icon { font-size: 4rem; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="icon">ü§ñ</div>
                    <h1>You are Offline</h1>
                    <p>This AI Refinance Calculator needs an internet connection to function and fetch live rates.</p>
                    <p>Please check your connection and try again.</p>
                </body>
                </html>
            `;
            
            const swContent = `
                const CACHE_NAME = 'refinance-calculator-v1';
                const urlsToCache = [
                    '.', // Caches the main HTML file
                    'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js',
                    'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js'
                ];
                
                const OFFLINE_PAGE_CONTENT = \`${OFFLINE_HTML}\`;

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Service Worker: Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                    );
                });

                self.addEventListener('fetch', event => {
                    if (event.request.mode !== 'navigate') {
                        // For non-HTML requests (like scripts, images), use cache-first
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    return response || fetch(event.request);
                                })
                        );
                        return;
                    }
                    
                    // For navigation requests, try network first, then cache, then offline page
                    event.respondWith(
                        fetch(event.request)
                            .catch(() => {
                                // Network failed, try cache
                                return caches.match(event.request)
                                    .then(response => {
                                        // Return from cache or show offline page
                                        return response || new Response(OFFLINE_PAGE_CONTENT, {
                                            headers: { 'Content-Type': 'text/html' }
                                        });
                                    });
                            })
                    );
                });
            `;
            // Create a Blob from the SW content and register it
            const blob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered from Blob.', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>

</body>
</html>
