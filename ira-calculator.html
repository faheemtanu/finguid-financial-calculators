<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>AI IRA Calculator 2025: Roth vs Traditional | FinGuid USA</title>

    <meta name="description" content="World's Best AI-Powered IRA Calculator by FinGuid. Compare Roth vs Traditional IRA, calculate tax savings, and optimize your 2024-2025 retirement contributions. Features live inflation data, MAGI phaseout limits, and 20+ personalized AI insights. WCAG 2.1 AA compliant.">

    <meta name="keywords" content="ira calculator, roth vs traditional ira calculator, retirement calculator, ira contribution limits 2024, ira contribution limits 2025, roth ira calculator, traditional ira calculator, retirement savings calculator, magi calculator, roth ira income limits 2024, roth ira income limits 2025, ai financial advisor, retirement planning, tax optimization, tax deferred growth, tax free growth, backdoor roth ira, roth conversion ladder, ira withdrawal calculator, ira rmd calculator, required minimum distribution, retirement tax calculator, financial calculator, finguid, retirement tool, 401k to ira rollover, pension calculator, savings calculator, investment calculator, sep ira calculator, simple ira calculator, ira deduction calculator, retirement income calculator, ira phase out 2024, ira phase out 2025, ai retirement planner">

    <meta name="author" content="FinGuid USA">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="theme-color" content="#24ACB9"> <meta property="og:type" content="website">
    <meta property="og:title" content="AI IRA Calculator 2025: Roth vs Traditional | FinGuid USA">
    <meta property="og:description" content="Free AI IRA calculator. Compare Roth vs Traditional, analyze tax benefits, and optimize contributions with live data and AI insights.">
    <meta property="og:url" content="https://www.finguid.com/calculators/ira">
    
    <link rel="canonical" href="https://www.finguid.com/calculators/ira">
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22FinGuid%20AI%20IRA%20Calculator%22,%22short_name%22:%22IRA%20Calc%22,%22description%22:%22AI-Powered%20IRA%20Calculator%20to%20compare%20Roth%20vs%20Traditional%20and%20optimize%20retirement%20savings.%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#FFFFFD%22,%22theme_color%22:%22#24ACB9%22,%22icons%22:[{%22src%22:%22https://placehold.co/192x192/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://placehold.co/512x512/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22512x512%22}]}">
    
    <style>
        /* === START: Global Variables (FinGuid Brand) === */
        :root {
            --primary: #24ACB9; /* Teal (Matches FinGuid Image & Car Lease CSS) */
            --primary-dark: #19343B; /* Dark Teal (Matches Car Lease CSS) */
            --accent: #FFC107;
            --accent-dark: #E69500;
            --text: #1F2121;
            --text-light: #64748B;
            --bg: #FFFFFD;
            --bg-secondary: #F5F7FA;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --error: #EF4444;
            --success: #10B981;
            --fred-color: #A31B20; /* FRED standard color */
        }

        [data-color-scheme="dark"] {
            --text: #E1E8ED;
            --text-light: #B8C5D0;
            --bg: #1F2121;
            --bg-secondary: #242B36;
            --card: #181919;
            --border: #38444D;
        }
        /* === END: Global Variables === */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { 
            font-size: 16px; 
            -webkit-font-smoothing: antialiased; 
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* ===== HEADER STYLES (Single Line) ===== */
        .header {
            position: sticky;
            top: 0;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--primary);
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .logo:hover { color: var(--primary-dark); }

        .calculator-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            flex-shrink: 0;
            margin-left: 16px;
            flex-basis: auto;
            min-width: 0;
        }

        /* === Animated Features === */
        .header-features {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 24px;
            flex-grow: 1;
            justify-content: flex-start;
            overflow: hidden;
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        .header-feature-item {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            animation: pulse-color-text 2.5s infinite ease-in-out;
        }
        .header-feature-item:nth-child(1) { animation-delay: 0s; }
        .header-feature-item:nth-child(2) { animation-delay: 0.2s; }
        .header-feature-item:nth-child(3) { animation-delay: 0.4s; }
        .header-feature-item:nth-child(4) { animation-delay: 0.6s; }

        @keyframes pulse-color-text {
            0%, 100% {
                opacity: 0.8;
                color: var(--text-light);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                color: var(--primary);
                transform: scale(1.03);
            }
        }
        
        /* Header Controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:hover { background: var(--primary); color: white; }
        .icon-btn.active { background: var(--primary); color: white; }

        #pwa-install-btn {
            display: none; /* Hidden by default, shown by JS */
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #pwa-install-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        /* ===== END HEADER STYLES ===== */

        /* ===== SPONSOR BANNER ===== */
        .sponsor-banner {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sponsor-text { font-weight: 500; flex: 1; min-width: 200px; }
        .sponsor-buttons { display: flex; gap: 8px; }

        .sponsor-btn {
            padding: 8px 12px;
            background: white;
            color: #6366F1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .sponsor-btn:hover { background: var(--accent); color: var(--text); transform: translateY(-2px); }

        /* ===== MAIN CALCULATOR LAYOUT ===== */
        .calculator-wrapper {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            padding: 24px 0;
            margin-bottom: 40px;
        }

        .inputs-panel, .results-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        .inputs-panel:hover, .results-panel:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .panel-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text); 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
        }

        .section-heading {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        /* ===== FORM STYLES ===== */
        .form-group { margin-bottom: 16px; }

        .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        .input-wrapper { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            min-width: 0; 
        }

        input[type="number"], input[type="text"], select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 0;
            width: 100%;
        }
        
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%231F2121' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 32px;
        }
        [data-color-scheme="dark"] select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23E1E8ED' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        .input-addon {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            min-width: 50px;
            text-align: center;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .form-hint-note {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 400;
        }

        /* ===== FRED Data Note ===== */
        .fred-note {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-light);
            margin-top: 6px;
        }
        .fred-note a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 600;
        }
        .fred-note a:hover { color: var(--primary); }

        /* ===== Tooltip Styles ===== */
        .tooltip {
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
            display: inline-flex;
            align-items: center;
            color: var(--text-light);
        }
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-light);
            color: var(--card);
            font-style: normal;
            font-size: 10px;
            font-weight: 700;
            line-height: 14px;
            margin-left: 5px;
            transition: all 0.2s ease;
        }
        .tooltip:hover .tooltip-icon, .tooltip:focus .tooltip-icon {
            background: var(--primary);
            outline: none;
        }
        .tooltip:focus { outline: none; }
        .tooltip-box {
            position: fixed;
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 200px;
            white-space: normal;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        /* ===== WCAG Focus Styles ===== */
        input[type="number"]:focus, input[type="text"]:focus, select:focus, 
        .rate-btn:focus, .lookup-btn:focus, .sponsor-btn:focus, 
        .btn-secondary:focus, .icon-btn:focus, #pwa-install-btn:focus, 
        .tab-btn:focus, .faq-question:focus, .primary-action-btn:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.25);
        }
        .icon-btn:focus, #pwa-install-btn:focus, .sponsor-btn:focus, 
        .lookup-btn:focus, .primary-action-btn:focus {
             box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
        }

        /* ===== Ad Slot ===== */
        .ad-slot {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin: 20px 0;
        }
        .ad-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .ad-placeholder { font-size: 14px; color: var(--text-light); font-weight: 600; }
        .ad-placeholder a { color: var(--primary); font-weight: 700; text-decoration: none; }
        .ad-placeholder a:hover { text-decoration: underline; }

        /* ===== Primary Action Button ===== */
        .primary-action-btn {
            width: 100%;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .primary-action-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .primary-action-btn:disabled { background: var(--text-light); cursor: not-allowed; }
        .privacy-note {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
            margin-top: 8px;
        }

        /* ===== RESULTS SECTION ===== */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(36, 172, 185, 0.2);
            text-align: center;
        }
        .summary-label { font-size: 0.875rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .payment-amount { display: flex; align-items: baseline; justify-content: center; gap: 8px; margin: 8px 0; }
        .amount { font-size: 2.5rem; font-weight: bold; }
        .unit { font-size: 1rem; opacity: 0.9; }
        .payment-breakdown { font-size: 0.875rem; opacity: 0.8; }
        
        /* ===== Tabs ===== */
        .tabs { margin-bottom: 24px; }
        .tab-buttons { 
            display: flex; 
            gap: 4px; 
            border-bottom: 2px solid var(--border); 
            margin-bottom: 24px; 
            overflow-x: auto; 
        }
        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:focus {
            color: var(--primary);
            box-shadow: none;
            border-bottom-color: rgba(36, 172, 185, 0.5);
        }
        .tab-btn.active:focus { border-bottom-color: var(--primary); }

        .tab-content { display: none; padding: 8px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        .tab-content:focus-visible {
            outline: 2px solid var(--primary);
            border-radius: 4px;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .results-heading {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin: 16px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .result-box { background: var(--bg-secondary); padding: 16px; border-radius: 6px; border-left: 4px solid var(--border); transition: all 0.2s; }
        .result-box:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .result-box.highlight { 
            border-left-color: var(--primary); 
            background: rgba(36, 172, 185, 0.1); 
        }
        .result-box.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .result-box.error {
            border-left-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        .result-box.accent {
            border-left-color: var(--accent-dark);
            background: rgba(255, 193, 7, 0.1);
        }
        .result-label { 
            display: block; 
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
        }
        .result-value { 
            display: block; 
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
        }

        /* ===== Amortization Table Styles ===== */
        .table-scroll-wrapper {
            overflow-x: auto;
            max-height: 500px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .amortization-table thead {
            position: sticky;
            top: 0;
            background: var(--primary);
            color: white;
            z-index: 10;
        }
        .amortization-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .amortization-table th:nth-child(n+2) { text-align: right; }
        .amortization-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .amortization-table tbody tr:nth-child(even) { background: var(--bg-secondary); }
        .amortization-table tbody tr:hover { background: rgba(36, 172, 185, 0.1); }
        .amortization-table td {
            padding: 10px 12px;
            color: var(--text-light);
        }
        .amortization-table td:first-child { font-weight: 600; color: var(--text); }
        .amortization-table td:nth-child(n+2) {
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
        }

        /* ===== AI INSIGHTS ===== */
        .insights-container { margin-top: 20px; }
        .insight-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .insight-box.success { border-left-color: var(--success); }
        .insight-box.warning { border-left-color: var(--accent-dark); }
        .insight-box.error { border-left-color: var(--error); }
        .insight-box strong { color: var(--text); }
        .insight-box ul {
            margin-top: 8px;
            margin-left: 20px;
            padding-left: 0;
        }
        .insight-box li { margin-bottom: 4px; }


        /* ===== PARTNER SECTION ===== */
        .footer-sponsor {
            background: linear-gradient(135deg, rgba(36, 172, 185, 0.1) 0%, rgba(25, 52, 59, 0.1) 100%);
            padding: 40px;
            border-bottom: 1px solid rgba(36, 172, 185, 0.2);
            border-radius: 12px;
        }
        .sponsor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; }
        .sponsor-item { text-align: center; padding: 16px; border-radius: 8px; background: var(--card); transition: all 0.2s; }
        .sponsor-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sponsor-item h4 { margin-bottom: 8px; color: var(--primary); font-size: 1rem; }
        .sponsor-item p { color: var(--text-light); margin-bottom: 12px; font-size: 0.875rem; line-height: 1.5; }
        .sponsor-item a {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .sponsor-item a:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        .sponsor-item a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(36, 172, 185, 0.3); }

        /* ===== FOOTER ===== */
        .footer { background: var(--card); border-top: 1px solid var(--border); padding: 32px 0; margin-top: 40px; }
        .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .footer-section h4 { font-size: 13px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .footer-section a { display: block; font-size: 12px; color: var(--text-light); text-decoration: none; margin-bottom: 8px; transition: color 0.3s ease; }
        .footer-section a:hover, .footer-section a:focus { 
            color: var(--primary); 
            text-decoration: underline;
            outline: none;
        }
        .compliance-badges { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; font-size: 12px; }
        .badge { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; font-weight: 600; color: var(--text-light); }
        .disclaimer { font-size: 11px; color: var(--text-light); line-height: 1.6; padding-top: 20px; border-top: 1px solid var(--border); }
        .footer-bottom { text-align: center; font-size: 12px; color: var(--text-light); padding-top: 16px; border-top: 1px solid var(--border); }

        /* ===== FAQ ACCORDION ===== */
        .faq-section { margin: 40px 0; }
        .faq-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 20px; text-align: center; }
        .faq-container { max-width: 900px; margin: 0 auto; }
        .faq-item { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; }
        .faq-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .faq-question { padding: 16px; background: var(--bg-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text); transition: all 0.3s ease; }
        .faq-question:hover { background: var(--card); color: var(--primary); }
        .faq-question.active { background: var(--primary); color: white; }
        .faq-question:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4) inset;
            color: var(--primary);
        }
        .faq-icon { font-size: 18px; transition: transform 0.3s ease; }
        .faq-question.active .faq-icon { transform: rotate(180deg); }
        .faq-answer { display: none; padding: 16px; background: var(--card); color: var(--text-light); line-height: 1.8; font-size: 14px; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }

        /* ===== GDPR/CCPA Cookie Consent Banner ===== */
        #cookie-consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            color: var(--text);
            padding: 24px;
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .cookie-consent-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-light);
            flex: 1 1 400px;
        }
        .cookie-consent-text a { color: var(--primary); text-decoration: underline; }
        .cookie-consent-text a:hover { color: var(--primary-dark); }
        #cookie-consent-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #cookie-consent-btn:hover { background: var(--primary-dark); }
        #cookie-consent-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }

        /* ===== WCAG Alert Modal ===== */
        .alert-modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .alert-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10003;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            display: none;
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }
        .alert-modal.visible { display: block; opacity: 1; }
        .alert-modal-backdrop.visible { display: block; opacity: 1; }
        .alert-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }
        .alert-modal-body {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .alert-modal-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .alert-modal-btn:hover { background: var(--primary-dark); }
        .alert-modal-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .calculator-wrapper { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: repeat(2, 1fr); }
            .inputs-panel {
                position: static;
                max-height: none;
                overflow-y: visible;
            }
        }

        @media (max-width: 768px) {
            .header-features { display: none; }
            .sponsor-banner { flex-direction: column; gap: 12px; }
            .sponsor-buttons { flex: 1 1 100%; justify-content: space-between; }
            .tab-buttons { flex-wrap: nowrap; overflow-x: auto; }
            .inputs-panel, .results-panel { padding: 16px; }
            .footer-sponsor { padding: 24px; }
        }

        @media (max-width: 480px) {
            .calculator-title { display: none; }
            .header-features { display: none; }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .header-controls {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            #pwa-install-btn { flex-grow: 1; }
            .payment-breakdown { font-size: 0.75rem; }
            .amount { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; }
            .sponsor-grid { grid-template-columns: 1fr; }
            #cookie-consent-banner { flex-direction: column; text-align: center; }
            .cookie-consent-text { flex-basis: auto; }
            #cookie-consent-btn { width: 100%; }
        }

        /* ===== PRINT STYLE ===== */
        @media print {
            .header, .sponsor-banner, .header-controls, .footer-sponsor, .faq-section, 
            .footer, .ad-slot, .primary-action-btn, #cookie-consent-banner,
            .alert-modal, .alert-modal-backdrop {
                display: none;
            }
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel, .results-panel { box-shadow: none; border: 1px solid #ccc; }
            .table-scroll-wrapper { max-height: none; overflow: visible; }
        }

        /* ===== ACCESSIBILITY ===== */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYBL2CDNQJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NYBL2CDNQJ', {
            'page_path': '/ira-calculator',
            'page_title': 'AI IRA Calculator - Roth vs Traditional'
      });
    </script>

    <script>
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            const pwaInstall = document.getElementById('pwa-install-btn');
            if (pwaInstall) {
                pwaInstall.style.display = 'flex';
                pwaInstall.onclick = async () => {
                    if (window.deferredPrompt) {
                        window.deferredPrompt.prompt();
                        const { outcome } = await window.deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            gtag('event', 'pwa_install_accepted');
                        }
                        window.deferredPrompt = null;
                        pwaInstall.style.display = 'none';
                    }
                };
            }
        });

        // Preload Chart.js
        document.addEventListener('DOMContentLoaded', () => {
            const chartJs = document.createElement('link');
            chartJs.rel = 'preload';
            chartJs.as = 'script';
            chartJs.href = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            document.head.appendChild(chartJs);

            const chartLabels = document.createElement('link');
            chartLabels.rel = 'preload';
            chartLabels.as = 'script';
            chartLabels.href = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js';
            document.head.appendChild(chartLabels);
        });
    </script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="https_www.finguid.com" class="logo" aria-label="FinGuid USA Home">
                    <span role="img" aria-label="Money bag emoji">üí∞</span>
                    <span>FinGuid USA</span>
                </a>
                
                <span class="calculator-title">IRA Optimizer Pro</span>

                <div class="header-features" aria-hidden="true">
                    <span class="header-feature-item">ü§ñ AI Insights</span>
                    <span class="header-feature-item">‚öñÔ∏è Roth vs Trad</span>
                    <span class="header-feature-item">üìà Live Inflation Data</span>
                    <span class="header-feature-item">üìã 2025 Limits</span>
                </div>

                <div class="header-controls">
                    <button type="button" class="icon-btn" id="pwa-install-btn" aria-label="Install App" title="Install App">üì±</button>
                    <button type="button" class="icon-btn" id="darkModeToggle" aria-label="Toggle dark mode" title="Dark mode">üåô</button>
                    <button type="button" class="icon-btn" id="voiceToggle" aria-label="Voice control" title="Voice commands">üé§</button>
                    <button type="button" class="icon-btn" id="ttsToggle" aria-label="Text to speech" title="Read results">üîä</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="sponsor-banner">
        <span class="sponsor-text">üéÅ Open a new IRA today and get a $100 bonus!</span>
        <div class="sponsor-buttons">
            <button type="button" class="sponsor-btn" onclick="app.showPartnerAlert('IRA Broker Partner');">View Top Brokers ‚Üí</button>
            <button type="button" class="sponsor-btn" onclick="app.showPartnerAlert('Sponsorship Inquiry');">Become a partner ‚Üí</button>
        </div>
    </div>

    <main class="container" role="main">
        <div class="calculator-wrapper">
            <section class="inputs-panel" role="region" aria-labelledby="inputs-title">
                <h2 class="panel-title" id="inputs-title">üìã Your Profile & Strategy</h2>
                
                <form id="ira-form" aria-label="IRA Calculator Form">
                    
                    <div class="section-heading">üë§ Personal Information</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="current-age">Current Age</label>
                            <div class="input-wrapper">
                                <input type="number" id="current-age" value="30" min="18" max="100" required aria-label="Current Age">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="retirement-age">Retirement Age</label>
                            <div class="input-wrapper">
                                <input type="number" id="retirement-age" value="67" min="59" max="100" required aria-label="Retirement Age">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="filing-status">Tax Filing Status
                             <span class="tooltip" data-tooltip="Determines your tax bracket and contribution eligibility." tabindex="0" role="tooltip" id="tooltip-filing">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <select id="filing-status" required aria-label="Tax Filing Status" aria-describedby="tooltip-filing">
                            <option value="Single">Single</option>
                            <option value="Married Filing Jointly">Married Filing Jointly</option>
                            <option value="Head of Household">Head of Household</option>
                            <option value="Married Filing Separately">Married Filing Separately</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="annual-income">Annual Gross Income (MAGI)
                            <span class="tooltip" data-tooltip="Your Modified Adjusted Gross Income (MAGI) is used to determine Roth eligibility and Traditional IRA deductibility." tabindex="0" role="tooltip" id="tooltip-magi">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-addon">$</span>
                            <input type="number" id="annual-income" value="85000" min="0" step="1000" required aria-label="Annual Gross Income" aria-describedby="tooltip-magi">
                        </div>
                    </div>

                    <div class="section-heading">üìà Investment & Timeline</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="current-balance">Current IRA Balance</label>
                            <div class="input-wrapper">
                                <span class="input-addon">$</span>
                                <input type="number" id="current-balance" value="25000" min="0" step="1000" required aria-label="Current IRA Balance">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="annual-contribution">Annual Contribution</label>
                            <div class="input-wrapper">
                                <span class="input-addon">$</span>
                                <input type="number" id="annual-contribution" value="7000" min="0" max="100000" step="100" required aria-label="Annual Contribution">
                            </div>
                            <span class="form-hint-note" id="contribution-limit-note">2024 Limit: $7,000 (Under 50)</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="return-rate">Expected Return
                                <span class="tooltip" data-tooltip="Average annual growth rate of your investments (e.g., 7-8% for S&P 500 average)." tabindex="0" role="tooltip" id="tooltip-return">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="return-rate" value="7" min="-10" max="20" step="0.5" required aria-label="Expected Annual Return" aria-describedby="tooltip-return">
                                <span class="input-addon">%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="inflation-rate">Est. Inflation
                                <span class="tooltip" data-tooltip="Projected average inflation rate. We pull the latest live data from FRED." tabindex="0" role="tooltip" id="tooltip-inflation">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="inflation-rate" value="2.5" min="0" max="10" step="0.1" required aria-label="Estimated Inflation Rate" aria-describedby="tooltip-inflation">
                                <span class="input-addon">%</span>
                            </div>
                            <div class="fred-note">
                                <span id="fred-last-updated">Loading live rate...</span>
                                <span class="fred-branding">
                                    Data via <a href="https://fred.stlouisfed.org/" target="_blank" rel="noopener">FRED¬Æ</a>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="section-heading">üéØ Advanced Strategy</div>

                    <div class="form-row">
                         <div class="form-group">
                            <label class="form-label" for="income-growth">Annual Income Growth</label>
                            <div class="input-wrapper">
                                <input type="number" id="income-growth" value="3" min="0" max="20" step="0.5" required aria-label="Annual Income Growth">
                                <span class="input-addon">%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="retirement-tax-rate">Retirement Tax Rate
                                <span class="tooltip" data-tooltip="Your estimated marginal tax bracket in retirement. Leave at 0 for AI estimation." tabindex="0" role="tooltip" id="tooltip-ret-tax">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="retirement-tax-rate" value="0" min="0" max="50" step="1" required aria-label="Retirement Tax Rate" aria-describedby="tooltip-ret-tax">
                                <span class="input-addon">%</span>
                            </div>
                            <span class="form-hint-note">0% = Auto-Estimate</span>
                        </div>
                    </div>
                   
                    <div class="form-group">
                        <label class="form-label" for="catch-up">Age 50+ Catch-Up?
                            <span class="tooltip" data-tooltip="Automatically adds an extra $1,000 (2024 limit) to your annual contribution from age 50 onwards." tabindex="0" role="tooltip" id="tooltip-catchup">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <select id="catch-up" required aria-label="Include Age 50+ Catch-Up Contributions" aria-describedby="tooltip-catchup">
                            <option value="yes" selected>Yes, include catch-up (+$1,000)</option>
                            <option value="no">No, do not include catch-up</option>
                        </select>
                    </div>

                    <div class="ad-slot" role="complementary" aria-label="Advertisement">
                        <div class="ad-label">üí° SPONSORED PRODUCT</div>
                        <div class="ad-placeholder">
                            <strong>Open Your AI-Powered IRA Today</strong><br>
                            Low-Cost Broker ‚Ä¢ Zero Setup Fees ‚Ä¢ Expert Support<br>
                            <a href="#our-partners" class="affiliate-link-sponsor" onclick="app.showPartnerAlert('Sponsored Broker');">Learn More & Get $100 Bonus ‚Üí</a>
                        </div>
                    </div>

                    <div class="action-group">
                        <button type="submit" class="primary-action-btn">
                            <span role="img" aria-label="Robot emoji">ü§ñ</span> Calculate & Get AI Insights
                        </button>
                        <p class="privacy-note">
                            üîí Your data is processed locally and never stored.
                        </p>
                    </div>
                </form>
            </section>

            <section class="results-panel" role="region" aria-labelledby="results-title">
                <h2 class="panel-title" id="results-title">üìä Analysis & Results</h2>

                <div class="summary-card">
                    <div class="summary-label">Recommended Strategy</div>
                    <div class="payment-amount">
                        <span class="amount" id="primary-recommendation">Roth IRA</span>
                    </div>
                    <div class="payment-breakdown" id="recommendation-reason">Based on your tax bracket, Roth offers the best after-tax value.</div>
                </div>
                
                <div class="tabs">
                    <div class="tab-buttons" role="tablist" aria-label="IRA Results">
                        <button type="button" class="tab-btn active" data-tab="ai-insights" role="tab" aria-selected="true" aria-controls="ai-insights" id="tab-ai-insights">
                            ü§ñ AI Insights
                        </button>
                        <button type="button" class="tab-btn" data-tab="comparison-chart" role="tab" aria-selected="false" aria-controls="comparison-chart" id="tab-comparison-chart" tabindex="-1">
                            ‚öñÔ∏è Roth vs Trad
                        </button>
                        <button type="button" class="tab-btn" data-tab="projection-chart" role="tab" aria-selected="false" aria-controls="projection-chart" id="tab-projection-chart" tabindex="-1">
                            üìä Projection
                        </button>
                        <button type="button" class="tab-btn" data-tab="tax-analysis" role="tab" aria-selected="false" aria-controls="tax-analysis" id="tab-tax-analysis" tabindex="-1">
                            üí≥ Tax Analysis
                        </button>
                        <button type="button" class="tab-btn" data-tab="contribution-limits" role="tab" aria-selected="false" aria-controls="contribution-limits" id="tab-contribution-limits" tabindex="-1">
                            üìã Limits & Rules
                        </button>
                        <button type="button" class="tab-btn" data-tab="schedule" role="tab" aria-selected="false" aria-controls="schedule" id="tab-schedule" tabindex="-1">
                            üìÖ Schedule
                        </button>
                    </div>

                    <div id="ai-insights" class="tab-content active" role="tabpanel" aria-labelledby="tab-ai-insights" tabindex="0">
                        <h3 class="results-heading">ü§ñ Your Personalized AI Financial Advisor</h3>
                        <div class="insights-container" id="ai-insights-content" aria-live="polite">
                            <div class="insight-box">
                                <p>üîÑ Analyzing your financial profile... Enter your details and click "Calculate" to generate personalized insights.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="comparison-chart" class="tab-content" role="tabpanel" aria-labelledby="tab-comparison-chart" tabindex="0">
                        <h3 class="results-heading">Roth vs Traditional: After-Tax Value at Retirement</h3>
                        <div class="chart-container">
                            <canvas id="comparison-canvas" role="img" aria-label="Bar chart comparing Roth vs Traditional IRA after-tax value"></canvas>
                        </div>
                        <div class="result-grid">
                            <div class="result-box success">
                                <span class="result-label">Roth IRA Value (Tax-Free)</span>
                                <span class="result-value" id="roth-balance">$0</span>
                            </div>
                            <div class="result-box highlight">
                                <span class="result-label">Traditional IRA (After-Tax)</span>
                                <span class="result-value" id="trad-balance-after-tax">$0</span>
                            </div>
                            <div class="result-box accent">
                                <span class="result-label">Roth Advantage</span>
                                <span class="result-value" id="roth-advantage">+$0</span>
                            </div>
                        </div>
                    </div>

                    <div id="projection-chart" class="tab-content" role="tabpanel" aria-labelledby="tab-projection-chart" tabindex="0">
                        <h3 class="results-heading">Balance Growth Projection (Recommended: <span id="projection-type">Roth</span>)</h3>
                        <div class="chart-container">
                            <canvas id="projection-canvas" role="img" aria-label="Line chart showing IRA balance growth over time"></canvas>
                        </div>
                        <div class="result-grid">
                            <div class="result-box">
                                <span class="result-label">Total Contributions</span>
                                <span class="result-value" id="total-contributions">$0</span>
                            </div>
                            <div class="result-box">
                                <span class="result-label">Investment Growth</span>
                                <span class="result-value" id="total-growth">$0</span>
                            </div>
                            <div class="result-box highlight">
                                <span class="result-label">Final Balance</span>
                                <span class="result-value" id="retirement-balance">$0</span>
                            </div>
                        </div>
                    </div>

                    <div id="tax-analysis" class="tab-content" role="tabpanel" aria-labelledby="tab-tax-analysis" tabindex="0">
                        <h3 class="results-heading">Tax Impact Analysis</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <span class="result-label">Current Tax Rate</span>
                                <span class="result-value" id="current-tax-rate">0%</span>
                            </div>
                            <div class="result-box">
                                <span class="result-label">Est. Retirement Rate</span>
                                <span class="result-value" id="retirement-tax-rate-display">0%</span>
                            </div>
                            <div class="result-box accent">
                                <span class="result-label">Annual Tax Savings (Trad)</span>
                                <span class="result-value" id="annual-tax-savings">$0</span>
                            </div>
                            <div class="result-box success">
                                <span class="result-label">Lifetime Tax-Free Growth (Roth)</span>
                                <span class="result-value" id="roth-tax-free-growth">$0</span>
                            </div>
                            <div class="result-box highlight">
                                <span class="result-label">Total Tax Bill (Trad IRA)</span>
                                <span class="result-value" id="trad-total-tax">$0</span>
                            </div>
                            <div class="result-box error">
                                <span class="result-label">Total Tax Bill (Roth IRA)</span>
                                <span class="result-value" id="roth-total-tax">$0</span>
                            </div>
                        </div>
                    </div>

                    <div id="contribution-limits" class="tab-content" role="tabpanel" aria-labelledby="tab-contribution-limits" tabindex="0">
                        <h3 class="results-heading">2024-2025 IRA Contribution Limits & Your Eligibility</h3>
                         <div class="result-grid">
                            <div class="result-box">
                                <span class="result-label">Standard Limit (Under 50)</span>
                                <span class="result-value" id="limit-standard">$7,000</span>
                            </div>
                            <div class="result-box">
                                <span class="result-label">Catch-Up (Age 50+)</span>
                                <span class="result-value" id="limit-catchup">$1,000</span>
                            </div>
                            <div class="result-box highlight">
                                <span class="result-label">Your Max Contribution</span>
                                <span class="result-value" id="your-max-contrib">$0</span>
                            </div>
                            <div class="result-box" id="roth-eligibility-box">
                                <span class="result-label">Roth Eligibility (MAGI)</span>
                                <span class="result-value" id="roth-eligibility">100%</span>
                            </div>
                            <div class="result-box" id="trad-deduction-box">
                                <span class="result-label">Trad. Deduction</span>
                                <span class="result-value" id="trad-deductibility">Fully Deductible</span>
                            </div>
                        </div>
                        <div class="insight-box" style="margin-top: 20px;">
                            <strong>üìã 2024-2025 IRA Rules (Updated):</strong>
                            <ul>
                                <li><strong>2024 Limit:</strong> $7,000 (Under 50) / $8,000 (Age 50+)</li>
                                <li><strong>2025 Limit (Est.):</strong> $7,500 (Under 50) / $8,500 (Age 50+)</li>
                                <li><strong>Roth MAGI Phaseout (2024, Single):</strong> Starts at $146,000</li>
                                <li><strong>Roth MAGI Phaseout (2024, MFJ):</strong> Starts at $230,000</li>
                                <li><strong>Traditional Deduction Phaseout (2024, Single w/ plan):</strong> Starts at $77,000</li>
                                <li><strong>Withdrawal Age (Penalty-Free):</strong> 59¬Ω</li>
                                <li><strong>RMD Age (Traditional IRA):</strong> 73</li>
                            </ul>
                        </div>
                    </div>

                    <div id="schedule" class="tab-content" role="tabpanel" aria-labelledby="tab-schedule">
                        <h3 class="results-heading">Year-by-Year Projection Schedule</h3>
                        <div class="table-scroll-wrapper">
                            <table class="amortization-table" id="projection-table" role="grid" aria-label="Yearly IRA projection">
                                <thead>
                                    <tr>
                                        <th scope="col">Age</th>
                                        <th scope="col">Contribution</th>
                                        <th scope="col">Growth</th>
                                        <th scope="col">End Balance</th>
                                        <th scope="col">Tax Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <section class="footer-sponsor" id="our-partners" aria-labelledby="partners-title">
            <div class="container">
                <h3 id="partners-title" style="text-align: center; margin-bottom: 24px; color: var(--primary); font-size: 24px; font-weight: 700;">Start Your Retirement Journey</h3>
                <div class="sponsor-grid">
                    <div class="sponsor-item">
                        <h4>üìà Open an IRA</h4>
                        <p>Compare top-rated brokers with low fees and get a sign-up bonus of up to $100.</p>
                        <a href="#affiliate-link-1" onclick="app.showPartnerAlert('Top IRA Brokers'); return false;" aria-label="Get Quotes for Opening an IRA">Get Quotes ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>ü§ñ Robo-Advisors</h4>
                        <p>Let AI manage your portfolio. Low-cost, automated investing perfect for your new IRA.</p>
                        <a href="#affiliate-link-2" onclick="app.showPartnerAlert('Robo-Advisor Partners'); return false;" aria-label="Compare Robo-Advisor Services">Compare Services ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>ü§ù Financial Advisors</h4>
                        <p>Get personalized retirement advice. Connect with a vetted fiduciary advisor near you.</p>
                        <a href="#affiliate-link-3" onclick="app.showPartnerAlert('Financial Advisor Network'); return false;" aria-label="Find a Financial Advisor">Find an Advisor ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üí∏ Tax Software</h4>
                        <p>File your taxes with confidence and maximize your retirement deductions.</p>
                        <a href="#affiliate-link-4" onclick="app.showPartnerAlert('Tax Software Partners'); return false;" aria-label="View Tax Software Deals">View Deals ‚Üí</a>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="faq-section" aria-labelledby="faq-title">
            <h2 class="faq-title" id="faq-title">‚ùì Frequently Asked Questions (FAQ)</h2>
            <div class="faq-container" id="faqContainer">
                </div>
        </section>

        <footer class="footer" role="contentinfo">
            <div class="container">
                <div class="footer-content">
                    <nav class="footer-section" role="navigation" aria-label="About this calculator">
                        <h4>About IRA Calculator</h4>
                        <a href="#how-it-works">How It Works</a>
                        <a href="#features">Features</a>
                        <a href="#faq">FAQ</a>
                        <a href="#contact">Contact Us</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Learn more about IRAs">
                        <h4>Learn More</h4>
                        <a href="#roth-vs-traditional">Roth vs. Traditional</a>
                        <a href="#contribution-limits">Contribution Limits</a>
                        <a href="#backdoor-roth">Backdoor Roth IRA</a>
                        <a href="#rmd">RMDs</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Financial resources">
                        <h4>Resources</h4>
                        <a href="/calculators/mortgage">Mortgage Calculator</a>
                        <a href="/calculators/401k">401k Calculator</a>
                        <a href="/education">Education Center</a>
                        <a href="/glossary">Glossary</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Legal links">
                        <h4>Legal</h4>
                        <a href="#privacy">Privacy Policy</a>
                        <a href="#terms">Terms of Service</a>
                        <a href="#disclaimer">Disclaimer</a>
                        <a href="#affiliate">Affiliate Disclosure</a>
                    </nav>
                </div>

                <div class="compliance-badges" role="list" aria-label="Compliance Badges">
                    <span class="badge" role="listitem">üîí SSL Secured</span>
                    <span class="badge" role="listitem">‚úÖ GDPR Compliant</span>
                    <span class="badge" role="listitem">‚úÖ CCPA Compliant</span>
                    <span class="badge" role="listitem">‚úÖ FTC Compliant</span>
                    <span class="badge" role="listitem">‚ôø WCAG 2.1 AA</span>
                </div>

                <section class="disclaimer" aria-label="Disclaimers and Disclosures">
                    <strong>IMPORTANT: Educational & Informational Only:</strong> This IRA calculator and the AI-generated insights are provided for educational and illustrative purposes only. The information provided is hypothetical and does not constitute financial, investment, tax, or legal advice. It is not an offer or solicitation to buy or sell any security.
                    <br><br>
                    <strong>No Guarantees:</strong> All projections are based on the inputs you provide and assumptions about future performance and tax laws, which may not be accurate. Past performance does not guarantee future results. Your actual retirement balance and tax situation may vary significantly.
                    <br><br>
                    <strong>Affiliate Disclosure:</strong> FinGuid USA participates in affiliate marketing programs. When you click on partner links (e.g., to brokers or financial advisors) and open an account or purchase a service, FinGuid may receive compensation. This does not affect your rates or terms and helps us keep this tool free. We only partner with firms we believe provide value to our users.
                    <br><br>
                    <strong>Data Accuracy:</strong> Inflation data (CPIAUCSL) is provided by the U.S. Bureau of Labor Statistics and delivered via FRED¬Æ API from the Federal Reserve Bank of St. Louis. While updated regularly, we make no guarantees about its accuracy or timeliness. All tax information is based on 2024-2025 IRS rules and is subject to change.
                    <br><br>
                    <strong>Consult a Professional:</strong> Always consult with a qualified financial advisor, CPA, or tax professional to understand how this information applies to your individual situation before making any financial decisions.
                </section>

                <div class="footer-bottom">
                    ¬© 2025 FinGuid USA. All Rights Reserved. | AI-Powered Financial Tools for Americans
                </div>
            </div>
        </footer>
    </main>

    <div id="cookie-consent-banner" role="dialog" aria-modal="true" aria-labelledby="cookie-consent-title" aria-describedby="cookie-consent-desc">
        <div class="cookie-consent-text">
            <h4 id="cookie-consent-title" style="font-weight: 700; color: var(--text); margin-bottom: 8px;">Your Privacy</h4>
            <p id="cookie-consent-desc">
                We use cookies and data to enhance your experience and provide personalized AI insights via Google Analytics. By clicking "Accept", you agree to our use of cookies.
                <a href="#privacy" aria-label="Read our Privacy Policy">Privacy Policy</a>.
            </p>
        </div>
        <button type="button" id="cookie-consent-btn">Accept</button>
    </div>

    <div class="alert-modal-backdrop" id="alert-modal-backdrop"></div>
    <div class="alert-modal" id="alert-modal" role="alertdialog" aria-modal="true" aria-labelledby="alert-modal-title" aria-describedby="alert-modal-body">
        <h4 class="alert-modal-title" id="alert-modal-title">Partner Information</h4>
        <p class="alert-modal-body" id="alert-modal-body">
            This is an affiliate link for [Partner].
        </p>
        <button type="button" class="alert-modal-btn" id="alert-modal-close">Close</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <script>
        /**
         * ========================================================================
         * AI IRA OPTIMIZER PRO - FinGuid USA
         * ========================================================================
         * Version: 2.0 - 100% COMPLIANT
         * Built with: S.O.L.I.D. Principles, WCAG 2.1 AA, PWA, GDPR/CCPA
         * * This script merges the IRA logic with the compliant, feature-rich
         * structure of the mortgage calculator.
         * ========================================================================
         */

        // ===== CONFIGURATION & CONSTANTS =====
        const CONFIG = {
            VERSION: '2.0',
            FRED_API_KEY: '9c6c421f077f2091e8bae4f143ada59a', // Per user request
            FRED_SERIES_INFLATION: 'CPIAUCSL', // Consumer Price Index (YoY rate)
            
            // 2024 IRA Contribution Limits (Base)
            CONTRIBUTION_LIMIT: 7000,
            CATCHUP_LIMIT: 1000,
            
            // 2024 MAGI Phaseout Ranges (Roth)
            ROTH_PHASEOUT: {
                'Single': { start: 146000, end: 161000 },
                'Married Filing Jointly': { start: 230000, end: 240000 },
                'Head of Household': { start: 146000, end: 161000 }, // Note: HOH uses Single limits for Roth
                'Married Filing Separately': { start: 0, end: 10000 }
            },
            
            // 2024 Traditional IRA Deduction Phaseout (Assumes workplace plan)
            TRAD_PHASEOUT: {
                'Single': { start: 77000, end: 87000 },
                'Married Filing Jointly': { start: 123000, end: 143000 },
                'Head of Household': { start: 77000, end: 87000 }, // Note: HOH uses Single limits
                'Married Filing Separately': { start: 0, end: 10000 }
            },
            
            // 2024 Federal Tax Brackets
            TAX_BRACKETS: {
                'Single': [
                    { limit: 11600, rate: 0.10 }, { limit: 47150, rate: 0.12 },
                    { limit: 100525, rate: 0.22 }, { limit: 191950, rate: 0.24 },
                    { limit: 243725, rate: 0.32 }, { limit: 609350, rate: 0.35 },
                    { limit: Infinity, rate: 0.37 }
                ],
                'Married Filing Jointly': [
                    { limit: 23200, rate: 0.10 }, { limit: 94300, rate: 0.12 },
                    { limit: 201050, rate: 0.22 }, { limit: 383900, rate: 0.24 },
                    { limit: 487450, rate: 0.32 }, { limit: 731200, rate: 0.35 },
                    { limit: Infinity, rate: 0.37 }
                ],
                'Head of Household': [
                    { limit: 16550, rate: 0.10 }, { limit: 63100, rate: 0.12 },
                    { limit: 100500, rate: 0.22 }, { limit: 191950, rate: 0.24 },
                    { limit: 243700, rate: 0.32 }, { limit: 609350, rate: 0.35 },
                    { limit: Infinity, rate: 0.37 }
                ],
                'Married Filing Separately': [
                    { limit: 11600, rate: 0.10 }, { limit: 47150, rate: 0.12 },
                    { limit: 100525, rate: 0.22 }, { limit: 191950, rate: 0.24 },
                    { limit: 243725, rate: 0.32 }, { limit: 365600, rate: 0.35 }, // Note: MFS has different 35/37 brackets
                    { limit: Infinity, rate: 0.37 }
                ]
            },
            
            charts: { projection: null, comparison: null },
            calculation: {
                inputs: {},
                roth: { projection: [], totalContrib: 0, totalGains: 0, finalBalance: 0, taxPaid: 0 },
                traditional: { projection: [], totalContrib: 0, totalGains: 0, finalBalance: 0, taxSaved: 0 }
            },
            liveInflationRate: 0.025 // Default fallback
        };

        // ===== EXPANDED FAQs for SEO =====
        const FAQs = [
            {
                q: "What is the difference between a Roth and Traditional IRA?",
                a: "A **Traditional IRA** allows you to contribute 'pre-tax' dollars, meaning your contribution may be tax-deductible *today*, lowering your current income tax. Your investments grow tax-deferred, but you pay ordinary income tax on all withdrawals in retirement. A **Roth IRA** is funded with 'post-tax' dollars (no tax deduction today). Your investments grow completely tax-free, and all qualified withdrawals in retirement are 100% tax-free. This calculator's AI insights will recommend one based on your current vs. estimated future tax rate."
            },
            {
                q: "What are the IRA contribution limits for 2024 and 2025?",
                a: "For **2024**, the maximum contribution to an IRA (Roth or Traditional) is **$7,000** if you are under age 50. If you are age 50 or older, you can make an additional **$1,000** 'catch-up' contribution, for a total of **$8,000**. For **2025**, limits are projected to increase to **$7,500** (under 50) and **$8,500** (50+)."
            },
            {
                q: "What is the income limit for a Roth IRA in 2024?",
                a: "Roth IRA contributions have income limits based on your Modified Adjusted Gross Income (MAGI). For 2024, the ability to contribute is phased out for: <ul><li>**Single / Head of Household:** $146,000 to $161,000</li><li>**Married Filing Jointly:** $230,000 to $240,000</li><li>**Married Filing Separately:** $0 to $10,000</li></ul>If your income is above these limits, you cannot contribute directly to a Roth IRA, but you may be able to use the 'Backdoor Roth IRA' strategy."
            },
            {
                q: "What is a 'Backdoor' Roth IRA?",
                a: "A Backdoor Roth IRA is a strategy for high-income earners who are above the Roth MAGI limits. It involves: <ol><li>Making a non-deductible contribution to a Traditional IRA (which has no income limit).</li><li>Shortly after, converting that Traditional IRA contribution to a Roth IRA.</li></ol>You must pay taxes on any *gains* in the account before conversion, but not on the principal (since it was already post-tax). This calculator's AI will check if you are a good candidate for this."
            },
            {
                q: "When should I choose a Roth vs. Traditional IRA?",
                a: "It's a question of your tax rate now vs. in retirement. <ul><li>Choose **Traditional IRA** if you believe your tax rate is *higher* today than it will be in retirement. You get the tax deduction now at your high rate.</li><li>Choose **Roth IRA** if you believe your tax rate is *lower* today than it will be in retirement (or the same). You pay taxes now at your low rate and get tax-free withdrawals later.</li></ul> Our AI advisor will give you a personalized recommendation."
            },
            {
                q: "What is MAGI?",
                a: "MAGI stands for **Modified Adjusted Gross Income**. It's your AGI (Adjusted Gross Income) from your tax return with certain deductions added back in. The IRS uses MAGI to determine your eligibility for contributing to a Roth IRA and deducting Traditional IRA contributions."
            },
            {
                q: "Can I deduct my Traditional IRA contributions?",
                a: "It depends. If you (and your spouse, if married) **do not** have a retirement plan at work (like a 401k), you can fully deduct your contribution. If you *do* have a workplace plan, your deduction is phased out based on your MAGI. For 2024 (Single), this phase-out is $77,000 - $87,000. This calculator will check your deductibility."
            },
            {
                q: "What is an RMD (Required Minimum Distribution)?",
                a: "RMDs are mandatory withdrawals you must start taking from your tax-deferred retirement accounts (like Traditional IRAs and 401ks) starting at **age 73**. These withdrawals are taxed as ordinary income. **Roth IRAs do not have RMDs** for the original owner, which is a significant advantage for estate planning and tax-free growth."
            },
            {
                q: "How does this AI IRA calculator work?",
                a: "This tool uses your age, income, filing status, and contribution strategy to project your retirement savings. It runs two parallel simulations (one for Roth, one for Traditional) year-by-year until your retirement age. It calculates your tax bracket each year, determines contribution eligibility (MAGI limits), and applies tax savings or tax costs to each scenario. The AI insights then compare the final *after-tax* values to recommend the best strategy for you."
            },
            {
                q: "Can I contribute to both a 401(k) and an IRA?",
                a: "Yes! This is a very common and powerful strategy. The contribution limits are separate. In 2024, you can contribute to your 401(k) (up to $23,000, or $30,500 if 50+) *and* contribute to your IRA (up to $7,000, or $8,000 if 50+). However, having a 401(k) may limit your ability to *deduct* Traditional IRA contributions, as noted in the FAQ above."
            },
            {
                q: "What is a SEP IRA or SIMPLE IRA?",
                a: "These are IRAs for small business owners or self-employed individuals. A **SEP (Simplified Employee Pension) IRA** allows employers to contribute to their own and their employees' retirement. A **SIMPLE (Savings Incentive Match Plan for Employees) IRA** is a workplace plan that involves employee and employer contributions. This calculator focuses on personal Roth and Traditional IRAs."
            },
            {
                q: "At what age can I withdraw from my IRA?",
                a: "You can take penalty-free 'qualified' distributions from your IRA after you reach **age 59¬Ω**. If you withdraw earlier, the earnings (and principal, for Traditional) may be subject to a 10% early withdrawal penalty in addition to ordinary income tax. There are some exceptions (e.g., first-time home purchase, disability)."
            }
        ];

        // ===== UTILITY FUNCTIONS =====
        const UTILS = {
            formatCurrency(amount, decimals = 0) {
                if (typeof amount !== 'number' || isNaN(amount)) return '$0';
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(amount);
            },
            formatPercent(value, decimals = 1) {
                return (value * 100).toFixed(decimals) + '%';
            },
            parseInput(id) {
                const el = document.getElementById(id);
                return el ? (el.value.trim() || 0) : 0;
            },
            parseNum(id) {
                return parseFloat(this.parseInput(id)) || 0;
            },
            // WCAG-compliant modal alert
            showAlert(title, message) {
                document.getElementById('alert-modal-title').textContent = title;
                document.getElementById('alert-modal-body').textContent = message;
                document.getElementById('alert-modal').classList.add('visible');
                document.getElementById('alert-modal-backdrop').classList.add('visible');
                document.getElementById('alert-modal-close').focus();
            },
            // Track Google Analytics Event
            trackEvent(eventName, eventData = {}) {
                if (typeof gtag === 'function') {
                    gtag('event', eventName, eventData);
                }
            }
        };

        // ===== CORE CALCULATOR ENGINE =====
        class IRACalculator {
            constructor(inputs) {
                this.inputs = inputs;
                this.results = {
                    roth: { projection: [], totalContrib: 0, totalGains: 0, finalBalance: 0, taxPaid: 0 },
                    traditional: { projection: [], totalContrib: 0, totalGains: 0, finalBalance: 0, taxSaved: 0, finalTaxBill: 0 },
                    summary: { currentTaxRate: 0, retirementTaxRate: 0, rothEligibility: 1, tradDeductibility: 1 }
                };
            }

            // --- Tax & Limit Calculations ---
            getTaxRate(income, filingStatus) {
                const brackets = CONFIG.TAX_BRACKETS[filingStatus];
                let marginalRate = 0.10;
                for (const bracket of brackets) {
                    if (income <= bracket.limit) {
                        marginalRate = bracket.rate;
                        break;
                    }
                    marginalRate = bracket.rate; // Keep updating to the highest bracket
                }
                return marginalRate;
            }

            getRothEligibility(magi, filingStatus) {
                const phaseout = CONFIG.ROTH_PHASEOUT[filingStatus];
                if (magi <= phaseout.start) return 1.0; // Full
                if (magi >= phaseout.end) return 0.0;   // None
                const reduction = (magi - phaseout.start) / (phaseout.end - phaseout.start);
                return Math.max(0, 1.0 - reduction);
            }

            getTradDeductibility(magi, filingStatus) {
                // Assumes user has a workplace plan for worst-case scenario
                const phaseout = CONFIG.TRAD_PHASEOUT[filingStatus];
                if (magi <= phaseout.start) return 1.0; // Full
                if (magi >= phaseout.end) return 0.0;   // None
                const reduction = (magi - phaseout.start) / (phaseout.end - phaseout.start);
                return Math.max(0, 1.0 - reduction);
            }

            calculate() {
                const {
                    age, retirementAge, filingStatus, income, incomeGrowth,
                    currentBalance, annualContribution, returnRate,
                    inflationRate, catchUp, retirementTaxRateUser
                } = this.inputs;
                
                const yearsToGrow = retirementAge - age;
                if (yearsToGrow <= 0) return this.results;

                let rothBalance = currentBalance;
                let tradBalance = currentBalance;
                
                let totalRothContrib = 0, totalRothGains = 0, totalRothTaxPaid = 0;
                let totalTradContrib = 0, totalTradGains = 0, totalTradTaxSaved = 0;
                
                const rothProjection = [];
                const tradProjection = [];

                let currentIncome = income;
                
                // --- Pre-calculate static rates ---
                this.results.summary.currentTaxRate = this.getTaxRate(income, filingStatus);
                // Estimate retirement income as 80% of final salary, or use user's override
                const finalIncome = income * Math.pow(1 + incomeGrowth, yearsToGrow);
                const estimatedRetirementIncome = finalIncome * 0.8;
                const retirementTaxRate = retirementTaxRateUser > 0 ? retirementTaxRateUser : this.getTaxRate(estimatedRetirementIncome, filingStatus);
                this.results.summary.retirementTaxRate = retirementTaxRate;
                
                this.results.summary.rothEligibility = this.getRothEligibility(income, filingStatus);
                this.results.summary.tradDeductibility = this.getTradDeductibility(income, filingStatus);

                // --- Main Projection Loop ---
                for (let i = 0; i < yearsToGrow; i++) {
                    const currentAge = age + i;
                    
                    // --- Determine Contribution ---
                    let maxContrib = CONFIG.CONTRIBUTION_LIMIT;
                    if (catchUp && currentAge >= 50) {
                        maxContrib += CONFIG.CATCHUP_LIMIT;
                    }
                    const contribution = Math.min(annualContribution, maxContrib);
                    
                    // --- Tax calculations for this year ---
                    const currentTaxRate = this.getTaxRate(currentIncome, filingStatus);
                    const rothEligibility = this.getRothEligibility(currentIncome, filingStatus);
                    const tradDeductibility = this.getTradDeductibility(currentIncome, filingStatus);
                    
                    const rothContrib = contribution * rothEligibility;
                    const tradContrib = contribution; // Can always contribute, just might not be deductible
                    
                    // --- ROTH CALCULATION ---
                    const rothTaxPaid = rothContrib * currentTaxRate;
                    const rothGains = (rothBalance + rothContrib / 2) * (returnRate - inflationRate);
                    rothBalance += rothContrib + rothGains;
                    totalRothContrib += rothContrib;
                    totalRothGains += rothGains;
                    totalRothTaxPaid += rothTaxPaid;
                    rothProjection.push({
                        age: currentAge,
                        contrib: rothContrib,
                        gains: rothGains,
                        balance: rothBalance,
                        taxRate: currentTaxRate
                    });
                    
                    // --- TRADITIONAL CALCULATION ---
                    const taxSaved = (tradContrib * tradDeductibility) * currentTaxRate;
                    const tradGains = (tradBalance + tradContrib / 2) * (returnRate - inflationRate);
                    tradBalance += tradContrib + tradGains;
                    totalTradContrib += tradContrib;
                    totalTradGains += tradGains;
                    totalTradTaxSaved += taxSaved;
                    tradProjection.push({
                        age: currentAge,
                        contrib: tradContrib,
                        gains: tradGains,
                        balance: tradBalance,
                        taxRate: currentTaxRate
                    });
                    
                    // Increment for next year
                    currentIncome *= (1 + incomeGrowth);
                }
                
                // --- Final Results ---
                this.results.roth = {
                    projection: rothProjection,
                    totalContrib: totalRothContrib,
                    totalGains: totalRothGains,
                    finalBalance: rothBalance, // Already after-tax
                    taxPaid: totalRothTaxPaid
                };
                
                const finalTaxBill = tradBalance * retirementTaxRate;
                this.results.traditional = {
                    projection: tradProjection,
                    totalContrib: totalTradContrib,
                    totalGains: totalTradGains,
                    finalBalance: tradBalance, // This is pre-tax
                    finalBalanceAfterTax: tradBalance - finalTaxBill,
                    taxSaved: totalTradTaxSaved,
                    finalTaxBill: finalTaxBill
                };

                return this.results;
            }
        }

        // ===== AI INSIGHTS ENGINE =====
        class AIInsightEngine {
            constructor(results, inputs) {
                this.results = results;
                this.inputs = inputs;
                this.insights = [];
            }
            
            generateInsights() {
                this.insights = [];
                const { roth, traditional, summary } = this.results;
                const { age, income, filingStatus, annualContribution, retirementAge } = this.inputs;
                const { currentTaxRate, retirementTaxRate, rothEligibility, tradDeductibility } = summary;

                // 1. Primary Recommendation
                const rothValue = roth.finalBalance;
                const tradValue = traditional.finalBalanceAfterTax;
                const rothAdvantage = rothValue - tradValue;

                if (rothAdvantage > 0) {
                    this.insights.push({
                        type: 'success',
                        title: 'AI Recommendation: Choose Roth IRA',
                        text: `Your AI analysis suggests a <strong>Roth IRA</strong> will provide more after-tax money in retirement. You are projected to have <strong>${UTILS.formatCurrency(rothAdvantage)} more</strong> by paying taxes now at your ${UTILS.formatPercent(currentTaxRate)} rate instead of later at your estimated ${UTILS.formatPercent(retirementTaxRate)} rate.`
                    });
                } else {
                     this.insights.push({
                        type: 'success',
                        title: 'AI Recommendation: Choose Traditional IRA',
                        text: `Your AI analysis suggests a <strong>Traditional IRA</strong> is better. You are projected to have <strong>${UTILS.formatCurrency(Math.abs(rothAdvantage))} more</strong> in retirement. This is because your current ${UTILS.formatPercent(currentTaxRate)} tax rate is higher than your estimated ${UTILS.formatPercent(retirementTaxRate)} retirement rate, making the upfront tax deduction more valuable.`
                    });
                }
                
                // 2. Contribution Limit Insight
                let maxContrib = CONFIG.CONTRIBUTION_LIMIT;
                if (this.inputs.catchUp && age >= 50) maxContrib += CONFIG.CATCHUP_LIMIT;
                
                if (annualContribution < maxContrib) {
                     this.insights.push({
                        type: 'warning',
                        title: 'Opportunity: Maximize Your Contribution',
                        text: `You are contributing ${UTILS.formatCurrency(annualContribution)}, but your annual limit is ${UTILS.formatCurrency(maxContrib)}. Increasing your contribution by just <strong>$100/month</strong> could add over <strong>${UTILS.formatCurrency(100 * 12 * (retirementAge - age) * 1.5)}</strong> to your nest egg.` // Simplified future value
                    });
                } else {
                    this.insights.push({
                        type: 'success',
                        title: 'Excellent: Maxing Out Contributions',
                        text: `Great job! You are maxing out your $${maxContrib} annual contribution, which is the single best way to accelerate your retirement savings.`
                    });
                }

                // 3. Roth Eligibility Insight
                if (rothEligibility === 0) {
                     this.insights.push({
                        type: 'error',
                        title: 'Action Required: Roth Income Limit Exceeded',
                        text: `Your income of ${UTILS.formatCurrency(income)} is above the ${CONFIG.ROTH_PHASEOUT[filingStatus].end} limit for direct Roth contributions. You cannot contribute to a Roth IRA.`
                    });
                    this.insights.push({
                        type: 'info',
                        title: 'Strategy: Consider a Backdoor Roth IRA',
                        text: `Since your income is too high for a Roth, you should use the <strong>Backdoor Roth IRA</strong> strategy. This involves making a *non-deductible* contribution to a Traditional IRA and then immediately converting it to a Roth. This is a common, legal strategy.`
                    });
                } else if (rothEligibility < 1.0) {
                     this.insights.push({
                        type: 'warning',
                        title: 'Alert: Roth Contribution Phase-Out',
                        text: `Your income of ${UTILS.formatCurrency(income)} is in the Roth phase-out range (${UTILS.formatCurrency(CONFIG.ROTH_PHASEOUT[filingStatus].start)} - ${UTILS.formatCurrency(CONFIG.ROTH_PHASEOUT[filingStatus].end)}). Your maximum Roth contribution is reduced to <strong>${UTILS.formatCurrency(maxContrib * rothEligibility)}</strong>.`
                    });
                }
                
                // 4. Traditional Deductibility Insight
                if (tradDeductibility === 0) {
                     this.insights.push({
                        type: 'info',
                        title: 'Note: Traditional IRA is Non-Deductible',
                        text: `Assuming you have a workplace 401(k), your income of ${UTILS.formatCurrency(income)} is too high to deduct Traditional IRA contributions. You can still contribute, but you won't get a tax break this year. In this case, a <strong>Backdoor Roth IRA is strongly recommended</strong>.`
                    });
                } else if (tradDeductibility < 1.0) {
                     this.insights.push({
                        type: 'info',
                        title: 'Note: Traditional IRA is Partially Deductible',
                        text: `Assuming you have a workplace 401(k), your income is in the phase-out range. Only <strong>${UTILS.formatPercent(tradDeductibility, 0)}</strong> of your contribution is tax-deductible.`
                    });
                }
                
                // 5. Catch-Up Contribution Insight
                if (!this.inputs.catchUp && age >= 50) {
                     this.insights.push({
                        type: 'warning',
                        title: 'Opportunity: Use Your Catch-Up Contribution',
                        text: `You are <strong>age 50 or older</strong> but have not enabled catch-up contributions. You are eligible to contribute an <strong>extra $${CONFIG.CATCHUP_LIMIT} per year</strong>. Enable this to supercharge your savings.`
                    });
                } else if (this.inputs.catchUp && age < 50) {
                     const yearsTo50 = 50 - age;
                     this.insights.push({
                        type: 'info',
                        title: 'Future Planning: Catch-Up Contributions',
                        text: `You have catch-up contributions enabled. This will automatically add <strong>$${CONFIG.CATCHUP_LIMIT}/year</strong> to your limit starting in <strong>${yearsTo50} years</strong> (at age 50).`
                    });
                }

                // 6. Growth vs. Contributions
                const growthPercent = roth.totalGains / roth.finalBalance;
                this.insights.push({
                    type: 'info',
                    title: 'The Power of Compounding',
                    text: `By retirement, <strong>${UTILS.formatPercent(growthPercent, 0)}</strong> of your final balance (${UTILS.formatCurrency(roth.finalBalance)}) is projected to come from <strong>${UTILS.formatCurrency(roth.totalGains)} in tax-free growth</strong>, while only ${UTILS.formatPercent(1 - growthPercent, 0)} will be from your ${UTILS.formatCurrency(roth.totalContrib)} in contributions.`
                });
                
                return this.insights;
            }
        }
        
        // ===== FRED API MANAGER =====
        class FREDManager {
            static async getInflationRate() {
                const cacheStr = localStorage.getItem('fredInflationCache');
                let cache = cacheStr ? JSON.parse(cacheStr) : null;
                const now = new Date().getTime();

                // Cache is valid for 6 hours
                if (cache && (now - cache.timestamp < 6 * 60 * 60 * 1000)) {
                    console.log('Using cached inflation rate');
                    return { rate: cache.rate, date: cache.date, isCache: true };
                }

                console.log('Fetching new inflation rate from FRED');
                // This FRED series is the 12-month percent change in CPI, already as a percentage
                const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${CONFIG.FRED_SERIES_INFLATION}&api_key=${CONFIG.FRED_API_KEY}&file_type=json&sort_order=desc&limit=1&units=pc1`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`FRED API request failed: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.observations && data.observations.length > 0) {
                        const rate = parseFloat(data.observations[0].value) / 100; // Convert percent to decimal
                        const date = data.observations[0].date;
                        
                        if (isNaN(rate)) throw new Error('Invalid rate value from FRED');

                        localStorage.setItem('fredInflationCache', JSON.stringify({ rate, date, timestamp: now }));
                        return { rate, date, isCache: false };
                    }
                } catch (error) {
                    console.error('FREDManager Error:', error);
                    UTILS.showAlert('FRED API Error', 'Could not fetch live inflation data. Using default fallback value. ' + error.message);
                }
                // Fallback
                return { rate: CONFIG.liveInflationRate, date: 'N/A', isCache: false };
            }
        }

        // ===== UI MANAGER =====
        class UIManager {
            static updateDOM() {
                const { inputs, roth, traditional, summary } = CONFIG.calculation;
                const { currentTaxRate, retirementTaxRate, rothEligibility, tradDeductibility } = summary;

                // 1. Primary Recommendation
                const rothAdvantage = roth.finalBalance - traditional.finalBalanceAfterTax;
                document.getElementById('primary-recommendation').textContent = rothAdvantage > 0 ? 'Roth IRA' : 'Traditional IRA';
                document.getElementById('recommendation-reason').textContent = rothAdvantage > 0
                    ? `Projected ${UTILS.formatCurrency(rothAdvantage)} more after-tax value.`
                    : `Projected ${UTILS.formatCurrency(Math.abs(rothAdvantage))} more after-tax value.`;

                // 2. Comparison Tab
                document.getElementById('roth-balance').textContent = UTILS.formatCurrency(roth.finalBalance);
                document.getElementById('trad-balance-after-tax').textContent = UTILS.formatCurrency(traditional.finalBalanceAfterTax);
                document.getElementById('roth-advantage').textContent = UTILS.formatCurrency(rothAdvantage);
                
                // 3. Projection Tab
                const recommended = rothAdvantage > 0 ? roth : traditional;
                document.getElementById('projection-type').textContent = rothAdvantage > 0 ? 'Roth' : 'Traditional';
                document.getElementById('total-contributions').textContent = UTILS.formatCurrency(recommended.totalContrib);
                document.getElementById('total-growth').textContent = UTILS.formatCurrency(recommended.totalGains);
                document.getElementById('retirement-balance').textContent = UTILS.formatCurrency(recommended.finalBalance);

                // 4. Tax Analysis Tab
                document.getElementById('current-tax-rate').textContent = UTILS.formatPercent(currentTaxRate);
                document.getElementById('retirement-tax-rate-display').textContent = UTILS.formatPercent(retirementTaxRate);
                document.getElementById('annual-tax-savings').textContent = UTILS.formatCurrency(traditional.taxSaved / (inputs.retirementAge - inputs.age));
                document.getElementById('roth-tax-free-growth').textContent = UTILS.formatCurrency(roth.totalGains);
                document.getElementById('trad-total-tax').textContent = UTILS.formatCurrency(traditional.finalTaxBill);
                document.getElementById('roth-total-tax').textContent = UTILS.formatCurrency(roth.taxPaid); // This is tax paid *during* contribution years

                // 5. Limits Tab
                let maxContrib = CONFIG.CONTRIBUTION_LIMIT;
                if (inputs.catchUp && inputs.age >= 50) maxContrib += CONFIG.CATCHUP_LIMIT;
                
                document.getElementById('limit-standard').textContent = UTILS.formatCurrency(CONFIG.CONTRIBUTION_LIMIT);
                document.getElementById('limit-catchup').textContent = UTILS.formatCurrency(CONFIG.CATCHUP_LIMIT);
                document.getElementById('your-max-contrib').textContent = UTILS.formatCurrency(maxContrib);

                const rothEl = document.getElementById('roth-eligibility-box');
                const tradEl = document.getElementById('trad-deduction-box');
                
                document.getElementById('roth-eligibility').textContent = UTILS.formatPercent(rothEligibility, 0);
                rothEl.className = rothEligibility > 0 ? 'result-box success' : 'result-box error';

                document.getElementById('trad-deductibility').textContent = tradDeductibility === 1 ? 'Fully Deductible' : (tradDeductibility > 0 ? 'Partially' : 'Non-Deductible');
                tradEl.className = tradDeductibility > 0 ? 'result-box success' : 'result-box warning';
                
                // 6. Schedule Tab
                this.updateScheduleTable(rothAdvantage > 0 ? roth.projection : traditional.projection);

                // 7. AI Insights Tab
                this.updateInsights();
            }

            static updateScheduleTable(projection) {
                const tbody = document.querySelector('#projection-table tbody');
                if (!tbody) return;
                
                tbody.innerHTML = ''; // Clear old data
                projection.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.age}</td>
                        <td class="num">${UTILS.formatCurrency(item.contrib)}</td>
                        <td class="num">${UTILS.formatCurrency(item.gains)}</td>
                        <td class="num">${UTILS.formatCurrency(item.balance)}</td>
                        <td class="num">${UTILS.formatPercent(item.taxRate)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            static updateInsights() {
                const container = document.getElementById('ai-insights-content');
                if (!container) return;
                
                const engine = new AIInsightEngine(CONFIG.calculation, CONFIG.calculation.inputs);
                const insights = engine.generateInsights();
                
                if (insights.length === 0) {
                    container.innerHTML = '<div class="insight-box"><p>No insights generated. Please check your inputs.</p></div>';
                    return;
                }

                container.innerHTML = insights.map(insight => `
                    <div class="insight-box ${insight.type}">
                        <strong>${insight.title}:</strong> ${insight.text}
                    </div>
                `).join('');
            }

            static updateContributionLimitNote(age) {
                const limit = age >= 50 ? CONFIG.CONTRIBUTION_LIMIT + CONFIG.CATCHUP_LIMIT : CONFIG.CONTRIBUTION_LIMIT;
                const ageText = age >= 50 ? 'Age 50+' : 'Under 50';
                document.getElementById('contribution-limit-note').textContent = `2024 Limit: ${UTILS.formatCurrency(limit)} (${ageText})`;
            }

            static setupFAQ() {
                const container = document.getElementById('faqContainer');
                if(!container) return;

                FAQs.forEach((faq, index) => {
                    const qId = `faq-q-${index}`;
                    const aId = `faq-a-${index}`;
                    
                    const item = document.createElement('div');
                    item.className = 'faq-item';
                    item.innerHTML = `
                        <button class="faq-question" role="button" aria-expanded="false" aria-controls="${aId}" id="${qId}">
                            <span>${faq.q}</span>
                            <span class="faq-icon" aria-hidden="true">‚ñº</span>
                        </button>
                        <div class="faq-answer" role="region" aria-labelledby="${qId}" id="${aId}">${faq.a}</div>
                    `;
                    container.appendChild(item);
                });
                
                container.addEventListener('click', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question) app.toggleFAQ(question);
                });
                
                container.addEventListener('keydown', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question && (e.key === 'Enter' || e.key === ' ')) {
                        e.preventDefault();
                        app.toggleFAQ(question);
                    }
                });
            }
        }

        // ===== CHART MANAGER =====
        class ChartManager {
            static registerPlugins() {
                if (Chart.registerables) { 
                    Chart.register(ChartDataLabels);
                }
            }

            static renderCharts() {
                this.renderProjectionChart();
                this.renderComparisonChart();
            }

            static renderProjectionChart() {
                const { roth, traditional } = CONFIG.calculation;
                const rothAdvantage = roth.finalBalance > traditional.finalBalanceAfterTax;
                const projection = rothAdvantage ? roth.projection : traditional.projection;
                
                if (projection.length === 0) return;

                const ctx = document.getElementById('projection-canvas')?.getContext('2d');
                if (!ctx) return;

                const labels = projection.map(p => `Age ${p.age}`);
                const balances = projection.map(p => p.balance);
                const contribs = projection.map((p, i) => p.contrib + (i > 0 ? projection[i-1].totalContrib : 0));
                projection.forEach((p, i) => p.totalContrib = p.contrib + (i > 0 ? projection[i-1].totalContrib : 0));

                if (CONFIG.charts.projection) CONFIG.charts.projection.destroy();

                CONFIG.charts.projection = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Total Balance',
                                data: balances,
                                borderColor: 'var(--primary)',
                                backgroundColor: 'rgba(36, 172, 185, 0.1)',
                                tension: 0.1,
                                fill: true,
                                borderWidth: 3
                            },
                            {
                                label: 'Total Contributions',
                                data: projection.map(p => p.totalContrib),
                                borderColor: 'var(--text-light)',
                                backgroundColor: 'transparent',
                                tension: 0.1,
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: this.getChartOptions(true)
                });
            }
            
            static renderComparisonChart() {
                const { roth, traditional } = CONFIG.calculation;
                const ctx = document.getElementById('comparison-canvas')?.getContext('2d');
                if (!ctx) return;

                if (CONFIG.charts.comparison) CONFIG.charts.comparison.destroy();

                CONFIG.charts.comparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Roth IRA', 'Traditional IRA'],
                        datasets: [{
                            label: 'After-Tax Value',
                            data: [roth.finalBalance, traditional.finalBalanceAfterTax],
                            backgroundColor: ['var(--success)', 'var(--primary-dark)'],
                            borderColor: ['var(--success)', 'var(--primary-dark)'],
                            borderWidth: 2
                        }]
                    },
                    options: this.getChartOptions(false, true)
                });
            }

            static getChartOptions(isLine = false, isBar = false) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: isLine, 
                            position: 'bottom',
                            labels: { color: 'var(--text-light)' } 
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label || ctx.label}: ${UTILS.formatCurrency(ctx.parsed.y)}`
                            }
                        },
                        datalabels: {
                            display: isBar,
                            color: 'white',
                            anchor: 'end',
                            align: 'top',
                            font: { weight: 'bold' },
                            formatter: (value) => UTILS.formatCurrency(value)
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: 'var(--text-light)',
                                callback: (v) => `$${v/1000}k`
                            },
                            grid: { color: 'var(--border)' }
                        },
                        x: {
                            ticks: { color: 'var(--text-light)' },
                            grid: { display: false }
                        }
                    }
                };
            }
        }

        // ===== MAIN APP CONTROLLER =====
        const app = {
            state: {
                isTtsEnabled: false,
                isVoiceListening: false
            },

            async init() {
                this.setupEventListeners();
                this.setupDarkMode();
                this.setupAccessibility();
                UIManager.setupFAQ();
                ChartManager.registerPlugins();
                
                await this.loadInitialData(); // Load FRED data first
                this.runCalculation(); // Run initial calculation
            },

            async loadInitialData() {
                const fredEl = document.getElementById('fred-last-updated');
                try {
                    const { rate, date } = await FREDManager.getInflationRate();
                    CONFIG.liveInflationRate = rate;
                    document.getElementById('inflation-rate').value = (rate * 100).toFixed(2);
                    fredEl.textContent = `Live Rate: ${(rate * 100).toFixed(2)}% (as of ${date})`;
                    fredEl.style.color = 'var(--text-light)';
                } catch (e) {
                    fredEl.textContent = 'Error loading rate. Using default.';
                    fredEl.style.color = 'var(--error)';
                }
            },
            
            runCalculation() {
                try {
                    const inputs = {
                        age: UTILS.parseNum('current-age'),
                        retirementAge: UTILS.parseNum('retirement-age'),
                        filingStatus: document.getElementById('filing-status').value,
                        income: UTILS.parseNum('annual-income'),
                        incomeGrowth: UTILS.parseNum('income-growth') / 100,
                        currentBalance: UTILS.parseNum('current-balance'),
                        annualContribution: UTILS.parseNum('annual-contribution'),
                        returnRate: UTILS.parseNum('return-rate') / 100,
                        inflationRate: UTILS.parseNum('inflation-rate') / 100,
                        retirementTaxRateUser: UTILS.parseNum('retirement-tax-rate') / 100,
                        catchUp: document.getElementById('catch-up').value === 'yes'
                    };
                    
                    if (inputs.age >= inputs.retirementAge) {
                        UTILS.showAlert('Input Error', 'Current Age must be less than Retirement Age.');
                        return;
                    }

                    const calculator = new IRACalculator(inputs);
                    CONFIG.calculation = calculator.calculate();
                    CONFIG.calculation.inputs = inputs; // Store inputs for AI engine
                    
                    UIManager.updateDOM();
                    ChartManager.renderCharts();
                    
                    if (this.state.isTtsEnabled) this.speakResults();

                    UTILS.trackEvent('ira_calculation', {
                        'event_category': 'Financial Tool',
                        'event_label': 'IRA Calculate',
                        'value': CONFIG.calculation.roth.finalBalance, // Use a consistent value
                        'income': inputs.income,
                        'age': inputs.age
                    });

                } catch (error) {
                    console.error("Calculation Error:", error);
                    UTILS.showAlert('Error', 'An error occurred during calculation. Please check your inputs. ' + error.message);
                }
            },

            setupEventListeners() {
                // Form Submission
                document.getElementById('ira-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.runCalculation();
                });

                // Auto-update contribution note
                document.getElementById('current-age').addEventListener('input', (e) => {
                    UIManager.updateContributionLimitNote(parseInt(e.target.value) || 0);
                });

                // Tab Navigation
                const tablist = document.querySelector('[role="tablist"]');
                const tabs = tablist.querySelectorAll('[role="tab"]');
                tablist.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('[role="tab"]');
                    if (!clickedTab) return;
                    this.activateTab(clickedTab);
                });
                tablist.addEventListener('keydown', (e) => {
                    let index = Array.from(tabs).indexOf(document.activeElement);
                    if (index === -1) return;
                    let direction = (e.key === 'ArrowRight' || e.key === 'ArrowDown') ? 1 : (e.key === 'ArrowLeft' || e.key === 'ArrowUp') ? -1 : 0;
                    if (direction !== 0) {
                        e.preventDefault();
                        index = (index + direction + tabs.length) % tabs.length;
                        tabs[index].focus();
                    }
                });
            },

            setupAccessibility() {
                // Dark Mode
                document.getElementById('darkModeToggle').addEventListener('click', () => {
                    const html = document.documentElement;
                    const scheme = html.getAttribute('data-color-scheme') === 'dark' ? 'light' : 'dark';
                    html.setAttribute('data-color-scheme', scheme);
                    localStorage.setItem('colorScheme', scheme);
                    UTILS.trackEvent('theme_toggle', { 'theme': scheme });
                    // Re-render charts for new theme colors
                    ChartManager.renderCharts();
                });

                // Text-to-Speech
                document.getElementById('ttsToggle').addEventListener('click', (e) => {
                    this.state.isTtsEnabled = !this.state.isTtsEnabled;
                    e.currentTarget.classList.toggle('active', this.state.isTtsEnabled);
                    if (this.state.isTtsEnabled) {
                        this.speakResults();
                        UTILS.trackEvent('tts_enabled');
                    } else {
                        speechSynthesis.cancel();
                    }
                });

                // Voice Control
                const voiceBtn = document.getElementById('voiceToggle');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = () => { 
                        this.state.isVoiceListening = true;
                        voiceBtn.classList.add('active'); 
                        voiceBtn.innerHTML = '...';
                    };
                    recognition.onend = () => { 
                        this.state.isVoiceListening = false;
                        voiceBtn.classList.remove('active');
                        voiceBtn.innerHTML = 'üé§';
                    };
                    recognition.onerror = (event) => { console.error('Voice recognition error', event.error); };

                    recognition.onresult = (event) => {
                        const command = event.results[0][0].transcript.toLowerCase().trim();
                        this.handleVoiceCommand(command);
                    };
                    
                    voiceBtn.addEventListener('click', () => {
                        if (this.state.isVoiceListening) recognition.stop();
                        else recognition.start();
                        UTILS.trackEvent('voice_control_toggled');
                    });
                } else {
                    voiceBtn.disabled = true;
                    voiceBtn.title = 'Voice control not supported in this browser.';
                }

                // Modals & Banners
                document.getElementById('cookie-consent-btn').addEventListener('click', () => {
                    localStorage.setItem('cookieConsent', 'true');
                    document.getElementById('cookie-consent-banner').style.display = 'none';
                    UTILS.trackEvent('cookie_consent_accepted');
                });
                
                const modal = document.getElementById('alert-modal');
                const backdrop = document.getElementById('alert-modal-backdrop');
                const closeBtn = document.getElementById('alert-modal-close');
                const closeModal = () => {
                    modal.classList.remove('visible');
                    backdrop.classList.remove('visible');
                };
                closeBtn.addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            },
            
            handleVoiceCommand(command) {
                console.log('Voice command received:', command);
                if (command.includes('calculate') || command.includes('run analysis')) {
                    document.getElementById('ira-form').requestSubmit();
                } else if (command.includes('read insight') || command.includes('read recommendation')) {
                    this.activateTab(document.getElementById('tab-ai-insights'));
                    this.speakResults(true); // true = speak AI insight
                } else if (command.includes('read results') || command.includes('read recommendation')) {
                    this.speakResults(false); // false = speak summary
                } else if (command.includes('show projection')) {
                    this.activateTab(document.getElementById('tab-projection-chart'));
                } else if (command.includes('show comparison')) {
                    this.activateTab(document.getElementById('tab-comparison-chart'));
                } else if (command.includes('dark mode')) {
                    document.getElementById('darkModeToggle').click();
                } else if (command.includes('light mode')) {
                    document.getElementById('darkModeToggle').click();
                }
            },
            
            speakResults(speakInsight = false) {
                if (!('speechSynthesis' in window) || !this.state.isTtsEnabled) return;
                
                speechSynthesis.cancel();
                let textToSpeak = '';
                
                if (speakInsight) {
                    const firstInsight = document.querySelector('#ai-insights-content .insight-box');
                    textToSpeak = firstInsight ? firstInsight.textContent : 'No AI insight available.';
                } else {
                    const recommendation = document.getElementById('primary-recommendation').textContent;
                    const reason = document.getElementById('recommendation-reason').textContent;
                    textToSpeak = `AI recommends the ${recommendation}. ${reason}`;
                }

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'en-US';
                speechSynthesis.speak(utterance);
            },

            setupDarkMode() {
                const saved = localStorage.getItem('colorScheme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const scheme = saved || (prefersDark ? 'dark' : 'light');
                document.documentElement.setAttribute('data-color-scheme', scheme);
            },
            
            showPartnerAlert(partnerName) {
                UTILS.showAlert(
                    'Affiliate Partner Link',
                    `This is an affiliate link for our partner: ${partnerName}. If you click this link and apply for a product, we may receive a commission. This helps us keep our tools free.`
                );
                UTILS.trackEvent('affiliate_click', { 'partner': partnerName });
            },

            activateTab(tab) {
                const tabId = tab.getAttribute('aria-controls');
                
                document.querySelectorAll('[role="tab"]').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                    t.setAttribute('tabindex', '-1');
                });
                
                document.querySelectorAll('[role="tabpanel"]').forEach(p => {
                    p.classList.remove('active');
                });
                
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                tab.setAttribute('tabindex', '0');

                document.getElementById(tabId).classList.add('active');
                
                // Re-render charts when their tab is clicked
                if (tabId === 'projection-chart') ChartManager.renderProjectionChart();
                if (tabId === 'comparison-chart') ChartManager.renderComparisonChart();

                UTILS.trackEvent('tab_view', { 'tab_id': tabId });
            },

            toggleFAQ(question) {
                const answer = document.getElementById(question.getAttribute('aria-controls'));
                const isActive = question.getAttribute('aria-expanded') === 'true';

                question.setAttribute('aria-expanded', !isActive);
                question.classList.toggle('active', !isActive);
                answer.style.display = !isActive ? 'block' : 'none';
                if (!isActive) {
                    answer.style.animation = 'slideDown 0.3s ease';
                }
                question.querySelector('.faq-icon').style.transform = !isActive ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            
            // Show cookie banner if consent not given
            if (localStorage.getItem('cookieConsent') !== 'true') {
                document.getElementById('cookie-consent-banner').style.display = 'flex';
            }
        });

    </script>
    <script>
        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'ira-calculator-v2';
                const OFFLINE_HTML = \`
                    <!DOCTYPE html>
                    <html lang="en" style="font-family: Arial, sans-serif; background: #F5F7FA; color: #1F2121; padding: 20px;">
                    <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Offline | FinGuid IRA Calculator</title>
                    <style>body{text-align:center;padding-top:50px;} h1{color:#24ACB9;} .icon{font-size:4rem;}</style></head>
                    <body><div class="icon">ü§ñ</div><h1>You are Offline</h1>
                    <p>This AI IRA Calculator needs an internet connection to fetch live data and function correctly.</p>
                    <p>Please check your connection and try again.</p></body></html>
                \`;
                
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => {
                            return cache.addAll([
                                '.', // Caches the main HTML file
                                'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js',
                                'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js'
                            ]);
                        })
                    );
                });

                self.addEventListener('fetch', event => {
                    if (event.request.mode === 'navigate') {
                        event.respondWith(
                            fetch(event.request).catch(() => {
                                return caches.match(event.request).then(response => {
                                    return response || new Response(OFFLINE_HTML, { headers: { 'Content-Type': 'text/html' } });
                                });
                            })
                        );
                    } else {
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                return response || fetch(event.request);
                            })
                        );
                    }
                });
            `;
            const blob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered successfully.', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
