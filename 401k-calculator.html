<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO & AI-Focused Metadata -->
    <title>AI 401(k) Calculator 2025 | Retirement & Match Optimizer | FinGuid</title>
    <meta name="description" content="World's First AI-Powered 401(k) Calculator by FinGuid. Optimize your retirement savings with employer match analysis, tax benefit projections, growth charts, and AI-driven insights. Uses live FRED inflation data. WCAG 2.1 AA compliant.">
    
    <!-- Extensive Keywords for SEO -->
    <meta name="keywords" content="401k calculator, retirement calculator, AI retirement planning, employer match calculator, 401k savings calculator, retirement savings, 401k contribution, 401k growth calculator, retirement planning AI, FinGuid, USA retirement, tax savings 401k, 401k projection, 401k optimizer, 401k limits 2025, retirement planning, 401k employer match, retirement fund calculator, 401k contribution limits, how much to save for retirement, AI financial calculator, FRED inflation data, 401k catch-up contributions, retirement income calculator, 401k tax benefits, retirement projection, 401k vs IRA, 401k match percentage, retirement goals, financial calculator USA, FinGuid USA, AI retirement advisor">

    <meta name="author" content="FinGuid USA">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="theme-color" content="#24ACB9"> <!-- FinGuid Primary Color -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="AI 401(k) Calculator 2025 | Retirement & Match Optimizer | FinGuid">
    <meta property="og:description" content="Free AI 401(k) calculator with employer match, tax savings, growth charts, and AI-driven insights.">
    
    <link rel="canonical" href="https://www.finguid.com/calculators/401k">
    
    <!-- Inlined PWA Web App Manifest (from mortgage-calc) -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22FinGuid%20AI%20401(k)%20Calculator%22,%22short_name%22:%22401kCalc%22,%22description%22:%22AI-Powered%20401(k)%20Calculator%20with%20Employer%20Match,%20Tax%20Savings,%20and%20AI%20Insights.%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#FFFFFD%22,%22theme_color%22:%22#24ACB9%22,%22icons%22:[{%22src%22:%22https://placehold.co/192x192/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://placehold.co/512x512/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22512x512%22}]}">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- 
      START: Inlined CSS
      This contains the full styling from mortgage-calculator (6).html
      to ensure unified design and full WCAG/Mobile compliance.
    -->
    <style>
        /* === START: Global Variables (Brand Color Match) === */
        :root {
            --primary: #24ACB9; /* Teal (From Mortgage Calc) */
            --primary-dark: #19343B; /* Dark Teal (From Mortgage Calc) */
            --accent: #FFC107;
            --accent-dark: #E69500;
            --text: #1F2121;
            --text-light: #64748B;
            --bg: #FFFFFD;
            --bg-secondary: #F5F7FA;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --error: #EF4444;
            --success: #10B981;
            --fred-color: #A31B20; /* FRED standard color */
        }

        [data-color-scheme="dark"] {
            --text: #E1E8ED;
            --text-light: #B8C5D0;
            --bg: #1F2121;
            --bg-secondary: #242B36;
            --card: #181919;
            --border: #38444D;
        }
        /* === END: Global Variables === */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { 
            font-size: 16px; 
            -webkit-font-smoothing: antialiased; 
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* ===== HEADER STYLES (Adapted for 401k) ===== */
        .header {
            position: sticky;
            top: 0;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--primary); 
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }
        .logo span {
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            opacity: 0.7;
        }

        .logo:hover { color: var(--primary-dark); }

        .calculator-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            flex-shrink: 0;
            margin-left: 16px;
            flex-basis: auto;
            min-width: 0;
        }

        /* === Animated Features (from 401k file) === */
        .header-features {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 24px;
            flex-grow: 1;
            justify-content: flex-start;
            overflow: hidden;
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        .header-feature-item {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            animation: pulse-color-text 2.5s infinite ease-in-out;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .header-feature-item i {
            color: var(--primary);
        }
        .header-feature-item:nth-child(1) { animation-delay: 0s; }
        .header-feature-item:nth-child(2) { animation-delay: 0.2s; }
        .header-feature-item:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulse-color-text {
            0%, 100% {
                opacity: 0.8;
                color: var(--text-light);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                color: var(--primary);
                transform: scale(1.03);
            }
        }
        /* === END: Improved Animated Features === */


        /* Header Controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:hover { background: var(--primary); color: white; }

        .icon-btn.active {
            background: var(--primary);
            color: white;
        }
        /* Voice/TTS specific active styles */
        .icon-btn.voice-active {
            background: var(--error);
            color: white;
        }
        .icon-btn.tts-active {
            background: var(--primary);
            color: white;
        }

        #pwa-install-btn {
            display: none; /* Hidden by default, shown by JS */
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #pwa-install-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        /* ===== END NEW HEADER STYLES ===== */

        /* ===== SPONSOR BANNER (Uses FinGuid/Car Lease Gradient) ===== */
        .sponsor-banner {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); /* Matched car lease color */
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .sponsor-text { font-weight: 500; flex: 1; min-width: 200px; }
        .sponsor-buttons { display: flex; gap: 8px; }
        .sponsor-btn {
            padding: 8px 12px;
            background: white;
            color: #6366F1; /* Color from the gradient for consistency */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .sponsor-btn:hover { background: var(--accent); color: var(--text); transform: translateY(-2px); }

        /* ===== MAIN CALCULATOR (Layout from Mortgage Calc) ===== */
        .calculator-wrapper {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            padding: 24px 0;
            margin-bottom: 40px;
        }

        .inputs-panel, .results-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        .inputs-panel:hover, .results-panel:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .panel-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text); 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }

        .section-heading {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }
        
        /* FRED Data Note */
        .fred-data-note {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 600;
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: flex-end;
        }
        .fred-data-note a {
            color: var(--text-light);
            text-decoration: none;
        }
         .fred-data-note a:hover {
            color: var(--primary);
        }


        /* ===== Tooltip Styles (from Mortgage Calc) ===== */
        .tooltip {
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
            display: inline-flex;
            align-items: center;
            color: var(--text-light);
        }
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-light);
            color: var(--card);
            font-style: normal;
            font-size: 10px;
            font-weight: 700;
            line-height: 14px;
            margin-left: 5px;
            transition: all 0.2s ease;
        }
        .tooltip:hover .tooltip-icon,
        .tooltip:focus .tooltip-icon {
            background: var(--primary);
            outline: none;
        }
        .tooltip:focus {
            outline: none;
        }
        .tooltip-box {
            position: fixed;
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 200px;
            white-space: normal;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        /* ===== END: Tooltip Styles ===== */

        .input-wrapper { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            min-width: 0; 
        }

        input[type="number"], input[type="text"], input[type="date"], input[type="month"], select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 0;
            width: 100%;
        }

        /* WCAG FIX: Focus ring */
        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus, 
        input[type="month"]:focus, select:focus, .rate-btn:focus, .calculate-btn:focus, 
        .sponsor-btn:focus, .btn-secondary:focus, .icon-btn:focus, 
        #pwa-install-btn:focus, .tab-btn:focus, .faq-question:focus,
        .checkbox-group input[type="checkbox"]:focus + label {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.25);
        }
        .icon-btn:focus, #pwa-install-btn:focus, .sponsor-btn:focus, .calculate-btn:focus {
             box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
        }

        .input-addon {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            min-width: 50px;
            text-align: center;
        }
        
        /* Checkbox styles from 401k, adapted */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 16px 0;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary);
        }
        .checkbox-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            margin-bottom: 0;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Calculate Button (from Mortgage Calc) */
        .calculate-btn {
            width: 100%;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .calculate-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .calculate-btn:active { transform: translateY(0); }

        /* Ad Slot (from Mortgage Calc) */
        .ad-slot {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin: 24px 0;
        }
        .ad-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .ad-placeholder {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 600;
        }

        /* ===== RESULTS SECTION (from Mortgage Calc) ===== */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(36, 172, 185, 0.2);
            text-align: center;
        }
        .summary-label { 
            font-size: 0.875rem; 
            opacity: 0.9; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
        }
        .payment-amount { 
            display: flex; 
            align-items: baseline; 
            justify-content: center; 
            gap: 8px; 
            margin: 8px 0; 
        }
        .amount { font-size: 2.5rem; font-weight: bold; }
        .unit { font-size: 1rem; opacity: 0.9; }
        .payment-breakdown { font-size: 0.875rem; opacity: 0.9; }

        .tabs { margin-bottom: 24px; }
        .tab-buttons { 
            display: flex; 
            gap: 4px; 
            border-bottom: 2px solid var(--border); 
            margin-bottom: 24px; 
            overflow-x: auto; 
        }

        .tab-btn {
            padding: 16px 20px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:focus {
            color: var(--primary);
            box-shadow: none;
            border-bottom-color: rgba(36, 172, 185, 0.5);
        }
        .tab-btn.active:focus {
             border-bottom-color: var(--primary);
        }

        .tab-content { display: none; padding: 8px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        .tab-content:focus-visible {
            outline: 2px solid var(--primary);
            border-radius: 4px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .results-heading {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin: 16px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .result-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        .result-box { 
            background: var(--bg-secondary); 
            padding: 16px; 
            border-radius: 6px; 
            border-left: 4px solid var(--border); 
            transition: all 0.2s; 
        }
        .result-box:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }

        .result-box.highlight { 
            border-left-color: var(--primary); 
            background: rgba(36, 172, 185, 0.1); 
        }
        .result-box.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .result-box.accent {
            border-left-color: var(--accent-dark);
            background: rgba(255, 193, 7, 0.1);
        }

        .result-label { 
            display: block; 
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
        }
        .result-value { 
            display: block; 
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }
        /* Special for tax savings */
        .result-box.success .result-value {
             color: var(--success);
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
        }

        /* ===== Amortization Table Styles (from Mortgage Calc) ===== */
        .amortization-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 8px 16px;
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .table-scroll-wrapper {
            overflow-x: auto;
            max-height: 500px; /* Scrollable table body */
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .amortization-table thead {
            position: sticky;
            top: 0;
            background: var(--primary);
            color: white;
            z-index: 10;
        }
        .amortization-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .amortization-table th:nth-child(n+2) { text-align: right; }

        .amortization-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .amortization-table tbody tr:nth-child(even) {
            background: var(--bg-secondary);
        }
        .amortization-table tbody tr:hover {
            background: rgba(36, 172, 185, 0.1);
        }
        .amortization-table td {
            padding: 10px 12px;
            color: var(--text-light);
        }
        .amortization-table td:first-child {
            font-weight: 600;
            color: var(--text);
        }
        .amortization-table td:nth-child(n+2) {
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
        }
        .amortization-table .summary-row td {
            font-weight: bold;
            color: var(--text);
            background: var(--bg-secondary);
        }
        /* ===== END: Amortization Styles ===== */

        /* ===== AI INSIGHTS (from Mortgage Calc) ===== */
        .insights-container { margin-top: 20px; }
        .insight-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            animation: slideIn 0.3s ease;
        }
        .insight-box h4 {
            color: var(--text);
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .insight-box h4 i {
            color: var(--primary);
        }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        /* AI Alert Box (from 401k, styled like mortgage calc) */
        .recommendation-alert {
            padding: 16px;
            margin: 16px 0;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .recommendation-alert i {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .recommendation-alert.high-priority {
            background: linear-gradient(135deg, var(--error) 0%, #b91c1c 100%);
        }
        .recommendation-alert.low-priority {
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
        }

        /* ===== PARTNER SECTION (from 401k Footer, styled like mortgage calc) ===== */
        .footer-sponsor {
            background: linear-gradient(135deg, rgba(36, 172, 185, 0.1) 0%, rgba(25, 52, 59, 0.1) 100%);
            padding: 40px;
            border-bottom: 1px solid rgba(36, 172, 185, 0.2);
            border-radius: 12px;
        }
        .sponsor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; }
        .sponsor-item { text-align: center; padding: 16px; border-radius: 8px; background: var(--card); transition: all 0.2s; }
        .sponsor-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sponsor-item h4 { margin-bottom: 8px; color: var(--primary); font-size: 1rem; }
        .sponsor-item p { color: var(--text-light); margin-bottom: 12px; font-size: 0.875rem; line-height: 1.5; }
        .sponsor-item a {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .sponsor-item a:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        .sponsor-item a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(36, 172, 185, 0.3); }

        /* ===== FOOTER (from 401k, styled like mortgage calc) ===== */
        .footer { background: var(--card); border-top: 1px solid var(--border); padding: 32px 0; margin-top: 40px; }
        .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .footer-section h4 { 
            font-size: 13px; 
            font-weight: 700; 
            color: var(--text); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 12px; 
        }
        .footer-section p {
            font-size: 12px; 
            color: var(--text-light); 
            line-height: 1.6;
            margin-bottom: 8px;
        }
        .footer-section a { 
            display: block; 
            font-size: 12px; 
            color: var(--text-light); 
            text-decoration: none; 
            margin-bottom: 8px; 
            transition: color 0.3s ease; 
        }
        .footer-section a:hover, .footer-section a:focus { 
            color: var(--primary); 
            text-decoration: underline;
            outline: none;
        }
        .compliance-badges { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; font-size: 12px; }
        .badge { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; font-weight: 600; color: var(--text-light); }
        .disclaimer { 
            font-size: 11px; 
            color: var(--text-light); 
            line-height: 1.6; 
            padding-top: 20px; 
            border-top: 1px solid var(--border); 
        }
        .footer-bottom { 
            text-align: center; 
            font-size: 12px; 
            color: var(--text-light); 
            padding-top: 16px; 
            border-top: 1px solid var(--border); 
        }

        /* ===== FAQ ACCORDION (from Mortgage Calc) ===== */
        .faq-section { margin: 40px 0; }
        .faq-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 20px; text-align: center; }
        .faq-container { max-width: 900px; margin: 0 auto; }
        .faq-item { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; }
        .faq-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .faq-question { padding: 16px; background: var(--bg-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text); transition: all 0.3s ease; }
        .faq-question:hover { background: var(--card); color: var(--primary); }
        .faq-question.active { background: var(--primary); color: white; }
        .faq-question:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4) inset;
            color: var(--primary);
        }
        .faq-icon { font-size: 18px; transition: transform 0.3s ease; }
        .faq-question.active .faq-icon { transform: rotate(180deg); }
        .faq-answer { display: none; padding: 16px; background: var(--card); color: var(--text-light); line-height: 1.8; font-size: 14px; }
        .faq-answer p { margin-bottom: 1em; }
        .faq-answer a { color: var(--primary); text-decoration: underline; }
        .faq-answer a:hover { color: var(--primary-dark); }
        
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }

        /* ===== GDPR/CCPA Cookie Consent Banner Styles ===== */
        #cookie-consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            color: var(--text);
            padding: 24px;
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .cookie-consent-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-light);
            flex: 1 1 400px;
        }
        .cookie-consent-text a {
            color: var(--primary);
            text-decoration: underline;
        }
        .cookie-consent-text a:hover {
            color: var(--primary-dark);
        }
        #cookie-consent-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #cookie-consent-btn:hover {
            background: var(--primary-dark);
        }
        #cookie-consent-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }

        /* ===== RESPONSIVE (Updated for new header) ===== */
        @media (max-width: 1024px) {
            .calculator-wrapper { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: repeat(2, 1fr); }
            .inputs-panel {
                position: static;
                max-height: none;
                overflow-y: visible;
            }
        }

        @media (max-width: 768px) {
            .header-features { display: none; }
            .sponsor-banner { flex-direction: column; gap: 12px; }
            .sponsor-buttons { flex: 1 1 100%; justify-content: space-between; }
            .tab-buttons { flex-wrap: nowrap; overflow-x: auto; }
            
            .inputs-panel, .results-panel {
                padding: 16px;
            }
            .footer-sponsor {
                padding: 24px;
            }
        }

        @media (max-width: 480px) {
            .calculator-title { display: none; }
            .header-features { display: none; }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .header-controls {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            #pwa-install-btn {
                flex-grow: 1;
            }

            .payment-breakdown { font-size: 0.75rem; }
            .amount { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; }
            .sponsor-grid { grid-template-columns: 1fr; }

            #cookie-consent-banner {
                flex-direction: column;
                text-align: center;
            }
            .cookie-consent-text {
                flex-basis: auto;
            }
            #cookie-consent-btn {
                width: 100%;
            }
        }

        /* ===== PRINT STYLE ===== */
        @media print {
            .header, .sponsor-banner, .header-controls, .footer-sponsor, .faq-section, 
            .footer, .ad-slot, .amortization-controls, .chart-summary-controls,
            #cookie-consent-banner, .calculate-btn {
                display: none;
            }
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel, .results-panel { box-shadow: none; border: 1px solid #ccc; }
            .table-scroll-wrapper { max-height: none; overflow: visible; }
        }
        
        /* Visually-hidden helper class for accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

    </style>
    <!-- END: Inlined CSS -->

    <!-- Google Analytics Script (G-NYBL2CDNQJ) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYBL2CDNQJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NYBL2CDNQJ');
    </script>

    <!-- PWA Install & Preload Logic -->
    <script>
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            const pwaInstall = document.getElementById('pwa-install-btn');
            if (pwaInstall) pwaInstall.style.display = 'flex';
        });

        document.addEventListener('DOMContentLoaded', () => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'script';
            link.href = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            document.head.appendChild(link);
        });
    </script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="https://www.finguid.com" class="logo">
                    <!-- WCAG FIX: Added aria-label for emoji -->
                    <span role="img" aria-label="Money bag emoji">üí∞</span>
                    FinGuid <span>USA</span>
                </a>
                
                <span class="calculator-title">AI 401(k) Optimizer</span>

                <div class="header-features" aria-hidden="true">
                    <span class="header-feature-item"><i class="fas fa-microchip"></i> AI Insights</span>
                    <span class="header-feature-item"><i class="fas fa-hand-holding-usd"></i> Employer Match</span>
                    <span class="header-feature-item"><i class="fas fa-chart-line"></i> Tax Savings</span>
                </div>

                <div class="header-controls">
                    <button type="button" id="pwa-install-btn" aria-label="Install App">üì± Install</button>
                    <button type="button" class="icon-btn" id="darkModeToggle" aria-label="Toggle dark mode" title="Dark mode">üåô</button>
                    <button type="button" class="icon-btn" id="voiceToggle" aria-label="Voice control" title="Voice commands">üé§</button>
                    <button type="button" class="icon-btn" id="ttsToggle" aria-label="Text to speech" title="Read results">üîä</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="sponsor-banner">
        <span class="sponsor-text">üéÅ Rollover your old 401(k) and get up to a $500 bonus!</span>
        <div class="sponsor-buttons">
            <button type="button" class="sponsor-btn" onclick="app.showPartnerAlert('401k Rollover Partner')">Compare Rollover IRAs ‚Üí</button>
        </div>
    </div>

    <main class="container" role="main">
        <div class="calculator-wrapper">
            <!-- INPUT SECTION (from 401k, restyled with mortgage-calc classes) -->
            <section class="inputs-panel" role="region" aria-labelledby="inputs-title">
                <h2 class="panel-title" id="inputs-title"><i class="fas fa-user-clock"></i> Your Retirement Inputs</h2>
                
                <form id="401k-form" novalidate>
                    <div class="section-heading">Personal & Income</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="current-age">Current Age
                                <span class="tooltip" data-tooltip="Your current age in years." tabindex="0" role="tooltip" id="tooltip-current-age">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <input type="number" id="current-age" value="30" min="18" max="99" aria-label="Current Age" aria-describedby="tooltip-current-age">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="retirement-age">Retirement Age
                                <span class="tooltip" data-tooltip="The age you plan to retire." tabindex="0" role="tooltip" id="tooltip-retirement-age">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <input type="number" id="retirement-age" value="65" min="19" max="100" aria-label="Retirement Age" aria-describedby="tooltip-retirement-age">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="annual-salary">Gross Annual Salary
                            <span class="tooltip" data-tooltip="Your total yearly income before taxes." tabindex="0" role="tooltip" id="tooltip-salary">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-addon" aria-hidden="true">$</span>
                            <input type="text" id="annual-salary" value="80,000" inputmode="numeric" aria-label="Gross Annual Salary" aria-describedby="tooltip-salary">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="filing-status">Filing Status (for Tax)
                             <span class="tooltip" data-tooltip="Used to estimate your federal tax bracket and potential savings." tabindex="0" role="tooltip" id="tooltip-filing">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <select id="filing-status" aria-label="Tax Filing Status" aria-describedby="tooltip-filing">
                            <option value="Single" selected>Single</option>
                            <option value="Married Filing Jointly">Married Filing Jointly</option>
                            <option value="Head of Household">Head of Household</option>
                        </select>
                    </div>

                    <!-- Ad Slot -->
                    <aside class="ad-slot" role="complementary" aria-label="Sponsored Advertisement">
                        <p class="ad-label">ADVERTISEMENT</p>
                        <div class="ad-placeholder">
                           <p>üíº Sponsored: Optimize your payroll with [Payroll Partner]</p>
                        </div>
                    </aside>

                    <div class="section-heading">Contributions & Match</div>
                    <div class="form-group">
                        <label class="form-label" for="current-balance">Current 401(k) Balance
                            <span class="tooltip" data-tooltip="The total amount you already have saved in your 401(k)." tabindex="0" role="tooltip" id="tooltip-balance">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-addon" aria-hidden="true">$</span>
                            <input type="text" id="current-balance" value="25,000" inputmode="numeric" aria-label="Current 401k Balance" aria-describedby="tooltip-balance">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="contribution-percent">Your Contribution
                            <span class="tooltip" data-tooltip="The percentage of your pre-tax salary you contribute to your 401(k)." tabindex="0" role="tooltip" id="tooltip-contrib">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="contribution-percent" value="6" min="0" max="100" step="1" aria-label="Your Contribution Percentage" aria-describedby="tooltip-contrib">
                            <span class="input-addon" aria-hidden="true">%</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="employer-match-percent">Employer Match %
                            <span class="tooltip" data-tooltip="The percentage your employer matches. (e.g., 50% or 100%)" tabindex="0" role="tooltip" id="tooltip-match-pct">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                         <div class="input-wrapper">
                            <input type="number" id="employer-match-percent" value="100" min="0" aria-label="Employer Match Percentage" aria-describedby="tooltip-match-pct">
                            <span class="input-addon" aria-hidden="true">%</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="match-up-to-percent">Match Up To %
                            <span class="tooltip" data-tooltip="The maximum percentage of *your salary* that your employer will apply the match to." tabindex="0" role="tooltip" id="tooltip-match-up-to">
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="match-up-to-percent" value="6" min="0" aria-label="Match Up To Percentage" aria-describedby="tooltip-match-up-to">
                            <span class="input-addon" aria-hidden="true">%</span>
                        </div>
                    </div>

                    <div class="section-heading">Projections & Assumptions</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="salary-increase">Annual Salary Increase
                                <span class="tooltip" data-tooltip="Your estimated average raise per year." tabindex="0" role="tooltip" id="tooltip-raise">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="salary-increase" value="3" min="0" step="0.5" aria-label="Annual Salary Increase" aria-describedby="tooltip-raise">
                                <span class="input-addon" aria-hidden="true">%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="rate-of-return">Annual Rate of Return
                                <span class="tooltip" data-tooltip="Your estimated average annual growth on your 401(k) investments." tabindex="0" role="tooltip" id="tooltip-ror">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                             <div class="input-wrapper">
                                <input type="number" id="rate-of-return" value="7" min="0" step="0.5" aria-label="Annual Rate of Return" aria-describedby="tooltip-ror">
                                <span class="input-addon" aria-hidden="true">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="include-catch-up" aria-label="Include Catch-Up Contributions">
                        <label for="include-catch-up">Include Catch-Up Contributions (Age 50+)</label>
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="include-inflation" aria-label="Show Inflation-Adjusted Returns">
                        <label for="include-inflation">Show Inflation-Adjusted (Real) Returns</label>
                    </div>
                    <div class="fred-data-note">
                        Uses live inflation data via <a href="https://fred.stlouisfed.org/" target="_blank" rel="noopener">FRED¬Æ</a>
                    </div>


                    <!-- Calculate Button -->
                    <div class="form-group" style="margin-top: 24px;">
                        <button type="submit" class="calculate-btn" id="calculate-button">
                            <i class="fas fa-calculator"></i> Calculate Projection
                        </button>
                    </div>
                </form>
            </section>

            <!-- RESULTS SECTION (from 401k, restyled with mortgage-calc classes) -->
            <section class="results-panel" role="region" aria-labelledby="results-title">
                <h2 class="panel-title" id="results-title">üìä Analysis & Results</h2>

                <!-- Summary Card -->
                <div class="summary-card">
                    <div class="summary-label">Projected Total at Retirement</div>
                    <div class="payment-amount">
                        <span class="amount" id="projected-total" aria-live="polite">$0</span>
                    </div>
                    <div class="payment-breakdown" id="projection-summary-details" aria-live="polite">
                        Your Cont: $0 | Employer Match: $0 | Total Growth: $0
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab-buttons" role="tablist" aria-label="Results sections">
                        <button type="button" class="tab-btn active" role="tab" aria-controls="projection-chart" aria-selected="true" id="tab-projection-chart"><i class="fas fa-chart-line"></i> Projections Chart</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="summary-details" aria-selected="false" id="tab-summary-details" tabindex="-1"><i class="fas fa-clipboard-list"></i> Summary & Tax</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="ai-insights" aria-selected="false" id="tab-ai-insights" tabindex="-1"><i class="fas fa-microchip"></i> AI Insights</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="schedule-detail" aria-selected="false" id="tab-schedule-detail" tabindex="-1"><i class="fas fa-calendar-alt"></i> Full Schedule</button>
                    </div>

                    <!-- Tab 1: Chart -->
                    <div id="projection-chart" class="tab-content active" role="tabpanel" aria-labelledby="tab-projection-chart" tabindex="0">
                        <div class="chart-container">
                            <canvas id="401k-projection-chart" role="img" aria-label="401k projection chart"></canvas>
                        </div>
                        <aside class="ad-slot" role="complementary" aria-label="Partner Advertisement" style="background: linear-gradient(135deg, rgba(36, 172, 185, 0.1) 0%, rgba(25, 52, 59, 0.1) 100%); border-color: var(--primary);">
                            <h4 style="color: var(--primary); font-weight: 700; margin-bottom: 8px;"><i class="fas fa-handshake"></i> Need a Professional Plan?</h4>
                            <p style="color: var(--text-light); margin-bottom: 16px; font-size: 13px;">Your projection looks good, but a pro can perfect it. Connect with a Vetted US Financial Advisor today!</p>
                            <button type="button" class="calculate-btn" style="width: auto; padding: 10px 20px; font-size: 14px;" onclick="app.showPartnerAlert('Financial Advisor'); return false;">
                                Find an Advisor (Affiliate)
                            </button>
                        </aside>
                    </div>

                    <!-- Tab 2: Summary & Tax -->
                    <div id="summary-details" class="tab-content" role="tabpanel" aria-labelledby="tab-summary-details" tabindex="0">
                        <h3 class="results-heading">First Year Projections</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <span class="result-label">Your Annual Contribution</span>
                                <span class="result-value" id="your-annual-contribution">$0.00</span>
                            </div>
                            <div class="result-box">
                                <span class="result-label">Employer's Annual Match</span>
                                <span class="result-value" id="employer-annual-match">$0.00</span>
                            </div>
                            <div class="result-box highlight">
                                <span class="result-label">Total First Year Contribution</span>
                                <span class="result-value" id="total-annual-contribution">$0.00</span>
                            </div>
                        </div>

                        <h3 class="results-heading" style="margin-top: 24px;">Estimated Tax Benefits</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <span class="result-label">Est. Marginal Tax Rate</span>
                                <span class="result-value" id="marginal-tax-rate">0.0%</span>
                            </div>
                            <div class="result-box success">
                                <span class="result-label">Estimated Annual Tax Savings</span>
                                <span class="result-value" id="annual-tax-savings">$0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 3: AI Insights -->
                    <div id="ai-insights" class="tab-content" role="tabpanel" aria-labelledby="tab-ai-insights" tabindex="0">
                        <h3 class="results-heading"><i class="fas fa-microchip"></i> AI Financial Advisor - World's First AI-Powered Insights</h3>
                        <div class="insights-container" id="ai-insights-content" aria-live="polite">
                            <div class="insight-box">
                                <h4><i class="fas fa-robot"></i> AI Advisor</h4>
                                <p>Calculating personalized insights based on your retirement profile...</p>
                            </div>
                        </div>
                        <aside class="ad-slot bottom-ad-slot" role="complementary" aria-label="Sponsor Advertisement">
                            <p class="ad-label">SPONSORED ROLLOVERS</p>
                            <div class="ad-placeholder">üîÑ Changing jobs? Roll over your 401(k) with [Sponsor Service]</div>
                        </aside>
                    </div>

                    <!-- Tab 4: Schedule -->
                    <div id="schedule-detail" class="tab-content" role="tabpanel" aria-labelledby="tab-schedule-detail" tabindex="0">
                         <div class="amortization-controls">
                            <!-- JS will control this, but we use mortgage calc classes -->
                            <button type="button" id="amortToggle" class="btn-secondary">Show Yearly</button>
                            <button type="button" id="exportCsv" class="btn-secondary">Export as CSV</button>
                        </div>
                        <div class="table-scroll-wrapper">
                            <table class="amortization-table" id="projection-table" aria-label="Year-by-year retirement projection">
                                 <caption class="visually-hidden">Detailed 401k projection schedule showing salary, contributions, match, gains, and balance for each year.</caption>
                                <thead>
                                    <tr>
                                        <th>Age</th>
                                        <th>Salary</th>
                                        <th>Your Cont.</th>
                                        <th>Match</th>
                                        <th>Gains</th>
                                        <th>End Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </section>
        </div>
        
        <!-- PARTNER SECTION (from 401k footer) -->
        <section class="footer-sponsor" id="our-partners" aria-labelledby="partners-title">
            <div class="container">
                <h3 id="partners-title" style="text-align: center; margin-bottom: 24px; color: var(--primary); font-size: 24px; font-weight: 700;">Our Partners & Sponsors</h3>
                <div class="sponsor-grid">
                    <div class="sponsor-item">
                        <h4>üìà Low-Fee Robo-Advisors</h4>
                        <p>Start investing with a low-fee, automated portfolio. Perfect for hands-off retirement growth.</p>
                        <a href="#affiliate-link-1" onclick="app.showPartnerAlert('Robo-Advisor'); return false;" aria-label="Compare low-fee robo-advisors">Compare Advisors ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>ü§ù Financial Advisor Match</h4>
                        <p>Connect with a pre-vetted, fiduciary financial advisor in your state to build a custom retirement plan.</p>
                        <a href="#affiliate-link-2" onclick="app.showPartnerAlert('Financial Advisor Match'); return false;" aria-label="Get matched with a financial advisor">Get Matched ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üè¶ High-Yield Savings</h4>
                        <p>Grow your emergency fund faster. Compare top high-yield savings accounts from US banks.</p>
                        <a href="#affiliate-link-3" onclick="app.showPartnerAlert('High-Yield Savings'); return false;" aria-label="See rates for high-yield savings accounts">See Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üîÑ 401(k) Rollover Service</h4>
                        <p>Changing jobs? Don't leave your 401(k) behind. Easily roll it over into a new IRA penalty-free.</p>
                        <a href="#affiliate-link-4" onclick="app.showPartnerAlert('401k Rollover'); return false;" aria-label="Start your 401k rollover">Start Rollover ‚Üí</a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- FAQ Section (from Mortgage Calc, with 401k content) -->
        <section class="faq-section" aria-labelledby="faq-title">
            <h2 class="faq-title" id="faq-title">‚ùì 401(k) Frequently Asked Questions</h2>
            <div class="faq-container" id="faqContainer">
                <!-- FAQs will be dynamically inserted here by JS -->
            </div>
        </section>

        <!-- FOOTER (from 401k, styled like mortgage calc) -->
        <footer class="footer" role="contentinfo">
            <div class="container">
                <div class="footer-content">
                    <nav class="footer-section" role="navigation" aria-label="About FinGuid">
                        <h4>About FinGuid USA</h4>
                        <p>World's first AI-powered financial calculator platform. Free, unbiased, comprehensive tools for smart financial decisions by Americans for Americans.</p>
                        <p><strong>Email:</strong> support@finguid.com</p>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Financial Calculators">
                        <h4>Financial Calculators</h4>
                        <a href="/mortgage-calculator.html">üè† Mortgage Calculator</a>
                        <a href="/401k-calculator.html" aria-current="page">üìà 401(k) Calculator</a>
                        <a href="#">üöó Auto Loan Calculator</a>
                        <a href="#">üí∏ Tax Withholding</a>
                        <a href="#">üë¥ Retirement Calculator</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Resources">
                        <h4>Resources & Learning</h4>
                        <a href="#">üì∞ Financial Blog</a>
                        <a href="#">üìñ 401(k) Guide</a>
                        <a href="#">üìö Financial Glossary</a>
                        <a href="#">üéì Calculator Help</a>
                    </nav>
                     <nav class="footer-section" role="navigation" aria-label="Legal links">
                        <h4>Company & Legal</h4>
                        <a href="#">About Us</a>
                        <a href="#privacy">Privacy Policy</a>
                        <a href="#terms">Terms of Service</a>
                        <a href="#contact">Contact Us</a>
                        <a href="#disclaimer">Disclaimer</a>
                    </nav>
                </div>

                <div class="compliance-badges" role="list" aria-label="Compliance Badges">
                    <span class="badge" role="listitem">üîí SSL Secured</span>
                    <span class="badge" role="listitem">‚úÖ GDPR Compliant</span>
                    <span class="badge" role="listitem">‚úÖ CCPA Compliant</span>
                    <span class="badge" role="listitem">‚úÖ FTC Compliant</span>
                    <span class="badge" role="listitem">‚ôø WCAG 2.1 AA</span>
                </div>

                <section class="disclaimer" aria-label="Disclaimers and Disclosures">
                    <strong>Educational & Informational Only:</strong> This 401(k) calculator is for educational and informational purposes only. It is NOT financial, legal, or investment advice. Estimates are based on user inputs and assumptions about future performance, which are not guaranteed. Actual returns, tax rates, and employer policies may vary.
                    <br><br>
                    <strong>Affiliate Disclosure:</strong> FinGuid monetizes through advertising and affiliate partnerships. When you click on partner links (e.g., for robo-advisors or rollover services), we may receive compensation. This does not affect our calculations or AI insights.
                    <br><br>
                    <strong>Data Accuracy:</strong> Inflation data (CPIAUCSL) provided by the U.S. Bureau of Labor Statistics and delivered via FRED¬Æ API from the Federal Reserve Bank of St. Louis. We make no guarantees about data accuracy. Always consult a licensed financial advisor before making decisions.
                </section>

                <div class="footer-bottom">
                    ¬© 2025 FinGuid USA. All Rights Reserved. | AI-Powered Financial Calculators for Americans
                </div>
            </div>
        </footer>
    </main>

    <!-- GDPR/CCPA Cookie Consent Banner -->
    <div id="cookie-consent-banner" role="dialog" aria-modal="true" aria-labelledby="cookie-consent-title" aria-describedby="cookie-consent-desc">
        <div class="cookie-consent-text">
            <h4 id="cookie-consent-title" style="font-weight: 700; color: var(--text); margin-bottom: 8px;">Your Privacy</h4>
            <p id="cookie-consent-desc">
                We use cookies and data to enhance your experience and provide personalized AI insights. By clicking "Accept", you agree to our use of cookies.
                <a href="#privacy" aria-label="Read our Privacy Policy">Privacy Policy</a>.
            </p>
        </div>
        <button type="button" id="cookie-consent-btn">Accept</button>
    </div>

    <!-- WCAG Compliant Modal for Alerts -->
    <style>
        .alert-modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .alert-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10003;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            display: none;
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }
        .alert-modal.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-backdrop.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }
        .alert-modal-body {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .alert-modal-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .alert-modal-btn:hover { background: var(--primary-dark); }
        .alert-modal-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
    </style>
    <div class="alert-modal-backdrop" id="alert-modal-backdrop"></div>
    <div class="alert-modal" id="alert-modal" role="alertdialog" aria-modal="true" aria-labelledby="alert-modal-title" aria-describedby="alert-modal-body">
        <h4 class="alert-modal-title" id="alert-modal-title">Partner Information</h4>
        <p class="alert-modal-body" id="alert-modal-body">
            This is an affiliate link for [Partner].
        </p>
        <button type="button" class="alert-modal-btn" id="alert-modal-close">Close</button>
    </div>
    <!-- END: Modal for Alerts -->

    <!-- CDN Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- 
      START: Inlined JavaScript
      Contains all logic from 401k-calculator (1).js, fully integrated
      with the mortgage calculator's WCAG/PWA/UI framework.
    -->
    <script>
        /**
         * ========================================================================
         * AI 401(k) CALCULATOR - PRODUCTION JS
         * ========================================================================
         * Version: 5.0 - COMPLIANT MERGE
         * Built with: SOLID Principles, WCAG 2.1 AA, PWA Compatible, GDPR/CCPA
         *
         * This file merges the 401k.js logic with the mortgage-calc.js UI/Compliance framework.
         * ========================================================================
         */

        // ===== 401K CONFIG & CONSTANTS =====
        const CONFIG = {
            VERSION: '5.0',
            DEBUG: false,
            FRED_API_KEY: '9c6c421f077f2091e8bae4f143ada59a', // As requested
            FRED_BASE_URL: 'https://api.stlouisfed.org/fred/series/observations',
            FRED_SERIES_ID: 'CPIAUCSL', // Consumer Price Index (for inflation)
            IRS_LIMIT: 23000, // 2024 limit, can be updated
            CATCHUP_LIMIT: 7500, // 2024 limit
            TAX_BRACKETS: { // 2024 brackets
                'Single': [
                    { limit: 11600, rate: 0.10 },
                    { limit: 47150, rate: 0.12 },
                    { limit: 100525, rate: 0.22 },
                    { limit: 191950, rate: 0.24 },
                    { limit: 243725, rate: 0.32 },
                    { limit: 609350, rate: 0.35 },
                    { limit: Infinity, rate: 0.37 }
                ],
                'Married Filing Jointly': [
                    { limit: 23200, rate: 0.10 },
                    { limit: 94300, rate: 0.12 },
                    { limit: 201050, rate: 0.22 },
                    { limit: 383900, rate: 0.24 },
                    { limit: 487450, rate: 0.32 },
                    { limit: 731200, rate: 0.35 },
                    { limit: Infinity, rate: 0.37 }
                ],
                'Head of Household': [
                    { limit: 16550, rate: 0.10 },
                    { limit: 63100, rate: 0.12 },
                    { limit: 100500, rate: 0.22 },
                    { limit: 191950, rate: 0.24 },
                    { limit: 243700, rate: 0.32 },
                    { limit: 609350, rate: 0.35 },
                    { limit: Infinity, rate: 0.37 }
                ]
            },
            charts: { 
                projection: null 
            },
            calculation: {
                projectionSchedule: [],
                firstYear: {},
                totals: {},
                inputs: {}
            },
            liveInflationRate: 0.025 // Default fallback
        };

        // ===== 401K FAQs (for SEO) =====
        const FAQs = [
            {
                q: "What is a 401(k) calculator?",
                a: "A 401(k) calculator is a tool that helps you project the future value of your retirement savings. This AI-powered calculator estimates your 401(k) balance at retirement based on your current age, salary, contributions, employer match, and expected rate of return. It also shows your potential tax savings."
            },
            {
                q: "How does the 'employer match' work?",
                a: "An employer match is free money your employer contributes to your 401(k) on your behalf. A common example is '100% match up to 6%.' This means if you contribute 6% of your salary, your employer will contribute an *additional* 6%, effectively doubling your contribution. Our AI insights will warn you if you're not contributing enough to get the full match."
            },
            {
                q: "Why is getting the full employer match so important?",
                a: "Not contributing enough to get your full employer match is like turning down a 100% risk-free return on your money. It is the single most powerful tool for accelerating your retirement savings. This calculator's AI will highlight any missed match as a critical priority."
            },
            {
                q: "What are the 401(k) contribution limits for 2024/2025?",
                a: "For 2024, the 401(k) contribution limit is $23,000 for employees under age 50. If you are age 50 or over, you can make an additional 'catch-up' contribution of $7,500, for a total of $30,500. This calculator accounts for these limits and can automatically add catch-up contributions."
            },
            {
                q: "How does a 401(k) save me money on taxes?",
                a: "Contributions to a traditional 401(k) are 'pre-tax.' This means the money is taken out of your paycheck *before* federal and state income taxes are calculated. This lowers your taxable income for the year, resulting in a smaller tax bill. This calculator estimates your annual tax savings based on your income and filing status."
            },
            {
                q: "What is a good rate of return for a 401(k)?",
                a: "A common historical average for a diversified stock market portfolio (like an S&P 500 index fund) is around 7-10% per year *before* inflation. We use 7% as a default, but you can adjust this based on your risk tolerance and investments. The 'inflation-adjusted' option shows your 'real' return, or growth in purchasing power."
            },
            {
                q: "What does 'inflation-adjusted' mean?",
                a: "Inflation is the rate at which prices for goods and services rise, decreasing your purchasing power. An 'inflation-adjusted' or 'real' return shows your investment growth *after* accounting for inflation. For example, if your investments grow 7% but inflation is 3%, your real return is 4%. This calculator uses live FRED data to get the latest inflation figures."
            },
            {
                q: "How much should I contribute to my 401(k)?",
                a: "A common recommendation is to save 10-15% of your gross income for retirement. At a bare minimum, you should contribute enough to get your full employer match. After that, gradually increase your contribution each year (e.g., by 1% when you get a raise) until you reach your goal."
            },
            {
                q: "What's the difference between this 401(k) calculator and others?",
                a: "This is the World's First AI-Powered 401(k) Optimizer. It doesn't just show you a final number; it provides actionable, AI-driven insights. It warns you about missed employer matches, calculates your tax savings, and uses live FRED data for inflation-adjusted returns, all within a WCAG-compliant, mobile-friendly interface."
            },
            {
                q: "What are 'catch-up' contributions?",
                a: "The IRS allows individuals age 50 and over to contribute *extra* money to their retirement accounts. For a 401(k) in 2024, this is an additional $7,500 per year. You can check the 'Include Catch-Up' box to have our calculator automatically add this to your savings starting at age 50."
            },
            {
                q: "What is a 'Robo-Advisor'?",
                a: "A Robo-Advisor is an automated, low-cost investment management service. They use algorithms to build and manage a diversified portfolio for you based on your goals and risk tolerance. They are a popular option for 401(k) rollovers or for managing an IRA."
            },
            {
                q: "What is a 401(k) rollover?",
                a: "When you leave a job, you usually have the option to 'roll over' your 401(k) into a new account, such as an IRA (Individual Retirement Account) or your new employer's 401(k) plan. An IRA rollover often gives you more investment choices and potentially lower fees. Our partners offer services to help with this."
            },
            {
                q: "How is my salary increase factored in?",
                a: "The calculator assumes your salary increases by the percentage you enter each year. Your contributions (which are a percentage of your salary) will therefore also increase, as will your employer's match (if it's based on a percentage of your salary). This helps create a more realistic long-term projection."
            },
            {
                q: "What is a 'fiduciary' financial advisor?",
                a: "A fiduciary is a financial advisor who is legally and ethically required to act in your best interest. This is the highest standard of care. When seeking professional advice, it's highly recommended to work with a fiduciary. Our partner-matching service connects you with vetted fiduciary advisors."
            },
            {
                q: "Does this calculator account for state taxes?",
                a: "This calculator estimates your *federal* income tax savings. State income tax rules for 401(k) contributions vary. Some states do not have an income tax, while others have different deduction rules. The federal savings are the most significant and universally applicable."
            }
        ];


        // ===== UTILITY & API CLASSES (Merged) =====
        
        /**
         * FRED API Manager for fetching live inflation data
         */
        const FRED = {
            async fetchInflation() {
                if (CONFIG.DEBUG) return 0.025;
                try {
                    const url = new URL(CONFIG.FRED_BASE_URL);
                    url.searchParams.append('series_id', CONFIG.FRED_SERIES_ID);
                    url.searchParams.append('api_key', CONFIG.FRED_API_KEY);
                    url.searchParams.append('file_type', 'json');
                    url.searchParams.append('sort_order', 'desc');
                    url.searchParams.append('limit', '13'); // Get 13 months for year-over-year
                    
                    // [GEMINI] Using a different CORS proxy (allorigins) to prevent fetch errors.
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const finalUrl = proxyUrl + encodeURIComponent(url.toString());
                    
                    const response = await fetch(finalUrl);
                    if (!response.ok) {
                        // [GEMINI] Add more detail to the error
                        throw new Error(`FRED API proxy error: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    const observations = data.observations.filter(o => o.value && o.value !== '.');
                    
                    if (observations.length >= 13) {
                        const latest = parseFloat(observations[0].value);
                        const prior = parseFloat(observations[12].value);
                        const rate = (latest - prior) / prior;
                        CONFIG.liveInflationRate = rate;
                        console.log(`Live inflation rate updated: ${(rate * 100).toFixed(2)}%`);
                        return rate;
                    }
                } catch (error) {
                    console.error('FRED API error:', error);
                }
                // Fallback on error
                CONFIG.liveInflationRate = 0.025;
                return 0.025;
            },

            startAutoUpdate() {
                // Fetch immediately on load, then calculate
                this.fetchInflation().then(() => app.calculate());
                // Then update every 6 hours
                setInterval(() => this.fetchInflation(), 6 * 60 * 60 * 1000); 
            }
        };

        /**
         * Speech Recognition & Synthesis (from 401k.js)
         */
        const SPEECH = {
            recognition: null,
            synthesizer: null,
            active: false,
            ttsActive: false,
            recognitionActive: false,

            init() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';

                    this.recognition.onstart = () => {
                        this.recognitionActive = true;
                        document.getElementById('voiceToggle').classList.add('voice-active');
                        document.getElementById('voiceToggle').setAttribute('aria-label', 'Voice control listening...');
                    };

                    this.recognition.onend = () => {
                        this.recognitionActive = false;
                        document.getElementById('voiceToggle').classList.remove('voice-active');
                        document.getElementById('voiceToggle').setAttribute('aria-label', 'Voice control');
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Voice recognition error', event.error);
                        this.recognitionActive = false;
                        document.getElementById('voiceToggle').classList.remove('voice-active');
                        document.getElementById('voiceToggle').setAttribute('aria-label', 'Voice control');
                        if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                            app.showAlert('Voice Not Allowed', 'Voice recognition is blocked. Please allow microphone access in your browser settings.');
                        }
                    };

                    this.recognition.onresult = (event) => {
                        const command = event.results[0][0].transcript.toLowerCase();
                        console.log('Voice command:', command);
                        if (command.includes('calculate') || command.includes('run') || command.includes('submit')) {
                            app.calculate();
                            this.speak("Calculating your projection.");
                        } else if (command.includes('read results') || command.includes('read summary')) {
                            this.speak(app.getSummaryText());
                        } else if (command.includes('read insights') || command.includes('read advice')) {
                            this.speak(app.getInsightsText());
                        } else if (command.includes('dark mode')) {
                            app.setDarkMode(true);
                        } else if (command.includes('light mode')) {
                            app.setDarkMode(false);
                        } else if (command.includes('help')) {
                             this.speak("You can say 'calculate', 'read results', 'read insights', 'dark mode', or 'light mode'.");
                        }
                    };
                }
                this.synthesizer = window.speechSynthesis;
            },

            toggleVoice() {
                if (!this.recognition) {
                    app.showAlert('Not Supported', 'Voice recognition is not supported in this browser.');
                    return;
                }
                if (this.recognitionActive) {
                    this.recognition.stop();
                } else {
                    try {
                        this.recognition.start();
                    } catch (e) {
                         console.error("Voice recognition start error", e);
                         app.showAlert('Voice Error', 'Could not start voice recognition. Please check microphone permissions.');
                    }
                }
                app.trackEvent('voice_toggle', { active: !this.recognitionActive });
            },

            toggleTTS() {
                const btn = document.getElementById('ttsToggle');
                if (this.ttsActive) {
                    this.ttsActive = false;
                    btn.classList.remove('tts-active');
                    btn.setAttribute('aria-label', 'Text to speech');
                    if (this.synthesizer) this.synthesizer.cancel();
                } else {
                    this.ttsActive = true;
                    btn.classList.add('tts-active');
                    btn.setAttribute('aria-label', 'Stop text to speech');
                    this.speak('Text-to-speech enabled');
                }
                app.trackEvent('tts_toggle', { active: this.ttsActive });
            },

            speak(text) {
                if (!this.ttsActive || !this.synthesizer || !text) return;
                this.synthesizer.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                this.synthesizer.speak(utterance);
            }
        };
        
        /**
         * ChartManager (from 401k, adapted)
         */
        class ChartManager {
            static registerPlugins() {
                if (Chart.registerables) { 
                    if (typeof ChartDataLabels !== 'undefined') {
                        Chart.register(ChartDataLabels);
                    }
                }
            }

            static renderProjectionChart(schedule) {
                const ctx = document.getElementById('401k-projection-chart')?.getContext('2d');
                if (!ctx) return;

                if (CONFIG.charts.projection) {
                    CONFIG.charts.projection.destroy();
                }

                if (!schedule || schedule.length === 0) return;

                const labels = schedule.map(d => d.age);
                const totalBalance = schedule.map(d => d.endBalance);
                const totalContributions = schedule.map(d => d.cumulativeContrib);
                const totalMatch = schedule.map(d => d.cumulativeMatch);
                
                const isDark = document.documentElement.getAttribute('data-color-scheme') === 'dark';
                const textColor = isDark ? 'var(--text)' : 'var(--text-light)';
                const gridColor = isDark ? 'var(--border)' : 'var(--border)';

                CONFIG.charts.projection = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Total Balance',
                                data: totalBalance,
                                borderColor: 'var(--primary)',
                                backgroundColor: 'rgba(36, 172, 185, 0.15)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 3
                            },
                            {
                                label: 'Your Contributions',
                                data: totalContributions,
                                borderColor: 'var(--accent)',
                                backgroundColor: 'transparent',
                                tension: 0.3,
                                fill: false,
                                borderWidth: 2,
                                borderDash: [5, 5]
                            },
                            {
                                label: 'Employer Match',
                                data: totalMatch,
                                borderColor: 'var(--success)',
                                backgroundColor: 'transparent',
                                tension: 0.3,
                                fill: false,
                                borderWidth: 2,
                                borderDash: [2, 2]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: textColor, font: { size: 13 }, padding: 15 },
                                position: 'bottom'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label}: ${app.formatCurrency(ctx.parsed.y, 0)}`,
                                },
                                backgroundColor: '#1a1a1a',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                padding: 12,
                                cornerRadius: 6
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor, maxRotation: 45, minRotation: 0 },
                                title: { display: true, text: 'Age', color: textColor, font: { size: 14, weight: '600' } },
                                grid: { display: false }
                            },
                            y: {
                                ticks: {
                                    color: textColor,
                                    callback: (v) => app.formatCurrency(v, 0).replace('.00', '')
                                },
                                title: { display: true, text: 'Balance ($)', color: textColor, font: { size: 14, weight: '600' } },
                                grid: { color: gridColor }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            }
        }
        

        // ===== MAIN APP (Controller) =====
        const app = {
            calculateDebounce: null,
            
            async init() {
                console.log('üá∫üá∏ FinGuid 401(k) Calculator v5.0 - World\'s First AI-Powered Optimizer');
                this.setupEventListeners();
                this.setupDarkMode();
                this.setupPWA();
                SPEECH.init();
                this.setupFAQ();
                this.initTooltips(); 
                this.setupTabs();
                this.setupAlertModal();
                this.setupCookieConsent();
                ChartManager.registerPlugins(); 
                FRED.startAutoUpdate(); // This will fetch data and then run the first calculation
            },

            setupEventListeners() {
                const form = document.getElementById('401k-form');
                if (!form) return;

                // Form submission
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.calculate();
                    SPEECH.speak('Calculation complete');
                });

                // Debounced calculation on input change
                const debouncedCalc = this.debounce(() => this.calculate(), 400);
                form.querySelectorAll('input, select').forEach(el => {
                    el.addEventListener('input', debouncedCalc);
                    el.addEventListener('change', debouncedCalc);
                });

                // Header controls
                document.getElementById('darkModeToggle').addEventListener('click', () => this.toggleDarkMode());
                document.getElementById('voiceToggle').addEventListener('click', () => SPEECH.toggleVoice());
                document.getElementById('ttsToggle').addEventListener('click', () => SPEECH.toggleTTS());

                // Amortization Controls
                document.getElementById('amortToggle').addEventListener('click', () => this.toggleAmortizationView());
                document.getElementById('exportCsv').addEventListener('click', () => this.exportAmortizationToCsv());
            },

            // ===== 401(k) CORE LOGIC =====
            
            getTaxRate(income, filingStatus) {
                const brackets = CONFIG.TAX_BRACKETS[filingStatus] || CONFIG.TAX_BRACKETS['Single'];
                for (const bracket of brackets) {
                    if (income <= bracket.limit) {
                        return bracket.rate;
                    }
                }
                return 0.37; // Default to max bracket
            },

            calculate() {
                try {
                    const inputs = {
                        currentAge: parseInt(document.getElementById('current-age').value) || 30,
                        retirementAge: parseInt(document.getElementById('retirement-age').value) || 65,
                        annualSalary: parseFloat(document.getElementById('annual-salary').value.replace(/[$,]/g, '')) || 0,
                        filingStatus: document.getElementById('filing-status').value,
                        currentBalance: parseFloat(document.getElementById('current-balance').value.replace(/[$,]/g, '')) || 0,
                        contributionPercent: (parseFloat(document.getElementById('contribution-percent').value) || 0) / 100,
                        employerMatchPercent: (parseFloat(document.getElementById('employer-match-percent').value) || 0) / 100,
                        matchUpToPercent: (parseFloat(document.getElementById('match-up-to-percent').value) || 0) / 100,
                        salaryIncrease: (parseFloat(document.getElementById('salary-increase').value) || 0) / 100,
                        rateOfReturn: (parseFloat(document.getElementById('rate-of-return').value) || 0) / 100,
                        includeCatchUp: document.getElementById('include-catch-up').checked,
                        includeInflation: document.getElementById('include-inflation').checked
                    };

                    if (inputs.currentAge >= inputs.retirementAge || inputs.annualSalary <= 0) {
                        if (inputs.annualSalary <= 0) {
                            app.showAlert('Input Error', 'Please enter a valid Annual Salary to run the calculation.');
                        }
                        return;
                    }

                    let balance = inputs.currentBalance;
                    let salary = inputs.annualSalary;
                    const projection = [];
                    let totalContrib = 0;
                    let totalMatch = 0;
                    let totalGains = 0;

                    const returnRate = inputs.includeInflation
                        ? ((1 + inputs.rateOfReturn) / (1 + CONFIG.liveInflationRate)) - 1
                        : inputs.rateOfReturn;

                    for (let age = inputs.currentAge; age < inputs.retirementAge; age++) {
                        let contrib = salary * inputs.contributionPercent;
                        let catchUp = 0;
                        if (age >= 50 && inputs.includeCatchUp) {
                            catchUp = CONFIG.CATCHUP_LIMIT;
                        }
                        // Apply IRS limit + catch-up
                        contrib = Math.min(contrib, CONFIG.IRS_LIMIT + catchUp);
                        
                        // Calculate match based on contribution
                        const matchableContribution = salary * inputs.matchUpToPercent;
                        const employerContribution = Math.min(contrib, matchableContribution) * inputs.employerMatchPercent;
                        
                        const totalAnnual = contrib + employerContribution;
                        const gains = (balance + totalAnnual / 2) * returnRate; // Average balance growth
                        const endBalance = balance + totalAnnual + gains;

                        projection.push({
                            age, 
                            salary, 
                            contrib, 
                            match: employerContribution, 
                            gains, 
                            endBalance,
                            cumulativeContrib: totalContrib + contrib,
                            cumulativeMatch: totalMatch + employerContribution,
                            cumulativeGains: totalGains + gains
                        });

                        balance = endBalance;
                        salary *= (1 + inputs.salaryIncrease);
                        totalContrib += contrib;
                        totalMatch += employerContribution;
                        totalGains += gains;
                    }

                    CONFIG.calculation = {
                        projectionSchedule: projection,
                        firstYear: projection[0] || {},
                        totals: { finalBalance: balance, totalContrib, totalMatch, totalGains },
                        inputs
                    };
                    
                    this.updateUI();
                    
                    this.trackEvent('calculation_complete', {
                        age: CONFIG.calculation.inputs.currentAge,
                        projected_total: CONFIG.calculation.totals.finalBalance
                    });

                } catch (error) {
                    console.error('Calculation error:', error);
                    app.showAlert('Calculation Error', 'An error occurred. Please check your inputs and try again.');
                }
            },
            
            // ===== UI UPDATE LOGIC =====

            updateUI() {
                this.updateSummary();
                this.updateDetailsTab();
                this.updateTable();
                this.generateAIInsights();
                
                // Update chart
                const activeTabId = document.querySelector('[role="tab"][aria-selected="true"]').getAttribute('aria-controls');
                if (activeTabId === 'projection-chart') {
                    ChartManager.renderProjectionChart(CONFIG.calculation.projectionSchedule);
                }
            },

            updateSummary() {
                const { totals } = CONFIG.calculation;
                document.getElementById('projected-total').textContent = this.formatCurrency(totals.finalBalance, 0);
                document.getElementById('projection-summary-details').innerHTML = `
                    Your Cont: ${this.formatCurrency(totals.totalContrib, 0)} | 
                    Employer Match: ${this.formatCurrency(totals.totalMatch, 0)} | 
                    Total Growth: ${this.formatCurrency(totals.totalGains, 0)}
                `;
            },

            updateDetailsTab() {
                const { firstYear, inputs } = CONFIG.calculation;
                if (!firstYear || Object.keys(firstYear).length === 0) return;
                
                document.getElementById('your-annual-contribution').textContent = this.formatCurrency(firstYear.contrib || 0);
                document.getElementById('employer-annual-match').textContent = this.formatCurrency(firstYear.match || 0);
                document.getElementById('total-annual-contribution').textContent = this.formatCurrency((firstYear.contrib || 0) + (firstYear.match || 0));

                const rate = this.getTaxRate(inputs.annualSalary, inputs.filingStatus);
                const savings = (firstYear.contrib || 0) * rate;

                document.getElementById('marginal-tax-rate').textContent = `${(rate * 100).toFixed(1)}%`;
                document.getElementById('annual-tax-savings').textContent = this.formatCurrency(savings);
            },
            
            updateTable() {
                const tbody = document.querySelector('#projection-table tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                const view = document.getElementById('amortToggle').textContent === 'Show Yearly' ? 'monthly' : 'yearly';
                const schedule = CONFIG.calculation.projectionSchedule;
                if (!schedule || schedule.length === 0) return;

                if (view === 'yearly') {
                    schedule.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.age}</td>
                            <td>${this.formatCurrency(item.salary, 0)}</td>
                            <td>${this.formatCurrency(item.contrib, 0)}</td>
                            <td>${this.formatCurrency(item.match, 0)}</td>
                            <td>${this.formatCurrency(item.gains, 0)}</td>
                            <td>${this.formatCurrency(item.endBalance, 0)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else { // 'monthly' in this context means first year
                     const firstYear = schedule[0] || {};
                     const row = document.createElement('tr');
                     row.innerHTML = `
                        <td>${firstYear.age || 'N/A'}</td>
                        <td>${this.formatCurrency(firstYear.salary, 0) || 'N/A'}</td>
                        <td>${this.formatCurrency(firstYear.contrib, 0) || 'N/A'}</td>
                        <td>${this.formatCurrency(firstYear.match, 0) || 'N/A'}</td>
                        <td>${this.formatCurrency(firstYear.gains, 0) || 'N/A'}</td>
                        <td>${this.formatCurrency(firstYear.endBalance, 0) || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                    tbody.innerHTML += `<tr><td colspan="6" style="text-align: center; padding: 10px; background: var(--bg-secondary); font-weight: bold;">Select 'Show Yearly' for full schedule</td></tr>`;
                }
            },
            
            toggleAmortizationView() {
                const btn = document.getElementById('amortToggle');
                const thead = document.querySelector('#projection-table thead tr');
                
                if (btn.textContent === 'Show Yearly') {
                    btn.textContent = 'Show First Year';
                    thead.innerHTML = `
                        <th>Age</th>
                        <th>Salary</th>
                        <th>Your Cont.</th>
                        <th>Match</th>
                        <th>Gains</th>
                        <th>End Balance</th>
                    `;
                } else {
                    btn.textContent = 'Show Yearly';
                    thead.innerHTML = `
                        <th>Age (First Year)</th>
                        <th>Salary</th>
                        <th>Your Cont.</th>
                        <th>Match</th>
                        <th>Gains</th>
                        <th>End Balance</th>
                    `;
                }
                this.updateTable();
            },
            
            exportAmortizationToCsv() {
                const schedule = CONFIG.calculation.projectionSchedule;
                if (!schedule || schedule.length === 0) {
                    app.showAlert('No Data', 'Please run a calculation to export data.');
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                let rows = [["Age", "Salary", "Your Contribution", "Employer Match", "Investment Gains", "Ending Balance"]];

                schedule.forEach(item => {
                    rows.push([
                        item.age,
                        item.salary.toFixed(2),
                        item.contrib.toFixed(2),
                        item.match.toFixed(2),
                        item.gains.toFixed(2),
                        item.endBalance.toFixed(2)
                    ]);
                });
                
                rows.forEach(rowArray => {
                    let row = rowArray.join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "401k_projection_schedule.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            
            generateAIInsights() {
                const { inputs, firstYear, totals, projectionSchedule } = CONFIG.calculation;
                const contentBox = document.getElementById('ai-insights-content');
                if (!contentBox || !firstYear || Object.keys(firstYear).length === 0) {
                     contentBox.innerHTML = `<div class="insight-box"><h4><i class="fas fa-robot"></i> AI Advisor</h4><p>Enter your details to generate personalized AI-powered insights...</p></div>`;
                    return;
                }

                let html = '';

                // 1. MISSING MATCH DETECTION (CRITICAL)
                const potentialMatchableSalary = inputs.annualSalary * inputs.matchUpToPercent;
                const potentialContribution = inputs.annualSalary * inputs.contributionPercent;
                const actualMatch = firstYear.match || 0;
                
                // Max possible match
                const maxPossibleMatch = potentialMatchableSalary * inputs.employerMatchPercent;
                
                const missedMatch = maxPossibleMatch - actualMatch;

                if (missedMatch > 1) {
                    const neededContributionPercent = inputs.matchUpToPercent;
                    html += `
                        <div class="recommendation-alert high-priority">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>CRITICAL: You are missing ${this.formatCurrency(missedMatch, 0)}/year in free money!</strong>
                                <p style="font-size: 13px; opacity: 0.9; font-weight: 500; margin-top: 4px;">Your employer matches up to ${inputs.matchUpToPercent * 100}%, but you're only contributing ${inputs.contributionPercent * 100}%. 
                                <strong>Action:</strong> Increase your contribution to at least ${neededContributionPercent * 100}% to capture your full employer match.</p>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="recommendation-alert low-priority">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <strong>Excellent! You are capturing your full employer match.</strong>
                                <p style="font-size: 13px; opacity: 0.9; font-weight: 500; margin-top: 4px;">You're receiving ${this.formatCurrency(actualMatch, 0)}/year in free money from your employer. This is the #1 way to accelerate your savings.</p>
                            </div>
                        </div>
                    `;
                }

                // 2. TAX SAVINGS ANALYSIS
                const taxRate = this.getTaxRate(inputs.annualSalary, inputs.filingStatus);
                const annualTaxSavings = (firstYear.contrib || 0) * taxRate;
                html += `
                    <div class="insight-box">
                        <h4><i class="fas fa-file-invoice-dollar"></i> Annual Tax Savings</h4>
                        <p>By contributing ${this.formatCurrency(firstYear.contrib, 0)} to your 401(k), you are lowering your taxable income. At an estimated ${ (taxRate * 100).toFixed(0) }% marginal tax rate, you are saving approximately <strong>${this.formatCurrency(annualTaxSavings, 0)} on this year's federal taxes</strong>.</p>
                    </div>
                `;

                // 3. RETIREMENT READINESS
                const yearsToRetire = inputs.retirementAge - inputs.currentAge;
                const lastSalary = (projectionSchedule[projectionSchedule.length - 1] || firstYear).salary;
                // 4% rule: annual withdrawal = 4% of total balance
                const annualRetirementIncome = totals.finalBalance * 0.04;
                const incomeReplacementRatio = (annualRetirementIncome / lastSalary) * 100;
                
                let readinessType = 'success';
                let readinessMsg = `Your 401(k) alone could provide ${this.formatCurrency(annualRetirementIncome, 0)}/year (before taxes) in retirement. This replaces <strong>${incomeReplacementRatio.toFixed(0)}%</strong> of your projected final salary. Combined with Social Security, you are on a strong path.`;
                if (incomeReplacementRatio < 40) {
                     readinessMsg = `Your 401(k) is projected to replace <strong>${incomeReplacementRatio.toFixed(0)}%</strong> of your final salary. This is a good start, but AI recommends increasing your contribution to aim for a 70-80% replacement goal (including Social Security).`;
                     readinessType = 'warning';
                }
                html += `
                    <div class="insight-box ${readinessType}">
                        <h4><i class="fas fa-bullseye"></i> Retirement Income Projection</h4>
                        <p>${readinessMsg}</p>
                    </div>
                `;
                
                // 4. POWER OF COMPOUNDING
                const percentFromGrowth = (totals.totalGains / totals.finalBalance) * 100;
                 html += `
                    <div class="insight-box">
                        <h4><i class="fas fa-magic"></i> The Power of Compounding</h4>
                        <p>Of your final balance of ${this.formatCurrency(totals.finalBalance, 0)}, a massive <strong>${percentFromGrowth.toFixed(0)}%</strong> (or ${this.formatCurrency(totals.totalGains, 0)}) is projected to come from investment growth alone. Your contributions of ${this.formatCurrency(totals.totalContrib + totals.totalMatch, 0)} are the seeds for this growth.</p>
                    </div>
                `;
                
                // 5. CATCH-UP CONTRIBUTION
                if (inputs.currentAge < 50 && !inputs.includeCatchUp) {
                    html += `
                        <div class="insight-box">
                            <h4><i class="fas fa-running"></i> Future-Proof: Catch-Up</h4>
                            <p>You're not 50 yet, but don't forget! The IRS allows "catch-up" contributions (currently ${this.formatCurrency(CONFIG.CATCHUP_LIMIT, 0)}/year) starting at age 50. Check the "Include Catch-Up" box to see how much this can supercharge your savings.</p>
                        </div>
                    `;
                }

                contentBox.innerHTML = html;
            },
            
            // ===== UTILITY FUNCTIONS (from mortgage-calc) =====
            
            debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            },

            formatCurrency(value, decimals = 0) {
                if (typeof value !== 'number' || isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(value);
            },
            
            trackEvent(eventName, eventData = {}) {
                if (typeof gtag === 'function') {
                    gtag('event', eventName, eventData);
                }
                if (CONFIG.DEBUG) {
                    console.log('Event Tracked:', eventName, eventData);
                }
            },
            
            // ===== UI FRAMEWORK FUNCTIONS (from mortgage-calc) =====
            
            setupTabs() {
                const tablist = document.querySelector('[role="tablist"]');
                const tabs = tablist.querySelectorAll('[role="tab"]');
                
                tablist.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('[role="tab"]');
                    if (!clickedTab) return;
                    this.activateTab(clickedTab);
                });

                tablist.addEventListener('keydown', (e) => {
                    let index = Array.from(tabs).indexOf(document.activeElement);
                    if (index === -1) return;

                    let direction = 0;
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        direction = 1;
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        direction = -1;
                    } else if (e.key === 'Home') {
                        e.preventDefault();
                        tabs[0].focus();
                    } else if (e.key === 'End') {
                        e.preventDefault();
                        tabs[tabs.length - 1].focus();
                    }

                    if (direction !== 0) {
                        e.preventDefault();
                        index = (index + direction + tabs.length) % tabs.length;
                        tabs[index].focus();
                    }
                });
            },

            activateTab(tab) {
                const tabId = tab.getAttribute('aria-controls');
                
                document.querySelectorAll('[role="tab"]').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                    t.setAttribute('tabindex', '-1');
                });
                
                document.querySelectorAll('[role="tabpanel"]').forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                tab.setAttribute('tabindex', '0');

                const panel = document.getElementById(tabId);
                panel.classList.add('active');
                panel.style.display = 'block';

                // Render chart if switching to its tab
                if (tabId === 'projection-chart' && CONFIG.calculation.projectionSchedule.length > 0) {
                    setTimeout(() => ChartManager.renderProjectionChart(CONFIG.calculation.projectionSchedule), 50);
                }
                
                this.trackEvent('tab_view', { tab: tabId });
            },
            
            initTooltips() {
                let tooltipBox = null;
                document.querySelectorAll('.tooltip').forEach(el => {
                    const showTooltip = (e) => {
                        const text = e.currentTarget.getAttribute('data-tooltip');
                        if (!text) return;
                        if (tooltipBox) tooltipBox.remove();
                        
                        tooltipBox = document.createElement('div');
                        tooltipBox.className = 'tooltip-box';
                        tooltipBox.textContent = text;
                        tooltipBox.setAttribute('role', 'tooltip');
                        document.body.appendChild(tooltipBox);

                        const rect = e.currentTarget.getBoundingClientRect();
                        let top = rect.top - tooltipBox.offsetHeight - 5;
                        let left = rect.left + rect.width / 2 - tooltipBox.offsetWidth / 2;

                        if (top < 0) { top = rect.bottom + 5; }
                        if (left < 0) { left = 5; }
                        if (left + tooltipBox.offsetWidth > window.innerWidth) {
                            left = window.innerWidth - tooltipBox.offsetWidth - 5;
                        }

                        tooltipBox.style.left = `${left}px`;
                        tooltipBox.style.top = `${top}px`;
                        tooltipBox.style.display = 'block';
                        setTimeout(() => { if (tooltipBox) tooltipBox.style.opacity = '1'; }, 10);
                    };

                    const hideTooltip = () => {
                        if (tooltipBox) {
                            tooltipBox.style.opacity = '0';
                            setTimeout(() => {
                                if (tooltipBox) {
                                    tooltipBox.remove();
                                    tooltipBox = null;
                                }
                            }, 200);
                        }
                    };

                    el.addEventListener('mouseenter', showTooltip);
                    el.addEventListener('focus', showTooltip);
                    el.addEventListener('mouseleave', hideTooltip);
                    el.addEventListener('blur', hideTooltip);
                });
            },

            setupDarkMode() {
                const toggle = document.getElementById('darkModeToggle');
                const scheme = localStorage.getItem('colorScheme') || 
                               (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                this.setDarkMode(scheme === 'dark', true);
                
                toggle.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-color-scheme');
                    this.setDarkMode(current !== 'dark');
                });
            },
            
            toggleDarkMode() {
                 const current = document.documentElement.getAttribute('data-color-scheme');
                 this.setDarkMode(current !== 'dark');
            },
            
            setDarkMode(isDark, isInitialLoad = false) {
                 const scheme = isDark ? 'dark' : 'light';
                 document.documentElement.setAttribute('data-color-scheme', scheme);
                 localStorage.setItem('colorScheme', scheme);
                 
                 const icon = document.querySelector('#darkModeToggle');
                 icon.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                 icon.setAttribute('aria-label', isDark ? 'Activate light mode' : 'Activate dark mode');
                 
                 if (!isInitialLoad) {
                    this.trackEvent('theme_toggle', { theme: scheme });
                    // Force chart redraw on theme change
                    if (CONFIG.calculation.projectionSchedule.length > 0) {
                         ChartManager.renderProjectionChart(CONFIG.calculation.projectionSchedule);
                    }
                 }
            },

            setupPWA() {
                const pwaBtn = document.getElementById('pwa-install-btn');
                if (pwaBtn) {
                    pwaBtn.addEventListener('click', async () => {
                        if (window.deferredPrompt) {
                            window.deferredPrompt.prompt();
                            const { outcome } = await window.deferredPrompt.userChoice;
                            if (outcome === 'accepted') {
                                this.trackEvent('pwa_installed');
                            }
                            window.deferredPrompt = null;
                        }
                    });
                }
            },

            setupFAQ() {
                const container = document.getElementById('faqContainer');
                if(!container) return;

                FAQs.forEach((faq, index) => {
                    const qId = `faq-q-${index}`;
                    const aId = `faq-a-${index}`;
                    
                    const item = document.createElement('div');
                    item.className = 'faq-item';
                    item.innerHTML = `
                        <div class="faq-question" role="button" tabindex="0" aria-expanded="false" aria-controls="${aId}" id="${qId}">
                            <span>${faq.q}</span>
                            <span class="faq-icon" aria-hidden="true">‚ñº</span>
                        </div>
                        <div class="faq-answer" role="region" aria-labelledby="${qId}" id="${aId}">${faq.a}</div>
                    `;
                    container.appendChild(item);
                });
                
                container.addEventListener('click', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question) this.toggleFAQ(question);
                });
                
                container.addEventListener('keydown', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question && (e.key === 'Enter' || e.key === ' ')) {
                        e.preventDefault();
                        this.toggleFAQ(question);
                    }
                });
            },
            
            toggleFAQ(question) {
                const answer = document.getElementById(question.getAttribute('aria-controls'));
                const isActive = question.getAttribute('aria-expanded') === 'true';

                // Deactivate all others
                document.querySelectorAll('.faq-question[aria-expanded="true"]').forEach(q => {
                    if (q !== question) {
                        q.setAttribute('aria-expanded', 'false');
                        q.classList.remove('active');
                        document.getElementById(q.getAttribute('aria-controls')).style.display = 'none';
                        q.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                    }
                });

                if (!isActive) {
                    question.setAttribute('aria-expanded', 'true');
                    question.classList.add('active');
                    answer.style.display = 'block';
                    answer.style.animation = 'slideDown 0.3s ease';
                    question.querySelector('.faq-icon').style.transform = 'rotate(180deg)';
                } else {
                    question.setAttribute('aria-expanded', 'false');
                    question.classList.remove('active');
                    answer.style.display = 'none';
                    question.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                }
            },

            setupCookieConsent() {
                const banner = document.getElementById('cookie-consent-banner');
                const btn = document.getElementById('cookie-consent-btn');
                
                if (localStorage.getItem('cookieConsent') === 'true') {
                    banner.style.display = 'none';
                } else {
                    banner.style.display = 'flex';
                }
                
                btn.addEventListener('click', () => {
                    localStorage.setItem('cookieConsent', 'true');
                    banner.style.display = 'none';
                    this.trackEvent('cookie_consent_accepted');
                });
            },
            
            setupAlertModal() {
                const modal = document.getElementById('alert-modal');
                const backdrop = document.getElementById('alert-modal-backdrop');
                const closeBtn = document.getElementById('alert-modal-close');
                
                const closeModal = () => {
                    modal.classList.remove('visible');
                    backdrop.classList.remove('visible');
                };

                closeBtn.addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            },
            
            showAlert(title, message) {
                document.getElementById('alert-modal-title').textContent = title;
                document.getElementById('alert-modal-body').textContent = message;
                document.getElementById('alert-modal').classList.add('visible');
                document.getElementById('alert-modal-backdrop').classList.add('visible');
                document.getElementById('alert-modal-close').focus();
            },
            
            showPartnerAlert(partnerName) {
                this.showAlert(
                    'Affiliate Partner Link',
                    `This is an affiliate link. If you click this link and apply for a product, we may receive a commission. This partner is: ${partnerName}.`
                );
                this.trackEvent('affiliate_click', { partner: partnerName });
            },

            // ===== Text Getters for TTS =====
            
            getSummaryText() {
                try {
                    const { totals } = CONFIG.calculation;
                    if (totals.finalBalance <= 0) return "Please run a calculation first.";
                    return `Your projected total at retirement is ${this.formatCurrency(totals.finalBalance, 0)}. This includes ${this.formatCurrency(totals.totalContrib, 0)} from you, ${this.formatCurrency(totals.totalMatch, 0)} from your employer, and ${this.formatCurrency(totals.totalGains, 0)} in growth.`;
                } catch (e) {
                    return "Error reading summary.";
                }
            },
            
            getInsightsText() {
                 try {
                    const insightsContainer = document.getElementById('ai-insights-content');
                    if (insightsContainer) {
                        // Read all insight text, skipping titles
                        let text = "Here are your AI insights: ";
                        insightsContainer.querySelectorAll('.recommendation-alert, .insight-box').forEach(el => {
                            text += el.textContent.replace(/CRITICAL:|Excellent!:|Action:|Annual Tax Savings|Retirement Income Projection|The Power of Compounding|Future-Proof: Catch-Up/g, '.') + " . ";
                        });
                        return text;
                    }
                    return "No insights available. Please run a calculation.";
                } catch (e) {
                    return "Error reading insights.";
                }
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => app.init());

        // ===== ERROR HANDLING =====
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.message, event.filename, event.lineno);
        });
        window.addEventListener('unhandledrejection', (event) => {
             console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <!-- END: Inlined JavaScript -->

    <!-- 
      PWA Service Worker for Offline Use (from mortgage-calc)
      This robust worker caches the app shell and provides a full offline fallback.
    -->
    <script>
        if ('serviceWorker' in navigator) {
            
            /*
            // [GEMINI] Disabling Blob-based Service Worker registration due to protocol support errors.
            // This environment does not support registering SW from a 'blob:' URL.

            const OFFLINE_HTML = `
                <!DOCTYPE html>
                <html lang="en" style="font-family: Arial, sans-serif; background: #F5F7FA; color: #1F2121; padding: 20px;">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Offline | FinGuid 401(k) Calculator</title>
                    <style>
                        body { text-align: center; padding-top: 50px; }
                        h1 { color: #24ACB9; }
                        p { font-size: 1.1rem; line-height: 1.6; }
                        .icon { font-size: 4rem; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="icon">ü§ñ</div>
                    <h1>You are Offline</h1>
                    <p>This AI 401(k) Calculator needs an internet connection to function and fetch live data.</p>
                    <p>Please check your connection and try again.</p>
                </body>
                </html>
            `;
            
            const swContent = `
                const CACHE_NAME = '401k-calculator-v2';
                const urlsToCache = [
                    '.', // Caches the main HTML file
                    'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js',
                    'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css'
                ];
                
                const OFFLINE_PAGE_CONTENT = \`${OFFLINE_HTML}\`;

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Service Worker: Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                    );
                });

                self.addEventListener('fetch', event => {
                    // We only want to handle navigation requests (HTML pages)
                    if (event.request.mode !== 'navigate') {
                        // For non-HTML requests (like scripts, images), use cache-first
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    return response || fetch(event.request);
                                })
                        );
                        return;
                    }
                    
                    // For navigation requests, try network first, then cache, then offline page
                    event.respondWith(
                        fetch(event.request)
                            .catch(() => {
                                // Network failed, try cache
                                return caches.match(event.request)
                                    .then(response => {
                                        // Return from cache or show offline page
                                        return response || new Response(OFFLINE_PAGE_CONTENT, {
                                            headers: { 'Content-Type': 'text/html' }
                                        });
                                    });
                            })
                    );
                });
                
                // Clean up old caches
                self.addEventListener('activate', event => {
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.filter(name => name !== CACHE_NAME).map(name => caches.delete(name))
                            );
                        })
                    );
                });
            `;
            // Create a Blob from the SW content and register it
            try {
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker registered from Blob.', reg))
                    .catch(err => console.error('Service Worker registration failed:', err));
            } catch (e) {
                console.error('Error creating Service Worker Blob:', e);
            }
            */
           console.log('PWA Service Worker registration skipped as blob: URLs are not supported in this environment.');
        }
    </script>

</body>
</html>
