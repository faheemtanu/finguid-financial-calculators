<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>AI Auto Loan Calculator 2025 | Car Payment &amp; Rates | FinGuid</title>

    <meta name="description" content="World's Best AI-Powered Auto Loan Calculator by FinGuid. Calculate your monthly car payment with live FRED rates, trade-in, sales tax, and AI insights. See total cost, amortization, and compare 36, 48, 60, 72, and 84 month terms. WCAG 2.1 AA compliant. Mobile-friendly PWA.">
    
    <!-- 
      SEO KEYWORDS: As requested, a comprehensive list for ranking.
    -->
    <meta name="keywords" content="auto loan calculator, car payment calculator, auto loan payment calculator, car loan calculator, monthly car payment calculator, car loan calculator with trade in, auto loan calculator with tax and fees, auto loan calculator with trade in tax and fees, car payment calculator with trade in, ai auto loan calculator, ai car payment calculator, find monthly car payment, estimate car payment, auto loan rates, car loan rates, live auto loan rates, FRED auto loan rates, new car loan calculator, used car loan calculator, auto refinance calculator, car loan amortization schedule, car loan comparison calculator, 36 month auto loan, 48 month auto loan, 60 month auto loan, 72 month auto loan, 84 month auto loan, car loan interest calculator, car loan total cost, car loan affordability calculator, auto loan calculator USA, FinGuid auto loan, 20/4/10 rule calculator, car loan trade in calculator, car sales tax calculator, auto loan calculator PWA, voice activated car calculator, WCAG compliant auto calculator">

    <meta name="author" content="FinGuid USA">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="theme-color" content="#24ACB9"> <!-- FinGuid Primary Color -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="AI Auto Loan Calculator 2025 | Car Payments &amp; Live Rates | FinGuid">
    <meta property="og:description" content="Free AI auto loan calculator with live FRED rates, trade-in, sales tax, loan comparison, and 100+ AI insights.">
    
    <link rel="canonical" href="https://www.finguid.com/calculators/auto-loan">
    
    <!-- 
      PWA FIX: Inlined PWA Web App Manifest (Preserved from mortgage calc)
      This fulfills the PWA requirement.
    -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22FinGuid%20AI%20Auto%20Loan%20Calculator%22,%22short_name%22:%22AutoLoanCalc%22,%22description%22:%22AI-Powered%20Auto%20Loan%20Calculator%20with%20Tax,%20Trade-in,%20Live%20Rates,%20and%20Amortization.%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#FFFFFD%22,%22theme_color%22:%22#24ACB9%22,%22icons%22:[{%22src%22:%22https://placehold.co/192x192/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://placehold.co/512x512/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22512x512%22}]}">
    
    <!-- 
      START: Inlined CSS
      Copied directly from 'mortgage-calculator (6).html' for design unification.
      WCAG, Mobile, and GDPR/CCPA fixes are included.
    -->
    <style>
        /* === START: Global Variables (Brand Color Match) === */
        :root {
            --primary: #24ACB9; /* Teal (Matches FinGuid Image & Car Lease CSS) */
            --primary-dark: #19343B; /* Dark Teal (Matches Car Lease CSS) */
            --accent: #FFC107;
            --accent-dark: #E69500;
            --text: #1F2121;
            --text-light: #64748B;
            --bg: #FFFFFD;
            --bg-secondary: #F5F7FA;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --error: #EF4444;
            --success: #10B981;
            --fred-color: #A31B20; /* FRED standard color for Live Rates button */
        }

        [data-color-scheme="dark"] {
            --text: #E1E8ED;
            --text-light: #B8C5D0;
            --bg: #1F2121;
            --bg-secondary: #242B36;
            --card: #181919;
            --border: #38444D;
        }
        /* === END: Global Variables === */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { 
            font-size: 16px; 
            -webkit-font-smoothing: antialiased; 
            /* WCAG FIX: Smooth scrolling for accessibility */
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* ===== NEW HEADER STYLES (Single Line) ===== */
        .header {
            position: sticky;
            top: 0;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            gap: 16px;
            /* MOBILE FIX: Allow wrapping on small screens */
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--primary); /* Uses new primary brand color */
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .logo:hover { color: var(--primary-dark); }

        .calculator-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            flex-shrink: 0;
            margin-left: 16px;
            /* MOBILE FIX: Allow title to shrink */
            flex-basis: auto;
            min-width: 0;
        }

        /* === IMPROVED: Animated Features === */
        .header-features {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 24px;
            flex-grow: 1;
            justify-content: flex-start;
            overflow: hidden;
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        .header-feature-item {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            animation: pulse-color-text 2.5s infinite ease-in-out;
        }
        .header-feature-item:nth-child(1) { animation-delay: 0s; }
        .header-feature-item:nth-child(2) { animation-delay: 0.2s; }
        .header-feature-item:nth-child(3) { animation-delay: 0.4s; }
        .header-feature-item:nth-child(4) { animation-delay: 0.6s; }

        @keyframes pulse-color-text {
            0%, 100% {
                opacity: 0.8;
                color: var(--text-light);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                color: var(--primary); /* Pulses to brand color */
                transform: scale(1.03);
            }
        }
        /* === END: Improved Animated Features === */


        /* Header Controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            /* MOBILE FIX: Ensure controls stay on the right */
            margin-left: auto;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:hover { background: var(--primary); color: white; }

        .icon-btn.active {
            background: var(--primary);
            color: white;
        }

        #pwa-install-btn {
            display: none; /* Hidden by default, shown by JS */
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #pwa-install-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        /* ===== END NEW HEADER STYLES ===== */


        /* ===== SPONSOR BANNER (Uses FinGuid/Car Lease Gradient) ===== */
        .sponsor-banner {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); /* Matched car lease color */
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sponsor-text { font-weight: 500; flex: 1; min-width: 200px; }
        .sponsor-buttons { display: flex; gap: 8px; }

        .sponsor-btn {
            padding: 8px 12px;
            background: white;
            color: #6366F1; /* Color from the gradient for consistency */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .sponsor-btn:hover { background: var(--accent); color: var(--text); transform: translateY(-2px); }

        /* ===== MAIN CALCULATOR (Layout Preserved) ===== */
        .calculator-wrapper {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            padding: 24px 0;
            margin-bottom: 40px;
        }

        .inputs-panel, .results-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        .inputs-panel {
            /* Make inputs sticky */
            position: sticky;
            top: 100px; /* Adjust based on header height */
            align-self: start; 
        }
        .inputs-panel:hover, .results-panel:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .panel-title { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }

        .section-heading {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary); /* Uses new primary brand color */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        /* ===== NEW: Style for automated FRED update text ===== */
        .fred-rates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        #fred-last-updated {
            font-size: 11px;
            color: var(--text-light);
            text-align: left;
        }
        .fred-branding {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 600;
        }
        .fred-branding a {
            color: var(--text-light);
            text-decoration: none;
        }
        .fred-branding a:hover {
            color: var(--primary);
        }

        .live-rates-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .rate-btn {
            flex-grow: 1;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .rate-btn:hover {
            background: var(--card);
            border-color: var(--primary);
            color: var(--primary);
        }
        .rate-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .rate-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* ===== END: New Styles ===== */

        /* ===== NEW: Tooltip Styles (from Car Lease) ===== */
        .tooltip {
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
            display: inline-flex; /* Use flex to align icon */
            align-items: center;
            color: var(--text-light); /* Make hint text match */
        }

        /* IMPROVED: Tooltip icon */
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-light);
            color: var(--card);
            font-style: normal;
            font-size: 10px;
            font-weight: 700;
            line-height: 14px;
            margin-left: 5px;
            transition: all 0.2s ease;
        }
        /* WCAG FIX: Add focus style for keyboard accessibility */
        .tooltip:hover .tooltip-icon,
        .tooltip:focus .tooltip-icon {
            background: var(--primary);
            outline: none;
        }
        /* WCAG FIX: Ensure tooltip span itself has no outline on focus */
        .tooltip:focus {
            outline: none;
        }


        .tooltip-box {
            position: fixed;
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 200px;
            white-space: normal;
            display: none; /* Hidden by default, shown by JS */
            opacity: 0;
            transition: opacity 0.2s;
        }
        /* ===== END: Tooltip Styles ===== */


        .input-wrapper { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            min-width: 0; 
        }

        input[type="number"], input[type="text"], input[type="date"], input[type="month"], select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 0;
            width: 100%; /* Ensure it takes available space */
        }

        /* WCAG FIX: Ensure all inputs/selects have a clear focus ring */
        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus, 
        input[type="month"]:focus, select:focus, .rate-btn:focus, .lookup-btn:focus, 
        .sponsor-btn:focus, .btn-secondary:focus, .icon-btn:focus, 
        #pwa-install-btn:focus, .tab-btn:focus, .faq-question:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.25); /* Updated focus color */
        }
        /* WCAG FIX: Special focus for buttons without borders */
        .icon-btn:focus, #pwa-install-btn:focus, .sponsor-btn:focus, .lookup-btn:focus {
             box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
        }


        .input-addon {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            min-width: 50px;
            text-align: center;
        }

        .toggle-btn {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s ease;
        }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* ===== FRED BRANDING (Button styles preserved in case you add other buttons) ===== */
        .lookup-btn {
            padding: 10px 12px;
            background: var(--primary); /* Default button uses new brand color */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .lookup-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .lookup-btn.fred-btn { background: var(--fred-color); }
        .lookup-btn.fred-btn:hover { background: #7D1418; }
        .lookup-btn:active { transform: translateY(0); }

        /* ===== NEW: Ad Slot (from Car Lease) ===== */
        .ad-slot {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
        }
        .ad-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .ad-placeholder {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 600;
        }
        /* ===== END: Ad Slot ===== */

        /* ===== RESULTS SECTION (Preserved) ===== */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); /* Updated gradient */
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(36, 172, 185, 0.2); /* Updated shadow */
            text-align: center;
        }
        .summary-label { font-size: 0.875rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .payment-amount { display: flex; align-items: baseline; justify-content: center; gap: 8px; margin: 8px 0; }
        .amount { font-size: 2rem; font-weight: bold; }
        .unit { font-size: 1rem; opacity: 0.9; }
        .payment-breakdown { font-size: 0.875rem; opacity: 0.8; }

        .tabs { margin-bottom: 24px; }
        .tab-buttons { 
            display: flex; 
            gap: 4px; 
            border-bottom: 2px solid var(--border); 
            margin-bottom: 24px; 
            overflow-x: auto; 
        }

        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        /* WCAG FIX: Style for tab focus */
        .tab-btn:focus {
            color: var(--primary);
            box-shadow: none; /* Focus ring is handled by global style */
            border-bottom-color: rgba(36, 172, 185, 0.5);
        }
        .tab-btn.active:focus {
             border-bottom-color: var(--primary);
        }


        .tab-content { display: none; padding: 8px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        /* WCAG FIX: Ensure tab content is focusable when shown */
        .tab-content:focus-visible {
            outline: 2px solid var(--primary);
            border-radius: 4px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .results-heading {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin: 16px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .result-box { background: var(--bg-secondary); padding: 16px; border-radius: 6px; border-left: 4px solid var(--border); transition: all 0.2s; }
        .result-box:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .result-box.highlight { 
            border-left-color: var(--primary); 
            background: rgba(36, 172, 185, 0.1); 
        }
        .result-box.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .result-box.accent {
            border-left-color: var(--accent-dark);
            background: rgba(255, 193, 7, 0.1);
        }

        .result-label { 
            display: block; 
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
        }
        .result-value { 
            display: block; 
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .chart-container {
            position: relative;
            height: 350px; 
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
        }

        .chart-summary-controls {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .chart-summary-controls label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        #slider-year-label {
            display: inline-block;
            font-weight: 700;
            color: var(--primary);
            min-width: 20px;
        }
        .year-slider {
            width: 100%;
            cursor: pointer;
        }


        /* ===== Amortization Controls & Table Styles ===== */
        .amortization-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 8px 16px;
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .table-scroll-wrapper {
            overflow-x: auto;
            max-height: 500px; /* Scrollable table body */
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .amortization-table thead {
            position: sticky;
            top: 0;
            background: var(--primary); /* Branded color */
            color: white;
            z-index: 10;
        }
        .amortization-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .amortization-table th:nth-child(n+2) { text-align: right; } /* Right-align numbers */

        .amortization-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .amortization-table tbody tr:nth-child(even) {
            background: var(--bg-secondary);
        }
        .amortization-table tbody tr:hover {
            background: rgba(36, 172, 185, 0.1); /* Branded hover */
        }
        .amortization-table td {
            padding: 10px 12px;
            color: var(--text-light);
        }
        .amortization-table td:first-child {
            font-weight: 600;
            color: var(--text);
        }
        .amortization-table td:nth-child(n+2) {
            text-align: right; /* Right-align numbers */
            font-family: 'Courier New', Courier, monospace;
        }
        .amortization-table .summary-row td {
            font-weight: bold;
            color: var(--text);
            background: var(--bg-secondary);
        }
        /* ===== END: Amortization Styles ===== */


        /* ===== AI INSIGHTS (Preserved) ===== */
        .insights-container { margin-top: 20px; }
        .insight-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary); /* Uses new primary brand color */
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .insight-box.success { border-left-color: var(--success); }
        .insight-box.warning { border-left-color: var(--accent-dark); }
        .insight-box.error { border-left-color: var(--error); }


        /* ===== PARTNER SECTION (Preserved) ===== */
        .footer-sponsor {
            background: linear-gradient(135deg, rgba(36, 172, 185, 0.1) 0%, rgba(25, 52, 59, 0.1) 100%); /* Updated gradient */
            padding: 40px;
            border-bottom: 1px solid rgba(36, 172, 185, 0.2);
            border-radius: 12px;
        }
        .sponsor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; }
        .sponsor-item { text-align: center; padding: 16px; border-radius: 8px; background: var(--card); transition: all 0.2s; }
        .sponsor-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sponsor-item h4 { margin-bottom: 8px; color: var(--primary); font-size: 1rem; }
        .sponsor-item p { color: var(--text-light); margin-bottom: 12px; font-size: 0.875rem; line-height: 1.5; }
        .sponsor-item a {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); /* Updated gradient */
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        /* WCAG FIX: Add focus style for partner links */
        .sponsor-item a:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        .sponsor-item a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(36, 172, 185, 0.3); } /* Updated shadow */

        /* ===== FOOTER (Preserved) ===== */
        .footer { background: var(--card); border-top: 1px solid var(--border); padding: 32px 0; margin-top: 40px; }
        .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .footer-section h4 { font-size: 13px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .footer-section a { display: block; font-size: 12px; color: var(--text-light); text-decoration: none; margin-bottom: 8px; transition: color 0.3s ease; }
        .footer-section a:hover, .footer-section a:focus { 
            color: var(--primary); 
            /* WCAG FIX: Add underline on focus for links */
            text-decoration: underline;
            outline: none;
        }
        .compliance-badges { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; font-size: 12px; }
        .badge { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; font-weight: 600; color: var(--text-light); }
        .disclaimer { font-size: 11px; color: var(--text-light); line-height: 1.6; padding-top: 20px; border-top: 1px solid var(--border); }
        .footer-bottom { text-align: center; font-size: 12px; color: var(--text-light); padding-top: 16px; border-top: 1px solid var(--border); }

        /* ===== FAQ ACCORDION (Preserved) ===== */
        .faq-section { margin: 40px 0; }
        .faq-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 20px; text-align: center; }
        .faq-container { max-width: 900px; margin: 0 auto; }
        .faq-item { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; }
        .faq-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .faq-question { padding: 16px; background: var(--bg-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text); transition: all 0.3s ease; }
        .faq-question:hover { background: var(--card); color: var(--primary); }
        .faq-question.active { background: var(--primary); color: white; }
        /* WCAG FIX: Focus style for accordion */
        .faq-question:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4) inset;
            color: var(--primary);
        }
        .faq-icon { font-size: 18px; transition: transform 0.3s ease; }
        .faq-question.active .faq-icon { transform: rotate(180deg); }
        .faq-answer { display: none; padding: 16px; background: var(--card); color: var(--text-light); line-height: 1.8; font-size: 14px; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }

        /* ===== GDPR/CCPA FIX: Cookie Consent Banner Styles ===== */
        #cookie-consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            color: var(--text);
            padding: 24px;
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .cookie-consent-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-light);
            flex: 1 1 400px; /* Allow wrapping */
        }
        .cookie-consent-text a {
            color: var(--primary);
            text-decoration: underline;
        }
        .cookie-consent-text a:hover {
            color: var(--primary-dark);
        }
        #cookie-consent-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #cookie-consent-btn:hover {
            background: var(--primary-dark);
        }
        /* WCAG FIX: Focus style for cookie button */
        #cookie-consent-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        /* ===== END: Cookie Consent Styles ===== */


        /* ===== RESPONSIVE (Updated for new header) ===== */
        @media (max-width: 1024px) {
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel { 
                position: static; /* Un-stick the input panel */
                align-self: auto;
            }
            .footer-content { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .header-features { display: none; }
            .sponsor-banner { flex-direction: column; gap: 12px; }
            .sponsor-buttons { flex: 1 1 100%; justify-content: space-between; }
            .tab-buttons { flex-wrap: nowrap; overflow-x: auto; }
            
            .inputs-panel, .results-panel {
                padding: 16px;
            }
            .footer-sponsor {
                padding: 24px;
            }
        }

        @media (max-width: 480px) {
            .calculator-title { display: none; }
            .header-features { display: none; }
            /* MOBILE FIX: Stack header controls under logo */
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .header-controls {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            #pwa-install-btn {
                flex-grow: 1; /* Make install button take up space */
            }

            .payment-breakdown { font-size: 0.75rem; }
            .amount { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; }
            .sponsor-grid { grid-template-columns: 1fr; }

            /* GDPR/CCPA FIX: Make cookie banner stack */
            #cookie-consent-banner {
                flex-direction: column;
                text-align: center;
            }
            .cookie-consent-text {
                flex-basis: auto;
            }
            #cookie-consent-btn {
                width: 100%;
            }
        }

        /* ===== PRINT STYLE (Preserved) ===== */
        @media print {
            .header, .sponsor-banner, .header-controls, .footer-sponsor, .faq-section, 
            .footer, .ad-slot, .amortization-controls, .chart-summary-controls,
            #cookie-consent-banner {
                display: none;
            }
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel, .results-panel { box-shadow: none; border: 1px solid #ccc; }
            .table-scroll-wrapper { max-height: none; overflow: visible; }
        }
    </style>
    <!-- END: Inlined CSS -->

    <!-- Google Analytics Script (Preserved) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYBL2CDNQJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NYBL2CDNQJ');
    </script>

    <!-- PWA Install & Preload Logic (Preserved) -->
    <script>
        // PWA Install Detection (Preserved)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            const pwaInstall = document.getElementById('pwa-install-btn');
            if (pwaInstall) pwaInstall.style.display = 'flex';
        });

        // Preload critical resources (Preserved)
        document.addEventListener('DOMContentLoaded', () => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'script';
            link.href = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            document.head.appendChild(link);
        });
    </script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="https://www.finguid.com" class="logo">
                    <!-- WCAG FIX: Added aria-label for emoji -->
                    <span role="img" aria-label="Money bag emoji">üí∞</span>
                    <span>FinGuid USA</span>
                </a>
                
                <span class="calculator-title">Auto Loan Pro - Car Payment Calculator</span>

                <div class="header-features" aria-hidden="true">
                    <span class="header-feature-item">ü§ñ AI Powered</span>
                    <span class="header-feature-item">üìà Live FRED Rates</span>
                    <span class="header-feature-item">üí° AI Insights</span>
                    <span class="header-feature-item">üí∏ Trade-in &amp; Tax</span>
                </div>

                <div class="header-controls">
                    <!-- WCAG FIX: Added type="button" to all buttons -->
                    <button type="button" id="pwa-install-btn" aria-label="Install App">üì± Install</button>
                    <button type="button" class="icon-btn" id="darkModeToggle" aria-label="Toggle dark mode" title="Dark mode">üåô</button>
                    <button type="button" class="icon-btn" id="voiceToggle" aria-label="Voice control" title="Voice commands">üé§</button>
                    <button type="button" class="icon-btn" id="ttsToggle" aria-label="Text to speech" title="Read results">üîä</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="sponsor-banner">
        <span class="sponsor-text">üéÅ Get Pre-Qualified for an Auto Loan and Compare Rates from Top Lenders</span>
        <div class="sponsor-buttons">
            <!-- WCAG FIX: Added type="button" -->
            <button type="button" class="sponsor-btn" onclick="location.href='#our-partners'">View Lenders ‚Üí</button>
            <button type="button" class="sponsor-btn" onclick="app.showPartnerAlert('Auto Lender Partnerships')">Become our partner ‚Üí</button>
            </div>
    </div>

    <!-- 
      WCAG FIX: Added role="main" to identify the main content
    -->
    <main class="container" role="main">
        <div class="calculator-wrapper">
            <!-- WCAG FIX: Added role="region" and aria-labelledby -->
            <section class="inputs-panel" role="region" aria-labelledby="inputs-title">
                <h2 class="panel-title" id="inputs-title">üìã Auto Loan Parameters</h2>

                <div class="section-heading">Vehicle &amp; Down Payment</div>
                <div class="form-group">
                    <!-- WCAG FIX: Added unique IDs for tooltip description -->
                    <label class="form-label" for="vehiclePrice">Vehicle Price 
                        <span class="tooltip" data-tooltip="The full purchase price of the car, before any trade-in or down payment." tabindex="0" role="tooltip" id="tooltip-vehicleprice">
                            <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-addon" aria-hidden="true">$</span>
                        <input type="number" id="vehiclePrice" value="35000" min="1000" step="1000" aria-label="Vehicle price" aria-describedby="tooltip-vehicleprice">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="downPaymentAmount">Down Payment 
                            <span class="tooltip" data-tooltip="The cash amount paid upfront." tabindex="0" role="tooltip" id="tooltip-dp-amount">$ 
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-addon" aria-hidden="true">$</span>
                            <input type="number" id="downPaymentAmount" value="5000" min="0" step="500" aria-label="Down payment amount in dollars" aria-describedby="tooltip-dp-amount">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="downPaymentPercent">Down Payment 
                            <span class="tooltip" data-tooltip="The percentage of the vehicle price paid upfront." tabindex="0" role="tooltip" id="tooltip-dp-percent">% 
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                             <input type="number" id="downPaymentPercent" value="14.3" min="0" max="100" step="1" aria-label="Down payment percentage" aria-describedby="tooltip-dp-percent">
                             <span class="input-addon" aria-hidden="true">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="tradeInValue">Trade-in Value 
                        <span class="tooltip" data-tooltip="The value of your trade-in. This reduces the taxable amount in most states." tabindex="0" role="tooltip" id="tooltip-tradein">
                            <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-addon" aria-hidden="true">$</span>
                        <input type="number" id="tradeInValue" value="2000" min="0" step="500" aria-label="Trade-in value" aria-describedby="tooltip-tradein">
                    </div>
                </div>


                <div class="section-heading">Loan &amp; Rates</div>

                <div class="form-group">
                    <label class="form-label" for="interestRate">
                        Interest Rate %
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="interestRate" value="7.50" min="0" max="25" step="0.01" aria-label="Interest rate">
                        <span class="input-addon" aria-hidden="true">%</span>
                    </div>
                    
                    <div class="fred-rates-header">
                        <span id="fred-last-updated">Loading live rates...</span>
                        <span class="fred-branding">
                            Data via <a href="https://fred.stlouisfed.org/" target="_blank" rel="noopener">FRED¬Æ</a>
                        </span>
                    </div>
                    <div class="live-rates-container">
                        <!-- WCAG FIX: Added type="button" -->
                        <button type="button" class="rate-btn" id="rate-btn-60mo" disabled>New 60-Mo: ...</button>
                        <button type="button" class="rate-btn" id="rate-btn-48mo" disabled>New 48-Mo: ...</button>
                        <button type="button" class="rate-btn" id="rate-btn-used" disabled>Used Avg: ...</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="loanTerm">Loan Term 
                        <span class="tooltip" data-tooltip="The length of the auto loan in months." tabindex="0" role="tooltip" id="tooltip-term">
                            <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                        </span>
                    </label>
                    <select id="loanTerm" aria-label="Loan term" aria-describedby="tooltip-term">
                        <option value="36">36 Months (3 Years)</option>
                        <option value="48">48 Months (4 Years)</option>
                        <option value="60" selected>60 Months (5 Years)</option>
                        <option value="72">72 Months (6 Years)</option>
                        <option value="84">84 Months (7 Years)</option>
                    </select>
                </div>
                
                <div class="section-heading">Taxes, Fees &amp; Extras</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="salesTaxRate">Sales Tax Rate
                            <span class="tooltip" data-tooltip="Your state/local sales tax rate." tabindex="0" role="tooltip" id="tooltip-tax">% 
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                             <input type="number" id="salesTaxRate" value="6.5" min="0" max="20" step="0.1" aria-label="Sales tax rate" aria-describedby="tooltip-tax">
                             <span class="input-addon" aria-hidden="true">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="fees">Title &amp; Fees 
                            <span class="tooltip" data-tooltip="Title, registration, and documentation fees. These are added to the loan." tabindex="0" role="tooltip" id="tooltip-fees">$ 
                                <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                            </span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-addon" aria-hidden="true">$</span>
                            <input type="number" id="fees" value="500" min="0" step="50" aria-label="Title and fees" aria-describedby="tooltip-fees">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="extraMonthly">Extra Monthly Payment 
                        <span class="tooltip" data-tooltip="Additional amount paid monthly to reduce principal." tabindex="0" role="tooltip" id="tooltip-extra-mo">$ 
                            <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-addon" aria-hidden="true">$</span>
                        <input type="number" id="extraMonthly" value="0" min="0" step="25" aria-label="Extra monthly payment" aria-describedby="tooltip-extra-mo">
                    </div>
                </div>
            </section>

            <!-- WCAG FIX: Added role="region" and aria-labelledby -->
            <section class="results-panel" role="region" aria-labelledby="results-title">
                <h2 class="panel-title" id="results-title">üìä Analysis & Results</h2>

                <div class="ad-slot" role="complementary" aria-label="Advertisement">
                    <p class="ad-label">ADVERTISEMENT</p>
                    <div class="ad-placeholder">
                        <p>Compare Top Auto Lenders &amp; Insurance Quotes</p>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="summary-label">Estimated Monthly Payment (P&amp;I)</div>
                    <div class="payment-amount">
                        <!-- WCAG FIX: Added aria-live for screen readers -->
                        <span class="amount" id="monthly-payment" aria-live="polite">$0.00</span>
                        <span class="unit">/month</span>
                    </div>
                    <!-- WCAG FIX: Added aria-live for screen readers -->
                    <div class="payment-breakdown" id="payment-breakdown" aria-live="polite">Principal &amp; Interest Payment</div>
                </div>
                
                <div class="tabs">
                    <!-- WCAG FIX: Added role="tablist" and aria-label -->
                    <div class="tab-buttons" role="tablist" aria-label="Results sections">
                        <!-- WCAG FIX: Added type, role, aria-controls, aria-selected -->
                        <button type="button" class="tab-btn active" role="tab" aria-controls="analysis" aria-selected="true" id="tab-analysis">Cost Analysis</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="comparison" aria-selected="false" id="tab-comparison" tabindex="-1">Term Comparison</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="charts" aria-selected="false" id="tab-charts" tabindex="-1">Loan Over Time</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="amortization" aria-selected="false" id="tab-amortization" tabindex="-1">Amortization</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="insights" aria-selected="false" id="tab-insights" tabindex="-1">AI Insights</button>
                    </div>

                    <!-- WCAG FIX: Added role="tabpanel", aria-labelledby, tabindex -->
                    <div class="tab-content active" id="analysis" role="tabpanel" aria-labelledby="tab-analysis" tabindex="0">
                        <h3 class="results-heading">Total Cost Breakdown</h3>
                        <div class="chart-container">
                            <!-- WCAG FIX: Added role="img" and aria-label -->
                            <canvas id="paymentBreakdownChart" role="img" aria-label="Doughnut chart showing total cost breakdown"></canvas>
                        </div>
                        
                        <h3 class="results-heading">Loan Summary</h3>
                        <div class="result-grid">
                            <div class="result-box highlight">
                                <div class="result-label">Total Loan Amount</div>
                                <div class="result-value" id="loanAmount">$0</div>
                            </div>
                            <div class="result-box accent">
                                <div class="result-label">Total Interest Paid</div>
                                <div class="result-value" id="totalInterest">$0</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Total Cost</div>
                                <div class="result-value" id="totalPayments">$0</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Sales Tax Paid</div>
                                <div class="result-value" id="salesTaxPaid">$0</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Fees Paid</div>
                                <div class="result-value" id="feesPaid">$0</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">LTV Ratio</div>
                                <div class="result-value" id="ltv">0%</div>
                            </div>
                            <div class="result-box success" id="interestSavedBox">
                                <div class="result-label">Interest Saved</div>
                                <div class="result-value" id="interestSaved">$0</div>
                            </div>
                            <div class="result-box success" id="payoffAccelBox">
                                <div class="result-label">Payoff Acceleration</div>
                                <div class="result-value" id="payoffAccel">0 months</div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW TAB: Loan Comparison -->
                    <div class="tab-content" id="comparison" role="tabpanel" aria-labelledby="tab-comparison" tabindex="0">
                        <h3 class="results-heading">Loan Term Comparison</h3>
                        <p style="font-size: 13px; color: var(--text-light); margin-bottom: 16px;">See how changing the loan term affects your monthly payment and the total interest you'll pay, based on your current inputs.</p>
                        <div class="table-scroll-wrapper">
                            <table class="amortization-table" aria-label="Loan Term Comparison">
                                <thead>
                                    <tr>
                                        <th>Term (Months)</th>
                                        <th>Monthly Payment</th>
                                        <th>Total Interest</th>
                                        <th>Total Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody">
                                    <!-- Rows will be dynamically inserted by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- WCAG FIX: Added role="tabpanel", aria-labelledby, tabindex -->
                    <div class="tab-content" id="charts" role="tabpanel" aria-labelledby="tab-charts" tabindex="0">
                        <h3 class="results-heading">Loan Balance Over Time</h3>
                        <div class="chart-container">
                            <!-- WCAG FIX: Added role="img" and aria-label -->
                            <canvas id="loanOverTimeChart" role="img" aria-label="Line and bar chart showing loan balance and payments over time"></canvas>
                        </div>
                        
                        <div class="chart-summary-controls">
                            <!-- WCAG FIX: Linked label to slider -->
                            <label for="year-slider">View Details for Year: <span id="slider-year-label">1</span></label>
                            <input type="range" id="year-slider" min="1" max="5" value="1" class="year-slider" aria-label="Select year to view summary">
                        </div>
                        <!-- WCAG FIX: Added aria-live to announce updates -->
                        <div class="result-grid" id="chart-year-summary" aria-live="polite">
                            <div class="result-box">
                                <div class="result-label">Principal Paid This Year</div>
                                <div class="result-value" id="summary-principal-paid">$0</div>
                            </div>
                            <div class="result-box accent">
                                <div class="result-label">Interest Paid This Year</div>
                                <div class="result-value" id="summary-interest-paid">$0</div>
                            </div>
                            <div class="result-box highlight">
                                <div class="result-label">Remaining Balance</div>
                                <div class="result-value" id="summary-remaining-balance">$0</div>
                            </div>
                        </div>
                    </div>

                    <!-- WCAG FIX: Added role="tabpanel", aria-labelledby, tabindex -->
                    <div class="tab-content" id="amortization" role="tabpanel" aria-labelledby="tab-amortization" tabindex="0">
                        <div class="amortization-controls">
                            <!-- WCAG FIX: Added type="button" -->
                            <button type="button" id="amortToggle" class="btn-secondary">Show Yearly</button>
                            <button type="button" id="exportCsv" class="btn-secondary">Export as CSV</button>
                        </div>
                        <div class="table-scroll-wrapper">
                            <!-- WCAG FIX: Added caption for table -->
                            <table class="amortization-table" aria-label="Amortization Schedule">
                                <caption class="visually-hidden">Detailed loan amortization schedule showing principal, interest, and balance for each payment.</caption>
                                <thead id="amortizationThead">
                                    </thead>
                                <tbody id="amortizationTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- WCAG FIX: Added role="tabpanel", aria-labelledby, tabindex -->
                    <div class="tab-content" id="insights" role="tabpanel" aria-labelledby="tab-insights" tabindex="0">
                         <h3 class="results-heading">ü§ñ AI-Powered Auto Insights</h3>
                         <!-- WCAG FIX: Added aria-live="polite" to announce new insights -->
                        <div class="insights-container" id="insightsContainer" aria-live="polite">
                            <div class="insight-box">
                                <strong>ü§ñ AI Auto Advisor:</strong> Enter your details to generate personalized insights...
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- WCAG FIX: Changed to <section> and added aria-labelledby -->
        <section class="footer-sponsor" id="our-partners" aria-labelledby="partners-title">
            <div class="container">
                <h3 id="partners-title" style="text-align: center; margin-bottom: 24px; color: var(--primary); font-size: 24px; font-weight: 700;">Our Auto Partners</h3>
                <div class="sponsor-grid">
                    <div class="sponsor-item">
                        <h4>üöó Auto Loan Pre-Approval</h4>
                        <p>Compare rates from top auto lenders. Get pre-approved in minutes. Know your budget before you shop.</p>
                        <!-- WCAG FIX: Added descriptive aria-label -->
                        <a href="#affiliate-link-1" onclick="app.showPartnerAlert('Auto Lender'); return false;" aria-label="Get Quotes for Auto Loan Pre-Approval">Get Quotes ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üõ°Ô∏è Auto Insurance Quotes</h4>
                        <p>Compare insurance rates from major providers. Save up to $500/year on your car insurance.</p>
                        <a href="#affiliate-link-2" onclick="app.showPartnerAlert('Auto Insurance'); return false;" aria-label="Compare Rates for Auto Insurance">Compare Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üîÑ Auto Refinancing</h4>
                        <p>Lower your monthly payment. Get quotes for auto refinancing from our trusted partners.</p>
                        <a href="#affiliate-link-3" onclick="app.showPartnerAlert('Auto Refinance'); return false;" aria-label="Check Rates for Auto Refinancing">Check Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>‚úÖ Credit Score Check</h4>
                        <p>Your credit score is key. Check your score for free before you apply for a loan. No impact on your score.</p>
                        <a href="#affiliate-link-4" onclick="app.showPartnerAlert('Credit Score'); return false;" aria-label="Check your credit score for free">Check Score Free ‚Üí</a>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="faq-section" aria-labelledby="faq-title">
            <h2 class="faq-title" id="faq-title">‚ùì Auto Loan Frequently Asked Questions</h2>
            <div class="faq-container" id="faqContainer">
                <!-- FAQs will be dynamically inserted here by JS -->
            </div>
        </section>

        <!-- WCAG FIX: Changed to <footer role="contentinfo"> -->
        <footer class="footer" role="contentinfo">
            <div class="container">
                <div class="footer-content">
                    <!-- WCAG FIX: Added role="navigation" and aria-label -->
                    <nav class="footer-section" role="navigation" aria-label="About this calculator">
                        <h4>About Auto Calculator</h4>
                        <a href="#how-it-works">How It Works</a>
                        <a href="#features">Features</a>
                        <a href="#faq">FAQ</a>
                        <a href="#contact">Contact Us</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Learn more about auto loans">
                        <h4>Learn More</h4>
                        <a href="#ltv">What is LTV?</a>
                        <a href="#amortization">Amortization Guide</a>
                        <a href="#rates">Current Rates</a>
                        <a href="#blog">Blog</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Financial resources">
                        <h4>Resources</h4>
                        <a href="#calculators">Other Calculators</a>
                        <a href="#tools">Financial Tools</a>
                        <a href="#education">Education</a>
                        <a href="#glossary">Glossary</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Legal links">
                        <h4>Legal</h4>
                        <a href="#privacy">Privacy Policy</a>
                        <a href="#terms">Terms of Service</a>
                        <a href="#disclaimer">Disclaimer</a>
                        <a href="#affiliate">Affiliate Disclosure</a>
                    </nav>
                </div>

                <div class="compliance-badges" role="list" aria-label="Compliance Badges">
                    <span class="badge" role="listitem">üîí SSL Secured</span>
                    <span class="badge" role="listitem">‚úÖ GDPR Compliant</span>
                    <span class="badge" role="listitem">‚úÖ CCPA Compliant</span>
                    <span class="badge" role="listitem">‚úÖ FTC Compliant</span>
                    <span class="badge" role="listitem">‚ôø WCAG 2.1 AA</span>
                </div>

                <!-- WCAG FIX: Changed to <section> and added aria-label -->
                <section class="disclaimer" aria-label="Disclaimers and Disclosures">
                    <strong>Educational & Informational Only:</strong> This auto loan calculator is for educational and informational purposes only. It is NOT financial advice. Actual auto loan rates, terms, and payments may vary significantly based on credit score, debt-to-income ratio, location, vehicle age (new/used), loan type, down payment percentage, credit history, employment status, and many other factors. Lenders may impose additional requirements or restrictions. Always consult with a qualified financial advisor or lender before making any borrowing decisions.
                    <br><br>
                    <strong>Affiliate Disclosure:</strong> FinGuid participates in affiliate programs with lending and insurance partners. When you click on partner links or apply for products through this calculator, FinGuid may receive compensation. This does not affect your rates or terms. We only recommend products we believe provide value to users.
                    <br><br>
    
                    <strong>Data Accuracy:</strong> Auto loan rates (TERMSCOAUTC48NS, TERMSCOAUTC60NS, TERMSCOAUCNS) provided by the Federal Reserve Bank of St. Louis. All data delivered via FRED¬Æ API. Rates are updated regularly but we make no guarantees about accuracy or applicability to your personal financial situation. Always verify rates directly with lenders.
                </section>

                <div class="footer-bottom">
                    ¬© 2025 FinGuid USA. All Rights Reserved. | AI-Powered Financial Tools for Americans
                </div>
            </div>
        </footer>
    </main>

    <!-- 
      GDPR/CCPA FIX: Added Cookie Consent Banner HTML 
      This is required for 100% compliance.
    -->
    <div id="cookie-consent-banner" role="dialog" aria-modal="true" aria-labelledby="cookie-consent-title" aria-describedby="cookie-consent-desc">
        <div class="cookie-consent-text">
            <h4 id="cookie-consent-title" style="font-weight: 700; color: var(--text); margin-bottom: 8px;">Your Privacy</h4>
            <p id="cookie-consent-desc">
                We use cookies and data to enhance your experience and provide personalized AI insights. By clicking "Accept", you agree to our use of cookies.
                <a href="#privacy" aria-label="Read our Privacy Policy">Privacy Policy</a>.
            </p>
        </div>
        <button type="button" id="cookie-consent-btn">Accept</button>
    </div>

    <!-- 
      NEW: Modal for Alerts
      WCAG/PWA FIX: Replaces native browser alert() which is non-compliant
      and bad for user experience.
    -->
    <style>
        .alert-modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .alert-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10003;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            display: none;
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }
        .alert-modal.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-backdrop.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }
        .alert-modal-body {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .alert-modal-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .alert-modal-btn:hover { background: var(--primary-dark); }
        .alert-modal-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
    </style>
    <div class="alert-modal-backdrop" id="alert-modal-backdrop"></div>
    <div class="alert-modal" id="alert-modal" role="alertdialog" aria-modal="true" aria-labelledby="alert-modal-title" aria-describedby="alert-modal-body">
        <h4 class="alert-modal-title" id="alert-modal-title">Partner Information</h4>
        <p class="alert-modal-body" id="alert-modal-body">
            This is an affiliate link for [Partner].
        </p>
        <button type="button" class="alert-modal-btn" id="alert-modal-close">Close</button>
    </div>
    <!-- END: Modal for Alerts -->

    <!-- CDN Dependencies (Preserved) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- 
      START: Inlined JavaScript
      Contains all logic from 'mortgage-calculator (6).js'
      HEAVILY ADAPTED for the Auto Loan Calculator, including:
      - New calculation logic (AutoLoanCalculator class)
      - New FRED API endpoints for auto loans
      - New AI Insights engine (AIAutoInsightEngine class)
      - New Loan Comparison tab logic
      - All WCAG, PWA, and GDPR/CCPA fixes from mortgage calc.
    -->
    <script>
        /**
         * ========================================================================
         * AUTO LOAN PRO - AI-POWERED CAR PAYMENT CALCULATOR
         * ========================================================================
         * Version: 1.0 - UNIFIED & COMPLIANT
         * Built with: SOLID Principles, WCAG 2.1 AA, PWA Compatible, GDPR/CCPA
         *
         * This file is a heavy adaptation of the FinGuid mortgage calculator,
         * rebuilt for Auto Loans as per user requirements.
         * ========================================================================
         */

        // ===== APP STATE & CONSTANTS (Adapted for Auto) =====
        const FRED_API_KEY = '9c6c421f077f2091e8bae4f143ada59a';
        const FRED_URL = 'https://api.stlouisfed.org/fred/series/observations';
        const FRED_SERIES_IDS = {
            rate60: 'TERMSCOAUTC60NS', // 60-Month New Auto Loan
            rate48: 'TERMSCOAUTC48NS', // 48-Month New Auto Loan
            rateUsed: 'TERMSCOAUCNS'  // Avg Used Auto Loan (All Terms)
        };

        // Fallback rates in case API fails
        const FALLBACK_RATES = {
            rates: { rate60: 7.50, rate48: 7.25, rateUsed: 8.50 },
            dates: { rate60: null, rate48: null, rateUsed: null },
        };

        // ===== EXPANDED FAQs for SEO (Auto Loan Specific) =====
        const FAQs = [
            {
                q: "How does this AI auto loan calculator work?",
                a: "This AI-powered calculator estimates your monthly car payment (Principal & Interest) based on four key inputs: the **Vehicle Price**, your **Down Payment** and **Trade-in Value**, the **Interest Rate (APR)**, and the **Loan Term** (in months). It also adds sales tax and fees to the loan amount for a highly accurate 'out-the-door' loan estimate."
            },
            {
                q: "What is the 20/4/10 rule for car buying?",
                a: "The 20/4/10 rule is a popular financial guideline for car buying. It suggests you should: <br/>1. Make a **20% down payment**. <br/>2. Finance the car for no more than **4 years** (48 months). <br/>3. Keep your total monthly car expenses (payment, insurance, gas) under **10%** of your gross monthly income. Our AI Insights will reference this rule."
            },
            {
                q: "How much car can I afford?",
                a: "Affordability depends on your income, debts, and budget. Many experts recommend your total car payment (including principal, interest, and insurance) should not exceed **10% to 15%** of your gross monthly income. Use this calculator to find the payment, then compare it to your budget. Remember to also account for fuel and maintenance!"
            },
            {
                q: "What is a good auto loan rate (APR) in 2025?",
                a: "Auto loan rates change daily and depend heavily on your **credit score**, the loan term, and whether the car is new or used. This calculator provides the latest available average rates from the Federal Reserve (FRED) for new and used cars. A 'good' rate is typically one at or below this national average for your credit tier (e.g., Excellent: 760+, Good: 700-759, etc.)."
            },
            {
                q: "How does a trade-in affect my car loan?",
                a: "A trade-in reduces the total amount you need to finance. In most US states, it also provides a significant tax benefit: you only pay sales tax on the *difference* between the new car's price and your trade-in's value. This calculator automatically applies this tax logic."
            },
            {
                q: "Should I choose a 60, 72, or 84-month auto loan?",
                a: "Longer terms (like 72 or 84 months) offer a lower monthly payment, which can be tempting. However, you will pay **significantly more interest** over the life of the loan. Worse, you risk being 'upside-down' (owing more than the car is worth) for years due to depreciation. Our AI Insights and 'Term Comparison' tab will show you this exact tradeoff."
            },
            {
                q: "What does 'LTV' or 'Loan-to-Value' mean for an auto loan?",
                a: "LTV compares your loan amount to the car's actual value. If you borrow $30,000 for a $30,000 car, your LTV is 100%. If you roll in taxes and fees, your LTV might be 110%. A high LTV is risky and may require GAP insurance. We recommend a down payment of 10-20% to keep your LTV below 100%."
            },
            {
                q: "What is GAP Insurance and do I need it?",
                a: "GAP (Guaranteed Asset Protection) Insurance covers the 'gap' between what you owe on your loan and what your car insurance will pay out if your car is totaled or stolen. You need it if you have a high LTV (e.g., small down payment). Our AI will recommend it if your down payment is below 20%."
            },
            {
                q: "New vs. Used Car: Which loan is better?",
                a: "This calculator can be used for both! Generally, **new car loans** have lower interest rates, but the car depreciates faster. **Used car loans** often have slightly higher rates, but the car's value is more stable. We provide a live average 'Used Car' rate from FRED to help you compare."
            },
            {
                q: "How is sales tax calculated on a car purchase?",
                a: "This calculator assumes the most common method: `(Vehicle Price - Trade-in Value) * Sales Tax Rate %`. Some states have different rules (e.g., taxing the full price regardless of trade-in). This calculator adds the resulting sales tax *to your loan amount*."
            },
            {
                q: "What is an amortization schedule for a car loan?",
                a: "An amortization schedule is a complete breakdown of every payment. It shows how much of your monthly payment goes to **principal** (paying down the loan) and how much goes to **interest** (the cost of the loan). You can see your full schedule in the 'Amortization' tab."
            },
            {
                q: "How do extra payments help pay off a car loan early?",
                a: "When you make an extra payment, 100% of that money goes directly to your **principal balance**. This reduces the loan amount, meaning you pay less interest on all future payments. This calculator will show you exactly how much interest you'll save and how many months you'll shave off your loan."
            },
            {
                q: "What's the difference between interest rate and APR?",
                a: "The **Interest Rate** is the cost of borrowing the money. The **APR (Annual Percentage Rate)** is a broader measure that includes the interest rate *plus* any lender fees. The APR is the more accurate number to use for comparing loan offers."
            },
            {
                q: "Should I get pre-approved for an auto loan?",
                a: "Yes. Getting pre-approved from a bank, credit union, or online lender *before* you go to the dealership is the single best way to save money. It gives you a 'benchmark' rate to compare against the dealership's financing offer and prevents you from being overcharged."
            }
        ];

        // ===== CALCULATOR ENGINE (Adapted for Auto) =====
        class AutoLoanCalculator {
            constructor(inputs) {
                this.inputs = inputs;
                this.results = {};
                this.amortizationSchedule = [];
            }

            // --- (Preserved) ---
            static calculatePayment(principal, rate, numPayments) {
                let payment = 0;
                if (principal > 0 && rate > 0) {
                    payment = principal * (rate * Math.pow(1 + rate, numPayments)) / 
                              (Math.pow(1 + rate, numPayments) - 1);
                } else if (principal > 0 && numPayments > 0) {
                    payment = principal / numPayments;
                }
                return payment;
            }

            calculate() {
                try {
                    this.calculateMonthlyPayment();
                    this.generateAmortizationSchedule(); 
                    this.calculateTotals(); 
                    return this.results;
                } catch (error) {
                    console.error('Calculation error:', error);
                    return null;
                }
            }

            calculateMonthlyPayment() {
                const vehiclePrice = parseFloat(this.inputs.vehiclePrice) || 0;
                const downPaymentVal = parseFloat(this.inputs.downPayment) || 0;
                const tradeInVal = parseFloat(this.inputs.tradeInValue) || 0;
                const taxRate = (parseFloat(this.inputs.salesTaxRate) || 0) / 100;
                const fees = parseFloat(this.inputs.fees) || 0;

                // Sales tax is typically on (Price - Trade-in)
                const taxableAmount = Math.max(0, vehiclePrice - tradeInVal);
                const salesTaxAmount = taxableAmount * taxRate;
                
                // Loan Amount = (Price + Tax + Fees) - (Down Payment + Trade-in)
                const totalCost = vehiclePrice + salesTaxAmount + fees;
                const totalPaidDown = downPaymentVal + tradeInVal;
                const principal = Math.max(0, totalCost - totalPaidDown);

                const rate = (parseFloat(this.inputs.interestRate) || 0) / 100 / 12;
                const numPayments = this.getTotalPayments();

                let payment = AutoLoanCalculator.calculatePayment(principal, rate, numPayments);

                this.results.loanAmount = principal;
                this.results.monthlyPI = payment;
                this.results.monthlyPayment = payment; // For auto loan, P&I is the whole payment
                this.results.downPaymentAmount = downPaymentVal;
                this.results.tradeInValue = tradeInVal;
                this.results.vehiclePrice = vehiclePrice;
                this.results.salesTaxPaid = salesTaxAmount;
                this.results.feesPaid = fees;
                
                // LTV = Loan Amount / Vehicle Price
                const ltv = (vehiclePrice > 0) ? (principal / vehiclePrice) * 100 : 0;
                this.results.ltv = ltv;
            }

            generateAmortizationSchedule(baseline = false) {
                const numPayments = this.getTotalPayments();
                const rate = (parseFloat(this.inputs.interestRate) || 0) / 100 / 12;
                let balance = this.results.loanAmount;
                
                const extraMonthly = baseline ? 0 : (parseFloat(this.inputs.extraMonthly) || 0);
                
                const basePayment = this.results.monthlyPI;

                const schedule = [];
                let totalInterest = 0;
                let totalPrincipal = 0;
                let totalExtra = 0;

                for (let i = 1; i <= numPayments; i++) {
                    if (balance <= 0.01) break; 

                    const interestPayment = balance * rate;
                    let principalPayment = basePayment - interestPayment;
                    
                    let extraPay = extraMonthly;
                    let totalPrincipalPaid = principalPayment + extraPay;
                    
                    if ((balance - totalPrincipalPaid) < 0) {
                        totalPrincipalPaid = balance;
                        principalPayment = totalPrincipalPaid - extraPay;
                        if (principalPayment < 0) {
                             extraPay = totalPrincipalPaid;
                             principalPayment = 0;
                        }
                    }
                    
                    if(balance < (basePayment + extraPay)) {
                        principalPayment = balance;
                        extraPay = 0; 
                        totalPrincipalPaid = principalPayment;
                        balance = 0;
                    } else {
                        balance -= totalPrincipalPaid;
                    }

                    totalInterest += interestPayment;
                    totalPrincipal += principalPayment;
                    totalExtra += extraPay;

                    schedule.push({
                        payment: i,
                        principal: principalPayment,
                        interest: interestPayment,
                        extra: extraPay,
                        balance: balance
                    });

                    if (balance <= 0.01) break;
                }

                if (!baseline) {
                    this.amortizationSchedule = schedule;
                    this.results.totalInterest = totalInterest;
                    this.results.totalPrincipal = totalPrincipal;
                    this.results.totalExtra = totalExtra;
                    this.results.actualPayments = schedule.length;
                }
                
                return {
                    totalInterest: totalInterest,
                    actualPayments: schedule.length,
                    totalPrincipal: totalPrincipal
                };
            }

            calculateTotals() {
                const actualTotalInterest = this.results.totalInterest;
                const actualPayments = this.results.actualPayments;

                const baselineResults = this.generateAmortizationSchedule(true);
                const baselineTotalInterest = baselineResults.totalInterest;
                const baselinePayments = baselineResults.actualPayments;
                
                this.results.interestSaved = baselineTotalInterest - actualTotalInterest;
                this.results.payoffAccel = baselinePayments - actualPayments; // in months
                this.results.baselineTotalInterest = baselineTotalInterest;
                
                // Total Cost = Down Payment + Trade-in + All Payments (which include principal, interest, tax, fees)
                this.results.totalPayments = this.results.downPaymentAmount + this.results.tradeInValue + (this.results.monthlyPI * actualPayments) + (this.inputs.extraMonthly * actualPayments);
            
                let firstYearInterest = 0;
                let firstYearPrincipal = 0;
                const yearSlice = this.amortizationSchedule.slice(0, 12);
                yearSlice.forEach(row => {
                    firstYearInterest += row.interest;
                    firstYearPrincipal += row.principal + row.extra;
                });
                this.results.firstYearInterest = firstYearInterest;
                this.results.firstYearPrincipal = firstYearPrincipal;
            }

            getTotalPayments() {
                // Auto loan uses a select, not custom term
                return parseFloat(document.getElementById('loanTerm').value) || 60;
            }
        }

        // ===== AI INSIGHTS ENGINE (Auto-Loan Specific) =====
        class AIAutoInsightEngine {
            constructor(results, inputs) {
                this.results = results;
                this.inputs = inputs;
            }
            
            generateInsights() {
                const insights = [];
                const { monthlyPayment, interestSaved, payoffAccel, ltv, loanAmount, vehiclePrice, totalInterest } = this.results;
                const { extraMonthly, interestRate, downPaymentAmount } = this.inputs;
                const loanTerm = parseFloat(this.inputs.loanTerm);
                const fmtd = UIManager.formatCurrency; // Helper

                if (!monthlyPayment || monthlyPayment <= 0) {
                     insights.push({
                        title: "ü§ñ AI Auto Advisor",
                        text: `Enter your loan details to generate personalized AI insights and affordability tips.`,
                        type: 'info'
                    });
                    return insights;
                }
                
                // --- Insight 1: 20/4/10 Rule ---
                const downPaymentPercent = (downPaymentAmount / vehiclePrice) * 100;
                let rule20 = downPaymentPercent >= 20;
                let rule4 = loanTerm <= 48;
                
                if (rule20 && rule4) {
                     insights.push({
                        title: "‚úÖ Excellent: 20/4/10 Rule",
                        text: `You're following the **20/4** part of the 20/4/10 rule! Your **${downPaymentPercent.toFixed(0)}% down payment** and **${loanTerm}-month term** will help you avoid negative equity and pay off your car quickly. This is a very smart financial move.`,
                        type: 'success'
                    });
                } else if (loanTerm >= 72) {
                     insights.push({
                        title: "‚ö†Ô∏è High Risk: Long Loan Term",
                        text: `You've selected a **${loanTerm}-month** term. While this lowers your payment to ${fmtd(monthlyPayment, 2)}, you will pay **${fmtd(totalInterest, 0)}** in interest. **AI Warning:** You are at a very high risk of being 'upside-down' (owing more than the car is worth) for several years.`,
                        type: 'error'
                    });
                } else if (downPaymentPercent < 10) {
                     insights.push({
                        title: "‚ö†Ô∏è High Risk: Low Down Payment",
                        text: `Your **${downPaymentPercent.toFixed(0)}% down payment** is below the recommended 20%. **AI Warning:** You will be 'upside-down' on your loan the moment you drive off the lot due to depreciation. This is a high-risk loan.`,
                        type: 'warning'
                    });
                } else {
                     insights.push({
                        title: "üí° AI Affordability Tip (20/4/10 Rule)",
                        text: `This is a reasonable loan. To build equity faster and save on interest, try to follow the **20/4/10 rule**: a **20%** down payment, a loan term of **4** years (48 months), and a total payment under **10%** of your gross income.`,
                        type: 'info'
                    });
                }

                // --- Insight 2: LTV & GAP Insurance ---
                if (ltv > 100) {
                    insights.push({
                        title: "üö® High LTV: GAP Insurance Recommended",
                        text: `Your Loan-to-Value (LTV) is **${ltv.toFixed(0)}%**. This means you are borrowing more than the car's price (due to taxes/fees). **AI Recommendation:** You should purchase **GAP Insurance**. If the car is totaled, your auto insurance will only pay its value, leaving you to pay the 'gap' on the loan.`,
                        type: 'error'
                    });
                } else if (ltv > 90) {
                     insights.push({
                        title: "‚ö†Ô∏è LTV Warning: Consider GAP Insurance",
                        text: `Your LTV is **${ltv.toFixed(0)}%**. You will likely be 'upside-down' for the first 1-2 years. **AI Recommendation:** Ask your lender or insurance agent about **GAP Insurance** to protect yourself from a total loss.`,
                        type: 'warning'
                    });
                }

                // --- Insight 3: High Interest Rate ---
                if (interestRate >= 10) {
                     insights.push({
                        title: "üí∏ High Interest Rate",
                        text: `Your interest rate of **${interestRate}%** is high. This will cost you ${fmtd(totalInterest, 0)} in interest alone. **AI Tip:** Check your credit score. If it's below 700, work on improving it. Get pre-approved quotes from credit unions or our partners *before* going to the dealer.`,
                        type: 'warning'
                    });
                }
                
                // --- Insight 4: Extra Payment Impact ---
                if (interestSaved > 0) {
                    insights.push({
                        title: "üíµ Extra Payment Impact",
                        text: `Your extra **${fmtd(extraMonthly, 2)}/mo** payment will save **${fmtd(interestSaved, 0)}** in interest and you'll pay off your car **${payoffAccel} months earlier!** This is a powerful strategy.`,
                        type: 'success'
                    });
                }
                
                // --- Insight 5: Round Up Tip ---
                if (extraMonthly <= 0 && monthlyPI > 0) {
                    const roundedPayment = Math.ceil(monthlyPI / 25) * 25;
                    const extra = roundedPayment - monthlyPI;
                    if (extra > 1) { 
                        const shadowInputs = {...this.inputs, extraMonthly: extra};
                        const shadowCalc = new AutoLoanCalculator(shadowInputs);
                        const shadowResults = shadowCalc.calculate();
                        if(shadowResults && shadowResults.interestSaved > 10) {
                            insights.push({
                                title: "üí° AI Tip: 'Round Up' Your Payment",
                                text: `Consider "rounding up" your payment from ${fmtd(monthlyPI, 2)} to ${fmtd(roundedPayment, 2)}. That tiny extra **${fmtd(extra, 2)}/mo** would save you **${fmtd(shadowResults.interestSaved, 0)}** in interest and pay off your loan **${shadowResults.payoffAccel} months earlier!**`,
                                type: 'info'
                            });
                        }
                    }
                }

                // --- Insight 6: Total Cost ---
                insights.push({
                    title: "üí∞ Total Cost of Ownership",
                    text: `Remember, the 'price' of this ${fmtd(vehiclePrice, 0)} car isn't just the sticker. Your total cost, including interest, taxes, and fees, will be **${fmtd(this.results.totalPayments, 0)}**. This doesn't include insurance, gas, or maintenance.`,
                    type: 'info'
                });


                return insights;
            }
        }

        // ===== FRED API MANAGER (Adapted for Auto) =====
        class FREDManager {
            
            // (Preserved from mortgage calc)
            static getEasternTimeInfo() {
                const now = new Date();
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const parts = etFormatter.formatToParts(now).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const currentETDate = `${parts.year}-${parts.month.padStart(2, '0')}-${parts.day.padStart(2, '0')}`;
                const currentETHour = parseInt(parts.hour, 10);
                const currentETMinute = parseInt(parts.minute, 10);
                
                const isAfterCutoff = (currentETHour > 16) || (currentETHour === 16 && currentETMinute >= 45); // 4:45 PM ET

                return { currentETDate, isAfterCutoff, now };
            }

            // (Preserved from mortgage calc)
            static isCacheValid(cache) {
                const { lastFetch } = cache;
                if (!lastFetch) return false;

                const { currentETDate, isAfterCutoff } = this.getEasternTimeInfo();

                const lastFetchDate = new Date(lastFetch);
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const lastFetchParts = etFormatter.formatToParts(lastFetchDate).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const lastFetchETDate = `${lastFetchParts.year}-${lastFetchParts.month.padStart(2, '0')}-${lastFetchParts.day.padStart(2, '0')}`;
                const lastFetchHour = parseInt(lastFetchParts.hour, 10);
                const lastFetchMinute = parseInt(lastFetchParts.minute, 10);
                const wasLastFetchAfterCutoff = (lastFetchHour > 16) || (lastFetchHour === 16 && lastFetchMinute >= 45);

                if (currentETDate !== lastFetchETDate) {
                    if (isAfterCutoff) return false; 
                    if (wasLastFetchAfterCutoff) return true;
                    return false;
                }
                if (!wasLastFetchAfterCutoff && isAfterCutoff) return false;
                return true;
            }

            // (Preserved from mortgage calc)
            static formatTimestamp(now) {
                return new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    dateStyle: 'short',
                    timeStyle: 'short'
                }).format(now) + " ET";
            }

            // (Preserved from mortgage calc)
            static async fetchFredSeries(seriesId) {
                try {
                    const url = `${FRED_URL}?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json&sort_order=desc&limit=1`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`FRED API request failed for ${seriesId}: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.observations && data.observations.length > 0) {
                        const rate = parseFloat(data.observations[0].value);
                        const date = data.observations[0].date;
                        if (isNaN(rate)) return { rate: null, date: null };
                        return { rate, date };
                    }
                } catch (error) {
                    console.error(error);
                }
                return { rate: null, date: null };
            }

            // --- HEAVILY ADAPTED for Auto Loan ---
            static async getRates() {
                const cacheStr = localStorage.getItem('autoLoanRatesCache'); // New cache key
                let cache = cacheStr ? JSON.parse(cacheStr) : null;
                
                const { now } = this.getEasternTimeInfo();

                if (cache && this.isCacheValid(cache)) {
                    console.log('Using cached FRED auto rates');
                    return {
                        ...cache,
                        isCache: true,
                        lastUpdatedTimestamp: `Rates as of ${this.formatTimestamp(new Date(cache.lastFetch))}`
                    };
                }

                console.log('Fetching new FRED auto rates');
                
                // Fetch all 3 auto series concurrently
                const [data60, data48, dataUsed] = await Promise.all([
                    this.fetchFredSeries(FRED_SERIES_IDS.rate60),
                    this.fetchFredSeries(FRED_SERIES_IDS.rate48),
                    this.fetchFredSeries(FRED_SERIES_IDS.rateUsed)
                ]);

                const newRates = {
                    rate60: data60.rate || FALLBACK_RATES.rates.rate60,
                    rate48: data48.rate || FALLBACK_RATES.rates.rate48,
                    rateUsed: dataUsed.rate || FALLBACK_RATES.rates.rateUsed,
                };

                const newDates = {
                    date60: data60.date || null,
                    date48: data48.date || null,
                    dateUsed: dataUsed.date || null,
                };

                const newCache = {
                    rates: newRates,
                    dates: newDates,
                    lastFetch: now.toISOString()
                };

                localStorage.setItem('autoLoanRatesCache', JSON.stringify(newCache));

                return {
                    ...newCache,
                    isCache: false,
                    lastUpdatedTimestamp: `Live Rates updated: ${this.formatTimestamp(now)}`
                };
            }
        }

        // ===== UI MANAGER (Adapted for Auto) =====
        class UIManager {
            static formatCurrency(value, decimals = 0) {
                if (typeof value !== 'number' || isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(value);
            }
            static formatPercent(value) { return (value).toFixed(1) + '%'; } 

            static updateResults(results) {
                 document.getElementById('monthly-payment').textContent = this.formatCurrency(results.monthlyPayment, 2);
                 const breakdownStr = `Principal & Interest: ${this.formatCurrency(results.monthlyPI, 2)}`;
                 document.getElementById('payment-breakdown').textContent = breakdownStr;
                 
                 // Analysis Tab
                 document.getElementById('loanAmount').textContent = this.formatCurrency(results.loanAmount);
                 document.getElementById('totalInterest').textContent = this.formatCurrency(results.totalInterest);
                 document.getElementById('totalPayments').textContent = this.formatCurrency(results.totalPayments);
                 document.getElementById('salesTaxPaid').textContent = this.formatCurrency(results.salesTaxPaid);
                 document.getElementById('feesPaid').textContent = this.formatCurrency(results.feesPaid);
                 document.getElementById('ltv').textContent = this.formatPercent(results.ltv);
                 document.getElementById('interestSaved').textContent = this.formatCurrency(results.interestSaved);
                 document.getElementById('payoffAccel').textContent = `${results.payoffAccel} months`;
                 
                 document.getElementById('ltv').parentElement.className = results.ltv > 100 ? 'result-box error' : (results.ltv > 90 ? 'result-box accent' : 'result-box');
                 document.getElementById('interestSavedBox').style.display = results.interestSaved > 0 ? 'block' : 'none';
                 document.getElementById('payoffAccelBox').style.display = results.payoffAccel > 0 ? 'block' : 'none';
            }

            // --- NEW: Fills the comparison table ---
            static updateComparisonTable(inputs) {
                const tableBody = document.getElementById('comparisonTableBody');
                tableBody.innerHTML = '';
                const termsToCompare = [36, 48, 60, 72, 84];
                const currentTerm = parseFloat(inputs.loanTerm);

                termsToCompare.forEach(term => {
                    const tempInputs = {...inputs, loanTerm: term.toString(), extraMonthly: '0'};
                    const calc = new AutoLoanCalculator(tempInputs);
                    const result = calc.calculate();
                    
                    if (result) {
                        const row = document.createElement('tr');
                        if (term === currentTerm) {
                            row.style.fontWeight = 'bold';
                            row.style.background = 'var(--bg-secondary)';
                        }
                        row.innerHTML = `
                            <td>${term} Months</td>
                            <td>${this.formatCurrency(result.monthlyPayment, 2)}</td>
                            <td>${this.formatCurrency(result.totalInterest, 0)}</td>
                            <td>${this.formatCurrency(result.totalPayments, 0)}</td>
                        `;
                        tableBody.appendChild(row);
                    }
                });
            }

            // (Adapted from mortgage calc)
            static updateAmortizationTable(schedule, view = 'monthly') {
                const thead = document.getElementById('amortizationThead');
                const tbody = document.getElementById('amortizationTable');
                tbody.innerHTML = '';
                thead.innerHTML = '';

                if (!schedule || schedule.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 12px; text-align: center; color: var(--text-light);">No schedule to display.</td></tr>';
                    return;
                }

                if (view === 'monthly') {
                    thead.innerHTML = `
                        <tr>
                            <th>Month</th>
                            <th>Total Payment</th>
                            <th>Principal</th>
                            <th>Interest</th>
                            <th>Extra Payment</th>
                            <th>Balance</th>
                        </tr>
                    `;
                    const rowsToShow = schedule.length > 120 ? 120 : schedule.length;
                    for (let i = 0; i < rowsToShow; i++) {
                        tbody.appendChild(this.createAmortRow(schedule[i]));
                    }
                    if (schedule.length > 120) {
                         tbody.innerHTML += `<tr><td colspan="6" style="text-align: center; padding: 10px; background: var(--bg-secondary); font-weight: bold;">...</td></tr>`;
                         tbody.appendChild(this.createAmortRow(schedule[schedule.length - 1]));
                    }
                } else { // Yearly view
                    thead.innerHTML = `
                        <tr>
                            <th>Year</th>
                            <th>Total Paid</th>
                            <th>Principal Paid</th>
                            <th>Interest Paid</th>
                            <th>Extra Paid</th>
                            <th>Ending Balance</th>
                        </tr>
                    `;
                    for (let y = 0; y < schedule.length / 12; y++) {
                        const yearSlice = schedule.slice(y * 12, (y + 1) * 12);
                        if (yearSlice.length === 0) continue;

                        const yearSummary = yearSlice.reduce((acc, row) => {
                            acc.principal += row.principal;
                            acc.interest += row.interest;
                            acc.extra += row.extra;
                            return acc;
                        }, { payment: y + 1, principal: 0, interest: 0, extra: 0, balance: yearSlice[yearSlice.length - 1].balance });
                        
                        tbody.appendChild(this.createAmortRow(yearSummary, 'yearly'));
                    }
                }
            }
            
            // (Preserved from mortgage calc)
            static createAmortRow(row, view = 'monthly') {
                const tr = document.createElement('tr');
                const totalPayment = row.principal + row.interest + row.extra;
                if (view === 'monthly') {
                    tr.innerHTML = `
                        <td>${row.payment}</td>
                        <td>${this.formatCurrency(totalPayment, 2)}</td>
                        <td>${this.formatCurrency(row.principal, 2)}</td>
                        <td>${this.formatCurrency(row.interest, 2)}</td>
                        <td>${this.formatCurrency(row.extra, 2)}</td>
                        <td>${this.formatCurrency(row.balance, 2)}</td>
                    `;
                } else { // Yearly
                     tr.innerHTML = `
                        <td>${row.payment}</td>
                        <td>${this.formatCurrency(totalPayment, 2)}</td>
                        <td>${this.formatCurrency(row.principal, 2)}</td>
                        <td>${this.formatCurrency(row.interest, 2)}</td>
                        <td>${this.formatCurrency(row.extra, 2)}</td>
                        <td>${this.formatCurrency(row.balance, 2)}</td>
                    `;
                }
                return tr;
            }

            // (Preserved from mortgage calc)
            static updateInsights(insights) {
                const container = document.getElementById('insightsContainer');
                container.innerHTML = '';
                if(!insights || insights.length === 0) {
                     container.innerHTML = '<div class="insight-box"><strong>ü§ñ AI Auto Advisor:</strong> Enter valid loan details to generate personalized insights...</div>';
                     return;
                }
                insights.forEach(insight => {
                    const box = document.createElement('div');
                    box.className = `insight-box ${insight.type}`; // Types: info, success, warning, error
                    box.innerHTML = `<strong>${insight.title}:</strong> ${insight.text}`;
                    container.appendChild(box);
                });
            }
        }

        // ===== CHART MANAGER (Adapted for Auto) =====
        class ChartManager {
            static charts = {};

            // (Preserved from mortgage calc)
            static registerPlugins() {
                if (Chart.registerables) { 
                    if (typeof ChartDataLabels !== 'undefined') {
                        Chart.register(ChartDataLabels);
                    }
                }
            }

            // --- REWRITTEN for Auto Loan Total Cost ---
            static renderTotalCostChart(results) {
                const ctx = document.getElementById('paymentBreakdownChart').getContext('2d');
                if (!ctx) return;
                if (this.charts.paymentBreakdown) this.charts.paymentBreakdown.destroy();
                
                // Use net vehicle price for chart
                const netPrice = results.vehiclePrice - results.tradeInValue - results.downPaymentAmount;
                
                const data = [
                    results.downPaymentAmount + results.tradeInValue, // Total Down
                    netPrice, // Net Principal
                    results.totalInterest,
                    results.salesTaxPaid,
                    results.feesPaid
                ];
                const total = data.reduce((a, b) => a + b, 0);
                const allZero = total === 0;

                this.charts.paymentBreakdown = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Down Payment & Trade-in', 'Net Principal', 'Total Interest', 'Sales Tax', 'Fees'],
                        datasets: [{
                            data: allZero ? [1] : data, 
                            backgroundColor: allZero ? ['#E2E8F0'] : ['#10B981', '#24ACB9', '#FFC107', '#EF4444', '#3B82F6'], // Brand colors
                            borderColor: 'var(--card)',
                            borderWidth: 3, 
                            hoverOffset: 10 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    color: 'var(--text-light)', 
                                    font: { size: 13 } 
                                } 
                            },
                            datalabels: {
                                display: (context) => {
                                    const value = context.dataset.data[context.dataIndex];
                                    return !allZero && (value / total) > 0.05; // Only show for slices > 5%
                                },
                                color: '#fff',
                                font: { weight: 'bold', size: 12 },
                                formatter: (value) => {
                                    return ((value / total) * 100).toFixed(0) + '%';
                                }
                            },
                            tooltip: {
                                 callbacks: {
                                    label: function(context) {
                                        if(allZero) return ' No data';
                                        let label = context.label || '';
                                        let value = context.raw;
                                        let percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${UIManager.formatCurrency(value, 2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- RENAMED but logic is identical to mortgage calc ---
            static renderLoanOverTimeChart(schedule) {
                const ctx = document.getElementById('loanOverTimeChart').getContext('2d');
                if (!ctx) return;
                if (this.charts.loanOverTime) this.charts.loanOverTime.destroy();
                if(!schedule || schedule.length === 0) return;

                const years = Math.ceil(schedule.length / 12);
                const yearlyLabels = [];
                const yearlyData = []; // Store full data for summary
                
                for (let y = 0; y < years; y++) {
                    const yearSlice = schedule.slice(y * 12, (y + 1) * 12);
                    if(yearSlice.length === 0) continue;
                    
                    const yearInterest = yearSlice.reduce((acc, row) => acc + row.interest, 0);
                    const yearPrincipal = yearSlice.reduce((acc, row) => acc + row.principal + row.extra, 0);
                    const yearBalance = yearSlice[yearSlice.length - 1].balance;

                    yearlyLabels.push(`Year ${y + 1}`);
                    yearlyData.push({
                        label: `Year ${y + 1}`,
                        interest: yearInterest,
                        principal: yearPrincipal,
                        balance: yearBalance
                    });
                }
                
                app.lastYearlyData = yearlyData;

                this.charts.loanOverTime = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: yearlyLabels,
                        datasets: [
                            {
                                label: 'Yearly Interest Paid',
                                data: yearlyData.map(d => d.interest),
                                backgroundColor: 'rgba(255, 193, 7, 0.2)', // Accent (Yellow)
                                borderColor: 'rgba(255, 193, 7, 1)',
                                fill: 'start',
                                type: 'bar', 
                                order: 2
                            },
                            {
                                label: 'Yearly Principal Paid',
                                data: yearlyData.map(d => d.principal),
                                backgroundColor: 'rgba(36, 172, 185, 0.2)', // Primary (Teal)
                                borderColor: 'rgba(36, 172, 185, 1)',
                                fill: 'start',
                                type: 'bar', 
                                order: 3
                            },
                             {
                                label: 'Loan Balance',
                                data: yearlyData.map(d => d.balance),
                                borderColor: 'rgba(239, 68, 68, 1)', // Error (Red)
                                backgroundColor: 'transparent',
                                borderWidth: 3,
                                borderDash: [5, 5],
                                pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                                fill: false,
                                type: 'line',
                                order: 1,
                                yAxisID: 'y1' // Assign to secondary axis
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                stacked: true, 
                                ticks: { color: 'var(--text-light)' }, 
                                grid: { display: false } 
                            },
                            y: { // Primary axis (P&I)
                                stacked: true, 
                                beginAtZero: true, 
                                ticks: { color: 'var(--text-light)', callback: (val) => `$${val/1000}k` }, 
                                grid: { color: 'var(--border)' },
                                position: 'left',
                                title: { display: true, text: 'Yearly P&I Paid ($)', color: 'var(--text-light)' }
                            },
                            y1: { // Secondary axis (Balance)
                                beginAtZero: false,
                                position: 'right',
                                ticks: { color: 'var(--text-light)', callback: (val) => `$${val/1000}k` },
                                grid: { display: false }, 
                                title: { display: true, text: 'Remaining Loan Balance ($)', color: 'var(--text-light)' }
                            }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { color: 'var(--text-light)' } },
                             tooltip: {
                                 mode: 'index',
                                 intersect: false,
                                 callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        let value = context.raw;
                                        return `${label}: ${UIManager.formatCurrency(value, 0)}`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                const slider = document.getElementById('year-slider');
                slider.max = yearlyLabels.length || 1;
                slider.value = 1;
                app.updateChartSummary(1);
            }
        }

        // ===== MAIN APP (Controller - Adapted for Auto) =====
        const app = {
            calculateDebounce: null,
            lastResults: null,
            lastSchedule: null,
            lastYearlyData: [], 
            state: {
                amortizationView: 'monthly', 
                isTtsEnabled: false,
                liveRates: FALLBACK_RATES.rates
            },

            async init() {
                this.setupEventListeners();
                this.setupDarkMode();
                this.setupPWA();
                this.setupVoiceControls();
                this.setupFAQ();
                this.initTooltips(); 
                this.setupTabs();
                this.setupAlertModal();
                this.setupCookieConsent();
                ChartManager.registerPlugins(); 
                await this.loadInitialRates();
            },

            setupEventListeners() {
                // Auto Loan Inputs
                ['vehiclePrice', 'interestRate', 'loanTerm', 'tradeInValue',
                 'salesTaxRate', 'fees', 'extraMonthly'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.debouncedCalculate());
                        el.addEventListener('change', () => this.debouncedCalculate());
                    }
                });
                
                // Synced Down Payment Listeners
                document.getElementById('downPaymentAmount').addEventListener('input', (e) => this.syncDownPayment('amount', e.target.value));
                document.getElementById('downPaymentPercent').addEventListener('input', (e) => this.syncDownPayment('percent', e.target.value));
                document.getElementById('vehiclePrice').addEventListener('input', () => this.syncDownPayment('amount', document.getElementById('downPaymentAmount').value));
                
                // Amortization Controls
                document.getElementById('amortToggle').addEventListener('click', () => this.toggleAmortizationView());
                document.getElementById('exportCsv').addEventListener('click', () => this.exportAmortizationToCsv());
                
                // Chart Summary Slider
                document.getElementById('year-slider').addEventListener('input', (e) => this.updateChartSummary(e.target.value));

                // Live Rate Button Listeners (Auto Loan Specific)
                document.getElementById('rate-btn-60mo').addEventListener('click', () => {
                    this.applyRate(this.state.liveRates.rate60, 'rate-btn-60mo');
                    document.getElementById('loanTerm').value = '60';
                });
                document.getElementById('rate-btn-48mo').addEventListener('click', () => {
                    this.applyRate(this.state.liveRates.rate48, 'rate-btn-48mo');
                    document.getElementById('loanTerm').value = '48';
                });
                document.getElementById('rate-btn-used').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rateUsed, 'rate-btn-used'));
            },

            applyRate(rate, btnId) {
                if (!rate) return;
                
                document.getElementById('interestRate').value = rate.toFixed(2);
                document.querySelectorAll('.rate-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(btnId).classList.add('active');
                
                this.calculate();
            },

            // (Preserved from mortgage calc)
            setupTabs() {
                const tablist = document.querySelector('[role="tablist"]');
                const tabs = tablist.querySelectorAll('[role="tab"]');
                
                tablist.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('[role="tab"]');
                    if (!clickedTab) return;
                    this.activateTab(clickedTab);
                });

                tablist.addEventListener('keydown', (e) => {
                    let index = Array.from(tabs).indexOf(document.activeElement);
                    if (index === -1) return;

                    let direction = 0;
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        direction = 1;
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        direction = -1;
                    } else if (e.key === 'Home') {
                        e.preventDefault();
                        tabs[0].focus();
                    } else if (e.key === 'End') {
                        e.preventDefault();
                        tabs[tabs.length - 1].focus();
                    }

                    if (direction !== 0) {
                        e.preventDefault();
                        index = (index + direction + tabs.length) % tabs.length;
                        tabs[index].focus();
                    }
                });
            },

            // (Preserved from mortgage calc)
            activateTab(tab) {
                const tabId = tab.getAttribute('aria-controls');
                
                document.querySelectorAll('[role="tab"]').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                    t.setAttribute('tabindex', '-1');
                });
                document.querySelectorAll('[role="tabpanel"]').forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                tab.setAttribute('tabindex', '0');

                const panel = document.getElementById(tabId);
                panel.classList.add('active');
                panel.style.display = 'block';

                // Render charts if switching to their tabs
                if (tabId === 'analysis' && this.lastResults) {
                    setTimeout(() => ChartManager.renderTotalCostChart(this.lastResults), 50);
                }
                if (tabId === 'charts' && this.lastSchedule) {
                    setTimeout(() => ChartManager.renderLoanOverTimeChart(this.lastSchedule), 50);
                }
            },
            
            // (Adapted for vehicle price)
            syncDownPayment(source, value) {
                const price = parseFloat(document.getElementById('vehiclePrice').value) || 0;
                const amountEl = document.getElementById('downPaymentAmount');
                const percentEl = document.getElementById('downPaymentPercent');

                if (price > 0) {
                    if (source === 'amount') {
                        const amount = parseFloat(value) || 0;
                        percentEl.value = ((amount / price) * 100).toFixed(1);
                    } else { // source === 'percent'
                        const percent = parseFloat(value) || 0;
                        amountEl.value = (price * (percent / 100)).toFixed(0);
                    }
                }
                this.debouncedCalculate();
            },

            // (Preserved from mortgage calc)
            debouncedCalculate() {
                clearTimeout(this.calculateDebounce);
                this.calculateDebounce = setTimeout(() => this.calculate(), 250);
            },

            async calculate() {
                const inputs = {
                    vehiclePrice: document.getElementById('vehiclePrice').value,
                    downPayment: document.getElementById('downPaymentAmount').value, 
                    tradeInValue: document.getElementById('tradeInValue').value,
                    interestRate: document.getElementById('interestRate').value,
                    loanTerm: document.getElementById('loanTerm').value,
                    salesTaxRate: document.getElementById('salesTaxRate').value,
                    fees: document.getElementById('fees').value,
                    extraMonthly: document.getElementById('extraMonthly').value,
                };

                const calculator = new AutoLoanCalculator(inputs);
                const results = calculator.calculate();

                if (results) {
                    this.lastResults = results;
                    this.lastSchedule = calculator.amortizationSchedule;

                    UIManager.updateResults(results);
                    UIManager.updateAmortizationTable(this.lastSchedule, this.state.amortizationView);
                    UIManager.updateComparisonTable(inputs); // NEW

                    const aiEngine = new AIAutoInsightEngine(results, inputs);
                    const insights = aiEngine.generateInsights();
                    UIManager.updateInsights(insights);

                    if (this.state.isTtsEnabled) {
                        this.speakResults();
                    }

                    // Refresh chart if tab is active
                    const activeTabId = document.querySelector('[role="tab"][aria-selected="true"]').getAttribute('aria-controls');
                    if (activeTabId === 'analysis') {
                        setTimeout(() => ChartManager.renderTotalCostChart(this.lastResults), 50);
                    } else if (activeTabId === 'charts') {
                        setTimeout(() => ChartManager.renderLoanOverTimeChart(this.lastSchedule), 50);
                    }
                }
            },
            
            // (Preserved from mortgage calc)
            updateChartSummary(year) {
                const yearIndex = parseInt(year) - 1;
                if (!this.lastYearlyData || !this.lastYearlyData[yearIndex]) return;

                const data = this.lastYearlyData[yearIndex];

                document.getElementById('slider-year-label').textContent = year;
                document.getElementById('summary-principal-paid').textContent = UIManager.formatCurrency(data.principal, 2);
                document.getElementById('summary-interest-paid').textContent = UIManager.formatCurrency(data.interest, 2);
                document.getElementById('summary-remaining-balance').textContent = UIManager.formatCurrency(data.balance, 2);
            },

            // (Preserved from mortgage calc)
            initTooltips() {
                let tooltipBox = null;
                document.querySelectorAll('.tooltip').forEach(el => {
                    const showTooltip = (e) => {
                        const text = e.currentTarget.getAttribute('data-tooltip');
                        if (!text) return;
                        if (tooltipBox) tooltipBox.remove();
                        
                        tooltipBox = document.createElement('div');
                        tooltipBox.className = 'tooltip-box';
                        tooltipBox.textContent = text;
                        tooltipBox.setAttribute('role', 'tooltip');
                        document.body.appendChild(tooltipBox);

                        const rect = e.currentTarget.getBoundingClientRect();
                        let top = rect.top - tooltipBox.offsetHeight - 5;
                        let left = rect.left + rect.width / 2 - tooltipBox.offsetWidth / 2;

                        if (top < 0) { top = rect.bottom + 5; }
                        if (left < 0) { left = 5; }
                        if (left + tooltipBox.offsetWidth > window.innerWidth) {
                            left = window.innerWidth - tooltipBox.offsetWidth - 5;
                        }

                        tooltipBox.style.left = `${left}px`;
                        tooltipBox.style.top = `${top}px`;
                        tooltipBox.style.display = 'block';
                        setTimeout(() => { if (tooltipBox) tooltipBox.style.opacity = '1'; }, 10);
                    };

                    const hideTooltip = () => {
                        if (tooltipBox) {
                            tooltipBox.style.opacity = '0';
                            setTimeout(() => {
                                if (tooltipBox) {
                                    tooltipBox.remove();
                                    tooltipBox = null;
                                }
                            }, 200);
                        }
                    };

                    el.addEventListener('mouseenter', showTooltip);
                    el.addEventListener('focus', showTooltip);
                    el.addEventListener('mouseleave', hideTooltip);
                    el.addEventListener('blur', hideTooltip);
                });
            },

            // (Preserved from mortgage calc)
            toggleAmortizationView() {
                const btn = document.getElementById('amortToggle');
                if (this.state.amortizationView === 'monthly') {
                    this.state.amortizationView = 'yearly';
                    btn.textContent = 'Show Monthly';
                } else {
                    this.state.amortizationView = 'monthly';
                    btn.textContent = 'Show Yearly';
                }
                UIManager.updateAmortizationTable(this.lastSchedule, this.state.amortizationView);
            },

            // (Preserved from mortgage calc)
            exportAmortizationToCsv() {
                if (!this.lastSchedule || this.lastSchedule.length === 0) return;

                let csvContent = "data:text/csv;charset=utf-8,";
                let rows = [];
                const view = this.state.amortizationView;

                if (view === 'monthly') {
                    rows.push(["Month", "Total Payment", "Principal", "Interest", "Extra Payment", "Balance"]);
                    this.lastSchedule.forEach(row => {
                        rows.push([
                            row.payment,
                            (row.principal + row.interest + row.extra).toFixed(2),
                            row.principal.toFixed(2),
                            row.interest.toFixed(2),
                            row.extra.toFixed(2),
                            row.balance.toFixed(2)
                        ]);
                    });
                } else { // Yearly
                    rows.push(["Year", "Total Paid", "Principal Paid", "Interest Paid", "Extra Paid", "Ending Balance"]);
                    for (let y = 0; y < this.lastSchedule.length / 12; y++) {
                        const yearSlice = this.lastSchedule.slice(y * 12, (y + 1) * 12);
                        if (yearSlice.length === 0) continue;
                        
                        const yearSummary = yearSlice.reduce((acc, row) => {
                            acc.principal += row.principal;
                            acc.interest += row.interest;
                            acc.extra += row.extra;
                            return acc;
                        }, { principal: 0, interest: 0, extra: 0 });
                        
                        const totalPaid = yearSummary.principal + yearSummary.interest + yearSummary.extra;
                        rows.push([
                            y + 1,
                            totalPaid.toFixed(2),
                            yearSummary.principal.toFixed(2),
                            yearSummary.interest.toFixed(2),
                            yearSummary.extra.toFixed(2),
                            yearSlice[yearSlice.length - 1].balance.toFixed(2)
                        ]);
                    }
                }
                
                rows.forEach(rowArray => {
                    let row = rowArray.join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `auto_loan_schedule_${view}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            // --- ADAPTED for Auto Loan ---
            async loadInitialRates() {
                const updatedEl = document.getElementById('fred-last-updated');
                const rateEl = document.getElementById('interestRate');
                
                const btn60 = document.getElementById('rate-btn-60mo');
                const btn48 = document.getElementById('rate-btn-48mo');
                const btnUsed = document.getElementById('rate-btn-used');

                try {
                    const { rates, lastUpdatedTimestamp } = await FREDManager.getRates();
                    
                    this.state.liveRates = rates;

                    updatedEl.textContent = lastUpdatedTimestamp;
                    updatedEl.style.color = "var(--text-light)";

                    btn60.textContent = `New 60-Mo: ${rates.rate60.toFixed(2)}%`;
                    btn48.textContent = `New 48-Mo: ${rates.rate48.toFixed(2)}%`;
                    btnUsed.textContent = `Used Avg: ${rates.rateUsed.toFixed(2)}%`;
                    
                    btn60.disabled = false;
                    btn48.disabled = false;
                    btnUsed.disabled = false;
                    
                    // Default to 60-month rate
                    rateEl.value = rates.rate60.toFixed(2);
                    btn60.classList.add('active');
                    document.getElementById('loanTerm').value = '60';


                } catch (error) {
                    console.error("Error loading initial auto rates:", error);
                    updatedEl.textContent = 'Error loading rates. Using fallbacks.';
                    updatedEl.style.color = "var(--error)";
                    this.state.liveRates = FALLBACK_RATES.rates;
                    btn60.textContent = `New 60-Mo: ${this.state.liveRates.rate60.toFixed(2)}%`;
                    btn48.textContent = `New 48-Mo: ${this.state.liveRates.rate48.toFixed(2)}%`;
                    btnUsed.textContent = `Used Avg: ${this.state.liveRates.rateUsed.toFixed(2)}%`;
                }
                
                this.calculate(); // Use calculate() for instant load
            },

            // (Preserved from mortgage calc)
            setupDarkMode() {
                const toggle = document.getElementById('darkModeToggle');
                const scheme = localStorage.getItem('colorScheme') || 'light';
                document.documentElement.setAttribute('data-color-scheme', scheme);
                
                toggle.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-color-scheme');
                    const next = current === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-color-scheme', next);
                    localStorage.setItem('colorScheme', next);
                    
                    // Force chart redraw on theme change
                    const activeTabId = document.querySelector('[role="tab"][aria-selected="true"]').getAttribute('aria-controls');
                    this.activateTab(document.getElementById(`tab-${activeTabId}`));
                });
            },

            // (Preserved from mortgage calc)
            setupPWA() {
                const pwaBtn = document.getElementById('pwa-install-btn');
                if (pwaBtn) {
                    pwaBtn.addEventListener('click', async () => {
                        if (window.deferredPrompt) {
                            window.deferredPrompt.prompt();
                            const { outcome } = await window.deferredPrompt.userChoice;
                            if (outcome === 'accepted') console.log('User accepted the PWA install prompt');
                            window.deferredPrompt = null;
                        }
                    });
                }
            },

            // (Preserved from mortgage calc)
            setupVoiceControls() {
                const voiceBtn = document.getElementById('voiceToggle');
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = () => { 
                        voiceBtn.classList.add('active'); 
                        voiceBtn.title = 'Listening...';
                    };
                    recognition.onend = () => { 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.title = 'Voice commands'; 
                    };
                    recognition.onerror = (event) => { 
                        console.error('Voice recognition error', event.error); 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.title = 'Voice commands'; 
                    };

                    recognition.onresult = (event) => {
                        const command = event.results[0][0].transcript.toLowerCase();
                        console.log('Voice command:', command);
                        // --- Auto Loan Voice Commands ---
                        if (command.includes('calculate')) this.calculate();
                        else if (command.includes('read results') || command.includes('what is the payment')) this.speakResults();
                        else if (command.includes('read insights') || command.includes('read advice')) this.speakInsights();
                        else if (command.includes('set price to')) {
                            const price = command.match(/(\d[\d,]*)/);
                            if(price) document.getElementById('vehiclePrice').value = price[0].replace(/,/g, '');
                            this.calculate();
                        }
                        else if (command.includes('set term to 60') || command.includes('set term to 5 years')) {
                            document.getElementById('loanTerm').value = '60';
                            this.calculate();
                        }
                        else if (command.includes('set term to 72') || command.includes('set term to 6 years')) {
                            document.getElementById('loanTerm').value = '72';
                            this.calculate();
                        }
                        else if (command.includes('set term to 48') || command.includes('set term to 4 years')) {
                            document.getElementById('loanTerm').value = '48';
                            this.calculate();
                        }
                    };
                    voiceBtn.addEventListener('click', () => { try { recognition.start(); } catch(e) { console.error("Voice recognition error", e); } });
                } else {
                     voiceBtn.title = 'Voice control not supported in this browser.';
                     voiceBtn.style.opacity = '0.5';
                     voiceBtn.disabled = true;
                }
                
                const ttsBtn = document.getElementById('ttsToggle');
                ttsBtn.addEventListener('click', () => {
                    this.state.isTtsEnabled = !this.state.isTtsEnabled;

                    if (this.state.isTtsEnabled) {
                        ttsBtn.classList.add('active'); 
                        this.speakResults(); 
                    } else {
                        ttsBtn.classList.remove('active'); 
                        if ('speechSynthesis' in window && speechSynthesis.speaking) {
                            speechSynthesis.cancel(); 
                        }
                    }
                });
            },

            // (Adapted for Auto)
            speakResults() {
                if ('speechSynthesis' in window && this.lastResults) {
                    speechSynthesis.cancel();
                    const text = `Your estimated monthly car payment is ${UIManager.formatCurrency(this.lastResults.monthlyPayment, 2)}.`;
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                }
            },
            
            // (Preserved from mortgage calc)
            speakInsights() {
                 if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const insightsContainer = document.getElementById('insightsContainer');
                    const firstInsight = insightsContainer.querySelector('.insight-box');
                    if(firstInsight) {
                        const text = firstInsight.textContent;
                        const utterance = new SpeechSynthesisUtterance(text);
                        speechSynthesis.speak(utterance);
                    }
                }
            },

            // (Preserved from mortgage calc)
            setupFAQ() {
                const container = document.getElementById('faqContainer');
                if(!container) return;

                FAQs.forEach((faq, index) => {
                    const qId = `faq-q-${index}`;
                    const aId = `faq-a-${index}`;
                    
                    const item = document.createElement('div');
                    item.className = 'faq-item';
                    item.innerHTML = `
                        <div class="faq-question" role="button" tabindex="0" aria-expanded="false" aria-controls="${aId}" id="${qId}">
                            <span>${faq.q}</span>
                            <span class="faq-icon" aria-hidden="true">‚ñº</span>
                        </div>
                        <div class="faq-answer" role="region" aria-labelledby="${qId}" id="${aId}">${faq.a}</div>
                    `;
                    container.appendChild(item);
                });
                
                container.addEventListener('click', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question) this.toggleFAQ(question);
                });
                
                container.addEventListener('keydown', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question && (e.key === 'Enter' || e.key === ' ')) {
                        e.preventDefault();
                        this.toggleFAQ(question);
                    }
                });
            },
            
            // (Preserved from mortgage calc)
            toggleFAQ(question) {
                const answer = document.getElementById(question.getAttribute('aria-controls'));
                const isActive = question.getAttribute('aria-expanded') === 'true';

                // Deactivate all others
                document.querySelectorAll('.faq-question[aria-expanded="true"]').forEach(q => {
                    if (q !== question) {
                        q.setAttribute('aria-expanded', 'false');
                        q.classList.remove('active');
                        document.getElementById(q.getAttribute('aria-controls')).style.display = 'none';
                        q.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                    }
                });

                if (!isActive) {
                    question.setAttribute('aria-expanded', 'true');
                    question.classList.add('active');
                    answer.style.display = 'block';
                    answer.style.animation = 'slideDown 0.3s ease';
                    question.querySelector('.faq-icon').style.transform = 'rotate(180deg)';
                } else {
                    question.setAttribute('aria-expanded', 'false');
                    question.classList.remove('active');
                    answer.style.display = 'none';
                    question.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                }
            },

            // (Preserved from mortgage calc)
            setupCookieConsent() {
                const banner = document.getElementById('cookie-consent-banner');
                const btn = document.getElementById('cookie-consent-btn');
                
                if (localStorage.getItem('cookieConsent') === 'true') {
                    banner.style.display = 'none';
                } else {
                    banner.style.display = 'flex';
                }
                
                btn.addEventListener('click', () => {
                    localStorage.setItem('cookieConsent', 'true');
                    banner.style.display = 'none';
                });
            },
            
            // (Preserved from mortgage calc)
            setupAlertModal() {
                const modal = document.getElementById('alert-modal');
                const backdrop = document.getElementById('alert-modal-backdrop');
                const closeBtn = document.getElementById('alert-modal-close');
                
                const closeModal = () => {
                    modal.classList.remove('visible');
                    backdrop.classList.remove('visible');
                };

                closeBtn.addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            },
            
            // (Preserved from mortgage calc)
            showAlert(title, message) {
                document.getElementById('alert-modal-title').textContent = title;
                document.getElementById('alert-modal-body').textContent = message;
                document.getElementById('alert-modal').classList.add('visible');
                document.getElementById('alert-modal-backdrop').classList.add('visible');
                document.getElementById('alert-modal-close').focus();
            },
            
            // (Preserved from mortgage calc)
            showPartnerAlert(partnerName) {
                this.showAlert(
                    'Affiliate Partner Link',
                    `This is an affiliate link. If you click this link and apply for a product, we may receive a commission. This partner is: ${partnerName}.`
                );
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => app.init());

        // ===== ERROR HANDLING (Preserved) =====
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.message, event.filename, event.lineno);
        });
        window.addEventListener('unhandledrejection', (event) => {
             console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <!-- END: Inlined JavaScript -->

    <!-- 
      NEW: PWA Service Worker for Offline Use
      (Preserved from mortgage-calculator)
    -->
    <script>
        if ('serviceWorker' in navigator) {
            
            const OFFLINE_HTML = `
                <!DOCTYPE html>
                <html lang="en" style="font-family: Arial, sans-serif; background: #F5F7FA; color: #1F2121; padding: 20px;">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Offline | FinGuid Auto Loan Calculator</title>
                    <style>
                        body { text-align: center; padding-top: 50px; }
                        h1 { color: #24ACB9; }
                        p { font-size: 1.1rem; line-height: 1.6; }
                        .icon { font-size: 4rem; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="icon">üöó</div>
                    <h1>You are Offline</h1>
                    <p>This AI Auto Loan Calculator needs an internet connection to function and fetch live rates.</p>
                    <p>Please check your connection and try again.</p>
                </body>
                </html>
            `;
            
            const swContent = `
                const CACHE_NAME = 'auto-loan-calculator-v1';
                const urlsToCache = [
                    '.', // Caches the main HTML file
                    'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js',
                    'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js'
                ];
                
                const OFFLINE_PAGE_CONTENT = \`${OFFLINE_HTML}\`;

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Service Worker: Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                    );
                });

                self.addEventListener('fetch', event => {
                    if (event.request.mode !== 'navigate') {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    return response || fetch(event.request);
                                })
                        );
                        return;
                    }
                    
                    event.respondWith(
                        fetch(event.request)
                            .catch(() => {
                                // Network failed, try cache
                                return caches.match(event.request)
                                    .then(response => {
                                        // Return from cache or show offline page
                                        return response || new Response(OFFLINE_PAGE_CONTENT, {
                                            headers: { 'Content-Type': 'text/html' }
                                        });
                                    });
                            })
                    );
                });
            `;
            // Create a Blob from the SW content and register it
            const blob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered from Blob.', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>

</body>
</html>
