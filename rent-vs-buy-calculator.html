<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO & Metadata Updated for Rent vs. Buy -->
    <title>AI Rent vs. Buy Calculator 2025 | Is It Better to Rent or Buy? | FinGuid</title>
    <meta name="description" content="World's Best AI-Powered Rent vs. Buy Calculator by FinGuid. Compare the true costs of renting vs. buying a home. Analyzes net worth, ROI, tax savings, and appreciation with live FRED rates. WCAG 2.1 AA compliant.">
    <meta name="keywords" content="rent vs buy calculator, rent or buy calculator, should I rent or buy a house, renting vs buying, home buying calculator, renting cost, buying cost, mortgage vs rent, AI financial advisor, FinGuid, USA housing market, net worth calculator, appreciation calculator, ROI analysis, SCO Friendly, AI Friendly, live mortgage rates, FRED API rates">

    <meta name="author" content="FinGuid USA">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="theme-color" content="#24ACB9">
    <meta property="og:type" content="website">
    <meta property="og:title" content="AI Rent vs. Buy Calculator 2025 | Live FRED Rates | FinGuid">
    <meta property="og:description" content="Free AI calculator to compare the net worth and costs of renting vs. buying with live FRED rates and AI insights.">
    
    <link rel="canonical" href="https://www.finguid.com/calculators/rent-vs-buy">
    
    <!-- PWA FIX: Inlined PWA Web App Manifest (Updated) -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22FinGuid%20AI%20Rent%20vs.%20Buy%20Calculator%22,%22short_name%22:%22RentVsBuyCalc%22,%22description%22:%22AI-Powered%20Rent%20vs.%20Buy%20Calculator%20with%20Net%20Worth%20Analysis%20and%20Live%20Rates.%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#FFFFFD%22,%22theme_color%22:%22#24ACB9%22,%22icons%22:[{%22src%22:%22https://placehold.co/192x192/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://placehold.co/512x512/24ACB9/FFFFFF?text=FinGuid%22,%22type%22:%22image/png%22,%22sizes%22:%22512x512%22}]}">
    
    <!-- 
      START: Inlined CSS
      This is the complete, unified stylesheet from the mortgage-calculator template.
      It ensures 100% visual consistency and compliance (WCAG, Dark Mode, etc.).
    -->
    <style>
        /* === START: Global Variables (Brand Color Match) === */
        :root {
            --primary: #24ACB9; /* Teal (Matches FinGuid Image & Car Lease CSS) */
            --primary-dark: #19343B; /* Dark Teal (Matches Car Lease CSS) */
            --accent: #FFC107;
            --accent-dark: #E69500;
            --text: #1F2121;
            --text-light: #64748B;
            --bg: #FFFFFD;
            --bg-secondary: #F5F7FA;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --error: #EF4444;
            --success: #10B981;
            --fred-color: #A31B20; /* FRED standard color for Live Rates button */
            
            /* Rent vs Buy Specific Chart Colors */
            --color-chart-rent: #FFC107; /* Rent - Yellow/Orange */
            --color-chart-buy: #24ACB9; /* Buy - FinGuid Teal */
        }

        [data-color-scheme="dark"] {
            --text: #E1E8ED;
            --text-light: #B8C5D0;
            --bg: #1F2121;
            --bg-secondary: #242B36;
            --card: #181919;
            --border: #38444D;
            
            --color-chart-rent: #E69500; /* Darker Rent color */
            --color-chart-buy: #24ACB9; /* Buy - FinGuid Teal */
        }
        /* === END: Global Variables === */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { 
            font-size: 16px; 
            -webkit-font-smoothing: antialiased; 
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* ===== HEADER STYLES (From Mortgage Calc) ===== */
        .header {
            position: sticky;
            top: 0;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--primary);
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .logo:hover { color: var(--primary-dark); }

        .calculator-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            flex-shrink: 0;
            margin-left: 16px;
            flex-basis: auto;
            min-width: 0;
        }

        .header-features {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 24px;
            flex-grow: 1;
            justify-content: flex-start;
            overflow: hidden;
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        .header-feature-item {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            animation: pulse-color-text 2.5s infinite ease-in-out;
        }
        .header-feature-item:nth-child(1) { animation-delay: 0s; }
        .header-feature-item:nth-child(2) { animation-delay: 0.2s; }
        .header-feature-item:nth-child(3) { animation-delay: 0.4s; }
        .header-feature-item:nth-child(4) { animation-delay: 0.6s; }

        @keyframes pulse-color-text {
            0%, 100% {
                opacity: 0.8;
                color: var(--text-light);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                color: var(--primary);
                transform: scale(1.03);
            }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:hover { background: var(--primary); color: white; }
        .icon-btn.active { background: var(--primary); color: white; }

        #pwa-install-btn {
            display: none;
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #pwa-install-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        /* ===== END HEADER STYLES ===== */

        /* ===== SPONSOR BANNER (From Mortgage Calc) ===== */
        .sponsor-banner {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .sponsor-text { font-weight: 500; flex: 1; min-width: 200px; }
        .sponsor-buttons { display: flex; gap: 8px; }
        .sponsor-btn {
            padding: 8px 12px;
            background: white;
            color: #6366F1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .sponsor-btn:hover { background: var(--accent); color: var(--text); transform: translateY(-2px); }

        /* ===== MAIN CALCULATOR (Layout from Mortgage Calc) ===== */
        .calculator-wrapper {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            padding: 24px 0;
            margin-bottom: 40px;
        }

        .inputs-panel, .results-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .inputs-panel:hover, .results-panel:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .panel-title { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }

        /* Section Heading (From Mortgage Calc) */
        .section-heading {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }
        
        /* Input Tabs (Using Results Tab Style) */
        .input-tabs { margin-bottom: 24px; }
        .input-tab-buttons { 
            display: flex; 
            gap: 4px; 
            border-bottom: 2px solid var(--border); 
            margin-bottom: 24px; 
            overflow-x: auto; 
        }
        .input-tab-btn {
            padding: 12px 16px; /* Slightly smaller for input panel */
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .input-tab-btn:hover { color: var(--text); }
        .input-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .input-tab-btn:focus {
            color: var(--primary);
            box-shadow: none;
            border-bottom-color: rgba(36, 172, 185, 0.5);
            outline: none;
            border-radius: 2px 2px 0 0;
        }
        .input-tab-btn.active:focus { border-bottom-color: var(--primary); }

        .input-tab-content { display: none; padding: 0; animation: fadeIn 0.3s ease; }
        .input-tab-content.active { display: block; }
        /* End Input Tabs */

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        /* FRED rate styles (From Mortgage Calc) */
        .fred-rates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        #fred-last-updated {
            font-size: 11px;
            color: var(--text-light);
            text-align: left;
        }
        .fred-branding {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 600;
        }
        .fred-branding a { color: var(--text-light); text-decoration: none; }
        .fred-branding a:hover { color: var(--primary); }

        .live-rates-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .rate-btn {
            flex-grow: 1;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .rate-btn:hover {
            background: var(--card);
            border-color: var(--primary);
            color: var(--primary);
        }
        .rate-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .rate-btn:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Tooltip Styles (From Mortgage Calc) */
        .tooltip {
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
            display: inline-flex;
            align-items: center;
            color: var(--text-light);
        }
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-light);
            color: var(--card);
            font-style: normal;
            font-size: 10px;
            font-weight: 700;
            line-height: 14px;
            margin-left: 5px;
            transition: all 0.2s ease;
        }
        .tooltip:hover .tooltip-icon,
        .tooltip:focus .tooltip-icon {
            background: var(--primary);
            outline: none;
        }
        .tooltip:focus { outline: none; }

        .tooltip-box {
            position: fixed;
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 200px;
            white-space: normal;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .input-wrapper { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            min-width: 0; 
        }

        input[type="number"], input[type="text"], select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 0;
            width: 100%;
        }

        /* WCAG Focus Styles (From Mortgage Calc) */
        input[type="number"]:focus, input[type="text"]:focus, select:focus, 
        .rate-btn:focus, .sponsor-btn:focus, .icon-btn:focus, 
        #pwa-install-btn:focus, .tab-btn:focus, .input-tab-btn:focus, .faq-question:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.25);
        }
        .icon-btn:focus, #pwa-install-btn:focus, .sponsor-btn:focus {
             box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
        }

        .input-addon {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            min-width: 50px;
            text-align: center;
        }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Ad Slot (From Mortgage Calc) */
        .ad-slot {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
        }
        .ad-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .ad-placeholder {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 600;
        }

        /* ===== RESULTS SECTION (Adapted for Rent vs Buy) ===== */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(36, 172, 185, 0.2);
            text-align: center;
        }
        .summary-label { font-size: 1rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .payment-amount { display: flex; align-items: baseline; justify-content: center; gap: 8px; margin: 8px 0; }
        .amount { font-size: 2.5rem; font-weight: bold; }
        .unit { font-size: 1rem; opacity: 0.9; }
        .payment-breakdown { font-size: 1rem; opacity: 0.8; }
        
        /* Special styles for verdict */
        .summary-card.buy-recommended {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        .summary-card.rent-recommended {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
        }


        .tabs { margin-bottom: 24px; }
        .tab-buttons { 
            display: flex; 
            gap: 4px; 
            border-bottom: 2px solid var(--border); 
            margin-bottom: 24px; 
            overflow-x: auto; 
        }

        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:focus {
            color: var(--primary);
            box-shadow: none;
            border-bottom-color: rgba(36, 172, 185, 0.5);
        }
        .tab-btn.active:focus { border-bottom-color: var(--primary); }

        .tab-content { display: none; padding: 8px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        .tab-content:focus-visible {
            outline: 2px solid var(--primary);
            border-radius: 4px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .results-heading {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin: 16px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }
        
        /* Special heading colors for Rent vs Buy */
        .results-heading.buy-path-title { color: var(--color-chart-buy); }
        .results-heading.rent-path-title { color: var(--color-chart-rent); }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .result-box { background: var(--bg-secondary); padding: 16px; border-radius: 6px; border-left: 4px solid var(--border); transition: all 0.2s; }
        .result-box:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .result-box.highlight { 
            border-left-color: var(--primary); 
            background: rgba(36, 172, 185, 0.1); 
        }
        .result-box.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .result-box.accent {
            border-left-color: var(--accent-dark);
            background: rgba(255, 193, 7, 0.1);
        }

        .result-label { 
            display: block; 
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
        }
        .result-value { 
            display: block; 
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }
        .result-value.positive { color: var(--success); }
        .result-value.negative { color: var(--error); }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
        }

        /* AI INSIGHTS (From Mortgage Calc) */
        .insights-container { margin-top: 20px; }
        .insight-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .insight-box.success { border-left-color: var(--success); }
        .insight-box.warning { border-left-color: var(--accent-dark); }
        .insight-box.error { border-left-color: var(--error); }
        .insight-box.monetization {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        /* ===== PARTNER SECTION (From Mortgage Calc) ===== */
        .footer-sponsor {
            background: linear-gradient(135deg, rgba(36, 172, 185, 0.1) 0%, rgba(25, 52, 59, 0.1) 100%);
            padding: 40px;
            border-bottom: 1px solid rgba(36, 172, 185, 0.2);
            border-radius: 12px;
        }
        .sponsor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; }
        .sponsor-item { text-align: center; padding: 16px; border-radius: 8px; background: var(--card); transition: all 0.2s; }
        .sponsor-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sponsor-item h4 { margin-bottom: 8px; color: var(--primary); font-size: 1rem; }
        .sponsor-item p { color: var(--text-light); margin-bottom: 12px; font-size: 0.875rem; line-height: 1.5; }
        .sponsor-item a {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .sponsor-item a:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        .sponsor-item a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(36, 172, 185, 0.3); }

        /* ===== FOOTER (From Mortgage Calc) ===== */
        .footer { background: var(--card); border-top: 1px solid var(--border); padding: 32px 0; margin-top: 40px; }
        .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .footer-section h4 { font-size: 13px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .footer-section a { display: block; font-size: 12px; color: var(--text-light); text-decoration: none; margin-bottom: 8px; transition: color 0.3s ease; }
        .footer-section a:hover, .footer-section a:focus { 
            color: var(--primary); 
            text-decoration: underline;
            outline: none;
        }
        .compliance-badges { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; font-size: 12px; }
        .badge { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; font-weight: 600; color: var(--text-light); }
        .disclaimer { font-size: 11px; color: var(--text-light); line-height: 1.6; padding-top: 20px; border-top: 1px solid var(--border); }
        .footer-bottom { text-align: center; font-size: 12px; color: var(--text-light); padding-top: 16px; border-top: 1px solid var(--border); }

        /* ===== FAQ ACCORDION (From Mortgage Calc) ===== */
        .faq-section { margin: 40px 0; }
        .faq-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 20px; text-align: center; }
        .faq-container { max-width: 900px; margin: 0 auto; }
        .faq-item { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; }
        .faq-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .faq-question { padding: 16px; background: var(--bg-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text); transition: all 0.3s ease; }
        .faq-question:hover { background: var(--card); color: var(--primary); }
        .faq-question.active { background: var(--primary); color: white; }
        .faq-question:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4) inset;
            color: var(--primary);
        }
        .faq-icon { font-size: 18px; transition: transform 0.3s ease; }
        .faq-question.active .faq-icon { transform: rotate(180deg); }
        .faq-answer { display: none; padding: 16px; background: var(--card); color: var(--text-light); line-height: 1.8; font-size: 14px; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }

        /* ===== GDPR/CCPA COOKIE BANNER (From Mortgage Calc) ===== */
        #cookie-consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            color: var(--text);
            padding: 24px;
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .cookie-consent-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-light);
            flex: 1 1 400px;
        }
        .cookie-consent-text a { color: var(--primary); text-decoration: underline; }
        .cookie-consent-text a:hover { color: var(--primary-dark); }
        #cookie-consent-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #cookie-consent-btn:hover { background: var(--primary-dark); }
        #cookie-consent-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
        
        /* Visually hidden class for accessibility */
        .visually-hidden {
            border: 0;
            clip: rect(0 0 0 0);
            height: 1px;
            margin: -1px;
            overflow: hidden;
            padding: 0;
            position: absolute;
            width: 1px;
        }

        /* ===== RESPONSIVE (From Mortgage Calc) ===== */
        @media (max-width: 1024px) {
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel {
                position: static; /* Remove sticky on mobile */
            }
            .footer-content { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .header-features { display: none; }
            .sponsor-banner { flex-direction: column; gap: 12px; }
            .sponsor-buttons { flex: 1 1 100%; justify-content: space-between; }
            .tab-buttons, .input-tab-buttons { flex-wrap: nowrap; overflow-x: auto; }
            .inputs-panel, .results-panel { padding: 16px; }
            .footer-sponsor { padding: 24px; }
        }

        @media (max-width: 480px) {
            .calculator-title { display: none; }
            .header-features { display: none; }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .header-controls {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            #pwa-install-btn { flex-grow: 1; }
            .payment-breakdown { font-size: 0.75rem; }
            .amount { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; }
            .sponsor-grid { grid-template-columns: 1fr; }
            #cookie-consent-banner { flex-direction: column; text-align: center; }
            .cookie-consent-text { flex-basis: auto; }
            #cookie-consent-btn { width: 100%; }
        }

        /* ===== PRINT STYLE (From Mortgage Calc) ===== */
        @media print {
            .header, .sponsor-banner, .header-controls, .footer-sponsor, .faq-section, 
            .footer, .ad-slot, #cookie-consent-banner, .tab-buttons, .input-tab-buttons {
                display: none;
            }
            .calculator-wrapper { grid-template-columns: 1fr; }
            .inputs-panel, .results-panel { box-shadow: none; border: 1px solid #ccc; }
            .tab-content.active { display: block; }
            .tab-content { display: none; }
        }
    </style>
    <!-- END: Inlined CSS -->

    <!-- Google Analytics Script (From Requirements) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYBL2CDNQJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NYBL2CDNQJ');
    </script>

    <!-- PWA Install & Preload Logic (From Mortgage Calc) -->
    <script>
        // PWA Install Detection
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            const pwaInstall = document.getElementById('pwa-install-btn');
            if (pwaInstall) pwaInstall.style.display = 'flex';
        });

        // Preload critical resources
        document.addEventListener('DOMContentLoaded', () => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'script';
            link.href = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            document.head.appendChild(link);
        });
    </script>
</head>
<body>
    <!-- Header (From Mortgage Calc, Titles Updated) -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="https://www.finguid.com" class="logo">
                    <span role="img" aria-label="Money bag emoji">üí∞</span>
                    <span>FinGuid USA</span>
                </a>
                
                <span class="calculator-title">AI Rent vs. Buy Analyzer</span>

                <div class="header-features" aria-hidden="true">
                    <span class="header-feature-item">ü§ñ AI Powered</span>
                    <span class="header-feature-item">üìà Live FRED Rates</span>
                    <span class="header-feature-item">üí° Net Worth Analysis</span>
                    <span class="header-feature-item">‚úÖ WCAG 2.1 AA</span>
                </div>

                <div class="header-controls">
                    <button type="button" id="pwa-install-btn" aria-label="Install App">üì± Install</button>
                    <button type="button" class="icon-btn" id="darkModeToggle" aria-label="Toggle dark mode" title="Dark mode">üåô</button>
                    <button type="button" class="icon-btn" id="voiceToggle" aria-label="Voice control" title="Voice commands">üé§</button>
                    <button type="button" class="icon-btn" id="ttsToggle" aria-label="Text to speech" title="Read results">üîä</button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Sponsor Banner (From Mortgage Calc) -->
    <div class="sponsor-banner">
        <span class="sponsor-text">üéÅ Undecided? Get a $1,000 Credit From Our Partners if You Decide to Buy.</span>
        <div class="sponsor-buttons">
            <button type="button" class="sponsor-btn" onclick="location.href='#our-partners'">View Lender Partners ‚Üí</button>
            <button type="button" class="sponsor-btn" onclick="app.showPartnerAlert()">Become our partner ‚Üí</button>
        </div>
    </div>

    <main class="container" role="main">
        <div class="calculator-wrapper">
            <!-- ===== INPUTS PANEL (Content from Rent vs Buy Calc) ===== -->
            <section class="inputs-panel" role="region" aria-labelledby="inputs-title">
                <h2 class="panel-title" id="inputs-title">üìã Comparison Inputs</h2>
                
                <!-- Ad Slot (From rent-vs-buy.html, placed at top of input) -->
                <div class="ad-slot" role="complementary" aria-label="Sponsor Ad Slot">
                    <p class="ad-label">ADVERTISEMENT / SPONSOR PRODUCT</p>
                    <div class="ad-placeholder">
                        <p>Get Pre-Approved For a Loan Today</p>
                    </div>
                </div>
                
                <!-- Input Tabs (From rent-vs-buy.html, restyled) -->
                <div class="input-tabs">
                    <div class="input-tab-buttons" role="tablist" aria-label="Input sections">
                        <button type="button" class="input-tab-btn active" role="tab" aria-controls="buy-inputs" aria-selected="true" id="tab-buy-inputs">Buying Path</button>
                        <button type="button" class="input-tab-btn" role="tab" aria-controls="rent-inputs" aria-selected="false" id="tab-rent-inputs" tabindex="-1">Renting Path</button>
                        <button type="button" class="input-tab-btn" role="tab" aria-controls="analysis-inputs" aria-selected="false" id="tab-analysis-inputs" tabindex="-1">Analysis</button>
                    </div>

                    <!-- Buying Path Tab -->
                    <div class="input-tab-content active" id="buy-inputs" role="tabpanel" aria-labelledby="tab-buy-inputs" tabindex="0">
                        <div class="section-heading">Home Purchase Details</div>
                        <div class="form-group">
                            <label class="form-label" for="home-price">Home Price
                                <span class="tooltip" data-tooltip="The full purchase price of the home." tabindex="0" role="tooltip" id="tooltip-homeprice">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <span class="input-addon" aria-hidden="true">$</span>
                                <input type="number" id="home-price" value="400000" min="0" step="1000" aria-label="Home price" aria-describedby="tooltip-homeprice">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="down-payment">Down Payment
                                <span class="tooltip" data-tooltip="The initial cash you pay upfront." tabindex="0" role="tooltip" id="tooltip-dp">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <span class="input-addon" aria-hidden="true">$</span>
                                <input type="number" id="down-payment" value="80000" min="0" step="500" aria-label="Down payment" aria-describedby="tooltip-dp">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="interest-rate">Interest Rate %</label>
                            <div class="input-wrapper">
                                <input type="number" id="interest-rate" value="6.75" min="0" max="15" step="0.01" aria-label="Interest rate">
                                <span class="input-addon" aria-hidden="true">%</span>
                            </div>
                            <!-- FRED Rates (From Mortgage Calc) -->
                            <div class="fred-rates-header">
                                <span id="fred-last-updated">Loading live rates...</span>
                                <span class="fred-branding">
                                    Data via <a href="https://fred.stlouisfed.org/" target="_blank" rel="noopener">FRED¬Æ</a>
                                </span>
                            </div>
                            <div class="live-rates-container">
                                <button type="button" class="rate-btn" id="rate-btn-30yr" disabled>30-Yr Fixed: ...</button>
                                <button type="button" class="rate-btn" id="rate-btn-15yr" disabled>15-Yr Fixed: ...</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="loan-term-years">Loan Term</label>
                            <select id="loan-term-years" aria-label="Loan term">
                                <option value="30" selected>30-Year Fixed</option>
                                <option value="15">15-Year Fixed</option>
                            </select>
                        </div>
                        <div class="section-heading">Buying Costs</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="property-tax-rate">Property Tax
                                    <span class="tooltip" data-tooltip="Annual property tax as a % of home price." tabindex="0" role="tooltip" id="tooltip-tax">
                                        <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                    </span>
                                </label>
                                <div class="input-wrapper">
                                    <input type="number" id="property-tax-rate" value="1.2" min="0" step="0.01" aria-label="Property tax rate" aria-describedby="tooltip-tax">
                                    <span class="input-addon" aria-hidden="true">%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="home-insurance">Home Insurance
                                    <span class="tooltip" data-tooltip="Estimated annual home insurance cost." tabindex="0" role="tooltip" id="tooltip-ins">
                                        <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                    </span>
                                </label>
                                <div class="input-wrapper">
                                    <span class="input-addon" aria-hidden="true">$</span>
                                    <input type="number" id="home-insurance" value="1500" min="0" step="10" aria-label="Annual home insurance" aria-describedby="tooltip-ins">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="maintenance-rate">Maintenance
                                    <span class="tooltip" data-tooltip="Annual maintenance as a % of home price." tabindex="0" role="tooltip" id="tooltip-maint">
                                        <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                    </span>
                                </label>
                                <div class="input-wrapper">
                                    <input type="number" id="maintenance-rate" value="1.0" min="0" step="0.1" aria-label="Annual maintenance rate" aria-describedby="tooltip-maint">
                                    <span class="input-addon" aria-hidden="true">%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="closing-costs-buy">Closing Costs
                                    <span class="tooltip" data-tooltip="One-time fees for buying the home." tabindex="0" role="tooltip" id="tooltip-closing">
                                        <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                    </span>
                                </label>
                                <div class="input-wrapper">
                                    <span class="input-addon" aria-hidden="true">$</span>
                                    <input type="number" id="closing-costs-buy" value="8000" min="0" step="100" aria-label="Buying closing costs" aria-describedby="tooltip-closing">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Renting Path Tab -->
                    <div class="input-tab-content" id="rent-inputs" role="tabpanel" aria-labelledby="tab-rent-inputs" tabindex="0">
                        <div class="section-heading">Renting Details</div>
                        <div class="form-group">
                            <label class="form-label" for="current-rent">Current Monthly Rent</label>
                            <div class="input-wrapper">
                                <span class="input-addon" aria-hidden="true">$</span>
                                <input type="number" id="current-rent" value="2200" min="0" step="10" aria-label="Current monthly rent">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="rent-increase-rate">Annual Rent Increase
                                <span class="tooltip" data-tooltip="Expected yearly rent increase." tabindex="0" role="tooltip" id="tooltip-rent-inc">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="rent-increase-rate" value="3.0" min="0" step="0.1" aria-label="Annual rent increase rate" aria-describedby="tooltip-rent-inc">
                                <span class="input-addon" aria-hidden="true">%</span>
                            </div>
                        </div>
                        <div class="section-heading">Renting Costs</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="security-deposit">Security Deposit</label>
                                <div class="input-wrapper">
                                    <span class="input-addon" aria-hidden="true">$</span>
                                    <input type="number" id="security-deposit" value="2200" min="0" step="10" aria-label="Security deposit">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="renters-insurance">Renter's Insurance</label>
                                <div class="input-wrapper">
                                    <span class="input-addon" aria-hidden="true">$</span>
                                    <input type="number" id="renters-insurance" value="200" min="0" step="10" aria-label="Annual renter's insurance">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="misc-rental-fees">Broker/Misc. Fees</label>
                            <div class="input-wrapper">
                                <span class="input-addon" aria-hidden="true">$</span>
                                <input type="number" id="misc-rental-fees" value="0" min="0" step="100" aria-label="Miscellaneous rental fees">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis Tab -->
                    <div class="input-tab-content" id="analysis-inputs" role="tabpanel" aria-labelledby="tab-analysis-inputs" tabindex="0">
                        <div class="section-heading">Future Growth Assumptions</div>
                        <div class="form-group">
                            <label class="form-label" for="analysis-period">Analysis Period (How long you stay)
                                <span class="tooltip" data-tooltip="The number of years to compare. 7 years is a typical break-even point." tabindex="0" role="tooltip" id="tooltip-period">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <select id="analysis-period" aria-label="Analysis period" aria-describedby="tooltip-period">
                                <option value="5">5 Years (Short-Term)</option>
                                <option value="7" selected>7 Years (Average)</option>
                                <option value_10">10 Years (Medium-Term)</option>
                                <option value="15">15 Years (Long-Term)</option>
                                <option value="30">30 Years (Full Loan)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="appreciation-rate">Home Appreciation Rate
                                <span class="tooltip" data-tooltip="Expected annual increase in home value (historical average is ~3-4%)." tabindex="0" role="tooltip" id="tooltip-appr">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="appreciation-rate" value="3.5" min="0" step="0.1" aria-label="Home appreciation rate" aria-describedby="tooltip-appr">
                                <span class="input-addon" aria-hidden="true">%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="investment-return-rate">Investment Return Rate
                                <span class="tooltip" data-tooltip="The annual return you expect on your saved money (e.g., in an index fund)." tabindex="0" role="tooltip" id="tooltip-invest">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="investment-return-rate" value="6.0" min="0" step="0.1" aria-label="Investment return rate" aria-describedby="tooltip-invest">
                                <span class="input-addon" aria-hidden="true">%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="marginal-tax-rate">Marginal Tax Rate
                                <span class="tooltip" data-tooltip="Your tax bracket (Combined Federal + State) used to estimate tax savings." tabindex="0" role="tooltip" id="tooltip-tax-rate">
                                    <span class="tooltip-icon" role="img" aria-label="Info">i</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="marginal-tax-rate" value="24" min="0" step="1" aria-label="Marginal tax rate" aria-describedby="tooltip-tax-rate">
                                <span class="input-addon" aria-hidden="true">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== RESULTS PANEL (Content from Rent vs Buy Calc) ===== -->
            <section class="results-panel" role="region" aria-labelledby="results-title">
                <h2 class="panel-title" id="results-title">üìä Rent vs. Buy Analysis</h2>
                
                <!-- Ad Slot (From rent-vs-buy.html, styled like mortgage calc) -->
                <div class="ad-slot" role="complementary" aria-label="Advertisement">
                    <p class="ad-label">ADVERTISEMENT</p>
                    <div class="ad-placeholder">
                        <p>Compare Top Mortgage Lenders in Your Area</p>
                    </div>
                </div>

                <!-- Main Summary (Adapted for Rent vs Buy) -->
                <div class="summary-card" id="final-verdict-box">
                    <div class="summary-label">Verdict After <span class="summary-period-years">7</span> Years</div>
                    <div class="payment-amount">
                        <span class="amount" id="final-verdict-text" aria-live="polite">Run Analysis...</span>
                    </div>
                    <div class="payment-breakdown" id="final-verdict-subtitle" aria-live="polite">Net Worth Difference: $0</div>
                </div>
                
                <div class="tabs">
                    <!-- Tabs (Adapted for Rent vs Buy) -->
                    <div class="tab-buttons" role="tablist" aria-label="Results sections">
                        <button type="button" class="tab-btn active" role="tab" aria-controls="comparison-summary" aria-selected="true" id="tab-summary">Cost Summary</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="comparison-chart" aria-selected="false" id="tab-chart" tabindex="-1">Net Worth Chart</button>
                        <button type="button" class="tab-btn" role="tab" aria-controls="ai-insights" aria-selected="false" id="tab-insights" tabindex="-1">AI Insights</button>
                    </div>

                    <!-- Comparison Summary Tab -->
                    <div class="tab-content active" id="comparison-summary" role="tabpanel" aria-labelledby="tab-summary" tabindex="0">
                        <h3 class="results-heading buy-path-title">Buying Path (After <span class="summary-period-years">7</span> Years)</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <div class="result-label">Total Payments (PITI+Maint)</div>
                                <div class="result-value" id="total-payments-buy">$0</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Initial Costs (Down/Closing)</div>
                                <div class="result-value" id="total-initial-buy">$0</div>
                            </div>
                            <div class="result-box success">
                                <div class="result-label">Estimated Tax Savings</div>
                                <div class="result-value" id="total-tax-savings">$0</div>
                            </div>
                            <div class="result-box success">
                                <div class="result-label">Home Equity Built</div>
                                <div class="result-value" id="total-equity-built">$0</div>
                            </div>
                            <div class="result-box success">
                                <div class="result-label">Home Appreciation</div>
                                <div class="result-value" id="total-appreciation">$0</div>
                            </div>
                            <div class="result-box highlight">
                                <div class="result-label">Final Net Worth (Buy)</div>
                                <div class="result-value" id="total-net-worth-buy">$0</div>
                            </div>
                        </div>
                        
                        <h3 class="results-heading rent-path-title">Renting Path (After <span class="summary-period-years">7</span> Years)</h3>
                        <div class="result-grid">
                            <div class="result-box">
                                <div class="result-label">Total Rent Paid</div>
                                <div class="result-value" id="total-rent-paid">$0</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Initial Costs (Deposit/Fees)</div>
                                <div class="result-value" id="total-initial-rent">$0</div>
                            </div>
                            <div class="result-box success">
                                <div class="result-label">Investment Gains on Savings</div>
                                <div class="result-value" id="total-investment-gains">$0</div>
                            </div>
                            <div class="result-box highlight">
                                <div class="result-label">Final Net Worth (Rent)</div>
                                <div class="result-value" id="total-net-worth-rent">$0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Tab -->
                    <div class="tab-content" id="comparison-chart" role="tabpanel" aria-labelledby="tab-chart" tabindex="0">
                        <h3 class="results-heading">Net Worth Projection Over Time</h3>
                        <div class="chart-container">
                            <canvas id="rentVsBuyChart" role="img" aria-label="Line chart comparing net worth of renting vs. buying over time"></canvas>
                        </div>
                    </div>

                    <!-- AI Insights Tab -->
                    <div class="tab-content" id="ai-insights" role="tabpanel" aria-labelledby="tab-insights" tabindex="0">
                         <h3 class="results-heading">ü§ñ AI-Powered Insights</h3>
                        <div class="insights-container" id="insightsContainer" aria-live="polite">
                            <div class="insight-box">
                                <strong>ü§ñ AI Advisor:</strong> Enter your details to generate personalized insights...
                            </div>
                        </div>
                         <h3 class="results-heading">Return on Investment (ROI)</h3>
                         <div class="result-grid">
                            <div class="result-box highlight">
                                <div class="result-label">Buying Path ROI</div>
                                <div class="result-value" id="buy-roi">0%</div>
                            </div>
                            <div class="result-box accent">
                                <div class="result-label">Renting Path ROI</div>
                                <div class="result-value" id="rent-roi">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Partner Section (From Mortgage Calc) -->
        <section class="footer-sponsor" id="our-partners" aria-labelledby="partners-title">
            <div class="container">
                <h3 id="partners-title" style="text-align: center; margin-bottom: 24px; color: var(--primary); font-size: 24px; font-weight: 700;">Our Partners</h3>
                <div class="sponsor-grid">
                    <div class="sponsor-item">
                        <h4>üí≥ Mortgage Pre-Approval</h4>
                        <p>Decided to buy? Compare rates from top lenders and get pre-approved in minutes.</p>
                        <a href="#affiliate-link-1" onclick="app.showPartnerAlert('Mortgage Lender'); return false;" aria-label="Get Quotes for Mortgage Pre-Approval">Get Quotes ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üõ°Ô∏è Renter's Insurance</h4>
                        <p>Decided to rent? Protect your belongings for as little as $5/month. Get instant quotes.</p>
                        <a href="#affiliate-link-2" onclick="app.showPartnerAlert('Renter\'s Insurance'); return false;" aria-label="Compare Rates for Renter's Insurance">Compare Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üìà Investment Accounts</h4>
                        <p>Grow your savings in the 'Rent' path. Open a high-yield savings or investment account.</p>
                        <a href="#affiliate-link-3" onclick="app.showPartnerAlert('Investment Firm'); return false;" aria-label="Check Rates for Investment Accounts">Check Rates ‚Üí</a>
                    </div>
                    <div class="sponsor-item">
                        <h4>üîß Home Services</h4>
                        <p>Find affordable plans for home warranties, repairs, and moving services (for renting or buying).</p>
                        <a href="#affiliate-link-4" onclick="app.showPartnerAlert('Services'); return false;" aria-label="View Plans for Home Services">View Plans ‚Üí</a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- FAQ Section (Content Updated for Rent vs Buy) -->
        <section class="faq-section" aria-labelledby="faq-title">
            <h2 class="faq-title" id="faq-title">‚ùì Rent vs. Buy Frequently Asked Questions</h2>
            <div class="faq-container" id="faqContainer">
                <!-- FAQs will be dynamically inserted here by JS -->
            </div>
        </section>

        <!-- Footer (From Mortgage Calc, Links Updated) -->
        <footer class="footer" role="contentinfo">
            <div class="container">
                <div class="footer-content">
                    <nav class="footer-section" role="navigation" aria-label="About this calculator">
                        <h4>About Rent vs. Buy</h4>
                        <a href="#how-it-works">How It Works</a>
                        <a href="#net-worth">Net Worth Calculation</a>
                        <a href="#faq">FAQ</a>
                        <a href="#contact">Contact Us</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Learn more about home ownership">
                        <h4>Learn More</h4>
                        <a href="#costs-of-buying">Costs of Buying</a>
                        <a href="#costs-of-renting">Costs of Renting</a>
                        <a href="#rates">Current Rates</a>
                        <a href="#blog">Blog</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Financial resources">
                        <h4>Resources</h4>
                        <a href="/calculators/mortgage">Mortgage Calculator</a>
                        <a href="/calculators/affordability">Affordability Calculator</a>
                        <a href="/calculators/refinance">Refinance Calculator</a>
                        <a href="#glossary">Glossary</a>
                    </nav>
                    <nav class="footer-section" role="navigation" aria-label="Legal links">
                        <h4>Legal</h4>
                        <a href="#privacy">Privacy Policy</a>
                        <a href="#terms">Terms of Service</a>
                        <a href="#disclaimer">Disclaimer</a>
                        <a href="#affiliate">Affiliate Disclosure</a>
                    </nav>
                </div>

                <div class="compliance-badges" role="list" aria-label="Compliance Badges">
                    <span class="badge" role="listitem">üîí SSL Secured</span>
                    <span class="badge" role="listitem">‚úÖ GDPR Compliant</span>
                    <span class="badge" role="listitem">‚úÖ CCPA Compliant</span>
                    <span class="badge" role="listitem">‚úÖ FTC Compliant</span>
                    <span class="badge" role="listitem">‚ôø WCAG 2.1 AA</span>
                </div>

                <!-- Disclaimers (Updated for Rent vs Buy) -->
                <section class="disclaimer" aria-label="Disclaimers and Disclosures">
                    <strong>Educational & Informational Only:</strong> This rent vs. buy calculator is for educational and informational purposes only and does NOT constitute financial advice. Results are estimates based on user-provided data and future assumptions (e.g., appreciation, rent increases, investment returns) which are not guaranteed. Actual costs, rates, and market conditions may vary significantly. Always consult with a qualified financial advisor, mortgage professional, and real estate agent before making any major financial decisions.
                    <br><br>
                    <strong>Affiliate Disclosure:</strong> FinGuid participates in affiliate programs with lending, insurance, and investment partners. When you click on partner links, FinGuid may receive compensation. This does not affect your rates or terms. We only recommend products we believe provide value.
                    <br><br>
                    <strong>Data Accuracy:</strong> Mortgage rates (MORTGAGE30US, MORTGAGE15US) provided by Freddie Mac via FRED¬Æ API from the Federal Reserve Bank of St. Louis. Rates are updated regularly but we make no guarantees about accuracy. Always verify rates directly with lenders.
                </section>

                <div class="footer-bottom">
                    ¬© 2025 FinGuid USA. All Rights Reserved. | AI-Powered Financial Tools for Americans
                </div>
            </div>
        </footer>
    </main>

    <!-- Cookie Consent Banner (From Mortgage Calc) -->
    <div id="cookie-consent-banner" role="dialog" aria-modal="true" aria-labelledby="cookie-consent-title" aria-describedby="cookie-consent-desc">
        <div class="cookie-consent-text">
            <h4 id="cookie-consent-title" style="font-weight: 700; color: var(--text); margin-bottom: 8px;">Your Privacy</h4>
            <p id="cookie-consent-desc">
                We use cookies and data to enhance your experience and provide personalized AI insights. By clicking "Accept", you agree to our use of cookies.
                <a href="#privacy" aria-label="Read our Privacy Policy">Privacy Policy</a>.
            </p>
        </div>
        <button type="button" id="cookie-consent-btn">Accept</button>
    </div>

    <!-- Custom Alert Modal (From Mortgage Calc) -->
    <style>
        .alert-modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .alert-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10003;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            display: none;
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }
        .alert-modal.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-backdrop.visible {
            display: block;
            opacity: 1;
        }
        .alert-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }
        .alert-modal-body {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .alert-modal-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .alert-modal-btn:hover { background: var(--primary-dark); }
        .alert-modal-btn:focus {
            box-shadow: 0 0 0 3px rgba(36, 172, 185, 0.4);
            outline: none;
        }
    </style>
    <div class="alert-modal-backdrop" id="alert-modal-backdrop"></div>
    <div class="alert-modal" id="alert-modal" role="alertdialog" aria-modal="true" aria-labelledby="alert-modal-title" aria-describedby="alert-modal-body">
        <h4 class="alert-modal-title" id="alert-modal-title">Partner Information</h4>
        <p class="alert-modal-body" id="alert-modal-body">
            This is an affiliate link for [Partner].
        </p>
        <button type="button" class="alert-modal-btn" id="alert-modal-close">Close</button>
    </div>
    <!-- END: Modal for Alerts -->

    <!-- CDN Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- 
      START: Inlined JavaScript
      Contains all logic from the mortgage-calculator template,
      merged with the calculation logic from rent-vs-buy-calculator.js
    -->
    <script>
        /**
         * ========================================================================
         * AI-POWERED RENT VS. BUY ANALYZER (UNIFIED)
         * ========================================================================
         * Version: 9.0 - UNIFIED BUILD
         * Built with: SOLID Principles, WCAG 2.1 AA, PWA Compatible, GDPR/CCPA
         *
         * This file merges the mortgage-calculator.html template with the
         * rent-vs-buy-calculator.js logic.
         * ========================================================================
         */

        // ===== APP STATE & CONSTANTS =====
        const FRED_API_KEY = '9c6c421f077f2091e8bae4f143ada59a'; // From requirements
        const FRED_URL = 'https://api.stlouisfed.org/fred/series/observations';
        const FRED_SERIES_IDS = {
            rate30: 'MORTGAGE30US', // 30-Year Fixed
            rate15: 'MORTGAGE15US', // 15-Year Fixed
            rate10: 'DGS10'           // 10-Year Treasury (Not used here, but part of manager)
        };

        const FALLBACK_RATES = {
            rates: { rate30: 6.75, rate15: 6.15, rate10: 4.50 },
            dates: { rate30: null, rate15: null, rate10: null },
        };
        
        // --- FAQs Updated for Rent vs. Buy ---
        const FAQs = [
            {
                q: "What does a rent vs. buy calculator do?",
                a: "This AI-powered calculator analyzes the total financial picture of renting versus buying a home over a specific time period. It compares not just the monthly payments, but also factors in home appreciation, tax savings, building equity, and the opportunity cost of investing your down payment to determine which path builds more net worth."
            },
            {
                q: "Is it better to rent or buy a house in 2025?",
                a: "The answer depends on your financial situation, location, and how long you plan to stay. Buying builds long-term wealth through equity and appreciation, but has high upfront costs. Renting is flexible and frees up your cash (from a down payment) to be invested. This calculator runs the numbers to give you an AI-powered verdict."
            },
            {
                q: "What is 'Net Worth' in this analysis?",
                a: "Net worth is the final financial value of each path after the analysis period.<br/>‚Ä¢ **Buying Net Worth:** Your Home Equity (what you own) + Tax Savings + Home Appreciation.<br/>‚Ä¢ **Renting Net Worth:** Your Initial Savings (down payment + closing costs) + Monthly Savings (if rent is cheaper) all grown at your assumed 'Investment Return Rate'."
            },
            {
                q: "What is the 'break-even point' for buying a house?",
                a: "The break-even point is the time (usually 5-7 years) it takes for the financial benefits of buying (like equity and appreciation) to outweigh the high upfront costs (down payment, closing costs). If you sell before this point, you often lose money compared to renting."
            },
            {
                q: "How do taxes affect the rent vs. buy decision?",
                a: "Homeowners in the US can typically deduct mortgage interest and property taxes from their federal income, which provides significant tax savings. This calculator estimates those savings based on your 'Marginal Tax Rate' and adds them to the 'Buying Path' benefits."
            },
            {
                q: "What is 'Opportunity Cost'?",
                a: "Opportunity cost is the potential gain you miss out on by choosing one option over another. In this calculator, the 'Renting Path' assumes you invest your down payment and closing costs. The return on that investment is the opportunity cost of buying."
            },
            {
                q: "Why is 'Analysis Period' so important?",
                a: "The longer you stay in a home, the more financially advantageous buying becomes. The high upfront costs are spread over more years, and you benefit from more appreciation and equity buildup. Renting is often financially better for short-term periods (less than 5 years)."
            },
            {
                q: "How does this calculator get the interest rate?",
                a: "This AI calculator automatically fetches the latest available mortgage rates (30-Year, 15-Year) from the **FRED¬Æ API** (Federal Reserve Bank of St. Louis). This rate is then used as the default in the 'Interest Rate' field to give you a realistic starting point."
            }
        ];

        // ===== CORE RENT VS BUY LOGIC (From rent-vs-buy-calculator.js) =====
        class RentVsBuyCalculator {
            
            static getInputs() {
                const parseNumeric = (id, defaultValue = 0) => {
                    const element = document.getElementById(id);
                    if (!element) return defaultValue;
                    return parseFloat(element.value.replace(/[^0-9.]/g, '')) || defaultValue; 
                };
                
                return {
                    homePrice: parseNumeric('home-price', 400000),
                    downPayment: parseNumeric('down-payment', 80000),
                    interestRate: parseNumeric('interest-rate', 6.75),
                    loanTermYears: parseNumeric('loan-term-years', 30),
                    propertyTaxRate: parseNumeric('property-tax-rate', 1.2),
                    homeInsurance: parseNumeric('home-insurance', 1500),
                    maintenanceRate: parseNumeric('maintenance-rate', 1.0),
                    closingCostsBuy: parseNumeric('closing-costs-buy', 8000),
                    currentRent: parseNumeric('current-rent', 2200),
                    rentIncreaseRate: parseNumeric('rent-increase-rate', 3.0),
                    securityDeposit: parseNumeric('security-deposit', 2200),
                    rentersInsurance: parseNumeric('renters-insurance', 200),
                    miscRentalFees: parseNumeric('misc-rental-fees', 0),
                    analysisPeriod: parseNumeric('analysis-period', 7),
                    appreciationRate: parseNumeric('appreciation-rate', 3.5),
                    investmentReturnRate: parseNumeric('investment-return-rate', 6.0),
                    marginalTaxRate: parseNumeric('marginal-tax-rate', 24),
                };
            }
            
            /**
             * Calculates the monthly principal and interest (P&I) payment.
             */
            static calculateMonthlyPayment(principal, annualRate, termYears) {
                if (principal <= 0 || termYears <= 0) return 0;
                
                const rate = (annualRate / 100) / 12; // Monthly rate
                const payments = termYears * 12; // Total number of payments

                if (rate === 0) {
                    return principal / payments; // Simple division for 0% rate
                }

                const numerator = principal * rate * Math.pow(1 + rate, payments);
                const denominator = Math.pow(1 + rate, payments) - 1;
                
                if (denominator === 0) return 0;

                return numerator / denominator;
            }
            
            static calculate() {
                const S = this.getInputs(); // S = State/Inputs

                if (S.homePrice === 0 || S.analysisPeriod === 0 || S.currentRent === 0) {
                    return null; // Not enough data to calculate
                }

                // --- Core Financial Variables ---
                const P = S.homePrice - S.downPayment; // Principal Loan Amount
                const r_m = (S.interestRate / 100) / 12; // Monthly Interest Rate (for P&I)
                const n = S.loanTermYears * 12; // Total Payments (for P&I)
                const T_m = (S.homePrice * (S.propertyTaxRate / 100)) / 12; // Monthly Property Tax
                const I_m = S.homeInsurance / 12; // Monthly Home Insurance
                const M_m = (S.homePrice * (S.maintenanceRate / 100)) / 12; // Monthly Maintenance
                
                const appreciation = S.appreciationRate / 100;
                const investmentReturn_m = (S.investmentReturnRate / 100) / 12;
                const rentIncrease = S.rentIncreaseRate / 100;
                const taxRate = S.marginalTaxRate / 100;
                const analysisMonths = S.analysisPeriod * 12;

                // --- 1. Buying Path: Monthly P&I Calculation ---
                let monthlyPI = this.calculateMonthlyPayment(P, S.interestRate, S.loanTermYears);
                const totalMonthlyBuyCost = monthlyPI + T_m + I_m + M_m;
                
                // --- 2. Renting Path: Initial Values ---
                const initialInvestmentBuy = S.downPayment + S.closingCostsBuy;
                const initialInvestmentRent = S.securityDeposit + S.miscRentalFees;
                
                // This is the core "opportunity cost" investment
                let cumulativeInvestmentRent = initialInvestmentBuy - initialInvestmentRent; 

                // --- 3. Track Costs & Equity over Analysis Period ---
                let outstandingBalance = P;
                let totalRentPaid = 0;
                let totalBuyPayments = 0;
                let totalTaxSavings = 0;
                let totalEquityBuilt = S.downPayment; // Start with down payment
                let totalAppreciation = 0;
                let currentHomeValue = S.homePrice;
                
                let annualComparisonData = [];

                for (let m = 1; m <= analysisMonths; m++) {
                    let year = Math.floor((m - 1) / 12); // 0-indexed year for compounding
                    
                    // --- BUYING PATH MONTHLY CALCULATIONS ---
                    let monthlyInterest = outstandingBalance * r_m;
                    let monthlyPrincipal = monthlyPI - monthlyInterest;
                    
                    if (outstandingBalance <= 0) { // Loan paid off
                        monthlyInterest = 0;
                        monthlyPrincipal = 0;
                        monthlyPI = 0;
                    }
                    
                    let monthlyTaxDeduction = (monthlyInterest + T_m) * taxRate;
                    totalTaxSavings += monthlyTaxDeduction;

                    let monthlyBuyOutflow = monthlyPI + T_m + I_m + M_m;
                    totalBuyPayments += monthlyBuyOutflow;

                    if (outstandingBalance > 0) {
                        outstandingBalance -= monthlyPrincipal;
                    }
                    totalEquityBuilt += monthlyPrincipal;

                    // --- RENTING PATH MONTHLY CALCULATIONS ---
                    let currentMonthlyRent = S.currentRent * Math.pow(1 + rentIncrease, year);
                    let monthlyRentOutflow = currentMonthlyRent + (S.rentersInsurance / 12);
                    totalRentPaid += monthlyRentOutflow;

                    // --- Investment Calculation ---
                    // Invest the difference in initial costs (done above)
                    // and the difference in *monthly* cash flow
                    let monthlySavingsInvested = monthlyBuyOutflow - monthlyRentOutflow;
                    
                    // Apply investment return to accumulated invested capital
                    cumulativeInvestmentRent *= (1 + investmentReturn_m);
                    cumulativeInvestmentRent += monthlySavingsInvested;

                    // --- ANNUAL CALCULATIONS (Save for Chart/Display) ---
                    if (m % 12 === 0 || m === analysisMonths) {
                        currentHomeValue = S.homePrice * Math.pow(1 + appreciation, m / 12);
                        totalAppreciation = currentHomeValue - S.homePrice;
                        
                        // BUYING PATH NET WORTH = Equity + Appreciation
                        let buyNetWorth = totalEquityBuilt + totalAppreciation;
                        
                        // RENTING PATH NET WORTH = Invested Capital + Returned Deposit
                        let rentNetWorth = cumulativeInvestmentRent + S.securityDeposit;

                        annualComparisonData.push({
                            year: Math.ceil(m / 12),
                            buyNetWorth: buyNetWorth,
                            rentNetWorth: rentNetWorth,
                        });
                    }
                }
                
                // --- 4. Final Result Metrics ---
                const finalData = annualComparisonData[annualComparisonData.length - 1];
                
                const totalNetWorthBuy = finalData.buyNetWorth + totalTaxSavings;
                const totalNetWorthRent = finalData.rentNetWorth;

                // ROI Calculation (Net Worth Gain / Initial Investment)
                const buyPathROI = (totalNetWorthBuy - initialInvestmentBuy) / initialInvestmentBuy;
                const rentPathROI = (totalNetWorthRent - initialInvestmentRent) / initialInvestmentRent;

                return {
                    ...S, // Return inputs along with results
                    totalPaymentsBuy: totalBuyPayments,
                    totalInitialBuy: initialInvestmentBuy,
                    totalTaxSavings: totalTaxSavings,
                    totalEquityBuilt: totalEquityBuilt,
                    totalAppreciation: totalAppreciation,
                    totalNetWorthBuy: totalNetWorthBuy,
                    totalRentPaid: totalRentPaid,
                    totalInitialRent: initialInvestmentRent,
                    totalInvestmentGains: totalNetWorthRent - initialInvestmentRent,
                    totalNetWorthRent: totalNetWorthRent,
                    buyPathROI: isFinite(buyPathROI) ? buyPathROI : 0,
                    rentPathROI: isFinite(rentPathROI) ? rentPathROI : 0,
                    annualComparisonData: annualComparisonData
                };
            }
        }

        // ===== AI INSIGHTS ENGINE (Logic from rent-vs-buy-calculator.js) =====
        class AIInsightEngine {
            
            static generateInsights(results) {
                const insights = [];
                const S = results; // Use results object
                const fmtd = UIManager.formatCurrency;
                const fmtdP = (num) => (num * 100).toFixed(1) + '%';
                
                const difference = S.totalNetWorthBuy - S.totalNetWorthRent;
                const period = S.analysisPeriod;

                // --- Core Recommendation ---
                if (difference > (S.initialInvestmentBuy * 0.1)) { // Buy is >10% better
                    insights.push({
                        title: "‚úÖ AI Verdict: BUY",
                        text: `The **BUYING PATH** is projected to be the stronger financial choice, resulting in **${fmtd(Math.abs(difference))}** more net worth after **${period} years**. Your strong down payment and the power of home appreciation are key drivers.`,
                        type: 'success'
                    });
                } else if (difference < -(S.initialInvestmentBuy * 0.1)) { // Rent is >10% better
                    insights.push({
                        title: "‚úÖ AI Verdict: RENT",
                        text: `The **RENTING PATH** appears to be significantly better over this **${period}-year period**, generating **${fmtd(Math.abs(difference))}** more net worth. This suggests your high investment return rate outweighs the current buying costs.`,
                        type: 'success'
                    });
                } else { // It's a close call
                    insights.push({
                        title: "‚öñÔ∏è AI Verdict: CLOSE CALL",
                        text: `The financial difference between renting and buying is narrow (less than 10%). Your decision should be based on **lifestyle factors**, job stability, and personal market conviction, not just the numbers.`,
                        type: 'info'
                    });
                }

                // --- Market Analysis & Actionable Advice ---
                
                // 1. Home Appreciation Sensitivity
                if (S.appreciationRate < 3.0) {
                     insights.push({ 
                        title: "Appreciation Risk",
                        text: `At a low **${fmtdP(S.appreciationRate)}** appreciation rate, the case for buying is weaker. **AI Tip:** Ensure you are buying in an area with strong growth potential to offset the high transaction costs.`,
                        type: 'warning'
                    });
                } else if (S.appreciationRate > 5.0) {
                     insights.push({ 
                        title: "Appreciation Strength",
                        text: `Your **${fmtdP(S.appreciationRate)}** appreciation rate is a major driver of wealth. This strong growth significantly favors the buying path.`,
                        type: 'info'
                    });
                }

                // 2. Rent vs Investment Opportunity
                if (S.investmentReturnRate > (S.interestRate + 1.0)) { // Investment rate is > 1% higher than mortgage rate
                    insights.push({
                        title: "Investment Opportunity",
                        text: `Your assumed investment return of **${fmtdP(S.investmentReturnRate)}** is significantly higher than your mortgage rate. This strongly favors the **Renting Path**, as your money works harder in the market than it saves you in interest.`,
                        type: 'info'
                    });
                }
                
                // 3. Tax Savings
                if (S.totalTaxSavings < 1000) {
                     insights.push({ 
                        title: "Low Tax Savings",
                        text: `Your estimated tax savings are very low. This is likely due to the high standard deduction. **AI Tip:** Do not factor tax savings heavily into your decision, as you may not be itemizing your deductions.`,
                        type: 'info'
                    });
                }

                // 4. Monetization Insight (Affiliate)
                if (S.homePrice > 300000) {
                     insights.push({ 
                        title: "Partner Recommendation", 
                        text: `If you choose the 'Buy' path, locking in the lowest possible rate is critical. **Compare live rates from our partners** to minimize your monthly payment and maximize your long-term ROI.`,
                        type: 'monetization' 
                    });
                } else {
                     insights.push({ 
                        title: "Partner Recommendation", 
                        text: `If you choose the 'Rent' path, protecting your belongings is key. **Compare top-rated renter's insurance** policies from our partners for as little as $5/month.`,
                        type: 'monetization' 
                    });
                }

                return insights;
            }
        }

        // ===== FRED API MANAGER (From Mortgage Calc) =====
        class FREDManager {
            
            static getEasternTimeInfo() {
                const now = new Date();
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const parts = etFormatter.formatToParts(now).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const currentETDate = `${parts.year}-${parts.month.padStart(2, '0')}-${parts.day.padStart(2, '0')}`;
                const currentETHour = parseInt(parts.hour, 10);
                const currentETMinute = parseInt(parts.minute, 10);
                const isAfterCutoff = (currentETHour > 16) || (currentETHour === 16 && currentETMinute >= 45);

                return { currentETDate, isAfterCutoff, now };
            }

            static isCacheValid(cache) {
                const { lastFetch } = cache;
                if (!lastFetch) return false;

                const { currentETDate, isAfterCutoff } = this.getEasternTimeInfo();

                const lastFetchDate = new Date(lastFetch);
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    hour: 'numeric',
                    minute: 'numeric',
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour12: false
                });
                
                const lastFetchParts = etFormatter.formatToParts(lastFetchDate).reduce((acc, part) => {
                    acc[part.type] = part.value;
                    return acc;
                }, {});
                
                const lastFetchETDate = `${lastFetchParts.year}-${lastFetchParts.month.padStart(2, '0')}-${lastFetchParts.day.padStart(2, '0')}`;
                const lastFetchHour = parseInt(lastFetchParts.hour, 10);
                const lastFetchMinute = parseInt(lastFetchParts.minute, 10);
                const wasLastFetchAfterCutoff = (lastFetchHour > 16) || (lastFetchHour === 16 && lastFetchMinute >= 45);

                if (currentETDate !== lastFetchETDate) {
                    if (isAfterCutoff) {
                        return false; 
                    }
                    if (wasLastFetchAfterCutoff) {
                        return true;
                    }
                    return false;
                }
                if (!wasLastFetchAfterCutoff && isAfterCutoff) {
                    return false;
                }
                return true;
            }

            static formatTimestamp(now) {
                return new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    dateStyle: 'short',
                    timeStyle: 'short'
                }).format(now) + " ET";
            }

            static async fetchFredSeries(seriesId) {
                try {
                    const url = `${FRED_URL}?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json&sort_order=desc&limit=1`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`FRED API request failed for ${seriesId}: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.observations && data.observations.length > 0) {
                        const rate = parseFloat(data.observations[0].value);
                        const date = data.observations[0].date;
                        if (isNaN(rate)) return { rate: null, date: null };
                        return { rate, date };
                    }
                } catch (error) {
                    console.error(error);
                }
                return { rate: null, date: null };
            }

            static async getRates() {
                const cacheStr = localStorage.getItem('fredRatesCache');
                let cache = cacheStr ? JSON.parse(cacheStr) : null;
                
                const { now } = this.getEasternTimeInfo();

                if (cache && this.isCacheValid(cache)) {
                    console.log('Using cached FRED rates');
                    return {
                        ...cache,
                        isCache: true,
                        lastUpdatedTimestamp: `Rates as of ${this.formatTimestamp(new Date(cache.lastFetch))}`
                    };
                }

                console.log('Fetching new FRED rates');
                
                const [data30, data15] = await Promise.all([
                    this.fetchFredSeries(FRED_SERIES_IDS.rate30),
                    this.fetchFredSeries(FRED_SERIES_IDS.rate15)
                ]);

                const newRates = {
                    rate30: data30.rate || FALLBACK_RATES.rates.rate30,
                    rate15: data15.rate || FALLBACK_RATES.rates.rate15,
                    rate10: FALLBACK_RATES.rates.rate10, // Not fetched for this calc
                };

                const newDates = {
                    date30: data30.date || null,
                    date15: data15.date || null,
                    date10: null,
                };

                const newCache = {
                    rates: newRates,
                    dates: newDates,
                    lastFetch: now.toISOString()
                };

                localStorage.setItem('fredRatesCache', JSON.stringify(newCache));

                return {
                    ...newCache,
                    isCache: false,
                    lastUpdatedTimestamp: `Live Rates updated: ${this.formatTimestamp(now)}`
                };
            }
        }

        // ===== UI MANAGER (From Mortgage Calc, adapted for Rent vs Buy) =====
        class UIManager {
            static formatCurrency(value, decimals = 0) {
                if (typeof value !== 'number' || isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(value);
            }
            static formatPercent(value, decimals = 1) { 
                if (!isFinite(value) || isNaN(value)) return '0.0%';
                return (value * 100).toFixed(decimals) + '%'; 
            } 

            static updateResults(results) {
                 const fmtd = this.formatCurrency;
                 
                 // Update summary period years everywhere
                 document.querySelectorAll('.summary-period-years').forEach(el => {
                    el.textContent = results.analysisPeriod;
                 });
                 
                 // Main Summary Card
                 const verdictBox = document.getElementById('final-verdict-box');
                 const verdictText = document.getElementById('final-verdict-text');
                 const verdictSubtitle = document.getElementById('final-verdict-subtitle');
                 const difference = results.totalNetWorthBuy - results.totalNetWorthRent;

                 if (difference > 0) {
                    verdictText.textContent = `Buy is Better`;
                    verdictSubtitle.textContent = `Net Worth Gain: ${fmtd(difference, 0)}`;
                    verdictBox.className = 'summary-card buy-recommended';
                 } else {
                    verdictText.textContent = `Rent is Better`;
                    verdictSubtitle.textContent = `Net Worth Gain: ${fmtd(Math.abs(difference), 0)}`;
                    verdictBox.className = 'summary-card rent-recommended';
                 }
                 
                 // Tab 1: Cost Summary
                 // Buying Path
                 document.getElementById('total-payments-buy').textContent = fmtd(results.totalPaymentsBuy, 0);
                 document.getElementById('total-initial-buy').textContent = fmtd(results.totalInitialBuy, 0);
                 document.getElementById('total-tax-savings').textContent = fmtd(results.totalTaxSavings, 0);
                 document.getElementById('total-equity-built').textContent = fmtd(results.totalEquityBuilt, 0);
                 document.getElementById('total-appreciation').textContent = fmtd(results.totalAppreciation, 0);
                 document.getElementById('total-net-worth-buy').textContent = fmtd(results.totalNetWorthBuy, 0);
                 
                 // Renting Path
                 document.getElementById('total-rent-paid').textContent = fmtd(results.totalRentPaid, 0);
                 document.getElementById('total-initial-rent').textContent = fmtd(results.totalInitialRent, 0);
                 document.getElementById('total-investment-gains').textContent = fmtd(results.totalInvestmentGains, 0);
                 document.getElementById('total-net-worth-rent').textContent = fmtd(results.totalNetWorthRent, 0);
                 
                 // Tab 3: ROI
                 document.getElementById('buy-roi').textContent = this.formatPercent(results.buyPathROI, 1);
                 document.getElementById('rent-roi').textContent = this.formatPercent(results.rentPathROI, 1);
            }
            
            static updateInsights(insights) {
                const container = document.getElementById('insightsContainer');
                container.innerHTML = '';
                if(!insights || insights.length === 0) {
                     container.innerHTML = '<div class="insight-box"><strong>ü§ñ AI Advisor:</strong> Enter valid details to generate personalized insights...</div>';
                     return;
                }
                insights.forEach(insight => {
                    const box = document.createElement('div');
                    box.className = `insight-box ${insight.type || 'info'}`;
                    const insightText = insight.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    box.innerHTML = `<strong>${insight.title}:</strong> ${insightText}`;
                    container.appendChild(box);
                });
            }
        }

        // ===== CHART MANAGER (From Mortgage Calc, adapted for Rent vs Buy) =====
        class ChartManager {
            static charts = {};

            static renderRentVsBuyChart(results) {
                const ctx = document.getElementById('rentVsBuyChart').getContext('2d');
                if (!ctx) return;
                if (this.charts.rentVsBuy) this.charts.rentVsBuy.destroy();
                
                const S = results;
                const labels = S.annualComparisonData.map(d => 'Year ' + d.year);
                const buyData = S.annualComparisonData.map(d => d.buyNetWorth);
                const rentData = S.annualComparisonData.map(d => d.rentNetWorth);
                
                const isDarkMode = document.documentElement.getAttribute('data-color-scheme') === 'dark';
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'var(--border)';
                const textColor = 'var(--text-light)';

                this.charts.rentVsBuy = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Buying Path Net Worth',
                                data: buyData,
                                borderColor: 'var(--color-chart-buy)',
                                backgroundColor: 'rgba(36, 172, 185, 0.2)',
                                fill: 'start',
                                tension: 0.1,
                                borderWidth: 3
                            },
                            {
                                label: 'Renting Path Net Worth',
                                data: rentData,
                                borderColor: 'var(--color-chart-rent)',
                                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                                fill: 'start',
                                tension: 0.1,
                                borderWidth: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { color: textColor } 
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${UIManager.formatCurrency(context.parsed.y, 0)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Total Net Worth ($)', color: textColor },
                                ticks: { color: textColor, callback: (value) => `$${value/1000}k` },
                                grid: { color: gridColor }
                            },
                            x: {
                                title: { display: true, text: 'Time (Years)', color: textColor },
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
            }
        }

        // ===== MAIN APP (Controller) =====
        const app = {
            calculateDebounce: null,
            lastResults: null,
            state: {
                isTtsEnabled: false,
                liveRates: FALLBACK_RATES.rates
            },

            async init() {
                this.setupEventListeners();
                this.setupDarkMode();
                this.setupPWA();
                this.setupVoiceControls();
                this.setupFAQ();
                this.initTooltips(); 
                this.setupInputTabs(); // Specific to Rent v Buy
                this.setupResultsTabs();
                this.setupAlertModal();
                this.setupCookieConsent();
                await this.loadInitialRates();
            },

            setupEventListeners() {
                // Inputs for rent vs buy calculator
                const inputIds = [
                    'home-price', 'down-payment', 'interest-rate', 'loan-term-years', 
                    'property-tax-rate', 'home-insurance', 'maintenance-rate', 'closing-costs-buy',
                    'current-rent', 'rent-increase-rate', 'security-deposit', 'renters-insurance',
                    'misc-rental-fees', 'analysis-period', 'appreciation-rate', 
                    'investment-return-rate', 'marginal-tax-rate'
                ];
                inputIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.debouncedCalculate());
                        el.addEventListener('change', () => this.debouncedCalculate());
                    }
                });
                
                // Live Rate Button Listeners
                document.getElementById('rate-btn-30yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate30, 'rate-btn-30yr'));
                    
                document.getElementById('rate-btn-15yr').addEventListener('click', () => 
                    this.applyRate(this.state.liveRates.rate15, 'rate-btn-15yr'));
            },

            applyRate(rate, btnId) {
                if (!rate) return;
                
                // --- MODIFIED: Apply to 'interest-rate' input ---
                document.getElementById('interest-rate').value = rate.toFixed(2);
                document.querySelectorAll('.rate-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(btnId).classList.add('active');
                
                this.calculate(); // Recalculate immediately
            },

            setupInputTabs() {
                const tablist = document.querySelector('.input-tab-buttons');
                const tabs = tablist.querySelectorAll('[role="tab"]');
                this.setupTabset(tablist, tabs);
            },

            setupResultsTabs() {
                const tablist = document.querySelector('.tab-buttons');
                const tabs = tablist.querySelectorAll('[role="tab"]');
                this.setupTabset(tablist, tabs);
            },
            
            setupTabset(tablist, tabs) {
                tablist.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('[role="tab"]');
                    if (!clickedTab) return;
                    this.activateTab(clickedTab, tabs);
                });

                tablist.addEventListener('keydown', (e) => {
                    let index = Array.from(tabs).indexOf(document.activeElement);
                    if (index === -1) return;

                    let direction = 0;
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        direction = 1;
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        direction = -1;
                    } else if (e.key === 'Home') {
                        e.preventDefault();
                        tabs[0].focus();
                    } else if (e.key === 'End') {
                        e.preventDefault();
                        tabs[tabs.length - 1].focus();
                    }

                    if (direction !== 0) {
                        e.preventDefault();
                        index = (index + direction + tabs.length) % tabs.length;
                        tabs[index].focus();
                    }
                });
            },

            activateTab(tab, allTabsInSet) {
                const tabId = tab.getAttribute('aria-controls');
                
                allTabsInSet.forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                    t.setAttribute('tabindex', '-1');
                    // Deactivate corresponding panel
                    const panel = document.getElementById(t.getAttribute('aria-controls'));
                    if (panel) {
                        panel.classList.remove('active');
                        // Use display none for inactive tabs
                        if (panel.closest('.results-panel') || panel.closest('.inputs-panel')) {
                             panel.style.display = 'none';
                        }
                    }
                });
                
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                tab.setAttribute('tabindex', '0');

                const panel = document.getElementById(tabId);
                panel.classList.add('active');
                // Use display block for active tabs
                if (panel.closest('.results-panel') || panel.closest('.inputs-panel')) {
                    panel.style.display = 'block';
                }


                // Render chart if switching to its tab
                if (tabId === 'comparison-chart' && this.lastResults) {
                    setTimeout(() => ChartManager.renderRentVsBuyChart(this.lastResults), 50);
                }
            },
            
            debouncedCalculate() {
                clearTimeout(this.calculateDebounce);
                this.calculateDebounce = setTimeout(() => this.calculate(), 250);
            },

            calculate() {
                const results = RentVsBuyCalculator.calculate();
                this.lastResults = results;
                
                if (results) {
                    UIManager.updateResults(results);
                    
                    const insights = AIInsightEngine.generateInsights(results);
                    UIManager.updateInsights(insights);

                    if (this.state.isTtsEnabled) {
                        this.speakResults();
                    }
                    
                    // Refresh chart if tab is active
                    const activeTabId = document.querySelector('.tab-buttons [role="tab"][aria-selected="true"]').getAttribute('aria-controls');
                    if (activeTabId === 'comparison-chart') {
                        setTimeout(() => ChartManager.renderRentVsBuyChart(this.lastResults), 50);
                    }
                }
            },
            
            initTooltips() {
                let tooltipBox = null;
                document.querySelectorAll('.tooltip').forEach(el => {
                    const showTooltip = (e) => {
                        const text = e.currentTarget.getAttribute('data-tooltip');
                        if (!text) return;
                        if (tooltipBox) tooltipBox.remove();
                        
                        tooltipBox = document.createElement('div');
                        tooltipBox.className = 'tooltip-box';
                        tooltipBox.textContent = text;
                        tooltipBox.setAttribute('role', 'tooltip');
                        document.body.appendChild(tooltipBox);

                        const rect = e.currentTarget.getBoundingClientRect();
                        let top = rect.top - tooltipBox.offsetHeight - 5;
                        let left = rect.left + rect.width / 2 - tooltipBox.offsetWidth / 2;

                        if (top < 0) { top = rect.bottom + 5; }
                        if (left < 0) { left = 5; }
                        if (left + tooltipBox.offsetWidth > window.innerWidth) {
                            left = window.innerWidth - tooltipBox.offsetWidth - 5;
                        }

                        tooltipBox.style.left = `${left}px`;
                        tooltipBox.style.top = `${top}px`;
                        tooltipBox.style.display = 'block';
                        setTimeout(() => { if (tooltipBox) tooltipBox.style.opacity = '1'; }, 10);
                    };

                    const hideTooltip = () => {
                        if (tooltipBox) {
                            tooltipBox.style.opacity = '0';
                            setTimeout(() => {
                                if (tooltipBox) {
                                    tooltipBox.remove();
                                    tooltipBox = null;
                                }
                            }, 200);
                        }
                    };

                    el.addEventListener('mouseenter', showTooltip);
                    el.addEventListener('focus', showTooltip);
                    el.addEventListener('mouseleave', hideTooltip);
                    el.addEventListener('blur', hideTooltip);
                });
            },

            async loadInitialRates() {
                const updatedEl = document.getElementById('fred-last-updated');
                const rateEl = document.getElementById('interest-rate');
                
                const btn30 = document.getElementById('rate-btn-30yr');
                const btn15 = document.getElementById('rate-btn-15yr');

                try {
                    const { rates, lastUpdatedTimestamp } = await FREDManager.getRates();
                    
                    this.state.liveRates = rates;

                    updatedEl.textContent = lastUpdatedTimestamp;
                    updatedEl.style.color = "var(--text-light)";

                    btn30.textContent = `30-Yr Fixed: ${rates.rate30.toFixed(2)}%`;
                    btn15.textContent = `15-Yr Fixed: ${rates.rate15.toFixed(2)}%`;
                    
                    btn30.disabled = false;
                    btn15.disabled = false;
                    
                    // Default to 30-Yr Fixed Rate
                    rateEl.value = rates.rate30.toFixed(2);
                    btn30.classList.add('active');

                } catch (error) {
                    console.error("Error loading initial rates:", error);
                    updatedEl.textContent = 'Error loading rates. Using fallbacks.';
                    updatedEl.style.color = "var(--error)";
                    this.state.liveRates = FALLBACK_RATES.rates;
                    btn30.textContent = `30-Yr Fixed: ${this.state.liveRates.rate30.toFixed(2)}%`;
                    btn15.textContent = `15-Yr Fixed: ${this.state.liveRates.rate15.toFixed(2)}%`;
                    rateEl.value = this.state.liveRates.rate30.toFixed(2); // Use fallback
                    btn30.classList.add('active');
                }
                
                this.calculate(); // Calculate on load
            },

            setupDarkMode() {
                const toggle = document.getElementById('darkModeToggle');
                const scheme = localStorage.getItem('colorScheme') || 'light';
                document.documentElement.setAttribute('data-color-scheme', scheme);
                
                toggle.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-color-scheme');
                    const next = current === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-color-scheme', next);
                    localStorage.setItem('colorScheme', next);
                    
                    // Force chart redraw on theme change
                    if (this.lastResults) {
                         setTimeout(() => ChartManager.renderRentVsBuyChart(this.lastResults), 50);
                    }
                });
            },

            setupPWA() {
                const pwaBtn = document.getElementById('pwa-install-btn');
                if (pwaBtn) {
                    pwaBtn.addEventListener('click', async () => {
                        if (window.deferredPrompt) {
                            window.deferredPrompt.prompt();
                            await window.deferredPrompt.userChoice;
                            window.deferredPrompt = null;
                        }
                    });
                }
            },

            setupVoiceControls() {
                const voiceBtn = document.getElementById('voiceToggle');
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = () => { 
                        voiceBtn.classList.add('active'); 
                        voiceBtn.textContent = '..'; 
                    };
                    recognition.onend = () => { 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.textContent = 'üé§'; 
                    };
                    recognition.onerror = (event) => { 
                        console.error('Voice recognition error', event.error); 
                        voiceBtn.classList.remove('active'); 
                        voiceBtn.textContent = 'üé§'; 
                    };

                    recognition.onresult = (event) => {
                        const command = event.results[0][0].transcript.toLowerCase();
                        if (command.includes('calculate') || command.includes('compute')) this.calculate();
                        else if (command.includes('read results')) this.speakResults();
                        else if (command.includes('read insights')) this.speakInsights();
                    };
                    voiceBtn.addEventListener('click', () => { try { recognition.start(); } catch(e) { console.error("Voice recognition error", e); } });
                } else {
                     voiceBtn.title = 'Voice control not supported in this browser.';
                     voiceBtn.style.opacity = '0.5';
                     voiceBtn.disabled = true;
                }
                
                const ttsBtn = document.getElementById('ttsToggle');
                ttsBtn.addEventListener('click', () => {
                    this.state.isTtsEnabled = !this.state.isTtsEnabled;

                    if (this.state.isTtsEnabled) {
                        ttsBtn.classList.add('active'); 
                        this.speakResults(); 
                    } else {
                        ttsBtn.classList.remove('active'); 
                        if ('speechSynthesis' in window && speechSynthesis.speaking) {
                            speechSynthesis.cancel(); 
                        }
                    }
                });
            },

            // --- Updated for Rent vs Buy ---
            speakResults() {
                if ('speechSynthesis' in window && this.lastResults) {
                    speechSynthesis.cancel();
                    const verdict = document.getElementById('final-verdict-text').textContent;
                    const subtitle = document.getElementById('final-verdict-subtitle').textContent;
                    const text = `The AI verdict after ${this.lastResults.analysisPeriod} years is: ${verdict}. ${subtitle}.`;
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                }
            },
            
            speakInsights() {
                 if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const insightsContainer = document.getElementById('insightsContainer');
                    const firstInsight = insightsContainer.querySelector('.insight-box');
                    if(firstInsight) {
                        const text = firstInsight.textContent;
                        const utterance = new SpeechSynthesisUtterance(text);
                        speechSynthesis.speak(utterance);
                    }
                }
            },

            setupFAQ() {
                const container = document.getElementById('faqContainer');
                if(!container) return;

                FAQs.forEach((faq, index) => {
                    const qId = `faq-q-${index}`;
                    const aId = `faq-a-${index}`;
                    
                    const item = document.createElement('div');
                    item.className = 'faq-item';
                    item.innerHTML = `
                        <div class="faq-question" role="button" tabindex="0" aria-expanded="false" aria-controls="${aId}" id="${qId}">
                            <span>${faq.q}</span>
                            <span class="faq-icon" aria-hidden="true">‚ñº</span>
                        </div>
                        <div class="faq-answer" role="region" aria-labelledby="${qId}" id="${aId}">${faq.a}</div>
                    `;
                    container.appendChild(item);
                });
                
                container.addEventListener('click', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question) this.toggleFAQ(question);
                });
                
                container.addEventListener('keydown', (e) => {
                    const question = e.target.closest('.faq-question');
                    if (question && (e.key === 'Enter' || e.key === ' ')) {
                        e.preventDefault();
                        this.toggleFAQ(question);
                    }
                });
            },
            
            toggleFAQ(question) {
                const answer = document.getElementById(question.getAttribute('aria-controls'));
                const isActive = question.getAttribute('aria-expanded') === 'true';

                document.querySelectorAll('.faq-question[aria-expanded="true"]').forEach(q => {
                    if (q !== question) {
                        q.setAttribute('aria-expanded', 'false');
                        q.classList.remove('active');
                        document.getElementById(q.getAttribute('aria-controls')).style.display = 'none';
                        q.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                    }
                });

                if (!isActive) {
                    question.setAttribute('aria-expanded', 'true');
                    question.classList.add('active');
                    answer.style.display = 'block';
                    answer.style.animation = 'slideDown 0.3s ease';
                    question.querySelector('.faq-icon').style.transform = 'rotate(180deg)';
                } else {
                    question.setAttribute('aria-expanded', 'false');
                    question.classList.remove('active');
                    answer.style.display = 'none';
                    question.querySelector('.faq-icon').style.transform = 'rotate(0deg)';
                }
            },

            setupCookieConsent() {
                const banner = document.getElementById('cookie-consent-banner');
                const btn = document.getElementById('cookie-consent-btn');
                
                if (localStorage.getItem('cookieConsent') === 'true') {
                    banner.style.display = 'none';
                } else {
                    banner.style.display = 'flex';
                }
                
                btn.addEventListener('click', () => {
                    localStorage.setItem('cookieConsent', 'true');
                    banner.style.display = 'none';
                });
            },
            
            setupAlertModal() {
                const modal = document.getElementById('alert-modal');
                const backdrop = document.getElementById('alert-modal-backdrop');
                const closeBtn = document.getElementById('alert-modal-close');
                
                const closeModal = () => {
                    modal.classList.remove('visible');
                    backdrop.classList.remove('visible');
                };

                closeBtn.addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            },
            
            showAlert(title, message) {
                document.getElementById('alert-modal-title').textContent = title;
                document.getElementById('alert-modal-body').textContent = message;
                document.getElementById('alert-modal').classList.add('visible');
                document.getElementById('alert-modal-backdrop').classList.add('visible');
                document.getElementById('alert-modal-close').focus();
            },
            
            showPartnerAlert(partnerName) {
                this.showAlert(
                    'Affiliate Partner Link',
                    `This is an affiliate link. If you click this link and apply for a product, we may receive a commission. This partner is: ${partnerName}.`
                );
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => app.init());

        // ===== ERROR HANDLING =====
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.message, event.filename, event.lineno);
        });
        window.addEventListener('unhandledrejection', (event) => {
             console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <!-- END: Inlined JavaScript -->

    <!-- 
      NEW: PWA Service Worker for Offline Use
      (From Mortgage Calc, provides offline fallback)
    -->
    <script>
        if ('serviceWorker' in navigator) {
            
            const OFFLINE_HTML = `
                <!DOCTYPE html>
                <html lang="en" style="font-family: Arial, sans-serif; background: #F5F7FA; color: #1F2121; padding: 20px;">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Offline | FinGuid Rent vs. Buy Calculator</title>
                    <style>
                        body { text-align: center; padding-top: 50px; }
                        h1 { color: #24ACB9; }
                        p { font-size: 1.1rem; line-height: 1.6; }
                        .icon { font-size: 4rem; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="icon">ü§ñ</div>
                    <h1>You are Offline</h1>
                    <p>This AI Rent vs. Buy Calculator needs an internet connection to function and fetch live rates.</p>
                    <p>Please check your connection and try again.</p>
                </body>
                </html>
            `;
            
            const swContent = `
                const CACHE_NAME = 'rent-vs-buy-calculator-v1';
                const urlsToCache = [
                    '.', // Caches the main HTML file
                    'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js'
                ];
                
                const OFFLINE_PAGE_CONTENT = \`${OFFLINE_HTML}\`;

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Service Worker: Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                    );
                });

                self.addEventListener('fetch', event => {
                    if (event.request.mode !== 'navigate') {
                        // For non-HTML requests (like scripts, images), use cache-first
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    return response || fetch(event.request);
                                })
                        );
                        return;
                    }
                    
                    // For navigation requests, try network first, then cache, then offline page
                    event.respondWith(
                        fetch(event.request)
                            .catch(() => {
                                // Network failed, try cache
                                return caches.match(event.request)
                                    .then(response => {
                                        // Return from cache or show offline page
                                        return response || new Response(OFFLINE_PAGE_CONTENT, {
                                            headers: { 'Content-Type': 'text/html' }
                                        });
                                    });
                            })
                    );
                });
            `;
            // Create a Blob from the SW content and register it
            const blob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered from Blob.', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>

</body>
</html>
